<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al&Ni KPSS Studio | Ultimate V13 (AdSense Ready)</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1105930817107200"
     crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316', 
                        primaryDark: '#ea580c', 
                        secondary: '#fff7ed',
                        success: '#22c55e',
                        warning: '#eab308',
                        danger: '#ef4444',
                        studio: '#1e293b' // Al&Ni Studios Brand Color
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        
        .status-btn { transition: all 0.2s; }
        .status-btn:active { transform: scale(0.95); }
        
        .nav-item.active-nav {
            background-color: #fff7ed;
            color: #f97316;
            border-right: 3px solid #f97316;
            font-weight: 600;
        }
        
        .avatar-option:hover { transform: scale(1.1); border-color: #f97316; }
        .avatar-option.selected { border-color: #f97316; ring: 2px solid #f97316; transform: scale(1.1); }

        .perspective { perspective: 1000px; }
        .flip-card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card:hover .flip-card-inner, .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            text-align: center;
        }
        .flip-card-back {
            background-color: #f97316;
            color: white;
            transform: rotateY(180deg);
        }
        
        .sticky-note {
            background: #fef3c7;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            border-bottom-right-radius: 20px;
        }

        .tab-active { border-bottom: 2px solid #f97316; color: #f97316; font-weight: bold; }
        
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        @media (min-width: 768px) { .sidebar-closed { transform: translateX(0); } }

        /* Carousel Styles */
        .carousel-track { transition: transform 0.5s ease-in-out; }
        .glass-panel { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body class="text-slate-800 h-screen overflow-hidden flex flex-col">

    <div id="authScreen" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-50 overflow-y-auto">
        <div class="w-full h-full md:h-[90vh] md:max-w-[1400px] bg-white md:rounded-3xl shadow-2xl flex flex-col md:flex-row overflow-hidden relative">
            
            <div class="w-full md:w-1/2 bg-slate-900 text-white relative flex flex-col justify-between shrink-0 h-[50vh] md:h-full">
                <div class="p-6 md:p-8 flex items-center gap-3 z-10">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center font-bold text-xl">A</div>
                    <div>
                        <h1 class="text-xl font-bold tracking-wider">Al&Ni STUDIOS</h1>
                        <p class="text-xs text-slate-400">Next Gen Software</p>
                    </div>
                </div>

                <div class="flex-1 relative overflow-hidden flex items-center">
                    <div id="sliderTrack" class="carousel-track flex w-full h-full absolute top-0 left-0">
                        
                        <div class="min-w-full h-full flex flex-col justify-center items-center p-8 text-center bg-gradient-to-br from-slate-900 to-slate-800">
                            <i class="fa-solid fa-graduation-cap text-6xl text-primary mb-6 animate-bounce"></i>
                            <h2 class="text-3xl font-bold mb-4">KPSS Studio Nedir?</h2>
                            <p class="text-slate-300 leading-relaxed max-w-md">
                                Al&Ni KPSS Studio, yapay zeka destekli altyapÄ±sÄ± ile sÄ±nav hazÄ±rlÄ±k sÃ¼recinizi dijitalleÅŸtirir. 
                                Konu takibi, deneme analizi, flashcard sistemi ve akÄ±llÄ± koÃ§luk modÃ¼lÃ¼ ile rakiplerinizin Ã¶nÃ¼ne geÃ§in.
                                <br><br>
                                <strong>Hedef:</strong> Minimum Ã§alÄ±ÅŸma ile maksimum verim.
                            </p>
                        </div>

                        <div class="min-w-full h-full flex flex-col justify-center items-center p-8 text-center bg-gradient-to-br from-indigo-900 to-slate-900">
                            <i class="fa-solid fa-book-open-reader text-6xl text-blue-400 mb-6"></i>
                            <h2 class="text-3xl font-bold mb-4">KPSS'ye NasÄ±l Ã‡alÄ±ÅŸÄ±lÄ±r?</h2>
                            <p class="text-slate-300 leading-relaxed max-w-md text-sm md:text-base">
                                Kamu Personeli SeÃ§me SÄ±navÄ± (KPSS), disiplin ve strateji gerektirir.
                                <br><br>
                                <ul class="text-left text-slate-400 space-y-2 list-disc pl-4 inline-block">
                                    <li>Konu eksiklerini erkenden tamamla.</li>
                                    <li>DÃ¼zenli deneme Ã§Ã¶z ve analiz et.</li>
                                    <li>Pomodoro tekniÄŸi ile odaklan (Sistemimizde mevcut!).</li>
                                    <li>Ã‡Ä±kmÄ±ÅŸ sorularÄ± mutlaka Ã§Ã¶z.</li>
                                </ul>
                            </p>
                        </div>

                        <div class="min-w-full h-full flex flex-col justify-center items-center p-8 text-center bg-gradient-to-br from-orange-900 to-slate-900">
                            <i class="fa-solid fa-layer-group text-6xl text-warning mb-6"></i>
                            <h2 class="text-3xl font-bold mb-4">Al&Ni Ekosistemi</h2>
                            <p class="text-slate-300 leading-relaxed max-w-md">
                                Biz sadece bir sÄ±nav uygulamasÄ± deÄŸiliz. Al&Ni Studios olarak;
                                <br><br>
                                <span class="block mb-2"><strong class="text-white">LifeCalc Pro:</strong> KiÅŸisel yaÅŸam ve finans yÃ¶netiminde devrim yaratan sÃ¼per uygulama.</span>
                                <span class="block mb-2"><strong class="text-white">Menu Architect:</strong> Kafeler iÃ§in yeni nesil SaaS dijital menÃ¼ Ã§Ã¶zÃ¼mleri.</span>
                                <span class="block"><strong class="text-white">Web & Mobil:</strong> Ä°htiyaca Ã¶zel, yÃ¼ksek performanslÄ± yazÄ±lÄ±m mimarileri.</span>
                            </p>
                        </div>

                    </div>
                    
                    <button onclick="moveSlide(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/10 hover:bg-white/20 p-3 rounded-full text-white backdrop-blur-sm"><i class="fa-solid fa-chevron-left"></i></button>
                    <button onclick="moveSlide(1)" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/10 hover:bg-white/20 p-3 rounded-full text-white backdrop-blur-sm"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="p-6 text-center text-xs text-slate-500 z-10">
                    &copy; 2025 Al&Ni Game Studios. All Rights Reserved.
                </div>
                
                <div class="absolute top-0 right-0 w-64 h-64 bg-primary/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2 pointer-events-none"></div>
            </div>

            <div class="w-full md:w-1/2 bg-white flex flex-col justify-center items-center p-8 md:p-12 overflow-y-auto h-[50vh] md:h-full">
                <div class="w-full max-w-md">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-slate-800">HoÅŸ Geldin!</h2>
                        <p class="text-slate-500 mt-2">HesabÄ±na giriÅŸ yap ve Ã§alÄ±ÅŸmaya baÅŸla.</p>
                    </div>

                    <div id="loginForm">
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-slate-700 mb-2">E-Posta</label>
                            <input type="email" id="loginEmail" class="w-full p-4 rounded-xl border border-slate-200 focus:border-primary focus:ring-2 focus:ring-orange-100 outline-none transition" placeholder="ornek@alni.com">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Åžifre</label>
                            <input type="password" id="loginPassword" class="w-full p-4 rounded-xl border border-slate-200 focus:border-primary focus:ring-2 focus:ring-orange-100 outline-none transition" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                        </div>
                        <button onclick="window.handleLogin()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-4 rounded-xl transition shadow-xl shadow-orange-200 transform hover:-translate-y-1">GiriÅŸ Yap</button>
                        <p class="mt-6 text-center text-sm text-slate-600">HesabÄ±n yok mu? <a href="#" onclick="window.toggleAuth('register')" class="text-primary font-bold hover:underline">Hemen KayÄ±t Ol</a></p>
                    </div>
                    
                    <div id="registerForm" class="hidden">
                        <div class="mb-3">
                            <input type="text" id="regName" class="w-full p-4 rounded-xl border border-slate-200 outline-none" placeholder="Ad Soyad">
                        </div>
                        <div class="mb-3">
                            <input type="email" id="regEmail" class="w-full p-4 rounded-xl border border-slate-200 outline-none" placeholder="E-Posta">
                        </div>
                        <div class="mb-3">
                            <input type="password" id="regPassword" class="w-full p-4 rounded-xl border border-slate-200 outline-none" placeholder="Åžifre">
                        </div>
                        <div class="flex items-start space-x-2 mb-6">
                            <input type="checkbox" id="privacyCheck" class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                            <label for="privacyCheck" class="text-xs text-slate-600 cursor-pointer leading-tight">
                                <span onclick="window.showPrivacyModal()" class="text-primary font-bold underline">Gizlilik PolitikasÄ±nÄ±</span> okudum, anladÄ±m ve onaylÄ±yorum.
                            </label>
                        </div>
                        <button onclick="window.handleRegister()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-4 rounded-xl transition shadow-xl">Ãœcretsiz KayÄ±t Ol</button>
                        <p class="mt-6 text-center text-sm text-slate-600">Zaten Ã¼ye misin? <a href="#" onclick="window.toggleAuth('login')" class="text-primary font-bold hover:underline">GiriÅŸ Yap</a></p>
                    </div>

                    <div class="mt-8 pt-8 border-t border-slate-100 flex justify-center space-x-4 text-xs text-slate-400">
                        <a href="#" class="hover:text-primary">YardÄ±m</a>
                        <span>â€¢</span>
                        <a href="#" class="hover:text-primary">Ä°letiÅŸim</a>
                        <span>â€¢</span>
                        <a href="#" onclick="window.showPrivacyModal()" class="hover:text-primary">Gizlilik</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="appContainer" class="hidden flex h-full relative">
        
        <div id="mobileOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass-effect transition-opacity"></div>

        <aside id="mainSidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-slate-200 flex flex-col justify-between transform -translate-x-full md:translate-x-0 transition-transform duration-300 md:static md:flex shrink-0 h-full shadow-2xl md:shadow-none">
            
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-xl">A</div>
                        <div>
                            <h2 class="font-bold text-slate-800 leading-tight">Al&Ni KPSS</h2>
                            <p class="text-xs text-slate-500">Ultimate Pro Max</p>
                        </div>
                    </div>
                    <button onclick="window.toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div class="p-4 bg-secondary m-4 rounded-xl border border-orange-100 text-center shrink-0">
                    <img id="sidebarAvatar" src="" class="w-12 h-12 rounded-full mx-auto border-2 border-white shadow-sm mb-2 bg-white">
                    <div id="sidebarName" class="text-sm font-bold text-slate-800">...</div>
                    <div id="sidebarTitle" class="text-xs text-primary font-semibold">...</div>
                </div>

                <nav class="px-4 space-y-1 text-sm mt-2 flex-1 overflow-y-auto pb-4">
                    <button id="nav-dashboard" onclick="window.loadPage('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-chart-pie w-5"></i><span>Genel BakÄ±ÅŸ</span></button>
                    <button id="nav-smartcoach" onclick="window.loadPage('smartcoach')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-brain w-5 text-purple-600"></i><span class="font-bold text-purple-700">SmartCoach AI</span></button>
                    
                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">Ã‡ALIÅžMA</div>
                    <button id="nav-subjects" onclick="window.loadPage('subjects')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-list-check w-5"></i><span>Konu Takip</span></button>
                    <button id="nav-quiz" onclick="window.loadPage('quiz')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-pen-nib w-5"></i><span>Soru Merkezi</span></button>
                    <button id="nav-cards" onclick="window.loadPage('cards')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-layer-group w-5"></i><span>Flashcards</span></button>
                    <button id="nav-mocks" onclick="window.loadPage('mocks')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-chart-line w-5"></i><span>Deneme & Analiz</span></button>
                    
                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">SOSYAL & EKSTRA</div>
                    <button id="nav-forum" onclick="window.loadPage('forum')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-comments w-5"></i><span>Forum</span></button>
                    <button id="nav-leaderboard" onclick="window.loadPage('leaderboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-trophy w-5 text-yellow-500"></i><span>Liderlik Tablosu</span></button>
                    <button id="nav-notes" onclick="window.loadPage('notes')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-sticky-note w-5"></i><span>Not Defterim</span></button>
                    <button id="nav-feedback" onclick="window.loadPage('feedback')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-paper-plane w-5"></i><span>Ã–neri / Åžikayet</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">KÄ°ÅžÄ°SEL</div>
                    <button id="nav-notifications" onclick="window.loadPage('notifications')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition relative">
                        <i class="fa-solid fa-bell w-5"></i><span>Bildirimler</span>
                        <span id="notifBadge" class="hidden absolute top-2 right-4 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full border border-white">0</span>
                    </button>
                    <button id="nav-profile" onclick="window.loadPage('profile')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 rounded-lg hover:bg-orange-50 hover:text-primary transition"><i class="fa-solid fa-user-gear w-5"></i><span>Ayarlar</span></button>
                    
                    <button id="adminLink" onclick="window.loadPage('admin')" class="hidden nav-item w-full flex items-center space-x-3 px-4 py-3 text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition mt-4"><i class="fa-solid fa-shield-halved w-5"></i><span>YÃ¶netim Paneli</span></button>
                </nav>
            </div>

            <div class="bg-slate-50 border-t border-slate-200 p-4">
                 <div class="bg-slate-800 rounded-xl p-3 text-white text-center mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-slate-400">POMODORO</span>
                        <span class="text-[10px] text-green-400" id="pomodoroCount">0 Seans</span>
                    </div>
                    <div id="timerDisplay" class="text-xl font-mono font-bold mb-2">25:00</div>
                    <div class="flex justify-center space-x-2">
                        <button onclick="window.toggleTimer()" id="timerBtn" class="w-6 h-6 rounded-full bg-primary hover:bg-primaryDark flex items-center justify-center"><i class="fa-solid fa-play text-[10px]"></i></button>
                        <button onclick="window.resetTimer()" class="w-6 h-6 rounded-full bg-slate-600 hover:bg-slate-500 flex items-center justify-center"><i class="fa-solid fa-rotate-right text-[10px]"></i></button>
                    </div>
                </div>

                <button onclick="window.logout()" class="w-full flex items-center justify-center space-x-2 text-slate-500 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition text-sm font-medium">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Ã‡Ä±kÄ±ÅŸ Yap</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50">
            <header class="md:hidden h-16 bg-white border-b flex items-center justify-between px-4 z-30 shrink-0 shadow-sm">
                <div class="flex items-center space-x-3">
                    <button onclick="window.toggleSidebar()" class="text-slate-600 hover:text-primary transition p-2">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="font-bold text-primary text-lg">Al&Ni KPSS</div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="window.loadPage('notifications')" class="text-slate-500 relative">
                         <i class="fa-solid fa-bell"></i>
                         <span id="mobileNotifBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] w-3 h-3 flex items-center justify-center rounded-full">0</span>
                    </button>
                    <img id="mobileAvatar" src="" class="w-8 h-8 rounded-full border border-slate-200">
                </div>
            </header>
            
            <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 relative"></div>
        </main>
    </div>

    <div id="privacyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col mx-4">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">Gizlilik PolitikasÄ± ve KullanÄ±m ÅžartlarÄ±</h3>
                <button onclick="window.closePrivacyModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-600 space-y-4">
                <p><strong>1. Veri Toplama:</strong> Al&Ni KPSS Studio, ilerleme durumunuzu takip etmek iÃ§in e-posta, Ã§alÄ±ÅŸma istatistikleri ve hedef puan verilerini saklar.</p>
                <p><strong>2. GÃ¼venlik:</strong> Verileriniz Firebase altyapÄ±sÄ±nda ÅŸifrelenmiÅŸ olarak saklanÄ±r. 3. ÅŸahÄ±slarla paylaÅŸÄ±lmaz.</p>
                <p><strong>3. Hesap Silme:</strong> KullanÄ±cÄ± dilediÄŸi zaman profil ayarlarÄ±ndan "HesabÄ±mÄ± Sil" talebinde bulunabilir.</p>
                <p><strong>4. Sorumluluk Reddi:</strong> Bu uygulama bir hazÄ±rlÄ±k aracÄ±dÄ±r.</p>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end">
                <button onclick="window.closePrivacyModal()" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primaryDark">AnladÄ±m</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVVuIdQzbPZqWaMLtkV0mRjr5qHOng460",
            authDomain: "alnikpss.firebaseapp.com",
            projectId: "alnikpss",
            storageBucket: "alnikpss.firebasestorage.app",
            messagingSenderId: "546288972320",
            appId: "1:546288972320:web:997647b8542e41f28f8245",
            measurementId: "G-XGCG35CPFJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SLIDER LOGIC ---
        let currentSlide = 0;
        const totalSlides = 3;
        
        window.moveSlide = (n) => {
            currentSlide = (currentSlide + n + totalSlides) % totalSlides;
            const track = document.getElementById('sliderTrack');
            if(track) track.style.transform = `translateX(-${currentSlide * 100}%)`;
        };
        
        // Auto slide
        setInterval(() => { if(!currentUser) window.moveSlide(1); }, 5000);

        // --- CONSTANTS ---
        const CURRICULUM = {
            "TÃ¼rkÃ§e": [ "SÃ¶zcÃ¼kte Anlam", "CÃ¼mlede Anlam", "Paragrafta Anlam", "Noktalama Ä°ÅŸaretleri", "YapÄ± Bilgisi", "Ses Bilgisi", "SÃ¶zcÃ¼k Bilgisi", "CÃ¼mle Bilgisi", "YazÄ±m KurallarÄ±", "AnlatÄ±m BozukluklarÄ±", "SÃ¶zel MantÄ±k" ],
            "Matematik": [ "Temel Kavramlar", "SayÄ±lar", "BÃ¶lme-BÃ¶lÃ¼nebilme", "Asal Ã‡arpanlar", "EBOB-EKOK", "1. Derece Denklemler", "Rasyonel SayÄ±lar", "EÅŸitsizlik", "Mutlak DeÄŸer", "ÃœslÃ¼ SayÄ±lar", "KÃ¶klÃ¼ SayÄ±lar", "Ã‡arpanlara AyÄ±rma", "Oran-OrantÄ±", "Problemler", "KÃ¼meler", "Fonksiyonlar", "PermÃ¼tasyon-Kombinasyon", "OlasÄ±lÄ±k" ],
            "Tarih": [ "Ä°slamiyet Ã–ncesi TÃ¼rk Tarihi", "TÃ¼rk-Ä°slam Tarihi", "Ä°lk TÃ¼rk Devletleri", "Anadolu SelÃ§uklu", "OsmanlÄ± KÃ¼ltÃ¼r Medeniyet", "OsmanlÄ± KuruluÅŸ-YÃ¼kselme", "OsmanlÄ± Duraklama-Gerileme", "Trablusgarp & Balkan SavaÅŸlarÄ±", "I. DÃ¼nya SavaÅŸÄ±", "KurtuluÅŸ SavaÅŸÄ± HazÄ±rlÄ±k", "KurtuluÅŸ SavaÅŸÄ± Muharebeler", "AtatÃ¼rk Ä°lkeleri", "DÄ±ÅŸ Politika", "Ã‡aÄŸdaÅŸ TÃ¼rk DÃ¼nyasÄ±" ],
            "CoÄŸrafya": [ "CoÄŸrafi Konum", "Yer Åžekilleri", "Ä°klim ve Bitki Ã–rtÃ¼sÃ¼", "NÃ¼fus ve YerleÅŸme", "TarÄ±m ve HayvancÄ±lÄ±k", "Madenler ve Enerji", "Sanayi ve Ticaret", "UlaÅŸÄ±m ve Turizm", "BÃ¶lgesel KalkÄ±nma" ],
            "VatandaÅŸlÄ±k": [ "Hukukun Temel KavramlarÄ±", "Anayasa Tarihi", "Temel Hak ve HÃ¼rriyetler", "Yasama", "YÃ¼rÃ¼tme", "YargÄ±", "Ä°dare Hukuku", "UluslararasÄ± KuruluÅŸlar", "GÃ¼ncel Bilgiler" ]
        };

        const STATUS_TYPES = {
            'not_started': { label: 'BaÅŸlamadÄ±', color: 'bg-slate-100 text-slate-500', icon: 'fa-circle' },
            'started': { label: 'Ã‡alÄ±ÅŸÄ±yorum', color: 'bg-yellow-100 text-yellow-700', icon: 'fa-person-digging' },
            'completed': { label: 'Bitti', color: 'bg-green-100 text-green-700', icon: 'fa-check-circle' },
            'needs_review': { label: 'Tekrar LazÄ±m', color: 'bg-red-100 text-red-700', icon: 'fa-rotate-right' }
        };

        const AVATAR_OPTIONS = [
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix", "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob", "https://api.dicebear.com/7.x/avataaars/svg?seed=Mia",
            "https://api.dicebear.com/7.x/notionists/svg?seed=Leo", "https://api.dicebear.com/7.x/notionists/svg?seed=Zoe",
            "https://api.dicebear.com/7.x/bottts/svg?seed=Robot1", "https://api.dicebear.com/7.x/bottts/svg?seed=Robot2"
        ];

        const ADMIN_EMAIL = "alnigamestudios@gmail.com";
        const IS_TEST_UNLOCKED = false; 

        // --- STATE ---
        let currentUser = null;
        let userData = null;
        let mockExamsHistory = [];
        let myQuestions = [];
        let myNotes = [];
        let myNotifications = [];
        let pomodoroInterval;
        let pomodoroTimeLeft = 25 * 60;
        let isTimerRunning = false;
        let unsubscribeNotifications = null;

        // --- AUTH & INIT (FIXED) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                if(user.email.toLowerCase() === ADMIN_EMAIL) document.getElementById('adminLink').classList.remove('hidden');
                
                try {
                    const docRef = doc(db, "users", user.uid);
                    const snap = await getDoc(docRef);
                    
                    if (snap.exists()) {
                        userData = snap.data();
                    } else {
                        // FORCE CREATE PROFILE FOR ADMIN/USER TO PREVENT CRASH
                        userData = { 
                            name: user.displayName || (user.email.split('@')[0]), 
                            email: user.email, 
                            progress: {}, 
                            targetScore: 85, 
                            title: (user.email.toLowerCase() === ADMIN_EMAIL ? "YÃ¶netici" : "Yeni Ãœye"), 
                            avatar: AVATAR_OPTIONS[0], 
                            pomodoroSessions: 0, 
                            totalScore: 0 
                        };
                        await setDoc(docRef, userData);
                    }
                    
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('appContainer').classList.remove('hidden');
                    updateSidebar();
                    
                    // Initial Loads
                    loadMocks();
                    loadMyQuestions();
                    loadMyNotes();
                    listenForNotificationBadge();
                    window.loadPage('dashboard');

                } catch (error) {
                    console.error("Auth Init Error:", error);
                    alert("GiriÅŸ sÄ±rasÄ±nda hata oluÅŸtu: " + error.message);
                }
            } else {
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
            }
        });

        // --- MOBILE MENU LOGIC ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            // Check if sidebar is currently closed (has -translate-x-full)
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
            }
        };

        // --- NAVIGATION LOGIC ---
        window.loadPage = (page) => {
            const content = document.getElementById('contentArea');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
            const activeBtn = document.getElementById('nav-' + page);
            if(activeBtn) activeBtn.classList.add('active-nav');
            
            // Auto close sidebar on mobile when navigating
            const sidebar = document.getElementById('mainSidebar');
            if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 768) {
                window.toggleSidebar();
            }

            // Admin Guard
            if(page === 'admin' && (!currentUser || currentUser.email.toLowerCase() !== ADMIN_EMAIL)) {
                content.innerHTML = '<div class="p-8 text-center text-red-500 font-bold">Yetkisiz EriÅŸim!</div>';
                return;
            }

            switch(page) {
                case 'dashboard': content.innerHTML = renderDashboard(); renderChart('dashboardChart'); break;
                case 'smartcoach': content.innerHTML = renderSmartCoachPage(); break;
                case 'subjects': content.innerHTML = renderSubjects(); break;
                case 'quiz': content.innerHTML = renderQuizCenter(); window.switchQuizTab('submit'); break;
                case 'mocks': content.innerHTML = renderMocks(); renderChart('historyChart'); break;
                case 'profile': content.innerHTML = renderProfile(); break;
                case 'admin': content.innerHTML = renderAdminPanel(); loadAdminData('questions'); break;
                case 'leaderboard': content.innerHTML = renderLeaderboard(); loadLeaderboardData(); break;
                case 'notes': content.innerHTML = renderNotes(); break;
                case 'cards': content.innerHTML = renderCards(); window.switchCardTab('submit'); break;
                case 'forum': content.innerHTML = renderForum(); loadForumPosts(); break;
                case 'feedback': content.innerHTML = renderFeedback(); break;
                case 'notifications': 
                    content.innerHTML = renderNotifications(); 
                    fetchNotifications(); 
                    break;
            }
        };

        // --- 1. DASHBOARD ---
        function renderDashboard() {
            const stats = calculateStats();
            return `
                <div class="mb-6 flex justify-between items-end">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800">Merhaba, ${userData.name} ðŸ‘‹</h1>
                        <p class="text-slate-500">BugÃ¼n kazanmak iÃ§in harika bir gÃ¼n!</p>
                    </div>
                </div>
                
                <div onclick="window.loadPage('smartcoach')" class="cursor-pointer bg-gradient-to-r from-purple-800 to-indigo-900 rounded-2xl p-6 text-white mb-8 relative shadow-xl transform transition hover:scale-[1.01]">
                    <div class="absolute right-4 top-4 bg-white/20 px-3 py-1 rounded-full text-xs font-bold">AI Raporu</div>
                    <div class="flex items-start gap-4">
                        <div class="bg-white/10 p-3 rounded-full animate-pulse"><i class="fa-solid fa-brain text-2xl"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-purple-200 mb-1">SmartCoach Ã–ngÃ¶rÃ¼sÃ¼</h3>
                            <p class="text-slate-100 text-sm italic">"${stats.shortAdvice}"</p>
                            <div class="mt-3 text-xs text-purple-300 font-semibold">DetaylÄ± analiz iÃ§in tÄ±kla &rarr;</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="text-sm text-slate-500">Genel Tamamlanma</div>
                        <div class="text-3xl font-bold text-slate-800">%${stats.totalProgress}</div>
                        <div class="w-full bg-slate-100 h-2 mt-2 rounded-full overflow-hidden"><div class="bg-primary h-2" style="width:${stats.totalProgress}%"></div></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="text-sm text-slate-500">Ã‡Ã¶zÃ¼len Deneme</div>
                        <div class="text-3xl font-bold text-primary">${mockExamsHistory.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="text-sm text-slate-500">Pomodoro SeansÄ±</div>
                        <div class="text-3xl font-bold text-green-600">${userData.pomodoroSessions || 0}</div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm h-80">
                    <h3 class="font-bold mb-4">Puan GrafiÄŸi</h3>
                    <canvas id="dashboardChart"></canvas>
                </div>
            `;
        }

        // --- 2. SMARTCOACH ---
        function renderSmartCoachPage() {
            const s = calculateStats();
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-10">
                        <div class="inline-block p-4 bg-purple-100 rounded-full mb-4"><i class="fa-solid fa-brain text-4xl text-purple-600"></i></div>
                        <h1 class="text-3xl font-bold text-slate-800">SmartCoach AI Analizi</h1>
                        <p class="text-slate-500">VeritabanÄ±ndaki tÃ¼m hareketlerin taranarak oluÅŸturulmuÅŸtur.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl border-l-4 border-blue-500 shadow-sm"><h3 class="font-bold text-slate-700 mb-2">Durum Tespiti</h3><p class="text-sm text-slate-600">${s.situationAnalysis}</p></div>
                        <div class="bg-white p-6 rounded-xl border-l-4 border-yellow-500 shadow-sm"><h3 class="font-bold text-slate-700 mb-2">Strateji Ã–nerisi</h3><p class="text-sm text-slate-600">${s.strategyAdvice}</p></div>
                        <div class="bg-white p-6 rounded-xl border-l-4 border-red-500 shadow-sm"><h3 class="font-bold text-slate-700 mb-2">ZayÄ±f Noktalar</h3><p class="text-sm text-slate-600">${s.weaknessAnalysis}</p></div>
                        <div class="bg-white p-6 rounded-xl border-l-4 border-green-500 shadow-sm"><h3 class="font-bold text-slate-700 mb-2">Motivasyon</h3><p class="text-sm text-slate-600">${s.motivationMsg}</p></div>
                    </div>
                </div>
            `;
        }

        // --- 3. SUBJECTS ---
        function renderSubjects() {
            let html = `<div class="grid grid-cols-1 gap-8 max-w-5xl mx-auto">`;
            for(let les in CURRICULUM) {
                let total = CURRICULUM[les].length;
                let done = 0;
                CURRICULUM[les].forEach(t => { if((userData.progress || {})[les+"_"+t] === 'completed') done++; });
                let pct = Math.round((done/total)*100);
                html += `<div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><div class="bg-slate-50 p-4 border-b border-slate-200 flex flex-col md:flex-row md:justify-between md:items-center gap-2"><h3 class="font-bold text-lg text-slate-800 border-l-4 border-primary pl-3">${les}</h3><div class="flex items-center gap-3 w-full md:w-1/3"><div class="flex-1 bg-white h-3 rounded-full border border-slate-200 overflow-hidden"><div class="bg-primary h-full transition-all duration-500" style="width: ${pct}%"></div></div><span class="text-xs font-bold text-slate-600 min-w-[3rem] text-right">%${pct}</span></div></div><div class="p-2 md:p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
                CURRICULUM[les].forEach(topic => {
                    const key = les + "_" + topic;
                    const status = (userData.progress || {})[key] || 'not_started';
                    const sInfo = STATUS_TYPES[status];
                    html += `<div class="flex items-center justify-between p-3 rounded-lg border border-slate-100 bg-white hover:shadow-md transition group"><span class="text-sm font-medium text-slate-700 truncate mr-2">${topic}</span><button onclick="window.cycleStatus('${key}')" class="text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 ${sInfo.color} status-btn min-w-[90px] justify-center"><i class="fa-solid ${sInfo.icon}"></i> ${sInfo.label}</button></div>`;
                });
                html += `</div></div>`;
            }
            return html + `</div>`;
        }

        // --- 4. LEADERBOARD (FIXED: CLIENT-SIDE SORTING) ---
        function renderLeaderboard() {
            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i>Liderlik Tablosu</h2>
                    <div class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                        <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 grid grid-cols-4 text-white font-bold text-sm">
                            <div class="col-span-2">KullanÄ±cÄ±</div>
                            <div class="text-center">Ãœnvan</div>
                            <div class="text-right">Tahmini Puan</div>
                        </div>
                        <div id="leaderboardList" class="divide-y divide-slate-100">
                            <div class="p-8 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadLeaderboardData() {
            // FIX: Removed 'orderBy' from Firestore query to avoid Index/Permission errors.
            // We fetch users and sort them in JavaScript instead.
            const q = query(collection(db, "users"), limit(50));
            
            try {
                const snap = await getDocs(q);
                let users = [];
                snap.forEach(doc => { users.push({ id: doc.id, ...doc.data() }); });
                
                // Client-side Sorting (Descending Order by TotalScore)
                users.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                
                let html = '';
                let rank = 1;
                
                users.forEach(u => {
                    const isMe = u.id === currentUser.uid;
                    const isAdmin = u.title === 'YÃ¶netici' || u.email === ADMIN_EMAIL;
                    
                    html += `
                        <div class="p-4 grid grid-cols-4 items-center ${isMe ? 'bg-orange-50' : ''}">
                            <div class="col-span-2 flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600">${rank++}</div>
                                <div class="flex items-center gap-2">
                                    <img src="${u.avatar}" class="w-6 h-6 rounded-full">
                                    <span class="font-medium ${isMe ? 'text-primary font-bold' : 'text-slate-700'}">
                                        ${u.name} ${isMe ? '(Sen)' : ''}
                                        ${isAdmin ? '<i class="fa-solid fa-shield-halved text-red-500 ml-1" title="YÃ¶netici"></i>' : ''}
                                    </span>
                                </div>
                            </div>
                            <div class="text-center flex justify-center">
                                ${isAdmin 
                                    ? '<span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold border border-red-200">YÃ–NETÄ°CÄ°</span>' 
                                    : `<span class="text-xs text-slate-500 bg-slate-100 rounded py-1 px-2">${u.title || '-'}</span>`
                                }
                            </div>
                            <div class="text-right font-bold text-slate-800">${u.totalScore || 0}</div>
                        </div>
                    `;
                });
                
                if(users.length === 0) html = '<div class="p-4 text-center text-slate-500">HenÃ¼z kayÄ±tlÄ± kullanÄ±cÄ± yok.</div>';
                
                document.getElementById('leaderboardList').innerHTML = html;
            } catch (error) {
                console.error("Leaderboard Error:", error);
                document.getElementById('leaderboardList').innerHTML = '<div class="p-4 text-center text-red-500">SÄ±ralama yÃ¼klenirken hata oluÅŸtu. (VeritabanÄ± eriÅŸim izni gerekebilir)</div>';
            }
        }

        // --- 5. FLASHCARDS ---
        function renderCards() {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex border-b border-slate-200 mb-6">
                        <button onclick="window.switchCardTab('browse')" id="tabCardBrowse" class="flex-1 py-4 text-center text-slate-500 font-medium hover:text-slate-700 transition">Kartlara GÃ¶z At</button>
                        <button onclick="window.switchCardTab('submit')" id="tabCardSubmit" class="flex-1 py-4 text-center text-slate-500 font-medium hover:text-slate-700 transition">Kart GÃ¶nder</button>
                    </div>

                    <div id="contentCardBrowse" class="hidden text-center py-10">
                        ${IS_TEST_UNLOCKED 
                            ? `<div id="liveCardsArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>` 
                            : `<div class="inline-block p-6 bg-slate-100 rounded-full mb-6"><i class="fa-solid fa-lock text-4xl text-slate-400"></i></div>
                               <h2 class="text-xl font-bold text-slate-800 mb-2">ModÃ¼l HazÄ±rlanÄ±yor</h2>
                               <p class="text-slate-500 max-w-md mx-auto">VeritabanÄ±mÄ±zda yeterli kart biriktiÄŸinde aÃ§Ä±lacaktÄ±r.</p>`
                        }
                    </div>

                    <div id="contentCardSubmit" class="hidden">
                         <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                            <h3 class="font-bold text-lg mb-4 text-slate-800">Kart Ã–nerisi GÃ¶nder</h3>
                            <div class="space-y-4">
                                <input id="cardFront" type="text" placeholder="Ã–n YÃ¼z (Soru/Kavram)" class="w-full p-3 border rounded-lg">
                                <input id="cardBack" type="text" placeholder="Arka YÃ¼z (Cevap/AÃ§Ä±klama)" class="w-full p-3 border rounded-lg">
                                <button onclick="window.submitCard()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">YÃ¶netici OnayÄ±na GÃ¶nder</button>
                            </div>
                        </div>
                        <div class="mt-8"><h3 class="font-bold text-md mb-4 text-slate-800">GÃ¶nderimlerin</h3><div id="myCardsList" class="space-y-3"></div></div>
                    </div>
                </div>
            `;
        }
        
        window.switchCardTab = (tab) => {
             document.getElementById('contentCardBrowse').classList.add('hidden');
             document.getElementById('contentCardSubmit').classList.add('hidden');
             document.getElementById('tabCardBrowse').classList.remove('tab-active');
             document.getElementById('tabCardSubmit').classList.remove('tab-active');
             
             if(tab === 'browse') {
                 document.getElementById('contentCardBrowse').classList.remove('hidden');
                 document.getElementById('tabCardBrowse').classList.add('tab-active');
                 if(IS_TEST_UNLOCKED) loadLiveCards();
             } else {
                 document.getElementById('contentCardSubmit').classList.remove('hidden');
                 document.getElementById('tabCardSubmit').classList.add('tab-active');
                 loadMyCardSubmissions();
             }
        };

        window.submitCard = async () => {
            const front = document.getElementById('cardFront').value;
            const back = document.getElementById('cardBack').value;
            if(!front || !back) return alert("Ä°ki yÃ¼zÃ¼ de doldurun.");
            await addDoc(collection(db, "flashcardSubmissions"), {
                uid: currentUser.uid, authorName: userData.name, front, back, status: 'pending', createdAt: serverTimestamp()
            });
            alert("Kart gÃ¶nderildi!");
            document.getElementById('cardFront').value = ""; document.getElementById('cardBack').value = "";
            loadMyCardSubmissions();
        };

        async function loadMyCardSubmissions() {
            const q = query(collection(db, "flashcardSubmissions"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const list = document.getElementById('myCardsList');
            if(list) {
                list.innerHTML = snap.docs.map(d => { const data=d.data(); return `
                    <div class="p-3 bg-white border rounded flex justify-between items-center">
                        <div><span class="font-bold">${data.front}</span> - ${data.back}</div>
                        <span class="text-xs px-2 py-1 rounded ${data.status==='approved'?'bg-green-100 text-green-700':(data.status==='rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700')}">${data.status}</span>
                    </div>`;
                }).join('');
            }
        }

        async function loadLiveCards() {
             const snap = await getDocs(collection(db, "flashcards"));
             document.getElementById('liveCardsArea').innerHTML = snap.docs.map(d => { const c=d.data(); return `
                <div class="flip-card h-48 w-full perspective cursor-pointer" onclick="this.classList.toggle('flipped')">
                    <div class="flip-card-inner relative w-full h-full shadow-md rounded-2xl bg-white border border-slate-200">
                        <div class="flip-card-front flex flex-col items-center justify-center p-4 text-center"><h3 class="font-bold text-slate-800 text-lg">${c.front}</h3></div>
                        <div class="flip-card-back flex flex-col items-center justify-center p-4 text-center bg-primary text-white rounded-2xl"><p class="font-bold text-xl">${c.back}</p></div>
                    </div>
                </div>`; 
             }).join('');
        }

        // --- 6. NOTES ---
        function renderNotes() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Not Defterim</h2>
                    <div class="mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <textarea id="newNoteText" class="w-full p-3 border border-slate-200 rounded-lg outline-none focus:border-primary h-24" placeholder="Yeni bir not al..."></textarea>
                        <button onclick="window.saveNote()" class="mt-2 bg-primary text-white px-6 py-2 rounded-lg font-bold hover:bg-primaryDark">Notu Kaydet</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="notesList">
                        ${myNotes.length === 0 ? '<p class="text-slate-500">HenÃ¼z notun yok.</p>' : ''}
                        ${myNotes.map(note => `
                            <div class="sticky-note p-6 relative group">
                                <p class="text-slate-800 font-handwriting">${note.text}</p>
                                <div class="absolute bottom-2 right-2 text-xs text-slate-500">${note.date}</div>
                                <button onclick="window.deleteNote('${note.id}')" class="absolute top-2 right-2 text-red-400 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- 7. FORUM MODULE ---
        function renderForum() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Ã–ÄŸrenci Forumu</h2>
                    
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-8">
                        <h3 class="font-bold mb-4">Yeni Konu BaÅŸlat</h3>
                        <div class="space-y-3">
                            <input id="forumTitle" type="text" placeholder="BaÅŸlÄ±k" class="w-full p-3 border rounded-lg">
                            <textarea id="forumContent" placeholder="MesajÄ±n..." class="w-full p-3 border rounded-lg" rows="3"></textarea>
                            <select id="forumCategory" class="p-3 border rounded-lg w-full bg-white">
                                <option>Genel Sohbet</option><option>Ders: TÃ¼rkÃ§e</option><option>Ders: Matematik</option><option>Ders: Tarih</option><option>Motivasyon</option>
                            </select>
                            <button onclick="window.submitForumPost()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold">GÃ¶nder (Onay Gerekli)</button>
                        </div>
                    </div>

                    <div id="forumFeed" class="space-y-4">
                        <div class="text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                    </div>
                </div>
            `;
        }

        window.submitForumPost = async () => {
            const title = document.getElementById('forumTitle').value;
            const content = document.getElementById('forumContent').value;
            const category = document.getElementById('forumCategory').value;
            if(!title || !content) return alert("Eksik alan var.");
            
            await addDoc(collection(db, "forumPosts"), {
                uid: currentUser.uid, 
                authorName: userData.name, 
                authorTitle: userData.title, // Save title for badge
                avatar: userData.avatar,
                title, content, category, status: 'pending', createdAt: serverTimestamp()
            });
            alert("Konu onaya gÃ¶nderildi.");
            document.getElementById('forumTitle').value = ""; document.getElementById('forumContent').value = "";
        }

        async function loadForumPosts() {
            const q = query(collection(db, "forumPosts"), where("status", "==", "approved"), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const isAdminUser = currentUser.email.toLowerCase() === ADMIN_EMAIL;
            
            document.getElementById('forumFeed').innerHTML = snap.docs.map(d => {
                const p = d.data();
                const isAuthorAdmin = p.authorTitle === 'YÃ¶netici';
                
                return `
                    <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm relative group">
                        <div class="flex items-center gap-3 mb-3">
                            <img src="${p.avatar}" class="w-10 h-10 rounded-full">
                            <div>
                                <div class="font-bold text-slate-800 flex items-center gap-2">
                                    ${p.authorName}
                                    ${isAuthorAdmin ? '<span class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-[9px] font-bold border border-red-200"><i class="fa-solid fa-shield-halved mr-1"></i>YÃ–NETÄ°CÄ°</span>' : ''}
                                </div>
                                <div class="text-xs text-slate-500">${p.category} â€¢ ${new Date(p.createdAt?.seconds*1000).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <h4 class="font-bold text-lg text-slate-900 mb-2">${p.title}</h4>
                        <p class="text-slate-600">${p.content}</p>
                        ${isAdminUser ? `<button onclick="window.deleteForumPost('${d.id}')" class="absolute top-4 right-4 text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                `;
            }).join('') || '<div class="text-center p-8 text-slate-500">HenÃ¼z konu yok.</div>';
        }
        
        window.deleteForumPost = async (id) => {
            if(confirm("Bu konuyu silmek istiyor musunuz?")) {
                await deleteDoc(doc(db, "forumPosts", id));
                loadForumPosts();
            }
        };

        // --- 8. FEEDBACK MODULE ---
        function renderFeedback() {
            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Ã–neri & Åžikayet Kutusu</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-lg border border-orange-100">
                        <div class="text-center mb-6"><i class="fa-solid fa-envelope-open-text text-6xl text-orange-200"></i></div>
                        <p class="text-center text-slate-600 mb-6">UygulamayÄ± geliÅŸtirmemiz iÃ§in fikirlerin bizim iÃ§in Ã§ok deÄŸerli. LÃ¼tfen aklÄ±na gelen her ÅŸeyi yaz.</p>
                        <textarea id="feedbackText" class="w-full p-4 border rounded-xl h-40 focus:border-primary outline-none" placeholder="MesajÄ±nÄ±z..."></textarea>
                        <button onclick="window.sendFeedback()" class="w-full mt-4 bg-primary text-white py-3 rounded-xl font-bold hover:bg-primaryDark transition">GÃ¶nder</button>
                    </div>
                </div>
            `;
        }

        window.sendFeedback = async () => {
            const txt = document.getElementById('feedbackText').value;
            if(!txt) return;
            await addDoc(collection(db, "feedback"), {
                uid: currentUser.uid, name: userData.name, message: txt, createdAt: serverTimestamp(), read: false
            });
            alert("MesajÄ±nÄ±z iletildi, teÅŸekkÃ¼rler!");
            document.getElementById('feedbackText').value = "";
        };

        // --- 9. NOTIFICATIONS MODULE ---
        function listenForNotificationBadge() {
            if(unsubscribeNotifications) unsubscribeNotifications();
            const q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), where("read", "==", false));
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                const badge = document.getElementById('notifBadge');
                const mobileBadge = document.getElementById('mobileNotifBadge');
                
                if(snap.size > 0) {
                    if(badge) { badge.innerText = snap.size; badge.classList.remove('hidden'); }
                    if(mobileBadge) { mobileBadge.innerText = snap.size; mobileBadge.classList.remove('hidden'); }
                } else {
                    if(badge) badge.classList.add('hidden');
                    if(mobileBadge) mobileBadge.classList.add('hidden');
                }
            });
        }

        function renderNotifications() {
            return `
                <div class="max-w-3xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Bildirimler</h2>
                    <div id="notifList" class="space-y-3">
                         <div class="text-center text-slate-400 mt-10"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                    </div>
                </div>
            `;
        }

        async function fetchNotifications() {
            let q;
            try {
                q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20));
                const snap = await getDocs(q);
                displayNotifications(snap);
            } catch (e) {
                console.log("Index missing, falling back to simple query", e);
                q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid));
                const snap = await getDocs(q);
                displayNotifications(snap);
            }

            const unreadQ = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), where("read", "==", false));
            const unreadSnap = await getDocs(unreadQ);
            unreadSnap.forEach(d => updateDoc(doc(db, "notifications", d.id), { read: true }));
        }

        function displayNotifications(snap) {
            const list = document.getElementById('notifList');
            if(!list) return;
            
            if(snap.empty) {
                list.innerHTML = '<div class="text-center text-slate-500 p-8">Bildirim yok.</div>';
                return;
            }

            let html = '';
            snap.forEach(d => {
                const n = d.data();
                html += `
                    <div class="p-4 bg-white border-l-4 ${n.type==='success'?'border-green-500':'border-red-500'} rounded shadow-sm">
                        <div class="font-medium text-slate-800">${n.message}</div>
                        <div class="text-xs text-slate-400 mt-1">${n.createdAt ? new Date(n.createdAt.seconds*1000).toLocaleString() : ''}</div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        // --- 10. QUIZ CENTER ---
        function renderQuizCenter() {
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="flex border-b border-slate-200 mb-6">
                        <button onclick="window.switchQuizTab('solve')" id="tabSolve" class="flex-1 py-4 text-center text-slate-500 font-medium hover:text-slate-700 transition">Test Ã‡Ã¶z</button>
                        <button onclick="window.switchQuizTab('submit')" id="tabSubmit" class="flex-1 py-4 text-center text-slate-500 font-medium hover:text-slate-700 transition">Soru GÃ¶nder</button>
                    </div>
                    <div id="contentSolve" class="hidden text-center py-10">
                        ${IS_TEST_UNLOCKED 
                            ? `<div id="liveQuestionsArea">Live Test Interface Here (Admin aÃ§tÄ±!)</div>`
                            : `<div class="inline-block p-6 bg-slate-100 rounded-full mb-6"><i class="fa-solid fa-lock text-4xl text-slate-400"></i></div>
                               <h2 class="text-xl font-bold text-slate-800 mb-2">ModÃ¼l HazÄ±rlanÄ±yor</h2>
                               <p class="text-slate-500 max-w-md mx-auto">Admin onayÄ±yla yeterli soru birikince aÃ§Ä±lacaktÄ±r.</p>`
                        }
                    </div>
                    <div id="contentSubmit" class="hidden">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 class="font-bold text-lg mb-4 text-slate-800">TopluluÄŸa KatkÄ±da Bulun</h3>
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ders</label><select id="qLesson" class="w-full p-3 border rounded-lg bg-white"><option>TÃ¼rkÃ§e</option><option>Matematik</option><option>Tarih</option><option>CoÄŸrafya</option><option>VatandaÅŸlÄ±k</option></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Soru Metni</label><textarea id="qText" rows="3" class="w-full p-3 border rounded-lg" placeholder="Soruyu buraya yazÄ±n..."></textarea></div>
                                <div class="grid grid-cols-2 gap-4"><input id="optA" type="text" placeholder="A ÅžÄ±kkÄ±" class="p-3 border rounded-lg"><input id="optB" type="text" placeholder="B ÅžÄ±kkÄ±" class="p-3 border rounded-lg"><input id="optC" type="text" placeholder="C ÅžÄ±kkÄ±" class="p-3 border rounded-lg"><input id="optD" type="text" placeholder="D ÅžÄ±kkÄ±" class="p-3 border rounded-lg"><input id="optE" type="text" placeholder="E ÅžÄ±kkÄ±" class="p-3 border rounded-lg"><select id="qCorrect" class="p-3 border rounded-lg bg-green-50 border-green-200"><option value="0">DoÄŸru Cevap: A</option><option value="1">DoÄŸru Cevap: B</option><option value="2">DoÄŸru Cevap: C</option><option value="3">DoÄŸru Cevap: D</option><option value="4">DoÄŸru Cevap: E</option></select></div>
                                <button onclick="window.submitQuestion()" class="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">YÃ¶netici OnayÄ±na GÃ¶nder</button>
                            </div>
                        </div>
                        <div class="mt-8"><h3 class="font-bold text-md mb-4 text-slate-800">GÃ¶nderdiÄŸin Sorular</h3><div id="myQuestionsList" class="space-y-3"></div></div>
                    </div>
                </div>
            `;
        }

        // --- 11. PROFILE ---
        function renderProfile() {
            const uName = userData?.name || '';
            const uTarget = userData?.targetScore || 85;
            const uAvatar = userData?.avatar || AVATAR_OPTIONS[0];

            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Profil AyarlarÄ±</h2>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mb-6">
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-700 mb-3">Avatar SeÃ§</label>
                            <div class="grid grid-cols-4 md:grid-cols-8 gap-2">
                                ${AVATAR_OPTIONS.map(url => `
                                    <img src="${url}" 
                                         onclick="window.updateProfileField('avatar', '${url}')"
                                         class="avatar-option w-12 h-12 rounded-full border-2 border-transparent cursor-pointer transition ${uAvatar === url ? 'selected' : ''}">
                                `).join('')}
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Ad Soyad</label><input type="text" onchange="window.updateProfileField('name', this.value)" value="${uName}" class="w-full p-3 border border-slate-200 rounded-lg focus:border-primary outline-none"></div>
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Hedef PuanÄ±n</label><input type="number" onchange="window.updateProfileField('targetScore', this.value)" value="${uTarget}" class="w-full p-3 border border-slate-200 rounded-lg focus:border-primary outline-none"></div>
                            <div class="text-sm text-slate-500 mt-4 flex items-center gap-2"><i class="fa-solid fa-file-contract"></i><span onclick="window.showPrivacyModal()" class="cursor-pointer hover:underline text-primary">Gizlilik PolitikasÄ±</span></div>
                            <hr class="border-slate-100 my-4">
                            <button onclick="alert('Åžifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± gÃ¶nderildi.')" class="w-full border border-slate-300 text-slate-600 font-medium py-3 rounded-lg hover:bg-slate-50 transition">Åžifre DeÄŸiÅŸtir</button>
                            <button onclick="window.deleteAccountRequest()" class="w-full border border-red-200 text-red-500 font-medium py-3 rounded-lg hover:bg-red-50 transition">HesabÄ±mÄ± Sil</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 12. ADMIN PANEL V2 ---
        function renderAdminPanel() {
            return `
                <div class="max-w-6xl mx-auto">
                    <h1 class="text-2xl font-bold mb-6 text-slate-800">YÃ¶netim Paneli</h1>
                    
                    <div class="flex gap-4 mb-6 overflow-x-auto pb-2">
                        <button onclick="window.loadAdminData('questions')" class="px-4 py-2 bg-white border rounded shadow-sm hover:bg-slate-50">Bekleyen Sorular</button>
                        <button onclick="window.loadAdminData('cards')" class="px-4 py-2 bg-white border rounded shadow-sm hover:bg-slate-50">Bekleyen Kartlar</button>
                        <button onclick="window.loadAdminData('forum')" class="px-4 py-2 bg-white border rounded shadow-sm hover:bg-slate-50">Bekleyen Forum</button>
                        <button onclick="window.loadAdminData('inbox')" class="px-4 py-2 bg-white border rounded shadow-sm hover:bg-slate-50">Gelen Kutusu</button>
                        <div class="w-px bg-slate-300 mx-2"></div>
                        <button onclick="window.loadAdminData('live_questions')" class="px-4 py-2 bg-red-50 border border-red-200 text-red-700 rounded shadow-sm">CanlÄ± Sorular</button>
                        <button onclick="window.loadAdminData('live_cards')" class="px-4 py-2 bg-red-50 border border-red-200 text-red-700 rounded shadow-sm">CanlÄ± Kartlar</button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="bg-slate-50 p-4 border-b border-slate-200 font-bold text-slate-600" id="adminPanelTitle">Veriler</div>
                        <div id="adminContentArea" class="divide-y divide-slate-100 min-h-[300px]">
                            <div class="p-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.loadAdminData = async (type) => {
            const container = document.getElementById('adminContentArea');
            container.innerHTML = '<div class="p-8 text-center text-slate-400">YÃ¼kleniyor...</div>';
            
            let html = '';
            
            if (type === 'questions') {
                const q = query(collection(db, "questionSubmissions"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if(snap.empty) html = '<div class="p-8 text-center">Bekleyen soru yok.</div>';
                else {
                      snap.forEach(doc => { const d=doc.data(); html += `
                        <div class="p-6">
                             <div class="flex justify-between mb-2"><span class="badge bg-blue-100 text-blue-800 px-2 rounded">${d.lesson}</span> <span class="text-xs text-slate-500">${d.authorName}</span></div>
                             <p class="font-bold mb-2">${d.text}</p>
                             <div class="grid grid-cols-2 text-sm gap-2 mb-4">${d.options.map((o,i)=>`<div class="${i===d.correct?'text-green-600 font-bold':''}">${String.fromCharCode(65+i)}) ${o}</div>`).join('')}</div>
                             <div class="flex gap-2"><button onclick="window.adminAction('question', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('question', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`; 
                      });
                }
            } else if (type === 'cards') {
                const q = query(collection(db, "flashcardSubmissions"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if(snap.empty) html = '<div class="p-8 text-center">Bekleyen kart yok.</div>';
                else {
                    snap.forEach(doc => { const d=doc.data(); html += `
                        <div class="p-6 flex justify-between items-center">
                            <div><div class="font-bold text-lg">${d.front}</div><div class="text-slate-600">${d.back}</div><div class="text-xs text-slate-400 mt-1">${d.authorName}</div></div>
                            <div class="flex gap-2"><button onclick="window.adminAction('card', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('card', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'forum') {
                const q = query(collection(db, "forumPosts"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if(snap.empty) html = '<div class="p-8 text-center">Bekleyen konu yok.</div>';
                else {
                    snap.forEach(doc => { const d=doc.data(); html += `
                        <div class="p-6">
                            <h4 class="font-bold text-lg">${d.title}</h4><p class="text-slate-600 mb-2">${d.content}</p><div class="text-xs text-slate-400 mb-2">${d.category} - ${d.authorName}</div>
                            <div class="flex gap-2"><button onclick="window.adminAction('forum', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('forum', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'inbox') {
                const q = query(collection(db, "feedback"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                snap.forEach(doc => { const d=doc.data(); html += `<div class="p-6"><div class="font-bold text-slate-800">${d.name}</div><p class="text-slate-600 mt-1">${d.message}</p><div class="text-xs text-slate-400 mt-2">${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : ''}</div></div>`; });
            } else if (type === 'live_questions') {
                const snap = await getDocs(collection(db, "questions"));
                snap.forEach(doc => { const d=doc.data(); html += `<div class="p-4 flex justify-between border-b items-center"><div><span class="font-bold">[${d.lesson}]</span> ${d.text}</div><button onclick="window.deleteLiveItem('questions', '${doc.id}')" class="text-red-500 hover:underline">Sil</button></div>`; });
            } else if (type === 'live_cards') {
                const snap = await getDocs(collection(db, "flashcards"));
                snap.forEach(doc => { const d=doc.data(); html += `<div class="p-4 flex justify-between border-b items-center"><div><span class="font-bold">${d.front}</span> = ${d.back}</div><button onclick="window.deleteLiveItem('flashcards', '${doc.id}')" class="text-red-500 hover:underline">Sil</button></div>`; });
            }

            container.innerHTML = html || '<div class="p-8 text-center">Veri yok.</div>';
        };

        window.adminAction = async (type, id, action) => {
            const collectionName = type === 'question' ? 'questionSubmissions' : (type === 'card' ? 'flashcardSubmissions' : 'forumPosts');
            const docRef = doc(db, collectionName, id);
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const notifMsg = `GÃ¶nderin (${type}) yÃ¶netici tarafÄ±ndan ${action === 'approve' ? 'onaylandÄ±' : 'reddedildi'}.`;
            await addDoc(collection(db, "notifications"), { uid: data.uid, message: notifMsg, type: action==='approve'?'success':'error', read: false, createdAt: serverTimestamp() });

            if (action === 'reject') {
                await updateDoc(docRef, { status: 'rejected' });
            } else {
                await updateDoc(docRef, { status: 'approved' });
                if(type === 'question') await addDoc(collection(db, "questions"), data);
                if(type === 'card') await addDoc(collection(db, "flashcards"), { front: data.front, back: data.back, lesson: 'General' });
            }
            alert("Ä°ÅŸlem tamam.");
            const activeType = type === 'question' ? 'questions' : (type === 'card' ? 'cards' : 'forum');
            loadAdminData(activeType);
        };
        
        window.deleteLiveItem = async (col, id) => {
            if(confirm("CanlÄ± veriyi silmek Ã¼zeresin!")) {
                await deleteDoc(doc(db, col, id));
                alert("Silindi.");
                loadAdminData(col === 'questions' ? 'live_questions' : 'live_cards');
            }
        };

        // --- 13. MOCKS MODULE (RESTORED) ---
        function renderMocks() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4">Yeni Deneme Ekle</h2>
                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500">TÃ¼rkÃ§e Net</label><input type="number" id="netTr" class="w-full p-2 border rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Matematik Net</label><input type="number" id="netMat" class="w-full p-2 border rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Tarih Net</label><input type="number" id="netHist" class="w-full p-2 border rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">CoÄŸrafya Net</label><input type="number" id="netGeo" class="w-full p-2 border rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">VatandaÅŸlÄ±k Net</label><input type="number" id="netCit" class="w-full p-2 border rounded outline-none focus:border-primary" placeholder="0"></div>
                            </div>
                            <button onclick="window.saveMockResult()" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primaryDark mt-4">Hesapla ve Kaydet</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4">SonuÃ§ GeÃ§miÅŸi</h2>
                        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden max-h-96 overflow-y-auto">
                            ${mockExamsHistory.length === 0 ? '<p class="p-4 text-slate-500">KayÄ±t yok.</p>' : ''}
                            ${mockExamsHistory.map(m => `
                                <div class="p-4 border-b border-slate-100 flex justify-between items-center hover:bg-slate-50">
                                    <div>
                                        <div class="font-bold text-slate-800">${m.date}</div>
                                        <div class="text-xs text-slate-500">TR: ${m.trNet} | MAT: ${m.mathNet} | TAR: ${m.histNet}</div>
                                    </div>
                                    <div class="text-xl font-bold text-primary">${m.totalScore} Puan</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-white p-6 rounded-2xl h-80 border border-slate-100 shadow-sm">
                    <h3 class="font-bold mb-4">Ä°lerleme Analizi</h3>
                    <canvas id="historyChart"></canvas>
                </div>
            `;
        }

        window.saveMockResult = async () => {
            const tr = Number(document.getElementById('netTr').value) || 0;
            const mat = Number(document.getElementById('netMat').value) || 0;
            const hist = Number(document.getElementById('netHist').value) || 0;
            const geo = Number(document.getElementById('netGeo').value) || 0;
            const cit = Number(document.getElementById('netCit').value) || 0;

            const gy = tr + mat;
            const gk = hist + geo + cit;
            let score = Math.round(55 + (gy * 0.4) + (gk * 0.4)); 
            
            // NEW RULE: Cap score at 100
            if(score > 100) score = 100;

            const data = {
                trNet: tr, mathNet: mat, histNet: hist, geoNet: geo, citNet: cit,
                totalScore: score,
                date: new Date().toLocaleDateString('tr-TR'),
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, `users/${currentUser.uid}/mockExams`), data);
            await updateDoc(doc(db, "users", currentUser.uid), { totalScore: score });
            
            alert(`PuanÄ±n: ${score}. Kaydedildi!`);
            window.loadPage('mocks');
        };

        async function loadMocks() {
            const q = query(collection(db, `users/${currentUser.uid}/mockExams`), orderBy("createdAt", "desc"), limit(10));
            onSnapshot(q, (s) => { 
                mockExamsHistory=[]; 
                s.forEach(d=>mockExamsHistory.push(d.data())); 
                // Auto refresh if looking at mocks or dashboard
                const content = document.getElementById('contentArea');
                if(content.innerHTML.includes('Yeni Deneme Ekle') || content.innerHTML.includes('Puan GrafiÄŸi')) {
                    // Slight hack to refresh charts without full page reload
                    const active = document.querySelector('.active-nav');
                    if(active) window.loadPage(active.id.replace('nav-', ''));
                }
            });
        }

        function renderChart(canvasId) {
            const ctx = document.getElementById(canvasId);
            if(!ctx || mockExamsHistory.length === 0) return;
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) existingChart.destroy();

            const labels = mockExamsHistory.slice().reverse().map(m => m.date);
            const data = mockExamsHistory.slice().reverse().map(m => m.totalScore);

            new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Puan', 
                        data: data, 
                        borderColor: '#f97316', 
                        backgroundColor: 'rgba(249, 115, 22, 0.1)', 
                        fill: true, 
                        tension: 0.4 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: false, min: 50, max: 100 } } 
                } 
            });
        }

        // --- GLOBAL WRAPPERS ---
        window.saveNote = async () => { const txt = document.getElementById('newNoteText').value; if(!txt) return; const noteData = { text: txt, createdAt: serverTimestamp() }; await addDoc(collection(db, `users/${currentUser.uid}/notes`), noteData); document.getElementById('newNoteText').value = ""; loadMyNotes(); };
        window.deleteNote = async (id) => { if(confirm("Sileyim mi?")) { await deleteDoc(doc(db, `users/${currentUser.uid}/notes/${id}`)); loadMyNotes(); } };
        window.toggleTimer = () => { if(isTimerRunning) { clearInterval(pomodoroInterval); isTimerRunning = false; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; } else { isTimerRunning = true; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-pause text-[10px]"></i>'; pomodoroInterval = setInterval(() => { pomodoroTimeLeft--; const m = Math.floor(pomodoroTimeLeft / 60).toString().padStart(2, '0'); const s = (pomodoroTimeLeft % 60).toString().padStart(2, '0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; if(pomodoroTimeLeft <= 0) { clearInterval(pomodoroInterval); isTimerRunning = false; alert("Pomodoro Bitti! +1 Puan"); savePomodoroSession(); pomodoroTimeLeft = 25 * 60; document.getElementById('timerDisplay').innerText = "25:00"; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; } }, 1000); } };
        window.resetTimer = () => { clearInterval(pomodoroInterval); isTimerRunning = false; pomodoroTimeLeft = 25 * 60; document.getElementById('timerDisplay').innerText = "25:00"; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; };
        async function savePomodoroSession() { const newCount = (userData.pomodoroSessions || 0) + 1; userData.pomodoroSessions = newCount; document.getElementById('pomodoroCount').innerText = newCount + " Seans"; await updateDoc(doc(db, "users", currentUser.uid), { pomodoroSessions: newCount }); }
        window.updateProfileField = async (key, value) => { userData[key] = value; updateSidebar(); if(key === 'avatar') window.loadPage('profile'); await updateDoc(doc(db, "users", currentUser.uid), { [key]: value }); };
        window.cycleStatus = async (key) => { if(!userData.progress) userData.progress = {}; const current = userData.progress[key] || 'not_started'; const order = ['not_started', 'started', 'completed', 'needs_review']; const next = order[(order.indexOf(current) + 1) % 4]; userData.progress[key] = next; window.loadPage('subjects'); await updateDoc(doc(db, "users", currentUser.uid), { progress: userData.progress }); };
        window.switchQuizTab = (tab) => { document.getElementById('contentSolve').classList.add('hidden'); document.getElementById('contentSubmit').classList.add('hidden'); document.getElementById('tabSolve').classList.remove('tab-active'); document.getElementById('tabSubmit').classList.remove('tab-active'); if(tab === 'solve') { document.getElementById('contentSolve').classList.remove('hidden'); document.getElementById('tabSolve').classList.add('tab-active'); if(IS_TEST_UNLOCKED) document.getElementById('liveQuestionsArea').innerText = "Testler burada listelenecek (VeritabanÄ± baÄŸlantÄ±sÄ± hazÄ±r)."; } else { document.getElementById('contentSubmit').classList.remove('hidden'); document.getElementById('tabSubmit').classList.add('tab-active'); loadMyQuestions(); } };
        window.submitQuestion = async () => { const text = document.getElementById('qText').value; const optA = document.getElementById('optA').value; if(!text || !optA) return alert("Soru ve en az bir ÅŸÄ±k girin."); const qData = { uid: currentUser.uid, authorName: userData.name, lesson: document.getElementById('qLesson').value, text: text, options: [ document.getElementById('optA').value, document.getElementById('optB').value, document.getElementById('optC').value, document.getElementById('optD').value, document.getElementById('optE').value ], correct: parseInt(document.getElementById('qCorrect').value), status: 'pending', adminNote: '', createdAt: serverTimestamp() }; await addDoc(collection(db, "questionSubmissions"), qData); alert("Sorun gÃ¶nderildi!"); document.getElementById('qText').value = ""; loadMyQuestions(); };
        async function loadMyQuestions() { if(!currentUser) return; const q = query(collection(db, "questionSubmissions"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc")); const snapshot = await getDocs(q); myQuestions = []; snapshot.forEach(doc => myQuestions.push({id: doc.id, ...doc.data()})); const list = document.getElementById('myQuestionsList'); if(list) list.innerHTML = myQuestions.map(mq => `<div class="p-4 bg-white rounded-lg border border-slate-100 flex justify-between items-start"><div><div class="text-xs font-bold text-slate-500 mb-1">${mq.lesson}</div><div class="text-sm font-medium text-slate-800 line-clamp-1">${mq.text}</div>${mq.status === 'rejected' ? `<div class="text-xs text-red-600 mt-2 bg-red-50 p-2 rounded"><strong>Red Sebebi:</strong> ${mq.adminNote}</div>` : ''}</div><div class="ml-4">${mq.status === 'pending' ? '<span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Bekliyor</span>' : ''}${mq.status === 'approved' ? '<span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">YayÄ±nda</span>' : ''}${mq.status === 'rejected' ? '<span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded">Red</span>' : ''}</div></div>`).join('') || '<p class="text-sm text-slate-400">HenÃ¼z soru gÃ¶ndermediniz.</p>'; }
        window.deleteAccountRequest = async () => { if(confirm("HesabÄ±nÄ± silmek istediÄŸine emin misin?")) { try { await deleteDoc(doc(db, "users", currentUser.uid)); await deleteUser(currentUser); alert("HesabÄ±nÄ±z silindi."); window.location.reload(); } catch(e) { alert("Hata: " + e.message); } } };
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } catch(e){alert(e.message)} };
        window.handleRegister = async () => { try { if(!document.getElementById('privacyCheck').checked) throw new Error("Onay gerekli"); const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPassword').value); await setDoc(doc(db, "users", cred.user.uid), {name: document.getElementById('regName').value, email: cred.user.email, progress: {}, targetScore: 85, createdAt: serverTimestamp(), avatar: AVATAR_OPTIONS[0], pomodoroSessions: 0, totalScore: 0 }); } catch(e){alert(e.message)} };
        
        // --- FIXED LOGOUT ---
        window.logout = async () => { 
            await signOut(auth);
            window.location.reload(); 
        };
        
        window.toggleAuth = (type) => { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('registerForm').classList.add('hidden'); document.getElementById(type === 'login' ? 'loginForm' : 'registerForm').classList.remove('hidden'); };
        window.showPrivacyModal = () => document.getElementById('privacyModal').classList.remove('hidden');
        window.closePrivacyModal = () => document.getElementById('privacyModal').classList.add('hidden');
        async function loadMyNotes() { const q = query(collection(db, `users/${currentUser.uid}/notes`), orderBy("createdAt", "desc")); const snap = await getDocs(q); myNotes = []; snap.forEach(d => myNotes.push({ id: d.id, text: d.data().text, date: new Date(d.data().createdAt?.seconds * 1000).toLocaleDateString() })); if(document.getElementById('nav-notes').classList.contains('active-nav')) window.loadPage('notes'); }
        function calculateStats() { let totalTopics = 0, completed = 0, started = 0; for(let les in CURRICULUM) { totalTopics += CURRICULUM[les].length; CURRICULUM[les].forEach(t => { const s = (userData.progress || {})[les+"_"+t]; if(s === 'completed') completed++; if(s === 'started') started++; }); } const totalProgress = Math.round((completed/totalTopics)*100) || 0; const avgScore = mockExamsHistory.length > 0 ? Math.round(mockExamsHistory.reduce((a,b)=>a+b.totalScore,0)/mockExamsHistory.length) : 0; let situation = "Veri giriÅŸi bekleniyor.", strategy = "Ã–nce konulara baÅŸla.", shortAdvice = "BaÅŸlamak bitirmenin yarÄ±sÄ±dÄ±r.", weakness = "Veri yok.", motivation = "Yolun baÅŸÄ±ndasÄ±n."; if(totalProgress < 10) { situation = "HenÃ¼z yolun baÅŸÄ±ndasÄ±n."; strategy = "Konulara yÃ¼klen."; shortAdvice = "Konu eksiÄŸin Ã§ok."; } else if(totalProgress < 50) { situation = "Orta seviye."; strategy = "Tekrarlara baÅŸla."; shortAdvice = "YarÄ±lamak Ã¼zeresin."; } else { situation = "Konular bitiyor."; strategy = "Deneme Ã§Ã¶z."; shortAdvice = "Deneme vakti!"; } if(mockExamsHistory.length > 0 && avgScore < 70) weakness = "Netlerin dÃ¼ÅŸÃ¼k."; else if(avgScore > 85) motivation = "Derece yapabilirsin!"; return { totalProgress, avgScore, completedCount: completed, startedCount: started, situationAnalysis: situation, strategyAdvice: strategy, weaknessAnalysis: weakness, motivationMsg: motivation, shortAdvice }; }
        function updateSidebar() { if(!userData) return; document.getElementById('sidebarName').innerText = userData.name; document.getElementById('sidebarAvatar').src = userData.avatar; document.getElementById('sidebarTitle').innerText = userData.title || 'Ã–ÄŸrenci'; document.getElementById('pomodoroCount').innerText = (userData.pomodoroSessions || 0) + " Seans"; document.getElementById('mobileAvatar').src = userData.avatar; }
    </script>
</body>
</html>
