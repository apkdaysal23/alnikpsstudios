<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al&Ni KPSS Studio | Al&Ni Studios</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1105930817107200" crossorigin="anonymous"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316', 
                        primaryDark: '#ea580c', 
                        secondary: '#fff7ed',
                        success: '#22c55e',
                        warning: '#eab308',
                        danger: '#ef4444',
                        studio: '#1e293b',
                        darkBg: '#0f172a', 
                        darkCard: '#1e293b', 
                        darkText: '#f1f5f9'  
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .status-btn { transition: all 0.2s; }
        .status-btn:active { transform: scale(0.95); }
        .nav-item.active-nav { background-color: #fff7ed; color: #f97316; border-right: 3px solid #f97316; font-weight: 600; }
        .dark .nav-item.active-nav { background-color: #334155; color: #fb923c; border-right: 3px solid #fb923c; }
        .avatar-option:hover { transform: scale(1.1); border-color: #f97316; }
        .avatar-option.selected { border-color: #f97316; ring: 2px solid #f97316; transform: scale(1.1); }
        .perspective { perspective: 1000px; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1rem; display: flex; align-items: center; justify-content: center; padding: 2rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .flip-card-back { background-color: #f97316; color: white; transform: rotateY(180deg); }
        .sticky-note { background: #fef3c7; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); border-bottom-right-radius: 20px; }
        .dark .sticky-note { background: #f59e0b; color: #000; }
        
        /* Bah√ße ve Program Stilleri */
        .garden-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 1rem; }
        .plant-slot { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.5); border-radius: 50%; transition: all 0.3s; position: relative; }
        .dark .plant-slot { background: rgba(30, 41, 59, 0.5); }
        .plant-slot:hover { transform: scale(1.1); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .plant-icon { font-size: 2rem; animation: growPlant 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes growPlant { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Akƒ±llƒ± Program Mobil Uyumu */
        .scheduler-container { display: flex; flex-direction: column; gap: 1rem; padding-bottom: 1rem; min-height: 500px; }
        @media (min-width: 1024px) {
            .scheduler-container { flex-direction: row; overflow-x: auto; }
        }
        
        .scheduler-col { min-width: 200px; flex: 1; background: #f8fafc; border-radius: 0.75rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .dark .scheduler-col { background: #1e293b; border-color: #334155; }
        .col-header { padding: 0.75rem; font-weight: bold; text-align: center; border-bottom: 1px solid #e2e8f0; background: #f1f5f9; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        .dark .col-header { background: #0f172a; border-color: #334155; color: #cbd5e1; }
        .col-body { padding: 0.5rem; flex: 1; min-height: 100px; }
        .col-body.drag-over { background-color: rgba(249, 115, 22, 0.1); border: 2px dashed #f97316; }
        
        #subjectSourceList.drag-over { background-color: rgba(239, 68, 68, 0.1); border: 2px dashed #ef4444; }

        .drag-item { background: white; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.8rem; cursor: grab; border: 1px solid transparent; transition: all 0.2s; }
        .dark .drag-item { background: #334155; color: #f1f5f9; }
        .drag-item:hover { border-color: #f97316; transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .drag-item.dragging { opacity: 0.5; transform: scale(0.95); }
        .countdown-item span { display: block; }

        /* Tab Active State */
        .tab-btn-active { 
            color: #f97316; 
            border-bottom: 2px solid #f97316; 
            background-color: rgba(249, 115, 22, 0.05);
        }
        
        /* ≈ûƒ±klar ve Kart Efektleri */
        .quiz-option { transition: all 0.2s; }
        .quiz-option:hover:not(:disabled) { transform: translateX(5px); border-color: #f97316; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body class="text-slate-800 bg-slate-50 dark:bg-darkBg dark:text-darkText h-screen overflow-hidden flex flex-col transition-colors duration-300">


    <div id="appContainer" class="hidden flex h-full relative">
        
        <div id="mobileOverlay" onclick="window.toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass-effect transition-opacity"></div>

        <aside id="mainSidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-darkCard border-r border-slate-200 dark:border-slate-700 flex flex-col justify-between transform -translate-x-full md:translate-x-0 transition-transform duration-300 md:static md:flex shrink-0 h-full shadow-2xl md:shadow-none transition-colors duration-300">
            
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-xl">A</div>
                        <div>
                            <h2 class="font-bold text-slate-800 dark:text-white leading-tight">Al&Ni KPSS</h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Ultimate Pro Max</p>
                        </div>
                    </div>
                    <button onclick="window.toggleSidebar()" class="md:hidden text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                
                <div class="p-4 bg-secondary dark:bg-slate-800 m-4 rounded-xl border border-orange-100 dark:border-slate-600 text-center shrink-0">
                    <img id="sidebarAvatar" src="" class="w-12 h-12 rounded-full mx-auto border-2 border-white dark:border-slate-700 shadow-sm mb-2 bg-white dark:bg-slate-600">
                    <div id="sidebarName" class="text-sm font-bold text-slate-800 dark:text-white">...</div>
                    <div class="flex justify-center items-center gap-2 mt-1">
                        <div id="sidebarTitle" class="text-xs text-primary font-semibold">...</div>
                        <div class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 px-1.5 py-0.5 rounded font-bold" title="XP Puanƒ±">
                            <i class="fa-solid fa-star text-[10px] mr-1"></i><span id="sidebarXP">0</span>
                        </div>
                    </div>
                </div>

                <nav class="px-4 space-y-1 text-sm mt-2 flex-1 overflow-y-auto pb-4">
                    <button id="nav-dashboard" onclick="window.loadPage('dashboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-chart-pie w-5"></i><span>Genel Bakƒ±≈ü</span></button>
                    <button id="nav-smartcoach" onclick="window.loadPage('smartcoach')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-brain w-5 text-purple-600"></i><span class="font-bold text-purple-700 dark:text-purple-400">SmartCoach AI</span></button>
                    
                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">VERƒ∞MLƒ∞Lƒ∞K</div>
                    <button id="nav-garden" onclick="window.loadPage('garden')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-seedling w-5 text-green-500"></i><span class="font-bold">Odak Bah√ßesi</span></button>
                    <button id="nav-scheduler" onclick="window.loadPage('scheduler')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-calendar-week w-5 text-indigo-500"></i><span>Akƒ±llƒ± Program</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">TOPLULUK</div>
                    <button id="nav-league" onclick="window.loadPage('league')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-trophy w-5 text-yellow-500"></i><span>Haftalƒ±k Lig</span></button>
                    <button id="nav-market" onclick="window.loadPage('market')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-shop w-5 text-pink-500"></i><span>Not Pazarƒ±</span></button>
                    <button id="nav-etut" onclick="window.loadPage('etut')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-users-viewfinder w-5 text-blue-500"></i><span class="font-bold">Sanal Et√ºt</span></button>
                    <button id="nav-forum" onclick="window.loadPage('forum')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-comments w-5"></i><span>Forum</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">√áALI≈ûMA</div>
                    <button id="nav-mistakes" onclick="window.loadPage('mistakes')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-triangle-exclamation w-5 text-red-500"></i><span>Hata Kutusu</span></button>
                    <button id="nav-subjects" onclick="window.loadPage('subjects')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-list-check w-5"></i><span>Konu Takip</span></button>
                    <button id="nav-quiz" onclick="window.loadPage('quiz')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-pen-nib w-5"></i><span>Soru Merkezi</span></button>
                    <button id="nav-cards" onclick="window.loadPage('cards')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-layer-group w-5"></i><span>Flashcards</span></button>
                    <button id="nav-mocks" onclick="window.loadPage('mocks')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-chart-line w-5"></i><span>Deneme & Analiz</span></button>
                    
                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">EKSTRA</div>
                    <button id="nav-leaderboard" onclick="window.loadPage('leaderboard')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-trophy w-5 text-yellow-600"></i><span>Genel Sƒ±ralama</span></button>
                    <button id="nav-notes" onclick="window.loadPage('notes')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-sticky-note w-5"></i><span>Not Defterim</span></button>
                    <button id="nav-feedback" onclick="window.loadPage('feedback')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-paper-plane w-5"></i><span>√ñneri / ≈ûikayet</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">Kƒ∞≈ûƒ∞SEL</div>
                    <button id="nav-notifications" onclick="window.loadPage('notifications')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition relative">
                        <i class="fa-solid fa-bell w-5"></i><span>Bildirimler</span>
                        <span id="notifBadge" class="hidden absolute top-2 right-4 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full border border-white dark:border-slate-800">0</span>
                    </button>
                    <button id="nav-profile" onclick="window.loadPage('profile')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i class="fa-solid fa-user-gear w-5"></i><span>Ayarlar</span></button>
                    
                    <button id="adminLink" onclick="window.loadPage('admin')" class="hidden nav-item w-full flex items-center space-x-3 px-4 py-3 text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-400 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition mt-4"><i class="fa-solid fa-shield-halved w-5"></i><span>Y√∂netim Paneli</span></button>
                </nav>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-4">
                 <div class="bg-slate-800 dark:bg-slate-700 rounded-xl p-3 text-white text-center mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-slate-400">POMODORO</span>
                        <span class="text-[10px] text-green-400" id="pomodoroCount">0 Seans</span>
                    </div>
                    <div id="timerDisplay" class="text-xl font-mono font-bold mb-2">25:00</div>
                    <div class="flex justify-center space-x-2">
                        <button onclick="window.toggleTimer()" id="timerBtn" class="w-6 h-6 rounded-full bg-primary hover:bg-primaryDark flex items-center justify-center"><i class="fa-solid fa-play text-[10px]"></i></button>
                        <button onclick="window.resetTimer()" class="w-6 h-6 rounded-full bg-slate-600 hover:bg-slate-500 flex items-center justify-center"><i class="fa-solid fa-rotate-right text-[10px]"></i></button>
                    </div>
                </div>
                
                <button onclick="window.toggleTheme()" class="w-full flex items-center justify-center space-x-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-orange-50 dark:hover:bg-slate-700 p-2 rounded-lg transition text-sm font-medium mb-2">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                    <span class="dark:hidden">Karanlƒ±k Mod</span>
                    <span class="hidden dark:inline">Aydƒ±nlƒ±k Mod</span>
                </button>

                <button onclick="window.logout()" class="w-full flex items-center justify-center space-x-2 text-slate-500 dark:text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-lg transition text-sm font-medium">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>√áƒ±kƒ±≈ü Yap</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50 dark:bg-darkBg transition-colors duration-300">
            <header class="md:hidden h-16 bg-white dark:bg-darkCard border-b dark:border-slate-700 flex items-center justify-between px-4 z-30 shrink-0 shadow-sm transition-colors duration-300">
                <div class="flex items-center space-x-3">
                    <button onclick="window.toggleSidebar()" class="text-slate-600 dark:text-slate-300 hover:text-primary transition p-2">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="font-bold text-primary text-lg">Al&Ni KPSS</div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="window.toggleTheme()" class="text-slate-500 dark:text-slate-300 p-2">
                         <i class="fa-solid fa-moon dark:hidden"></i>
                         <i class="fa-solid fa-sun hidden dark:inline"></i>
                    </button>
                    <button onclick="window.loadPage('notifications')" class="text-slate-500 dark:text-slate-300 relative">
                         <i class="fa-solid fa-bell"></i>
                         <span id="mobileNotifBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] w-3 h-3 flex items-center justify-center rounded-full">0</span>
                    </button>
                    <img id="mobileAvatar" src="" class="w-8 h-8 rounded-full border border-slate-200 dark:border-slate-600">
                </div>
            </header>
            
            <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 pb-32 relative"></div>
        </main>
    </div>

    <div id="privacyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white dark:bg-darkCard rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col mx-4 transition-colors duration-300">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Gizlilik Politikasƒ± ve Kullanƒ±m ≈ûartlarƒ±</h3>
                <button onclick="window.closePrivacyModal()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-600 dark:text-slate-300 space-y-4">
                <p><strong>1. Veri Toplama:</strong> Al&Ni KPSS Studio, ilerleme durumunuzu takip etmek i√ßin e-posta, √ßalƒ±≈üma istatistikleri ve hedef puan verilerini saklar.</p>
                <p><strong>2. G√ºvenlik:</strong> Verileriniz Firebase altyapƒ±sƒ±nda ≈üifrelenmi≈ü olarak saklanƒ±r. 3. ≈üahƒ±slarla payla≈üƒ±lmaz.</p>
                <p><strong>3. Hesap Silme:</strong> Kullanƒ±cƒ± dilediƒüi zaman profil ayarlarƒ±ndan "Hesabƒ±mƒ± Sil" talebinde bulunabilir.</p>
                <p><strong>4. Sorumluluk Reddi:</strong> Bu uygulama bir hazƒ±rlƒ±k aracƒ±dƒ±r.</p>
            </div>
            <div class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 rounded-b-xl flex justify-end">
                <button onclick="window.closePrivacyModal()" class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primaryDark">Anladƒ±m</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp, where, getDocs, deleteDoc, arrayUnion, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVVuIdQzbPZqWaMLtkV0mRjr5qHOng460",
            authDomain: "alnikpss.firebaseapp.com",
            projectId: "alnikpss",
            storageBucket: "alnikpss.firebasestorage.app",
            messagingSenderId: "546288972320",
            appId: "1:546288972320:web:997647b8542e41f28f8245",
            measurementId: "G-XGCG35CPFJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DARK MODE LOGIC ---
        window.initializeTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };
        
        window.toggleTheme = () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        };

        window.initializeTheme();

        // --- SLIDER LOGIC ---
        let currentSlide = 0;
        const totalSlides = 3;
        
        window.moveSlide = (n) => {
            currentSlide = (currentSlide + n + totalSlides) % totalSlides;
            const track = document.getElementById('sliderTrack');
            if(track) track.style.transform = `translateX(-${currentSlide * 100}%)`;
        };
        
        setInterval(() => { if(!currentUser) window.moveSlide(1); }, 5000);

        // --- CONSTANTS ---
        const CURRICULUM = {
            "T√ºrk√ße": [ "S√∂zc√ºkte Anlam", "C√ºmlede Anlam", "Paragrafta Anlam", "Noktalama ƒ∞≈üaretleri", "Yapƒ± Bilgisi", "Ses Bilgisi", "S√∂zc√ºk Bilgisi", "C√ºmle Bilgisi", "Yazƒ±m Kurallarƒ±", "Anlatƒ±m Bozukluklarƒ±", "S√∂zel Mantƒ±k" ],
            "Matematik": [ "Temel Kavramlar", "Sayƒ±lar", "B√∂lme-B√∂l√ºnebilme", "Asal √áarpanlar", "EBOB-EKOK", "1. Derece Denklemler", "Rasyonel Sayƒ±lar", "E≈üitsizlik", "Mutlak Deƒüer", "√úsl√º Sayƒ±lar", "K√∂kl√º Sayƒ±lar", "√áarpanlara Ayƒ±rma", "Oran-Orantƒ±", "Problemler", "K√ºmeler", "Fonksiyonlar", "Perm√ºtasyon-Kombinasyon", "Olasƒ±lƒ±k" ],
            "Tarih": [ "ƒ∞slamiyet √ñncesi T√ºrk Tarihi", "T√ºrk-ƒ∞slam Tarihi", "ƒ∞lk T√ºrk Devletleri", "Anadolu Sel√ßuklu", "Osmanlƒ± K√ºlt√ºr Medeniyet", "Osmanlƒ± Kurulu≈ü-Y√ºkselme", "Osmanlƒ± Duraklama-Gerileme", "Trablusgarp & Balkan Sava≈ülarƒ±", "I. D√ºnya Sava≈üƒ±", "Kurtulu≈ü Sava≈üƒ± Hazƒ±rlƒ±k", "Kurtulu≈ü Sava≈üƒ± Muharebeler", "Atat√ºrk ƒ∞lkeleri", "Dƒ±≈ü Politika", "√áaƒüda≈ü T√ºrk D√ºnyasƒ±" ],
            "Coƒürafya": [ "Coƒürafi Konum", "Yer ≈ûekilleri", "ƒ∞klim ve Bitki √ñrt√ºs√º", "N√ºfus ve Yerle≈üme", "Tarƒ±m ve Hayvancƒ±lƒ±k", "Madenler ve Enerji", "Sanayi ve Ticaret", "Ula≈üƒ±m ve Turizm", "B√∂lgesel Kalkƒ±nma" ],
            "Vatanda≈ülƒ±k": [ "Hukukun Temel Kavramlarƒ±", "Anayasa Tarihi", "Temel Hak ve H√ºrriyetler", "Yasama", "Y√ºr√ºtme", "Yargƒ±", "ƒ∞dare Hukuku", "Uluslararasƒ± Kurulu≈ülar", "G√ºncel Bilgiler" ]
        };

        const STATUS_TYPES = {
            'not_started': { label: 'Ba≈ülamadƒ±', color: 'bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-300', icon: 'fa-circle' },
            'started': { label: '√áalƒ±≈üƒ±yorum', color: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-200', icon: 'fa-person-digging' },
            'completed': { label: 'Bitti', color: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200', icon: 'fa-check-circle' },
            'needs_review': { label: 'Tekrar Lazƒ±m', color: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200', icon: 'fa-rotate-right' }
        };

        const AVATAR_OPTIONS = [
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix", "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob", "https://api.dicebear.com/7.x/avataaars/svg?seed=Mia",
            "https://api.dicebear.com/7.x/notionists/svg?seed=Leo", "https://api.dicebear.com/7.x/notionists/svg?seed=Zoe",
            "https://api.dicebear.com/7.x/bottts/svg?seed=Robot1", "https://api.dicebear.com/7.x/bottts/svg?seed=Robot2"
        ];

        const ADMIN_EMAIL = "alnigamestudios@gmail.com";
        const IS_TEST_UNLOCKED = true; // Kilitler kaldƒ±rƒ±ldƒ±

        // --- STATE ---
        let currentUser = null;
        let userData = null;
        let mockExamsHistory = [];
        let myQuestions = [];
        let myNotes = [];
        let myNotifications = [];
        let pomodoroInterval;
        let pomodoroTimeLeft = 25 * 60;
        let isTimerRunning = false;
        let unsubscribeNotifications = null;
        let countdownInterval;
        
        // Yeni Oyun Modu Deƒüi≈ükenleri
        let quizQuestionsPool = []; // √áekilen sorular havuzu
        let currentQuestion = null; // Ekranda g√∂sterilen soru objesi
        let flashcardsPool = []; // √áekilen kart havuzu
        let currentCard = null; // Ekranda g√∂sterilen kart objesi

        // --- AUTH & INIT ---
// app.html i√ßindeki onAuthStateChanged kƒ±smƒ±nƒ± bununla g√ºncelle
        onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        const ADMIN_EMAIL = "alnigamestudios@gmail.com";
        
        // --- 1. BAKIM MODU KONTROL√ú ---
        const maintenanceSnap = await getDoc(doc(db, "settings", "maintenance"));
        const isMaintenance = maintenanceSnap.exists() ? maintenanceSnap.data().active : false;
        
        if (isMaintenance && user.email.toLowerCase() !== ADMIN_EMAIL) {
            document.body.innerHTML = `
                <div style="height:100vh; background:#020617; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-family:sans-serif; text-align:center; padding:20px;">
                    <h1 style="color:#f97316; font-size:4rem;">‚ö†Ô∏è</h1>
                    <h2 style="font-size:2rem; font-weight:900;">≈ûU AN G√úNCELLEME YAPIYORUZ</h2>
                    <p style="color:#64748b; max-width:500px; margin-top:10px;">KPSS Studio'yu senin i√ßin daha g√º√ßl√º hale getirmek i√ßin kƒ±sa bir mola verdik. Birka√ß dakika sonra tekrar dene!</p>
                    <button onclick="location.reload()" style="margin-top:20px; background:#f97316; color:white; border:none; padding:12px 30px; border-radius:12px; font-weight:bold; cursor:pointer;">Tekrar Dene</button>
                </div>`;
            await signOut(auth);
            return;
        }

        // --- 2. KULLANICI VERƒ∞Sƒ∞ & BAN & AKTƒ∞FLƒ∞K ---
        const docRef = doc(db, "users", user.uid);
        const snap = await getDoc(docRef);

        if (snap.exists()) {
            userData = snap.data();

            if (userData.isBanned) {
                alert("√úzg√ºn√ºz, hesabƒ±nƒ±z kurallara aykƒ±rƒ± hareket nedeniyle engellenmi≈ütir.");
                await signOut(auth);
                window.location.href = './';
                return;
            }

            // AKTƒ∞FLƒ∞K G√úNCELLEME (Admin Paneli ƒ∞√ßin)
            await updateDoc(docRef, { lastLoginDate: serverTimestamp() });

            // Admin Butonu G√∂r√ºn√ºrl√ºƒü√º
            const adminBtn = document.getElementById('adminLink');
            if (user.email.toLowerCase() === ADMIN_EMAIL) {
                if(adminBtn) adminBtn.classList.remove('hidden');
            }

            document.getElementById('appContainer').classList.remove('hidden');
            updateSidebar();
            loadMocks();
            loadMyQuestions();
            loadMyNotes();
            listenForNotificationBadge();
            window.loadPage('dashboard');
            await checkStreak(docRef, userData);
        }
    } else {
        window.location.href = './';
    }
});
        // --- STREAK LOGIC (HATA KORUMALI) ---
        // --- STREAK LOGIC (D√úZELTƒ∞LDƒ∞: Takvim G√ºn√º Bazlƒ± Hesaplama) ---
        async function checkStreak(docRef, data) {
            const now = new Date();
            let lastLoginDate;

            // Veritabanƒ±ndan gelen tarihi al, yoksa ≈üu anƒ± kabul et
            if (data.lastLoginDate && typeof data.lastLoginDate.toDate === 'function') {
                lastLoginDate = data.lastLoginDate.toDate();
            } else if (data.lastLoginDate instanceof Date) {
                lastLoginDate = data.lastLoginDate;
            } else {
                lastLoginDate = new Date(); 
            }
            
            // Tarihleri "Saat/Dakika/Saniye"den arƒ±ndƒ±rƒ±p saf g√ºn haline getiriyoruz (Gece yarƒ±sƒ± 00:00:00)
            const todayReset = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const lastLoginReset = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate());

            // Milisaniye farkƒ±nƒ± al
            const diffTime = todayReset - lastLoginReset;
            // G√ºn farkƒ±na √ßevir (1 g√ºn = 86400000 ms)
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // Durum 1: Eƒüer fark 0 ise (Bug√ºn zaten girmi≈ü), hi√ßbir ≈üey yapma ve √ßƒ±k.
            if (diffDays === 0) return;

            let newStreak = data.streak || 0;

            // Durum 2: Eƒüer fark 1 ise (D√ºn girmi≈ü, bug√ºn de giriyor) -> Zinciri Artƒ±r
            if (diffDays === 1) {
                newStreak += 1;
            } 
            // Durum 3: Eƒüer fark 1'den b√ºy√ºkse (D√ºn girmemi≈ü, zincir kopmu≈ü) -> Zinciri 1'e Sƒ±fƒ±rla
            else if (diffDays > 1) {
                newStreak = 1; 
            }
            // (diffDays < 0 durumu teknik olarak imkansƒ±z ama olursa dokunma)

            // State g√ºncelle
            userData.streak = newStreak;
            
            // Veritabanƒ± g√ºncelle
            await updateDoc(docRef, { 
                lastLoginDate: serverTimestamp(),
                streak: newStreak
            });

            // Aray√ºz√º anlƒ±k g√ºncelle (Sayfa yenilemeye gerek kalmasƒ±n)
            updateSidebar();
            
            // Dashboard a√ßƒ±ksa oradaki sayƒ±yƒ± da g√ºncelle
            const dashboardStreak = document.querySelector('.fa-fire')?.nextElementSibling?.querySelector('.font-bold');
            if(dashboardStreak) dashboardStreak.innerText = newStreak + " G√ºn";
        }

        // --- MOBILE MENU LOGIC ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('mobileOverlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
            }
        };

        // --- NAVIGATION LOGIC ---
        window.loadPage = (page) => {
    const content = document.getElementById('contentArea');
    const ADMIN_EMAIL = "alnigamestudios@gmail.com"; // Admin mailin

    // Admin sayfasƒ± korumasƒ±
    if (page === 'admin') {
        if (!currentUser || currentUser.email.toLowerCase() !== ADMIN_EMAIL) {
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-8">
                    <i class="fa-solid fa-shield-slash text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Yetkisiz Eri≈üim!</h2>
                    <p class="text-slate-500 mt-2">Bu alana sadece Al&Ni y√∂neticileri girebilir.</p>
                </div>`;
            return;
        }
    }

            if(countdownInterval) clearInterval(countdownInterval);

            // Mod√ºl ge√ßi≈ülerinde temizlik
            currentQuestion = null;
            currentCard = null;

            switch(page) {
                case 'dashboard': content.innerHTML = renderDashboard(); renderChart('dashboardChart'); startCountdown(); break;
                case 'smartcoach': content.innerHTML = renderSmartCoachPage(); break;
                case 'subjects': content.innerHTML = renderSubjects(); break;
                case 'quiz': content.innerHTML = renderQuizCenter(); window.switchQuizTab('solve'); break; 
                case 'mocks': content.innerHTML = renderMocks(); renderChart('historyChart'); break;
                case 'profile': content.innerHTML = renderProfile(); break;
                case 'admin': content.innerHTML = renderAdminPanel(); loadAdminData('questions'); break;
                case 'leaderboard': content.innerHTML = renderLeaderboard(); loadLeaderboardData(); break;
                case 'notes': content.innerHTML = renderNotes(); break;
                case 'cards': content.innerHTML = renderCards(); window.switchCardTab('browse'); break; 
                case 'forum': content.innerHTML = renderForum(); loadForumPosts(); break;
                case 'feedback': content.innerHTML = renderFeedback(); break;
                case 'etut': content.innerHTML = renderEtut(); loadEtutQuestions(); break;
                case 'mistakes': content.innerHTML = renderMistakes(); loadMistakes(); break;
                case 'garden': content.innerHTML = renderGarden(); loadGarden(); break; 
                case 'scheduler': content.innerHTML = renderScheduler(); loadScheduler(); break; 
                case 'league': content.innerHTML = renderLeague(); loadLeagueData(); break;
                case 'market': content.innerHTML = renderMarket(); window.switchMarketTab('browse'); break; 
                case 'notifications': 
                    content.innerHTML = renderNotifications(); 
                    fetchNotifications(); 
                    break;
            }
        };

        // --- 1. DASHBOARD ---
        function renderDashboard() {
            const stats = calculateStats();
            const xp = userData.xp || 0;
            const streak = userData.streak || 1;
            const level = Math.floor(xp / 100) + 1;

            return `
                <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Merhaba, ${userData.name} üëã</h1>
                        <p class="text-slate-500 dark:text-slate-400">Bug√ºn kazanmak i√ßin harika bir g√ºn!</p>
                    </div>
                    <div class="flex items-center gap-3">
                         <div class="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-fire text-orange-500 animate-pulse"></i>
                            <div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Zincir</div>
                                <div class="font-bold text-slate-800 dark:text-white leading-none">${streak} G√ºn</div>
                            </div>
                         </div>
                         <div class="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-star text-yellow-500"></i>
                            <div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Seviye ${level}</div>
                                <div class="font-bold text-slate-800 dark:text-white leading-none">${xp} XP</div>
                            </div>
                         </div>
                    </div>
                </div>
                
                <div class="bg-slate-900 text-white rounded-2xl p-6 mb-8 relative shadow-xl overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 opacity-20 group-hover:opacity-30 transition"></div>
                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="text-center md:text-left">
                            <h3 class="text-lg font-bold text-blue-200 uppercase tracking-widest mb-1">B√ºy√ºk Sƒ±nav</h3>
                            <div class="text-3xl md:text-4xl font-bold">04 Ekim 2026</div>
                            <p class="text-blue-200/60 text-sm">Hayallerine giden yol.</p>
                        </div>
                        <div class="flex gap-3 md:gap-6 text-center" id="countdownTimer">
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdDays">00</span><span class="text-[10px] uppercase opacity-70">G√ºn</span></div>
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdHours">00</span><span class="text-[10px] uppercase opacity-70">Saat</span></div>
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdMins">00</span><span class="text-[10px] uppercase opacity-70">Dk</span></div>
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdSecs">00</span><span class="text-[10px] uppercase opacity-70">Sn</span></div>
                        </div>
                    </div>
                </div>

                <div onclick="window.loadPage('smartcoach')" class="cursor-pointer bg-gradient-to-r from-purple-800 to-indigo-900 rounded-2xl p-6 text-white mb-8 relative shadow-xl transform transition hover:scale-[1.01]">
                    <div class="absolute right-4 top-4 bg-white/20 px-3 py-1 rounded-full text-xs font-bold">AI Raporu</div>
                    <div class="flex items-start gap-4">
                        <div class="bg-white/10 p-3 rounded-full animate-pulse"><i class="fa-solid fa-brain text-2xl"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-purple-200 mb-1">SmartCoach √ñng√∂r√ºs√º</h3>
                            <p class="text-slate-100 text-sm italic">"${stats.shortAdvice}"</p>
                            <div class="mt-3 text-xs text-purple-300 font-semibold">Detaylƒ± analiz i√ßin tƒ±kla &rarr;</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-sm text-slate-500 dark:text-slate-400">Genel Tamamlanma</div>
                        <div class="text-3xl font-bold text-slate-800 dark:text-white">%${stats.totalProgress}</div>
                        <div class="w-full bg-slate-100 dark:bg-slate-700 h-2 mt-2 rounded-full overflow-hidden"><div class="bg-primary h-2" style="width:${stats.totalProgress}%"></div></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-sm text-slate-500 dark:text-slate-400">√á√∂z√ºlen Deneme</div>
                        <div class="text-3xl font-bold text-primary">${mockExamsHistory.length}</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-sm text-slate-500 dark:text-slate-400">Pomodoro Seansƒ±</div>
                        <div class="text-3xl font-bold text-green-600 dark:text-green-400">${userData.pomodoroSessions || 0}</div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm h-80">
                    <h3 class="font-bold mb-4 dark:text-white">Puan Grafiƒüi</h3>
                    <canvas id="dashboardChart"></canvas>
                </div>
            `;
        }

        function startCountdown() {
            const targetDate = new Date("2026-10-04T00:00:00").getTime();
            const update = () => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                if (distance < 0) {
                    if(document.getElementById("countdownTimer")) document.getElementById("countdownTimer").innerHTML = "SINAV G√úN√ú!";
                    clearInterval(countdownInterval);
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                if(document.getElementById("cdDays")) {
                    document.getElementById("cdDays").innerText = days;
                    document.getElementById("cdHours").innerText = hours.toString().padStart(2, '0');
                    document.getElementById("cdMins").innerText = minutes.toString().padStart(2, '0');
                    document.getElementById("cdSecs").innerText = seconds.toString().padStart(2, '0');
                }
            };
            update();
            countdownInterval = setInterval(update, 1000);
        }

        // --- 2. SMARTCOACH (MEVCUT) ---
        function renderSmartCoachPage() {
            const s = calculateStats();
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-10">
                        <div class="inline-block p-4 bg-purple-100 dark:bg-purple-900 rounded-full mb-4"><i class="fa-solid fa-brain text-4xl text-purple-600 dark:text-purple-300"></i></div>
                        <h1 class="text-3xl font-bold text-slate-800 dark:text-white">SmartCoach AI Analizi</h1>
                        <p class="text-slate-500 dark:text-slate-400">Veritabanƒ±ndaki t√ºm hareketlerin taranarak olu≈üturulmu≈ütur.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border-l-4 border-blue-500 shadow-sm"><h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2">Durum Tespiti</h3><p class="text-sm text-slate-600 dark:text-slate-400">${s.situationAnalysis}</p></div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border-l-4 border-yellow-500 shadow-sm"><h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2">Strateji √ñnerisi</h3><p class="text-sm text-slate-600 dark:text-slate-400">${s.strategyAdvice}</p></div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border-l-4 border-red-500 shadow-sm"><h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2">Zayƒ±f Noktalar</h3><p class="text-sm text-slate-600 dark:text-slate-400">${s.weaknessAnalysis}</p></div>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border-l-4 border-green-500 shadow-sm"><h3 class="font-bold text-slate-700 dark:text-slate-200 mb-2">Motivasyon</h3><p class="text-sm text-slate-600 dark:text-slate-400">${s.motivationMsg}</p></div>
                    </div>
                </div>
            `;
        }

        // --- 3. SUBJECTS (MEVCUT) ---
        function renderSubjects() {
            let html = `<div class="grid grid-cols-1 gap-8 max-w-5xl mx-auto">`;
            for(let les in CURRICULUM) {
                let total = CURRICULUM[les].length;
                let done = 0;
                CURRICULUM[les].forEach(t => { if((userData.progress || {})[les+"_"+t] === 'completed') done++; });
                let pct = Math.round((done/total)*100);
                html += `<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"><div class="bg-slate-50 dark:bg-slate-700 p-4 border-b border-slate-200 dark:border-slate-600 flex flex-col md:flex-row md:justify-between md:items-center gap-2"><h3 class="font-bold text-lg text-slate-800 dark:text-white border-l-4 border-primary pl-3">${les}</h3><div class="flex items-center gap-3 w-full md:w-1/3"><div class="flex-1 bg-white dark:bg-slate-600 h-3 rounded-full border border-slate-200 dark:border-slate-500 overflow-hidden"><div class="bg-primary h-full transition-all duration-500" style="width: ${pct}%"></div></div><span class="text-xs font-bold text-slate-600 dark:text-slate-300 min-w-[3rem] text-right">%${pct}</span></div></div><div class="p-2 md:p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
                CURRICULUM[les].forEach(topic => {
                    const key = les + "_" + topic;
                    const status = (userData.progress || {})[key] || 'not_started';
                    const sInfo = STATUS_TYPES[status];
                    html += `<div class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 hover:shadow-md transition group"><span class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate mr-2">${topic}</span><button onclick="window.cycleStatus('${key}')" class="text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 ${sInfo.color} status-btn min-w-[90px] justify-center"><i class="fa-solid ${sInfo.icon}"></i> ${sInfo.label}</button></div>`;
                });
                html += `</div></div>`;
            }
            return html + `</div>`;
        }

        // --- 4. LEADERBOARD (MEVCUT) ---
        function renderLeaderboard() {
            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 text-center"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i>Liderlik Tablosu</h2>
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 grid grid-cols-5 text-white font-bold text-sm">
                            <div class="col-span-2">Kullanƒ±cƒ±</div>
                            <div class="text-center">√únvan</div>
                            <div class="text-center">XP</div>
                            <div class="text-right">Tahmini Puan</div>
                        </div>
                        <div id="leaderboardList" class="divide-y divide-slate-100 dark:divide-slate-700">
                            <div class="p-8 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadLeaderboardData() {
            const q = query(collection(db, "users"), limit(50));
            try {
                const snap = await getDocs(q);
                let users = [];
                snap.forEach(doc => { users.push({ id: doc.id, ...doc.data() }); });
                
                users.sort((a, b) => {
                    const scoreDiff = (b.totalScore || 0) - (a.totalScore || 0);
                    if(scoreDiff !== 0) return scoreDiff;
                    
                    const xpDiff = (b.xp || 0) - (a.xp || 0);
                    if(xpDiff !== 0) return xpDiff;
                    
                    return (a.name || "").localeCompare(b.name || "");
                });
                
                let html = '';
                let rank = 1;
                
                users.forEach(u => {
                    const isMe = u.id === currentUser.uid;
                    const isAdmin = u.title === 'Y√∂netici' || u.email === ADMIN_EMAIL;
                    
                    html += `
                        <div class="p-4 grid grid-cols-5 items-center ${isMe ? 'bg-orange-50 dark:bg-orange-900/20' : ''}">
                            <div class="col-span-2 flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center font-bold text-slate-600 dark:text-slate-300">${rank++}</div>
                                <div class="flex items-center gap-2">
                                    <img src="${u.avatar}" class="w-6 h-6 rounded-full">
                                    <span class="font-medium ${isMe ? 'text-primary font-bold' : 'text-slate-700 dark:text-slate-300'}">
                                        ${u.name} ${isMe ? '(Sen)' : ''}
                                        ${isAdmin ? '<i class="fa-solid fa-shield-halved text-red-500 ml-1" title="Y√∂netici"></i>' : ''}
                                    </span>
                                </div>
                            </div>
                            <div class="text-center flex justify-center">
                                ${isAdmin 
                                    ? '<span class="bg-red-100 text-red-600 px-2 py-0.5 rounded text-[10px] font-bold border border-red-200">Y√ñNETƒ∞Cƒ∞</span>' 
                                    : `<span class="text-xs text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 rounded py-1 px-2">${u.title || '-'}</span>`
                                }
                            </div>
                            <div class="text-center font-bold text-purple-600 dark:text-purple-400 text-xs">${u.xp || 0} XP</div>
                            <div class="text-right font-bold text-slate-800 dark:text-white">${u.totalScore || 0}</div>
                        </div>
                    `;
                });
                
                if(users.length === 0) html = '<div class="p-4 text-center text-slate-500">Hen√ºz kayƒ±tlƒ± kullanƒ±cƒ± yok.</div>';
                document.getElementById('leaderboardList').innerHTML = html;
            } catch (error) {
                console.error("Leaderboard Error:", error);
                document.getElementById('leaderboardList').innerHTML = '<div class="p-4 text-center text-red-500">Sƒ±ralama y√ºklenirken hata olu≈ütu.</div>';
            }
        }

        // --- 5. ODAK BAH√áESƒ∞ ---
        function renderGarden() {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-seedling text-green-500 mr-2"></i>Odak Bah√ßesi</h2>
                        <p class="text-slate-500 dark:text-slate-400">Tamamladƒ±ƒüƒ±n her Pomodoro i√ßin bir bitki kazanƒ±rsƒ±n.</p>
                    </div>
                    
                    <div class="bg-gradient-to-b from-blue-200 to-green-100 dark:from-slate-800 dark:to-slate-900 p-8 rounded-3xl shadow-xl min-h-[400px] border border-white/50 dark:border-slate-700 relative overflow-hidden">
                        <div class="absolute top-[-50px] right-[-50px] w-32 h-32 bg-yellow-300 rounded-full blur-2xl opacity-50"></div>
                        <div id="gardenGrid" class="garden-grid">
                            <div class="text-center w-full col-span-full py-20 text-slate-500 dark:text-slate-400">
                                <i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>Bah√ßen sulanƒ±yor...
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-center gap-4 text-sm font-bold text-slate-600 dark:text-slate-300">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-tree text-green-700"></i> Toplam: <span id="totalPlants">0</span></div>
                        <div class="flex items-center gap-2"><i class="fa-solid fa-droplet text-blue-500"></i> Seviye: <span id="gardenLevel">1</span></div>
                    </div>
                </div>
            `;
        }

        async function loadGarden() {
            const count = userData.pomodoroSessions || 0;
            const grid = document.getElementById('gardenGrid');
            if(!grid) return;

            if (count === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-500 italic mt-20">Hen√ºz hi√ß bitkin yok. Pomodoro sayacƒ±nƒ± ba≈ülat ve odaklan!</div>';
                document.getElementById('totalPlants').innerText = 0;
                return;
            }

            let html = '';
            const plants = ['üåª', 'üå≤', 'üåµ', 'üå¥', 'üå∑', 'üçÑ', 'üå∏', 'üåπ', 'üåæ', 'ü™¥'];
            for(let i=0; i<count; i++) {
                const plantIcon = plants[i % plants.length]; 
                html += `<div class="plant-slot" title="Seans #${i+1}"><div class="plant-icon">${plantIcon}</div></div>`;
            }

            grid.innerHTML = html;
            document.getElementById('totalPlants').innerText = count;
            document.getElementById('gardenLevel').innerText = Math.floor(count / 10) + 1;
        }

        // --- 6. AKILLI DERS PROGRAMI (MOBƒ∞L UYUMLU & GERƒ∞ ALMA) ---
        function renderScheduler() {
            const days = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
            return `
                <div class="h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-calendar-week text-indigo-500 mr-2"></i>Akƒ±llƒ± Program</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">Konularƒ± g√ºnlerin √ºzerine s√ºr√ºkle. ƒ∞ptal etmek i√ßin listeye geri s√ºr√ºkle.</p>
                        </div>
                        <button onclick="window.saveSchedule()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow-md transition"><i class="fa-solid fa-save mr-2"></i>Kaydet</button>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-6 h-full overflow-hidden">
                        <div class="w-full lg:w-64 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col shrink-0 max-h-[300px] lg:max-h-full">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 bg-slate-50 dark:bg-slate-900 rounded-t-xl">
                                Ders Konularƒ±
                            </div>
                            <div class="p-2 overflow-y-auto flex-1 subject-source col-body" id="subjectSourceList" ondrop="window.drop(event)" ondragover="window.allowDrop(event)">
                                </div>
                        </div>

                        <div class="flex-1 overflow-x-auto pb-4">
                            <div class="scheduler-container" id="schedulerContainer">
                                ${days.map(day => `
                                    <div class="scheduler-col">
                                        <div class="col-header">${day}</div>
                                        <div class="col-body" id="col-${day}" ondrop="window.drop(event)" ondragover="window.allowDrop(event)">
                                            </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadScheduler() {
            const sourceList = document.getElementById('subjectSourceList');
            if(!sourceList) return;
            
            let sourceHtml = '';
            for(let lesson in CURRICULUM) {
                sourceHtml += `<div class="text-xs font-bold text-slate-400 uppercase mt-3 mb-1 px-2 no-drag pointer-events-none select-none" data-lesson="${lesson}">${lesson}</div>`;
                
                CURRICULUM[lesson].forEach((topic, idx) => {
                    const id = `drag-${lesson}-${idx}`.replace(/\s+/g, '');
                    sourceHtml += `
                        <div class="drag-item" id="${id}" draggable="true" ondragstart="window.drag(event)" data-lesson="${lesson}">
                            ${topic}
                        </div>
                    `;
                });
            }
            sourceList.innerHTML = sourceHtml;

            try {
                const docRef = doc(db, `users/${currentUser.uid}/scheduler/weekly`);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    for (const [day, items] of Object.entries(data)) {
                        const col = document.getElementById(`col-${day}`);
                        if (col && Array.isArray(items)) {
                            items.forEach(itemId => {
                                const original = document.getElementById(itemId);
                                if (original) {
                                    col.appendChild(original);
                                }
                            });
                        }
                    }
                }
            } catch (e) {
                console.error("Scheduler Load Error:", e);
            }
        }

        window.allowDrop = (ev) => {
            ev.preventDefault();
            if(!ev.target.classList.contains('no-drag')) {
                ev.currentTarget.classList.add('drag-over');
            }
        };

        window.drag = (ev) => {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.classList.add('dragging');
        };

        window.drop = (ev) => {
            ev.preventDefault();
            let targetCol = ev.target;
            while (targetCol && !targetCol.classList.contains('col-body')) {
                targetCol = targetCol.parentElement;
            }
            if (!targetCol) return;
            targetCol.classList.remove('drag-over');

            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                if (targetCol.id === 'subjectSourceList') {
                    const lessonName = draggedElement.getAttribute('data-lesson');
                    const header = targetCol.querySelector(`.no-drag[data-lesson='${lessonName}']`);
                    if (header) {
                        if(header.nextSibling) targetCol.insertBefore(draggedElement, header.nextSibling);
                        else targetCol.appendChild(draggedElement);
                        return; 
                    }
                }
                targetCol.appendChild(draggedElement);
            }
        };

        window.saveSchedule = async () => {
            const days = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let scheduleData = {};
            days.forEach(day => {
                const col = document.getElementById(`col-${day}`);
                if(col) {
                    const items = col.querySelectorAll('.drag-item');
                    let itemIds = [];
                    items.forEach(item => itemIds.push(item.id));
                    scheduleData[day] = itemIds;
                }
            });
            try {
                await setDoc(doc(db, `users/${currentUser.uid}/scheduler/weekly`), scheduleData);
                alert("Program kaydedildi!");
            } catch (e) {
                console.error(e);
                alert("Kaydederken hata olu≈ütu.");
            }
        };
        // --- 7. HAFTALIK Lƒ∞G Sƒ∞STEMƒ∞ ---
        function renderLeague() {
            const league = userData.currentLeague || "Bronz";
            return `
                <div class="max-w-2xl mx-auto">
                    <div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-8 text-white mb-8 text-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <h2 class="text-3xl font-bold mb-2 uppercase tracking-wide">${league} Ligi</h2>
                        <p class="text-blue-200 text-sm mb-6">Haftalƒ±k sƒ±ralama her Pazar 00:00'da sƒ±fƒ±rlanƒ±r.</p>
                        <div class="flex justify-center gap-8">
                            <div class="text-center"><div class="text-2xl font-bold text-green-400"><i class="fa-solid fa-arrow-up"></i> ƒ∞lk 10</div><div class="text-[10px] uppercase tracking-wider opacity-70">Lig Atlar</div></div>
                            <div class="text-center"><div class="text-2xl font-bold text-red-400"><i class="fa-solid fa-arrow-down"></i> Son 5</div><div class="text-[10px] uppercase tracking-wider opacity-70">Lig D√º≈üer</div></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 bg-slate-50 dark:bg-slate-900 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-300">Bu Haftanƒ±n Sƒ±ralamasƒ±</div>
                        <div id="leagueList" class="divide-y divide-slate-100 dark:divide-slate-700"><div class="p-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div></div>
                    </div>
                </div>
            `;
        }

        async function loadLeagueData() {
            const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(50));
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

            users.sort((a, b) => {
                const xpDiff = (b.xp || 0) - (a.xp || 0);
                if (xpDiff !== 0) return xpDiff;
                return (a.name || "").localeCompare(b.name || "");
            });

            let html = '';
            let rank = 1;
            users.forEach(u => {
                const isMe = u.id === currentUser.uid;
                let statusIcon = rank <= 3 ? '<i class="fa-solid fa-trophy text-yellow-500"></i>' : (rank <= 10 ? '<i class="fa-solid fa-arrow-up text-green-500 text-xs"></i>' : (rank > 15 ? '<i class="fa-solid fa-arrow-down text-red-500 text-xs"></i>' : '<i class="fa-solid fa-minus text-slate-300 text-xs"></i>'));
                html += `<div class="p-4 flex items-center justify-between ${isMe ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}"><div class="flex items-center gap-4"><div class="w-8 font-bold text-slate-500 text-center">${rank++}</div><img src="${u.avatar}" class="w-10 h-10 rounded-full border-2 border-white dark:border-slate-600 shadow-sm"><div><div class="font-bold text-slate-800 dark:text-white ${isMe ? 'text-indigo-600 dark:text-indigo-400' : ''}">${u.name} ${isMe ? '(Sen)' : ''}</div><div class="text-xs text-slate-500">${u.title || '√ñƒürenci'}</div></div></div><div class="flex items-center gap-4"><div class="text-right"><div class="font-bold text-slate-800 dark:text-white">${u.xp || 0} XP</div><div class="text-[10px] text-slate-400">Bu Hafta</div></div><div class="w-6 text-center">${statusIcon}</div></div></div>`;
            });
            document.getElementById('leagueList').innerHTML = html;
        }

        // --- 8. NOT PAZARI ---
        function renderMarket() {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-shop text-pink-500 mr-2"></i>Not Pazarƒ±</h2><p class="text-slate-500 dark:text-slate-400 text-sm">XP'lerinle not satƒ±n al veya kendi notlarƒ±nƒ± sat.</p></div>
                        <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-xl font-bold border border-yellow-200">C√ºzdan: <span id="marketWallet">${userData.xp || 0}</span> XP</div>
                    </div>
                    <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                        <button onclick="window.switchMarketTab('browse')" id="tabMarketBrowse" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-bold hover:text-pink-600 transition border-b-2 border-transparent">Maƒüaza</button>
                        <button onclick="window.switchMarketTab('sell')" id="tabMarketSell" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-bold hover:text-pink-600 transition border-b-2 border-transparent">Not Sat</button>
                        <button onclick="window.switchMarketTab('inventory')" id="tabMarketInv" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-bold hover:text-pink-600 transition border-b-2 border-transparent">Aldƒ±klarƒ±m</button>
                    </div>
                    <div id="marketContent" class="min-h-[300px]"></div>
                </div>
            `;
        }

        window.switchMarketTab = async (tab) => {
            const content = document.getElementById('marketContent');
            ['tabMarketBrowse', 'tabMarketSell', 'tabMarketInv'].forEach(id => {
                document.getElementById(id).classList.remove('tab-btn-active');
            });
            const activeBtn = tab === 'browse' ? 'tabMarketBrowse' : (tab === 'sell' ? 'tabMarketSell' : 'tabMarketInv');
            document.getElementById(activeBtn).classList.add('tab-btn-active');

            if (tab === 'sell') {
                content.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 max-w-xl mx-auto">
                        <h3 class="font-bold text-lg mb-4 dark:text-white">Not Satƒ±≈üa √áƒ±kar</h3>
                        <div class="space-y-4">
                            <input id="noteTitle" type="text" placeholder="Not Ba≈ülƒ±ƒüƒ± (√ñrn: Tarih √ñzet)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                            <textarea id="noteDesc" placeholder="A√ßƒ±klama" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg" rows="3"></textarea>
                            <div class="grid grid-cols-2 gap-4">
                                <input id="notePrice" type="number" placeholder="Fiyat (XP)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                <input id="noteLink" type="text" placeholder="Google Drive / PDF Linki" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                            </div>
                            <button onclick="window.sellNote()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition">Satƒ±≈üa Koy</button>
                        </div>
                    </div>`;
            } else if (tab === 'browse') {
                content.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin"></i> Maƒüaza y√ºkleniyor...</div>';
                const q = query(collection(db, "marketItems"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                if(snap.empty) { content.innerHTML = '<div class="text-center py-10 text-slate-500">Maƒüazada hen√ºz √ºr√ºn yok.</div>'; return; }
                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
                snap.forEach(doc => {
                    const item = doc.data();
                    const isOwn = item.sellerId === currentUser.uid;
                    const isAdmin = currentUser.email === ADMIN_EMAIL;
                    const hasBought = (userData.inventory || []).includes(doc.id);
                    html += `
                        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col relative group">
                            ${(isOwn || isAdmin) ? `<button onclick="window.deleteMarketItem('${doc.id}')" class="absolute top-2 right-2 bg-red-500 text-white p-1.5 rounded-lg text-xs opacity-0 group-hover:opacity-100 transition z-10"><i class="fa-solid fa-trash"></i></button>` : ''}
                            <div class="p-4 flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-slate-800 dark:text-white line-clamp-1">${item.title}</h4>
                                    <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">${item.price} XP</span>
                                </div>
                                <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Satƒ±cƒ±: ${item.sellerName}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-300 line-clamp-2">${item.description}</p>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-100 dark:border-slate-700">
                                ${isOwn 
                                    ? '<button class="w-full py-2 bg-slate-200 dark:bg-slate-700 text-slate-500 rounded-lg cursor-not-allowed text-sm font-bold">Senin √úr√ºn√ºn</button>'
                                    : (hasBought 
                                        ? `<a href="${item.link}" target="_blank" class="block w-full py-2 bg-green-500 text-white rounded-lg text-center text-sm font-bold hover:bg-green-600">ƒ∞ndir / G√∂r√ºnt√ºle</a>`
                                        : `<button onclick="window.buyItem('${doc.id}', ${item.price})" class="w-full py-2 bg-pink-600 text-white rounded-lg text-sm font-bold hover:bg-pink-700 transition">Satƒ±n Al</button>`
                                      )
                                }
                            </div>
                        </div>`;
                });
                html += '</div>';
                content.innerHTML = html;
            } else if (tab === 'inventory') {
                const inventory = userData.inventory || [];
                if(inventory.length === 0) { content.innerHTML = '<div class="text-center py-10 text-slate-500">Hen√ºz bir ≈üey satƒ±n almadƒ±n.</div>'; return; }
                content.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>';
                let html = '<div class="space-y-4">';
                for(const itemId of inventory) {
                    const itemDoc = await getDoc(doc(db, "marketItems", itemId));
                    if(itemDoc.exists()) {
                        const item = itemDoc.data();
                        html += `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 flex justify-between items-center"><div><div class="font-bold text-slate-800 dark:text-white">${item.title}</div><div class="text-xs text-slate-500">${item.description}</div></div><a href="${item.link}" target="_blank" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg font-bold hover:bg-green-200 text-sm"><i class="fa-solid fa-download"></i> ƒ∞ndir</a></div>`;
                    }
                }
                html += '</div>';
                content.innerHTML = html;
            }
        };

        window.sellNote = async () => {
            const title = document.getElementById('noteTitle').value;
            const desc = document.getElementById('noteDesc').value;
            const price = parseInt(document.getElementById('notePrice').value);
            const link = document.getElementById('noteLink').value;

            if(!title || isNaN(price) || !link) return alert("L√ºtfen t√ºm alanlarƒ± doƒüru doldurun. Fiyat sayƒ± olmalƒ±.");

            try {
                await addDoc(collection(db, "marketItems"), {
                    sellerId: currentUser.uid, sellerName: userData.name, title: title, description: desc, price: Number(price), link: link, createdAt: serverTimestamp(), sales: 0
                });
                alert("Notun satƒ±≈üa √ßƒ±ktƒ±!");
                window.switchMarketTab('browse');
            } catch (e) { console.error("Satƒ±≈ü Hatasƒ±:", e); alert("Hata olu≈ütu: " + e.message); }
        };

        window.deleteMarketItem = async (id) => {
            if(confirm("Bu √ºr√ºn√º silmek istediƒüine emin misin?")) {
                await deleteDoc(doc(db, "marketItems", id));
                alert("Silindi.");
                window.switchMarketTab('browse');
            }
        };

        window.buyItem = async (itemId, price) => {
            if(userData.xp < price) return alert("Yetersiz XP!");
            if(!confirm(`${price} XP kar≈üƒ±lƒ±ƒüƒ±nda almak istiyor musun?`)) return;
            try {
                const newXp = userData.xp - price;
                userData.xp = newXp;
                await updateDoc(doc(db, "users", currentUser.uid), { xp: newXp, inventory: arrayUnion(itemId) });
                if(!userData.inventory) userData.inventory = [];
                userData.inventory.push(itemId);
                alert("Satƒ±n alma ba≈üarƒ±lƒ±!");
                updateSidebar();
                document.getElementById('marketWallet').innerText = newXp;
                window.switchMarketTab('inventory');
            } catch (e) { console.error(e); alert("Satƒ±n alma hatasƒ±."); }
        };

        // --- 9. SANAL ET√úT ODASI ---
        let tempUploadedImageUrl = ""; 
        function renderEtut() {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                        <div><h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-users-viewfinder text-blue-500 mr-2"></i>Sanal Et√ºt Odasƒ±</h2><p class="text-slate-500 dark:text-slate-400 text-sm">Yapamadƒ±ƒüƒ±n sorularƒ± sor, bilenlere yardƒ±m et, XP kazan!</p></div>
                        <div class="flex gap-2 text-[10px] font-bold"><div class="bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200">Soru Sor: +5 XP</div><div class="bg-purple-100 text-purple-700 px-2 py-1 rounded border border-purple-200">Cevap: +10 XP</div><div class="bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">En ƒ∞yi: +50 XP</div></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-8">
                        <div onclick="document.getElementById('askForm').classList.toggle('hidden')" class="flex justify-between items-center cursor-pointer"><h3 class="font-bold text-slate-700 dark:text-slate-200">Yeni Soru Olu≈ütur</h3><i class="fa-solid fa-chevron-down text-slate-400"></i></div>
                        <div id="askForm" class="hidden mt-4 space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <select id="etutLesson" class="p-3 border dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 dark:text-white outline-none"><option value="Genel">Ders Se√ßiniz...</option><option value="Matematik">Matematik</option><option value="T√ºrk√ße">T√ºrk√ße</option><option value="Tarih">Tarih</option><option value="Coƒürafya">Coƒürafya</option><option value="Vatanda≈ülƒ±k">Vatanda≈ülƒ±k</option></select>
                                <button onclick="window.openCloudinaryWidget()" id="uploadBtn" class="p-3 border border-dashed border-slate-300 dark:border-slate-600 rounded-lg text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center gap-2"><i class="fa-solid fa-camera"></i> Fotoƒüraf Ekle</button>
                            </div>
                            <div id="imagePreview" class="hidden relative w-full h-32 bg-slate-100 dark:bg-slate-900 rounded-lg overflow-hidden"><img id="previewImg" src="" class="h-full w-auto mx-auto object-contain"><button onclick="window.clearImage()" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>
                            <textarea id="etutText" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none" placeholder="Sorunu buraya yaz..."></textarea>
                            <button onclick="window.submitEtutQuestion()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">Payla≈ü (+5 XP)</button>
                        </div>
                    </div>
                    <div id="etutFeed" class="space-y-6"><div class="text-center text-slate-400 mt-8"><i class="fa-solid fa-spinner fa-spin"></i> Sorular y√ºkleniyor...</div></div>
                </div>`;
        }

        window.openCloudinaryWidget = () => {
            const myWidget = cloudinary.createUploadWidget({ cloudName: 'dbwqidxpy', uploadPreset: 'alnikpss', sources: ['local', 'camera'], multiple: false, folder: 'etut_questions' }, (error, result) => { 
                if (!error && result && result.event === "success") { 
                    tempUploadedImageUrl = result.info.secure_url;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('previewImg').src = tempUploadedImageUrl;
                    document.getElementById('uploadBtn').classList.add('bg-green-50', 'text-green-600', 'border-green-200');
                    document.getElementById('uploadBtn').innerHTML = '<i class="fa-solid fa-check"></i> Y√ºklendi';
                }
            });
            myWidget.open();
        }

        window.clearImage = () => {
            tempUploadedImageUrl = "";
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('previewImg').src = "";
            document.getElementById('uploadBtn').classList.remove('bg-green-50', 'text-green-600', 'border-green-200');
            document.getElementById('uploadBtn').innerHTML = '<i class="fa-solid fa-camera"></i> Fotoƒüraf Ekle';
        }

        window.submitEtutQuestion = async () => {
            const lesson = document.getElementById('etutLesson').value;
            const text = document.getElementById('etutText').value;
            if(lesson === 'Genel' || !text) return alert("L√ºtfen ders se√ßin ve soru metni girin.");
            
            try {
                await addDoc(collection(db, "etutQuestions"), { uid: currentUser.uid, authorName: userData.name, authorAvatar: userData.avatar, lesson, text, image: tempUploadedImageUrl, createdAt: serverTimestamp(), isSolved: false, commentCount: 0 });
                const newXp = (userData.xp || 0) + 5;
                userData.xp = newXp;
                await updateDoc(doc(db, "users", currentUser.uid), { xp: newXp });
                window.notifyAdmin("Yeni bir Et√ºt Sorusu payla≈üƒ±ldƒ±.");
                alert("Soru payla≈üƒ±ldƒ±! +5 XP");
                document.getElementById('etutText').value = "";
                window.clearImage();
                document.getElementById('askForm').classList.add('hidden');
                loadEtutQuestions();
                updateSidebar();
            } catch (err) { console.error(err); alert("Hata olu≈ütu."); }
        };

        window.deleteEtutQuestion = async (qId) => {
            if(!confirm("Bu soruyu silmek istediƒüine emin misin?")) return;
            await deleteDoc(doc(db, "etutQuestions", qId));
            loadEtutQuestions();
        };

        window.deleteEtutComment = async (qId, cId) => {
            if(!confirm("Yorumu silmek istiyor musun?")) return;
            await deleteDoc(doc(db, `etutQuestions/${qId}/comments/${cId}`));
            loadEtutQuestions(); 
        };

        async function loadEtutQuestions() {
            const container = document.getElementById('etutFeed');
            const q = query(collection(db, "etutQuestions"), orderBy("createdAt", "desc"), limit(20));
            const snap = await getDocs(q);
            if(snap.empty) { container.innerHTML = '<div class="text-center text-slate-400 py-10">Hen√ºz soru sorulmamƒ±≈ü.</div>'; return; }
            let html = '';
            for (const d of snap.docs) {
                const qData = d.data();
                const qId = d.id;
                const isMyQuestion = qData.uid === currentUser.uid;
                const isAdmin = currentUser.email === ADMIN_EMAIL;

                const commentsQ = query(collection(db, `etutQuestions/${qId}/comments`), orderBy("createdAt", "asc"));
                const commentsSnap = await getDocs(commentsQ);
                let commentsHtml = '';
                commentsSnap.forEach(cDoc => {
                    const c = cDoc.data();
                    const isBest = c.isBestAnswer;
                    const isMyComment = c.uid === currentUser.uid;
                    commentsHtml += `
                        <div class="flex gap-3 text-sm ${isBest ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3' : 'border-l-2 border-slate-200 dark:border-slate-700 pl-3'}">
                            <img src="${c.authorAvatar}" class="w-8 h-8 rounded-full">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div class="font-bold text-slate-700 dark:text-slate-300">${c.authorName} ${isBest ? '<span class="text-xs text-green-600 ml-2"><i class="fa-solid fa-check-circle"></i> En ƒ∞yi Cevap</span>' : ''}</div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-xs text-slate-400">${c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}</div>
                                        ${(isMyComment || isAdmin) ? `<button onclick="window.deleteEtutComment('${qId}', '${cDoc.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>` : ''}
                                    </div>
                                </div>
                                <p class="text-slate-600 dark:text-slate-300 mt-1">${c.text}</p>
                                ${isMyQuestion && !qData.isSolved && !isBest && c.uid !== currentUser.uid ? `<button onclick="window.markBestAnswer('${qId}', '${cDoc.id}', '${c.uid}')" class="mt-2 text-xs text-slate-400 hover:text-green-500 transition flex items-center gap-1"><i class="fa-regular fa-star"></i> En iyi cevap se√ß (+50 XP Ver)</button>` : ''}
                            </div>
                        </div>`;
                });
                
                html += `
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border ${qData.isSolved ? 'border-green-200 dark:border-green-900' : 'border-slate-100 dark:border-slate-700'} overflow-hidden relative group">
                        ${(isMyQuestion || isAdmin) ? `<button onclick="window.deleteEtutQuestion('${qId}')" class="absolute top-4 right-4 bg-red-500 text-white p-1.5 rounded text-xs opacity-0 group-hover:opacity-100 transition z-10"><i class="fa-solid fa-trash"></i></button>` : ''}
                        <div class="p-4 md:p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center gap-3"><img src="${qData.authorAvatar}" class="w-10 h-10 rounded-full border border-slate-200"><div><div class="font-bold text-slate-800 dark:text-white">${qData.authorName}</div><div class="text-xs text-slate-500">${qData.lesson} ‚Ä¢ ${qData.createdAt ? new Date(qData.createdAt.seconds*1000).toLocaleString() : ''}</div></div></div>
                                ${qData.isSolved ? '<div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold"><i class="fa-solid fa-check"></i> √á√∂z√ºld√º</div>' : ''}
                            </div>
                            <p class="text-slate-800 dark:text-slate-200 mb-4 whitespace-pre-wrap">${qData.text}</p>
                            ${qData.image ? `<div class="mb-4 rounded-lg overflow-hidden border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900"><img src="${qData.image}" class="max-h-96 w-auto mx-auto" onclick="window.open(this.src)" style="cursor:zoom-in"></div>` : ''}
                            <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <div class="space-y-4 mb-4" id="comments-${qId}">${commentsHtml}</div>
                                <div class="flex gap-2 items-center">
                                    <img src="${userData.avatar}" class="w-8 h-8 rounded-full hidden md:block">
                                    <div class="relative flex-1">
                                        <input type="text" id="commentInput-${qId}" placeholder="Cevabƒ±nƒ± yaz (+10 XP)..." class="w-full pl-4 pr-12 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-full text-sm outline-none focus:border-blue-500 transition dark:text-white" onkeydown="if(event.key === 'Enter') window.submitComment('${qId}')">
                                        <button onclick="window.submitComment('${qId}')" class="absolute right-1 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center hover:bg-blue-600 transition"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        }

        window.submitComment = async (qId) => {
            const input = document.getElementById(`commentInput-${qId}`);
            const text = input.value.trim();
            if(!text) return;
            try {
                await addDoc(collection(db, `etutQuestions/${qId}/comments`), { uid: currentUser.uid, authorName: userData.name, authorAvatar: userData.avatar, text, createdAt: serverTimestamp(), isBestAnswer: false });
                const newXp = (userData.xp || 0) + 10;
                userData.xp = newXp;
                await updateDoc(doc(db, "users", currentUser.uid), { xp: newXp });
                input.value = "";
                loadEtutQuestions(); updateSidebar();
            } catch (err) { console.error(err); alert("Yorum g√∂nderilemedi."); }
        };

        window.markBestAnswer = async (qId, cId, authorId) => {
            if(!confirm("Bu cevabƒ± en iyi cevap se√ßmek istiyor musun?")) return;
            try {
                await updateDoc(doc(db, `etutQuestions/${qId}/comments/${cId}`), { isBestAnswer: true });
                await updateDoc(doc(db, "etutQuestions", qId), { isSolved: true });
                const authorRef = doc(db, "users", authorId);
                const authorSnap = await getDoc(authorRef);
                if(authorSnap.exists()) { await updateDoc(authorRef, { xp: (authorSnap.data().xp || 0) + 50 }); }
                await addDoc(collection(db, "notifications"), { uid: authorId, message: "Tebrikler! Cevabƒ±n 'En ƒ∞yi Cevap' se√ßildi. +50 XP kazandƒ±n!", type: "success", read: false, createdAt: serverTimestamp() });
                loadEtutQuestions();
            } catch (err) { console.error(err); alert("Hata olu≈ütu."); }
        };

        // --- 10. HATA KUTUSU ---
        function renderMistakes() {
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-recycle text-red-500 mr-2"></i>Hata Kutusu</h2>
                        <p class="text-slate-500 dark:text-slate-400">Yanlƒ±≈ü yaptƒ±ƒüƒ±n sorular burada birikir. Tekrar √ß√∂z√ºp doƒürusunu √∂ƒürenince silinir.</p>
                    </div>
                    <div id="mistakesList" class="space-y-6 pb-32">
                        <div class="text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>
                    </div>
                </div>
            `;
        }

        async function loadMistakes() {
            const container = document.getElementById('mistakesList');
            const q = query(collection(db, `users/${currentUser.uid}/mistakes`));
            const snap = await getDocs(q);

            if(snap.empty) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-10 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                        <i class="fa-solid fa-check-circle text-6xl text-green-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Harika Gidiyorsun!</h3>
                        <p class="text-slate-500 dark:text-slate-400">Hata kutun bo≈ü. T√ºm yanlƒ±≈ülarƒ±nƒ± temizledin.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            snap.forEach((doc) => {
                const data = doc.data();
                html += `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border-l-4 border-red-500 shadow-sm" id="mistake-${doc.id}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold px-2 py-1 rounded uppercase">${data.lesson || 'Genel'}</span>
                            <button onclick="window.deleteMistake('${doc.id}')" class="text-slate-400 hover:text-red-500" title="Kutudan Sil"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <p class="text-lg font-bold text-slate-800 dark:text-white mb-6">${data.text}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${data.options.map((opt, idx) => `
                                <button onclick="window.checkMistakeAnswer('${doc.id}', ${idx}, ${data.correct})" 
                                    class="text-left p-3 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition mistake-opt-${doc.id}" data-idx="${idx}">
                                    <span class="font-bold mr-2">${String.fromCharCode(65+idx)})</span> ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-${doc.id}" class="mt-4 hidden font-bold text-center"></div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- 11. FLASHCARDS (YENƒ∞LENMƒ∞≈û OYUN MODU) ---
        function renderCards() {
            return `
                <div class="max-w-4xl mx-auto h-full flex flex-col">
                    <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6 shrink-0">
                        <button onclick="window.switchCardTab('browse')" id="tabCardBrowse" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Kartlara G√∂z At</button>
                        <button onclick="window.switchCardTab('submit')" id="tabCardSubmit" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Kart G√∂nder</button>
                    </div>

                    <div id="contentCardBrowse" class="hidden flex-1 flex flex-col items-center">
                        <div id="flashcardStartScreen" class="w-full max-w-md text-center p-8 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700">
                            <i class="fa-solid fa-layer-group text-5xl text-primary mb-4"></i>
                            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Flashcard √áalƒ±≈ümasƒ±</h3>
                            <p class="text-slate-500 dark:text-slate-400 mb-6">Kategorini se√ß ve kartlarƒ± √ßevirmeye ba≈üla!</p>
                            <select id="flashcardCategorySelect" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 dark:text-white outline-none mb-4">
                                <option value="All">T√ºm Dersler</option>
                                <option value="Tarih">Tarih</option>
                                <option value="Coƒürafya">Coƒürafya</option>
                                <option value="Vatanda≈ülƒ±k">Vatanda≈ülƒ±k</option>
                                <option value="T√ºrk√ße">T√ºrk√ße</option>
                                <option value="Matematik">Matematik</option>
                                <option value="General">Genel</option>
                            </select>
                            <button onclick="window.startFlashcardGame()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-3 rounded-xl transition shadow-lg shadow-orange-500/30">Ba≈üla</button>
                        </div>

                        <div id="flashcardGameArea" class="hidden w-full max-w-lg flex flex-col items-center flex-1 justify-center min-h-[400px]">
                            <div class="w-full flex justify-between items-center mb-4 px-4">
                                <button onclick="window.switchCardTab('browse')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white"><i class="fa-solid fa-arrow-left"></i> √áƒ±k</button>
                                <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200 px-3 py-1 rounded-full text-xs font-bold" id="fcCategoryBadge">Genel</span>
                            </div>
                            
                            <div class="flip-card w-full h-80 perspective cursor-pointer group mb-8" onclick="this.classList.toggle('flipped')">
                                <div class="flip-card-inner relative w-full h-full shadow-xl rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 transition-transform duration-500">
                                    <div class="flip-card-front flex flex-col items-center justify-center p-8 text-center bg-white dark:bg-slate-800 rounded-2xl">
                                        <div class="absolute top-4 right-4 flex gap-2 z-20" onclick="event.stopPropagation()">
                                            <button onclick="window.reportContent('card', currentCard.id)" class="text-slate-300 hover:text-yellow-500 transition" title="≈ûikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>
                                            ${currentUser.email === ADMIN_EMAIL ? `<button onclick="window.deleteLiveItem('flashcards', currentCard.id)" class="text-red-300 hover:text-red-500 transition" title="Y√∂netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
                                        </div>
                                        <h3 class="font-bold text-slate-800 dark:text-white text-2xl" id="fcFront">...</h3>
                                        <p class="text-xs text-slate-400 mt-4 uppercase tracking-widest">√áevirmek i√ßin dokun</p>
                                    </div>
                                    <div class="flip-card-back flex flex-col items-center justify-center p-8 text-center bg-primary text-white rounded-2xl">
                                        <div class="absolute top-4 right-4 flex gap-2 z-20" onclick="event.stopPropagation()">
                                             <button onclick="window.reportContent('card', currentCard.id, document.getElementById('fcFront').innerText)" class="text-white/50 hover:text-white transition" title="≈ûikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>
                                             ${currentUser.email === ADMIN_EMAIL ? `<button onclick="window.deleteLiveItem('flashcards', currentCard.id)" class="text-white/50 hover:text-white transition" title="Y√∂netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
                                        </div>
                                        <p class="font-bold text-2xl" id="fcBack">...</p>
                                    </div>
                                </div>
                            </div>

                            <button onclick="window.nextCard()" class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:-translate-y-1">
                                Sƒ±radaki Kart <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <div id="contentCardSubmit" class="hidden pb-32">
                         <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Kart √ñnerisi G√∂nder</h3>
                            <div class="space-y-4">
                                <input id="cardFront" type="text" placeholder="√ñn Y√ºz (Soru/Kavram)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                <input id="cardBack" type="text" placeholder="Arka Y√ºz (Cevap/A√ßƒ±klama)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                <button onclick="window.submitCard()" class="w-full bg-slate-800 dark:bg-slate-700 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">Y√∂netici Onayƒ±na G√∂nder</button>
                            </div>
                        </div>
                        <div class="mt-8"><h3 class="font-bold text-md mb-4 text-slate-800 dark:text-white">G√∂nderimlerin</h3><div id="myCardsList" class="space-y-3"></div></div>
                    </div>
                </div>
            `;
        }
        
        window.switchCardTab = (tab) => {
             document.getElementById('contentCardBrowse').classList.add('hidden');
             document.getElementById('contentCardSubmit').classList.add('hidden');
             document.getElementById('tabCardBrowse').classList.remove('tab-btn-active');
             document.getElementById('tabCardSubmit').classList.remove('tab-btn-active');
             
             if(tab === 'browse') {
                 document.getElementById('contentCardBrowse').classList.remove('hidden');
                 document.getElementById('tabCardBrowse').classList.add('tab-btn-active');
                 // Reset Game View
                 document.getElementById('flashcardStartScreen').classList.remove('hidden');
                 document.getElementById('flashcardGameArea').classList.add('hidden');
             } else {
                 document.getElementById('contentCardSubmit').classList.remove('hidden');
                 document.getElementById('tabCardSubmit').classList.add('tab-btn-active');
                 loadMyCardSubmissions();
             }
        };

        window.submitCard = async () => {
            const front = document.getElementById('cardFront').value;
            const back = document.getElementById('cardBack').value;
            if(!front || !back) return alert("ƒ∞ki y√ºz√º de doldurun.");
            await addDoc(collection(db, "flashcardSubmissions"), {
                uid: currentUser.uid, authorName: userData.name, front, back, status: 'pending', createdAt: serverTimestamp()
            });
            window.notifyAdmin("Yeni bir Flashcard onayƒ± bekliyor.");
            alert("Kart g√∂nderildi!");
            document.getElementById('cardFront').value = ""; document.getElementById('cardBack').value = "";
            loadMyCardSubmissions();
        };

        async function loadMyCardSubmissions() {
            const q = query(collection(db, "flashcardSubmissions"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const list = document.getElementById('myCardsList');
            if(list) {
                list.innerHTML = snap.docs.map(d => { const data=d.data(); return `
                    <div class="p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded flex justify-between items-center text-slate-800 dark:text-slate-200">
                        <div><span class="font-bold">${data.front}</span> - ${data.back}</div>
                        <span class="text-xs px-2 py-1 rounded ${data.status==='approved'?'bg-green-100 text-green-700':(data.status==='rejected'?'bg-red-100 text-red-700':'bg-yellow-100 text-yellow-700')}">${data.status}</span>
                    </div>`;
                }).join('');
            }
        }

        // --- FLASHCARD OYUN MANTIƒûI ---
        window.startFlashcardGame = async () => {
            const category = document.getElementById('flashcardCategorySelect').value;
            const btn = document.querySelector('#flashcardStartScreen button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...';
            
            try {
                let q;
                if(category === 'All') {
                    q = query(collection(db, "flashcards"));
                } else {
                    // Not: Bu sorgu i√ßin Firestore Index gerekebilir. Hata verirse linke tƒ±kla.
                    // ≈ûimdilik client-side filtering yapalƒ±m g√ºvenli olsun.
                    q = query(collection(db, "flashcards"));
                }
                
                const snap = await getDocs(q);
                flashcardsPool = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    // Manuel filtreleme (Category field varsa) veya hepsi
                    // JSON import'ta category yoksa 'General' varsayƒ±yoruz
                    if(category === 'All' || d.lesson === category || (!d.lesson && category === 'General')) {
                        flashcardsPool.push({ id: doc.id, ...d });
                    }
                });

                if(flashcardsPool.length === 0) {
                    alert("Bu kategoride hen√ºz kart yok.");
                    btn.innerHTML = 'Ba≈üla';
                    return;
                }

                // Shuffle (Karƒ±≈ütƒ±r)
                flashcardsPool.sort(() => Math.random() - 0.5);

                // UI Ge√ßi≈üi
                document.getElementById('flashcardStartScreen').classList.add('hidden');
                document.getElementById('flashcardGameArea').classList.remove('hidden');
                document.getElementById('fcCategoryBadge').innerText = category === 'All' ? 'Karƒ±≈üƒ±k' : category;
                
                window.nextCard();
                btn.innerHTML = 'Ba≈üla';

            } catch (e) {
                console.error(e);
                alert("Kartlar y√ºklenirken hata olu≈ütu.");
                btn.innerHTML = 'Ba≈üla';
            }
        };

        window.nextCard = () => {
            if(flashcardsPool.length === 0) {
                alert("T√ºm kartlar bitti! Ba≈üa d√∂n√ºl√ºyor.");
                window.switchCardTab('browse'); 
                return;
            }
            // Havuzdan rastgele bir tane alƒ±p √ßƒ±karalƒ±m (tekrarsƒ±z olsun diye) veya rastgele se√ßip bƒ±rakalƒ±m (sonsuz d√∂ng√º)
            // Sonsuz d√∂ng√º i√ßin:
            const randomIndex = Math.floor(Math.random() * flashcardsPool.length);
            currentCard = flashcardsPool[randomIndex];
            
            // Kartƒ± √ßevrilmemi≈ü hale getir
            const cardEl = document.querySelector('.flip-card');
            cardEl.classList.remove('flipped');

            // ƒ∞√ßeriƒüi g√ºncelle (biraz gecikmeli ki animasyon bozulmasƒ±n)
            setTimeout(() => {
                document.getElementById('fcFront').innerText = currentCard.front;
                document.getElementById('fcBack').innerText = currentCard.back;
            }, 200);
        };

        // --- 12. NOTLAR ---
        function renderNotes() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Not Defterim</h2>
                    <div class="mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <textarea id="newNoteText" class="w-full p-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-primary h-24" placeholder="Yeni bir not al..."></textarea>
                        <button onclick="window.saveNote()" class="mt-2 bg-primary text-white px-6 py-2 rounded-lg font-bold hover:bg-primaryDark">Notu Kaydet</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-32" id="notesList">
                        ${myNotes.length === 0 ? '<p class="text-slate-500">Hen√ºz notun yok.</p>' : ''}
                        ${myNotes.map(note => `
                            <div class="sticky-note p-6 relative group">
                                <p class="text-slate-800 font-handwriting">${note.text}</p>
                                <div class="absolute bottom-2 right-2 text-xs text-slate-500">${note.date}</div>
                                <button onclick="window.deleteNote('${note.id}')" class="absolute top-2 right-2 text-red-400 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- 13. FORUM ---
        function renderForum() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">√ñƒürenci Forumu</h2>
                    
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-8">
                        <h3 class="font-bold mb-4 dark:text-white">Yeni Konu Ba≈ülat</h3>
                        <div class="space-y-3">
                            <input id="forumTitle" type="text" placeholder="Ba≈ülƒ±k" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                            <textarea id="forumContent" placeholder="Mesajƒ±n..." class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg" rows="3"></textarea>
                            <select id="forumCategory" class="p-3 border dark:border-slate-600 rounded-lg w-full bg-white dark:bg-slate-700 dark:text-white">
                                <option>Genel Sohbet</option><option>Ders: T√ºrk√ße</option><option>Ders: Matematik</option><option>Ders: Tarih</option><option>Motivasyon</option>
                            </select>
                            <button onclick="window.submitForumPost()" class="bg-slate-800 dark:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold">G√∂nder (Onay Gerekli)</button>
                        </div>
                    </div>

                    <div id="forumFeed" class="space-y-4 pb-32">
                        <div class="text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>
                    </div>
                </div>
            `;
        }

        window.submitForumPost = async () => {
            const title = document.getElementById('forumTitle').value;
            const content = document.getElementById('forumContent').value;
            const category = document.getElementById('forumCategory').value;
            if(!title || !content) return alert("Eksik alan var.");
            
            await addDoc(collection(db, "forumPosts"), {
                uid: currentUser.uid, 
                authorName: userData.name, 
                authorTitle: userData.title, 
                avatar: userData.avatar,
                title, content, category, status: 'pending', createdAt: serverTimestamp()
            });
            window.notifyAdmin("Yeni bir Forum Konusu onayƒ± bekliyor.");
            alert("Konu onaya g√∂nderildi.");
            document.getElementById('forumTitle').value = ""; document.getElementById('forumContent').value = "";
        }

        async function loadForumPosts() {
            try {
                const q = query(collection(db, "forumPosts"), where("status", "==", "approved"));
                const snap = await getDocs(q);
                let posts = [];
                snap.forEach(d => { posts.push({id: d.id, ...d.data()}); });

                posts.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                const isAdminUser = currentUser.email.toLowerCase() === ADMIN_EMAIL;
                const container = document.getElementById('forumFeed');
                if (!container) return;

                if (posts.length === 0) {
                    container.innerHTML = '<div class="text-center p-8 text-slate-500 dark:text-slate-400">Hen√ºz onaylanmƒ±≈ü konu yok.</div>';
                    return;
                }

                container.innerHTML = posts.map(p => {
                    const isAuthorAdmin = p.authorTitle === 'Y√∂netici';
                    return `
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm relative group">
                            <div class="flex items-center gap-3 mb-3">
                                <img src="${p.avatar}" class="w-10 h-10 rounded-full">
                                <div>
                                    <div class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                        ${p.authorName}
                                        ${isAuthorAdmin ? '<span class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-[9px] font-bold border border-red-200">Y√ñNETƒ∞Cƒ∞</span>' : ''}
                                    </div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">${p.category} ‚Ä¢ ${p.createdAt ? new Date(p.createdAt.seconds*1000).toLocaleDateString() : 'Az √∂nce'}</div>
                                </div>
                            </div>
                            <h4 class="font-bold text-lg text-slate-900 dark:text-white mb-2">${p.title}</h4>
                            <p class="text-slate-600 dark:text-slate-300">${p.content}</p>
                            ${isAdminUser ? `<button onclick="window.deleteForumPost('${p.id}')" class="absolute top-4 right-4 text-red-500 hover:bg-red-50 p-2 rounded"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error("Forum loading error:", err);
            }
        }
        
        window.deleteForumPost = async (id) => {
            if(confirm("Bu konuyu silmek istiyor musunuz?")) {
                await deleteDoc(doc(db, "forumPosts", id));
                loadForumPosts();
            }
        };
        // --- 14. FEEDBACK MODULE ---
        function renderFeedback() {
            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">√ñneri & ≈ûikayet Kutusu</h2>
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg border border-orange-100 dark:border-slate-700">
                        <div class="text-center mb-6"><i class="fa-solid fa-envelope-open-text text-6xl text-orange-200 dark:text-orange-900"></i></div>
                        <p class="text-center text-slate-600 dark:text-slate-300 mb-6">Uygulamayƒ± geli≈ütirmemiz i√ßin fikirlerin bizim i√ßin √ßok deƒüerli. L√ºtfen aklƒ±na gelen her ≈üeyi yaz.</p>
                        <textarea id="feedbackText" class="w-full p-4 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl h-40 focus:border-primary outline-none" placeholder="Mesajƒ±nƒ±z..."></textarea>
                        <button onclick="window.sendFeedback()" class="w-full mt-4 bg-primary text-white py-3 rounded-xl font-bold hover:bg-primaryDark transition">G√∂nder</button>
                    </div>
                </div>
            `;
        }

        window.sendFeedback = async () => {
            const txt = document.getElementById('feedbackText').value;
            if(!txt) return;
            await addDoc(collection(db, "feedback"), {
                uid: currentUser.uid, name: userData.name, message: txt, createdAt: serverTimestamp(), read: false
            });
            window.notifyAdmin("Yeni bir Geri Bildirim var.");
            alert("Mesajƒ±nƒ±z iletildi, te≈üekk√ºrler!");
            document.getElementById('feedbackText').value = "";
        };

        // --- 15. NOTIFICATIONS MODULE ---
        function listenForNotificationBadge() {
            if(unsubscribeNotifications) unsubscribeNotifications();
            const q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), where("read", "==", false));
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                const badge = document.getElementById('notifBadge');
                const mobileBadge = document.getElementById('mobileNotifBadge');
                if(snap.size > 0) {
                    if(badge) { badge.innerText = snap.size; badge.classList.remove('hidden'); }
                    if(mobileBadge) { mobileBadge.innerText = snap.size; mobileBadge.classList.remove('hidden'); }
                } else {
                    if(badge) badge.classList.add('hidden');
                    if(mobileBadge) mobileBadge.classList.add('hidden');
                }
            });
        }

        function renderNotifications() {
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Bildirimler</h2>
                        <div class="flex gap-2">
                            <button onclick="window.toggleSelectAllNotifications()" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded hover:bg-slate-200 dark:text-white transition">Hepsini Se√ß</button>
                            <button onclick="window.deleteSelectedNotifications()" class="text-xs bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 border border-red-200 transition">Se√ßilenleri Sil</button>
                            <button onclick="window.deleteAllNotifications()" class="text-xs bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 transition">T√ºm√ºn√º Sil</button>
                        </div>
                    </div>
                    <div id="notifList" class="space-y-3 pb-32">
                         <div class="text-center text-slate-400 mt-10"><i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...</div>
                    </div>
                </div>
            `;
        }

        async function fetchNotifications() {
            let q;
            q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            let notifs = [];
            snap.forEach(d => notifs.push({id: d.id, ...d.data()}));
            
            notifs.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
            displayNotifications(notifs);

            const unreadQ = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), where("read", "==", false));
            const unreadSnap = await getDocs(unreadQ);
            const batch = writeBatch(db);
            unreadSnap.forEach(d => batch.update(doc(db, "notifications", d.id), { read: true }));
            await batch.commit();
        }

        function displayNotifications(data) {
            const list = document.getElementById('notifList');
            if(!list) return;
            if(data.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 dark:text-slate-400 p-8">Bildirim yok.</div>'; return; }
            
            let html = '';
            data.forEach(n => {
                html += `
                    <div class="p-4 bg-white dark:bg-slate-800 border-l-4 ${n.type==='success'?'border-green-500':(n.type==='warning'?'border-yellow-500':'border-blue-500')} rounded shadow-sm flex gap-3 items-start transition hover:shadow-md">
                        <input type="checkbox" class="notif-checkbox mt-1.5 w-4 h-4 accent-primary cursor-pointer" value="${n.id}">
                        <div class="flex-1">
                            ${n.title ? `<div class="font-bold text-sm text-slate-800 dark:text-white mb-1">${n.title}</div>` : ''}
                            <div class="text-sm font-medium text-slate-700 dark:text-slate-200 leading-relaxed">${n.message}</div>
                            <div class="text-xs text-slate-400 mt-2 flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${n.createdAt ? new Date(n.createdAt.seconds*1000).toLocaleString() : ''}</div>
                        </div>
                    </div>`;
            });
            list.innerHTML = html;
        }

        window.toggleSelectAllNotifications = () => {
            const checkboxes = document.querySelectorAll('.notif-checkbox');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        };

        window.deleteSelectedNotifications = async () => {
            const checkboxes = document.querySelectorAll('.notif-checkbox:checked');
            if(checkboxes.length === 0) return alert("Se√ßim yapmadƒ±nƒ±z.");
            if(!confirm(`${checkboxes.length} bildirimi silmek istiyor musun?`)) return;
            
            const batch = writeBatch(db);
            checkboxes.forEach(c => { batch.delete(doc(db, "notifications", c.value)); });
            await batch.commit();
            fetchNotifications();
        };

        window.deleteAllNotifications = async () => {
            if(!confirm("T√úM bildirimlerin silinecek! Emin misin?")) return;
            const q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(doc(db, "notifications", d.id)));
            await batch.commit();
            fetchNotifications();
        };

        // --- 16. QUIZ CENTER (YENƒ∞LENMƒ∞≈û OYUN MODU) ---
        // --- 16. QUIZ CENTER (G√úNCELLENDƒ∞: MOBƒ∞L KAYDIRMA & K√ú√á√úLTME) ---
        function renderQuizCenter() {
            return `
                <div class="max-w-3xl mx-auto h-full flex flex-col">
                    <div class="flex border-b border-slate-200 dark:border-slate-700 mb-4 shrink-0">
                        <button onclick="window.switchQuizTab('solve')" id="tabSolve" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Test √á√∂z</button>
                        <button onclick="window.switchQuizTab('submit')" id="tabSubmit" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Soru G√∂nder</button>
                    </div>
                    
                    <div id="contentSolve" class="hidden flex-1 overflow-y-auto w-full px-2"> 
                        
                        <div id="quizStartScreen" class="w-full max-w-md mx-auto text-center p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 mt-4">
                            <i class="fa-solid fa-pen-nib text-4xl md:text-5xl text-primary mb-4"></i>
                            <h3 class="text-lg md:text-xl font-bold text-slate-800 dark:text-white mb-2">Test √á√∂z</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Kendini sƒ±namaya hazƒ±r mƒ±sƒ±n? Dersini se√ß ve ba≈üla.</p>
                            <select id="quizCategorySelect" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 dark:text-white outline-none mb-4 text-sm">
                                <option value="All">T√ºm Dersler (Karƒ±≈üƒ±k)</option>
                                <option value="Tarih">Tarih</option>
                                <option value="Coƒürafya">Coƒürafya</option>
                                <option value="Vatanda≈ülƒ±k">Vatanda≈ülƒ±k</option>
                                <option value="T√ºrk√ße">T√ºrk√ße</option>
                                <option value="Matematik">Matematik</option>
                            </select>
                            <button onclick="window.startQuizGame()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-3 rounded-xl transition shadow-lg shadow-orange-500/30">Teste Ba≈üla</button>
                        </div>

                        <div id="quizGameArea" class="hidden w-full max-w-2xl mx-auto flex flex-col py-4 pb-24"> <div class="w-full flex justify-between items-center mb-3">
                                <button onclick="window.switchQuizTab('solve')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white text-sm"><i class="fa-solid fa-arrow-left"></i> √áƒ±k</button>
                                <span class="bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase" id="quizCategoryBadge">Genel</span>
                            </div>

                            <div class="bg-white dark:bg-slate-800 p-5 md:p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 relative">
                                <div class="absolute top-3 right-3 flex gap-1">
                                    <button onclick="window.openReportModal('questions', currentQuestion.id, currentQuestion.text)" class="text-slate-300 hover:text-yellow-500 transition p-2" title="≈ûikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>
                                    ${currentUser.email === ADMIN_EMAIL ? `<button onclick="window.deleteLiveItem('questions', currentQuestion.id)" class="text-red-300 hover:text-red-500 transition p-2" title="Y√∂netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
                                </div>

                                <div class="text-xs text-slate-400 mb-2 font-bold uppercase tracking-wider">Soru</div>
                                
                                <p class="font-bold text-slate-800 dark:text-white text-base md:text-xl mb-6 leading-relaxed" id="qGameText">...</p>
                                
                                <div class="space-y-2 md:space-y-3" id="qGameOptions">
                                    </div>

                                <div id="qGameFeedback" class="mt-4 hidden p-3 rounded-xl font-bold text-center text-sm md:text-base"></div>
                            </div>

                            <div class="mt-6 text-center">
                                <button onclick="window.nextQuestion()" id="nextQBtn" class="hidden bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-3 px-8 md:px-12 rounded-full shadow-lg transition transform hover:-translate-y-1 w-full md:w-auto">
                                    Sonraki Soru <i class="fa-solid fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="contentSubmit" class="hidden flex-1 overflow-y-auto pb-32 px-2">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mt-4">
                            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Topluluƒüa Katkƒ±da Bulun</h3>
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ders</label><select id="qLesson" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 dark:text-white"><option>T√ºrk√ße</option><option>Matematik</option><option>Tarih</option><option>Coƒürafya</option><option>Vatanda≈ülƒ±k</option></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Soru Metni</label><textarea id="qText" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg" placeholder="Soruyu buraya yazƒ±n..."></textarea></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input id="optA" type="text" placeholder="A ≈ûƒ±kkƒ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optB" type="text" placeholder="B ≈ûƒ±kkƒ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optC" type="text" placeholder="C ≈ûƒ±kkƒ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optD" type="text" placeholder="D ≈ûƒ±kkƒ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optE" type="text" placeholder="E ≈ûƒ±kkƒ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <select id="qCorrect" class="p-3 border rounded-lg bg-green-50 border-green-200 dark:bg-green-900 dark:border-green-700 dark:text-white"><option value="0">Doƒüru Cevap: A</option><option value="1">Doƒüru Cevap: B</option><option value="2">Doƒüru Cevap: C</option><option value="3">Doƒüru Cevap: D</option><option value="4">Doƒüru Cevap: E</option></select>
                                </div>
                                <button onclick="window.submitQuestion()" class="w-full bg-slate-800 dark:bg-slate-600 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">Y√∂netici Onayƒ±na G√∂nder</button>
                            </div>
                        </div>
                        <div class="mt-8"><h3 class="font-bold text-md mb-4 text-slate-800 dark:text-white">G√∂nderdiƒüin Sorular</h3><div id="myQuestionsList" class="space-y-3"></div></div>
                    </div>
                </div>
            `;
        }

        window.switchQuizTab = (tab) => {
            document.getElementById('contentSolve').classList.add('hidden');
            document.getElementById('contentSubmit').classList.add('hidden');
            document.getElementById('tabSolve').classList.remove('tab-btn-active');
            document.getElementById('tabSubmit').classList.remove('tab-btn-active');
            
            if(tab === 'solve') {
                document.getElementById('contentSolve').classList.remove('hidden');
                document.getElementById('tabSolve').classList.add('tab-btn-active');
                // Reset Game View
                document.getElementById('quizStartScreen').classList.remove('hidden');
                document.getElementById('quizGameArea').classList.add('hidden');
            } else {
                document.getElementById('contentSubmit').classList.remove('hidden');
                document.getElementById('tabSubmit').classList.add('tab-btn-active');
                loadMyQuestions();
            }
        };

        // --- QUIZ OYUN MANTIƒûI ---
        window.startQuizGame = async () => {
            const category = document.getElementById('quizCategorySelect').value;
            const btn = document.querySelector('#quizStartScreen button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Hazƒ±rlanƒ±yor...';

            try {
                let q;
                if(category === 'All') {
                    q = query(collection(db, "questions"));
                } else {
                    // Not: Index hatasƒ± alƒ±rsan linke tƒ±kla veya client-side filtre kullan.
                    // Client-side filtre (Daha g√ºvenli):
                    q = query(collection(db, "questions"));
                }

                const snap = await getDocs(q);
                quizQuestionsPool = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if(category === 'All' || d.lesson === category) {
                        quizQuestionsPool.push({ id: doc.id, ...d });
                    }
                });

                if(quizQuestionsPool.length === 0) {
                    alert("Bu kategoride hen√ºz soru yok.");
                    btn.innerHTML = 'Teste Ba≈üla';
                    return;
                }

                // Shuffle
                quizQuestionsPool.sort(() => Math.random() - 0.5);

                // UI Transition
                document.getElementById('quizStartScreen').classList.add('hidden');
                document.getElementById('quizGameArea').classList.remove('hidden');
                document.getElementById('quizCategoryBadge').innerText = category === 'All' ? 'Karma Test' : category;

                window.nextQuestion();
                btn.innerHTML = 'Teste Ba≈üla';

            } catch (e) {
                console.error(e);
                alert("Hata olu≈ütu.");
                btn.innerHTML = 'Teste Ba≈üla';
            }
        };

        window.nextQuestion = () => {
            if(quizQuestionsPool.length === 0) {
                alert("Test bitti! Ba≈üa d√∂n√ºl√ºyor.");
                window.switchQuizTab('solve');
                return;
            }

            // Sonsuz d√∂ng√º i√ßin random se√ßip bƒ±rakƒ±yoruz (veya √ßƒ±karabiliriz)
            // Tekrarsƒ±z i√ßin:
            // currentQuestion = quizQuestionsPool.pop();
            // Sonsuz i√ßin:
            const randomIndex = Math.floor(Math.random() * quizQuestionsPool.length);
            currentQuestion = quizQuestionsPool[randomIndex];

            // Render
            document.getElementById('qGameText').innerText = currentQuestion.text;
            const optsDiv = document.getElementById('qGameOptions');
            optsDiv.innerHTML = '';
            
            currentQuestion.options.forEach((opt, idx) => {
                optsDiv.innerHTML += `
                    <button onclick="window.checkGameAnswer(${idx})" 
                        class="quiz-option w-full text-left p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 bg-white dark:bg-slate-800 transition flex items-center gap-3" id="gameOpt-${idx}">
                        <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center font-bold text-slate-500 dark:text-slate-300 text-sm shrink-0">${String.fromCharCode(65+idx)}</div>
                        <span class="text-slate-700 dark:text-slate-200">${opt}</span>
                    </button>
                `;
            });

            document.getElementById('qGameFeedback').classList.add('hidden');
            document.getElementById('nextQBtn').classList.add('hidden');
        };

        window.checkGameAnswer = (selectedIdx) => {
            const correctIdx = currentQuestion.correct;
            const feedback = document.getElementById('qGameFeedback');
            const buttons = document.querySelectorAll('.quiz-option');
            
            // Disable all
            buttons.forEach(btn => btn.disabled = true);

            if(selectedIdx === correctIdx) {
                feedback.innerHTML = '<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> Doƒüru Cevap! Harikasƒ±n.</span>';
                feedback.className = "mt-6 p-4 rounded-xl font-bold text-center bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800";
                document.getElementById(`gameOpt-${selectedIdx}`).classList.add('ring-2', 'ring-green-500', 'bg-green-50', 'dark:bg-green-900/20');
            } else {
                feedback.innerHTML = `<span class="text-red-600"><i class="fa-solid fa-times-circle"></i> Yanlƒ±≈ü Cevap. Doƒüru ≈üƒ±k: ${String.fromCharCode(65+correctIdx)}</span>`;
                feedback.className = "mt-6 p-4 rounded-xl font-bold text-center bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800";
                document.getElementById(`gameOpt-${selectedIdx}`).classList.add('ring-2', 'ring-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                document.getElementById(`gameOpt-${correctIdx}`).classList.add('ring-2', 'ring-green-500', 'bg-green-50', 'dark:bg-green-900/20'); // Doƒüruyu g√∂ster
                
                // Hata Kutusuna Ekle
                window.addToMistakes(currentQuestion.id);
            }

            feedback.classList.remove('hidden');
            document.getElementById('nextQBtn').classList.remove('hidden');
        };

        // ... addToMistakes fonksiyonu Part 4 i√ßinde tanƒ±mlƒ± ...

        window.submitQuestion = async () => {
            const text = document.getElementById('qText').value;
            const optA = document.getElementById('optA').value;
            if(!text || !optA) return alert("Soru ve en az bir ≈üƒ±k girin.");
            
            const qData = { 
                uid: currentUser.uid, 
                authorName: userData.name, 
                lesson: document.getElementById('qLesson').value, 
                text: text, 
                options: [
                    document.getElementById('optA').value, 
                    document.getElementById('optB').value, 
                    document.getElementById('optC').value, 
                    document.getElementById('optD').value, 
                    document.getElementById('optE').value
                ], 
                correct: parseInt(document.getElementById('qCorrect').value), 
                status: 'pending', 
                adminNote: '', 
                createdAt: serverTimestamp() 
            };
            
            await addDoc(collection(db, "questionSubmissions"), qData);
            window.notifyAdmin("Yeni bir soru onayƒ± bekliyor.");
            alert("Sorun g√∂nderildi!");
            document.getElementById('qText').value = "";
            loadMyQuestions();
        };

        async function loadMyQuestions() {
            if(!currentUser) return;
            const q = query(collection(db, "questionSubmissions"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            myQuestions = [];
            snapshot.forEach(doc => myQuestions.push({id: doc.id, ...doc.data()}));
            
            const list = document.getElementById('myQuestionsList');
            if(list) {
                list.innerHTML = myQuestions.map(mq => `
                    <div class="p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 mb-1">${mq.lesson}</div>
                            <div class="text-sm font-medium text-slate-800 dark:text-white line-clamp-1">${mq.text}</div>
                            ${mq.status === 'rejected' ? `<div class="text-xs text-red-600 mt-2 bg-red-50 p-2 rounded"><strong>Red Sebebi:</strong> ${mq.adminNote}</div>` : ''}
                        </div>
                        <div class="ml-4">
                            ${mq.status === 'pending' ? '<span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Bekliyor</span>' : ''}
                            ${mq.status === 'approved' ? '<span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">Yayƒ±nda</span>' : ''}
                            ${mq.status === 'rejected' ? '<span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded">Red</span>' : ''}
                        </div>
                    </div>`).join('') || '<p class="text-sm text-slate-400">Hen√ºz soru g√∂ndermediniz.</p>';
            }
        }

        // --- 17. PROFILE MODULE ---
        function renderProfile() {
            const uName = userData?.name || '';
            const uTarget = userData?.targetScore || 85;
            const uAvatar = userData?.avatar || AVATAR_OPTIONS[0];

            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Profil Ayarlarƒ±</h2>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Avatar Se√ß</label>
                            <div class="grid grid-cols-4 md:grid-cols-8 gap-2">
                                ${AVATAR_OPTIONS.map(url => `
                                    <img src="${url}" 
                                         onclick="window.updateProfileField('avatar', '${url}')"
                                         class="avatar-option w-12 h-12 rounded-full border-2 border-transparent cursor-pointer transition ${uAvatar === url ? 'selected' : ''}">
                                `).join('')}
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ad Soyad</label><input type="text" onchange="window.updateProfileField('name', this.value)" value="${uName}" class="w-full p-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:border-primary outline-none"></div>
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Hedef Puanƒ±n</label><input type="number" onchange="window.updateProfileField('targetScore', this.value)" value="${uTarget}" class="w-full p-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:border-primary outline-none"></div>
                            <div class="text-sm text-slate-500 mt-4 flex items-center gap-2"><i class="fa-solid fa-file-contract"></i><span onclick="window.showPrivacyModal()" class="cursor-pointer hover:underline text-primary">Gizlilik Politikasƒ±</span></div>
                            <hr class="border-slate-100 dark:border-slate-700 my-4">
                            <button onclick="alert('≈ûifre sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂nderildi.')" class="w-full border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-medium py-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition">≈ûifre Deƒüi≈ütir</button>
                            <button onclick="window.deleteAccountRequest()" class="w-full border border-red-200 text-red-500 font-medium py-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition">Hesabƒ±mƒ± Sil</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.updateProfileField = async (key, value) => { 
            userData[key] = value; 
            updateSidebar(); 
            if(key === 'avatar') window.loadPage('profile'); 
            await updateDoc(doc(db, "users", currentUser.uid), { [key]: value }); 
        };

        // --- 18. ADMIN PANEL (D√úZELTƒ∞LDƒ∞: Layout & Flashcard JSON) ---
        function renderAdminPanel() {
            return `
                <div class="max-w-6xl mx-auto">
                    <h1 class="text-2xl font-bold mb-6 text-slate-800 dark:text-white">Y√∂netim Paneli</h1>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                             <div class="flex gap-4 mb-4 overflow-x-auto pb-2">
                                <button onclick="window.loadAdminData('questions')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap">Bekleyen Soru</button>
                                <button onclick="window.loadAdminData('cards')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap">Bekleyen Kart</button>
                                <button onclick="window.loadAdminData('forum')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap">Bekleyen Konu</button>
                                <button onclick="window.loadAdminData('inbox')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap">Gelen Kutusu</button>
                            </div>
                            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden min-h-[400px]">
                                <div id="adminContentArea" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-800 dark:text-slate-200">
                                    <div class="p-8 text-center text-slate-400">ƒ∞≈ülem se√ßiniz.</div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            
                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                <h3 class="font-bold text-lg mb-4 dark:text-white">Bildirim G√∂nder</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kullanƒ±cƒ± ID (Opsiyonel)</label>
                                        <input type="text" id="adminNotifUid" placeholder="Bo≈ü bƒ±rakƒ±lƒ±rsa herkese gider" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ba≈ülƒ±k (Opsiyonel)</label>
                                        <input type="text" id="adminNotifTitle" placeholder="Admin Mesajƒ±" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mesaj</label>
                                        <textarea id="adminNotifMsg" rows="3" placeholder="Bildirim metni..." class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-sm"></textarea>
                                    </div>
                                    <button onclick="window.adminSendNotification()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">G√∂nder</button>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i class="fa-solid fa-file-import text-indigo-500"></i> Toplu Soru Y√ºkle</h3>
                                <div class="space-y-3">
                                    <p class="text-xs text-slate-500 dark:text-slate-400">JSON Format: <code>[{"lesson":"..", "text":"..", "options":[], "correct":0}]</code></p>
                                    <textarea id="bulkJsonData" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-xs font-mono outline-none focus:border-indigo-500" placeholder="JSON buraya..."></textarea>
                                    <button onclick="window.bulkUploadQuestions()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold transition shadow-lg shadow-indigo-500/30">
                                        Sorularƒ± Y√ºkle
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                                <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i class="fa-solid fa-layer-group text-pink-500"></i> Toplu Flashcard Y√ºkle</h3>
                                <div class="space-y-3">
                                    <p class="text-xs text-slate-500 dark:text-slate-400">JSON Format: <code>[{"front":"Soru", "back":"Cevap"}]</code></p>
                                    <textarea id="bulkJsonFlashcards" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-xs font-mono outline-none focus:border-pink-500" placeholder="JSON buraya..."></textarea>
                                    <button onclick="window.bulkUploadFlashcards()" class="w-full bg-pink-600 hover:bg-pink-700 text-white py-2.5 rounded-lg font-bold transition shadow-lg shadow-pink-500/30">
                                        Kartlarƒ± Y√ºkle
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            `;
        }

        // --- ADMIN HELPER FUNCTIONS ---
        window.loadAdminData = async (type) => {
            const container = document.getElementById('adminContentArea');
            container.innerHTML = '<div class="p-8 text-center text-slate-400">Y√ºkleniyor...</div>';
            let html = '';
            
            if (type === 'questions') {
                const q = query(collection(db, "questionSubmissions"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if(snap.empty) html = '<div class="p-8 text-center">Bekleyen soru yok.</div>';
                else {
                      snap.forEach(doc => { const d=doc.data(); html += `
                        <div class="p-6">
                             <div class="flex justify-between mb-2"><span class="badge bg-blue-100 text-blue-800 px-2 rounded">${d.lesson}</span> <span class="text-xs text-slate-500">${d.authorName}</span></div>
                             <p class="font-bold mb-2">${d.text}</p>
                             <div class="grid grid-cols-2 text-sm gap-2 mb-4">${d.options.map((o,i)=>`<div class="${i===d.correct?'text-green-600 font-bold':''}">${String.fromCharCode(65+i)}) ${o}</div>`).join('')}</div>
                             <div class="flex gap-2"><button onclick="window.adminAction('question', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('question', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`; 
                      });
                }
            } else if (type === 'cards') {
                const q = query(collection(db, "flashcardSubmissions"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if(snap.empty) html = '<div class="p-8 text-center">Bekleyen kart yok.</div>';
                else {
                    snap.forEach(doc => { const d=doc.data(); html += `
                        <div class="p-6 flex justify-between items-center">
                            <div><div class="font-bold text-lg">${d.front}</div><div class="text-slate-600 dark:text-slate-400">${d.back}</div><div class="text-xs text-slate-400 mt-1">${d.authorName}</div></div>
                            <div class="flex gap-2"><button onclick="window.adminAction('card', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('card', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'forum') {
                const q = query(collection(db, "forumPosts"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if(snap.empty) html = '<div class="p-8 text-center">Bekleyen konu yok.</div>';
                else {
                    snap.forEach(doc => { const d=doc.data(); html += `
                        <div class="p-6">
                            <h4 class="font-bold text-lg">${d.title}</h4><p class="text-slate-600 dark:text-slate-400 mb-2">${d.content}</p><div class="text-xs text-slate-400 mb-2">${d.category} - ${d.authorName}</div>
                            <div class="flex gap-2"><button onclick="window.adminAction('forum', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('forum', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'inbox') {
                const q = query(collection(db, "feedback"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                snap.forEach(doc => { const d=doc.data(); html += `<div class="p-6"><div class="font-bold text-slate-800 dark:text-white">${d.name}</div><p class="text-slate-600 dark:text-slate-400 mt-1">${d.message}</p><div class="text-xs text-slate-400 mt-2">${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : ''}</div></div>`; });
            }

            container.innerHTML = html || '<div class="p-8 text-center">Veri yok.</div>';
        };

        window.adminAction = async (type, id, action) => {
            const collectionName = type === 'question' ? 'questionSubmissions' : (type === 'card' ? 'flashcardSubmissions' : 'forumPosts');
            const docRef = doc(db, collectionName, id);
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const notifMsg = `G√∂nderin (${type}) y√∂netici tarafƒ±ndan ${action === 'approve' ? 'onaylandƒ±' : 'reddedildi'}.`;
            await addDoc(collection(db, "notifications"), { uid: data.uid, title: "Onay Durumu", message: notifMsg, type: action==='approve'?'success':'error', read: false, createdAt: serverTimestamp() });

            if (action === 'reject') {
                await updateDoc(docRef, { status: 'rejected' });
            } else {
                await updateDoc(docRef, { status: 'approved' });
                // Onaylananlarƒ± ana koleksiyona ta≈üƒ± (CANLI VERƒ∞TABANI)
                if(type === 'question') {
                    await addDoc(collection(db, "questions"), {
                        lesson: data.lesson, text: data.text, options: data.options, correct: data.correct,
                        authorName: data.authorName, uid: data.uid, createdAt: serverTimestamp(), status: 'approved'
                    });
                }
                if(type === 'card') {
                    await addDoc(collection(db, "flashcards"), { 
                        front: data.front, back: data.back, authorName: data.authorName, uid: data.uid, createdAt: serverTimestamp() 
                    });
                }
            }
            alert("ƒ∞≈ülem tamam.");
            loadAdminData(type === 'question' ? 'questions' : (type === 'card' ? 'cards' : 'forum'));
        };

        window.bulkUploadQuestions = async () => {
            const input = document.getElementById('bulkJsonData').value.trim();
            if(!input) return alert("L√ºtfen JSON verisi yapƒ±≈ütƒ±rƒ±n.");
            try {
                const questions = JSON.parse(input);
                if(!Array.isArray(questions)) throw new Error("Veri k√∂≈üeli parantez [] ile ba≈ülamalƒ±.");
                if(questions.length === 0) throw new Error("Liste bo≈ü.");
                if(!confirm(`${questions.length} adet soru YAYINA alƒ±nacak. Emin misin?`)) return;

                const batch = writeBatch(db);
                let count = 0;
                questions.forEach(q => {
                    if(q.lesson && q.text && Array.isArray(q.options) && q.correct !== undefined) {
                        const newRef = doc(collection(db, "questions")); 
                        batch.set(newRef, {
                            lesson: q.lesson, text: q.text, options: q.options, correct: Number(q.correct),
                            authorName: "Sistem", uid: currentUser.uid, createdAt: serverTimestamp(), status: 'approved'
                        });
                        count++;
                    }
                });
                await batch.commit();
                alert(`‚úÖ ƒ∞≈ülem Ba≈üarƒ±lƒ±! ${count} soru canlƒ±ya alƒ±ndƒ±.`);
                document.getElementById('bulkJsonData').value = ""; 
            } catch (e) { console.error(e); alert("‚ùå HATA: " + e.message); } 
        };
        
        // --- EKSƒ∞K OLAN FLASHCARD Y√úKLEME FONKSƒ∞YONU ---
        window.bulkUploadFlashcards = async () => {
            // 1. Elementi Bul
            const inputEl = document.getElementById('bulkJsonFlashcards');
            if (!inputEl) return alert("Hata: JSON kutusu bulunamadƒ±.");
            
            const input = inputEl.value.trim();
            if(!input) return alert("L√ºtfen kutuya JSON verisi yapƒ±≈ütƒ±rƒ±n.");

            try {
                // 2. JSON Ayrƒ±≈ütƒ±rma
                const cards = JSON.parse(input);
                
                // 3. Yapƒ± Kontrol√º
                if(!Array.isArray(cards)) throw new Error("Veri [...] k√∂≈üeli parantez ile ba≈ülamalƒ±dƒ±r.");
                if(cards.length === 0) throw new Error("Liste bo≈ü.");

                if(!confirm(`${cards.length} adet Flashcard YAYINA alƒ±nacak. Emin misin?`)) return;

                // Butonu ge√ßici olarak kilitle
                const btn = document.querySelector('button[onclick="window.bulkUploadFlashcards()"]');
                if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒ∞≈üleniyor...'; }

                // 4. Veritabanƒ±na Yazma (Batch i≈ülemi)
                const batch = writeBatch(db);
                let count = 0;

                cards.forEach((c, index) => {
                    // Anahtarlarƒ±n (Keys) doƒüru olduƒüundan emin oluyoruz
                    if(c.front && c.back) {
                        const newRef = doc(collection(db, "flashcards")); 
                        batch.set(newRef, {
                            front: c.front, 
                            back: c.back,
                            lesson: c.lesson || "General", // Ders belirtilmemi≈üse 'General' yap
                            authorName: "Sistem", 
                            uid: currentUser.uid, 
                            createdAt: serverTimestamp()
                        });
                        count++;
                    } else {
                        console.warn(`Satƒ±r ${index+1} atlandƒ±: 'front' veya 'back' verisi eksik.`);
                    }
                });

                if(count === 0) throw new Error("Y√ºklenecek ge√ßerli kart bulunamadƒ±. JSON formatƒ±nda 'front' ve 'back' alanlarƒ±nƒ±n olduƒüundan emin ol.");

                await batch.commit();
                
                alert(`‚úÖ BA≈ûARILI! ${count} adet kart sisteme y√ºklendi.`);
                inputEl.value = ""; // Kutuyu temizle

            } catch (e) { 
                console.error("Y√ºkleme Hatasƒ±:", e); 
                alert("‚ùå HATA: " + e.message + "\n\nL√ºtfen JSON formatƒ±nƒ± kontrol et."); 
            } finally {
                // Butonu eski haline getir
                const btn = document.querySelector('button[onclick="window.bulkUploadFlashcards()"]');
                if(btn) { btn.disabled = false; btn.innerHTML = 'Kartlarƒ± Y√ºkle'; }
            }
        };

        window.startFlashcardGame = async () => {
            const category = document.getElementById('flashcardCategorySelect').value;
            const btn = document.querySelector('#flashcardStartScreen button');
            
            // Butonu kilitle ve y√ºkleniyor yap
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Y√ºkleniyor...';
            btn.disabled = true;
            
            try {
                // Veritabanƒ±ndan t√ºm kartlarƒ± √ßek
                const q = query(collection(db, "flashcards"));
                const snap = await getDocs(q);
                
                flashcardsPool = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    // Kategori filtreleme: "All" ise hepsi, deƒüilse sadece o ders
                    // Eƒüer veritabanƒ±nda 'lesson' alanƒ± yoksa ve kategori 'General' ise onu da al
                    if(category === 'All' || d.lesson === category || (!d.lesson && category === 'General')) {
                        flashcardsPool.push({ id: doc.id, ...d });
                    }
                });

                // Eƒüer hi√ß kart yoksa uyar
                if(flashcardsPool.length === 0) {
                    alert("Bu kategoride hen√ºz kart bulunamadƒ±.");
                    btn.innerHTML = 'Ba≈üla';
                    btn.disabled = false;
                    return;
                }

                // Kartlarƒ± karƒ±≈ütƒ±r (Shuffle)
                flashcardsPool.sort(() => Math.random() - 0.5);

                // Ekranlarƒ± deƒüi≈ütir (Giri≈ü ekranƒ±nƒ± gizle, Oyunu a√ß)
                document.getElementById('flashcardStartScreen').classList.add('hidden');
                document.getElementById('flashcardGameArea').classList.remove('hidden');
                
                // Rozeti g√ºncelle
                const badge = document.getElementById('fcCategoryBadge');
                if(badge) badge.innerText = category === 'All' ? 'Karƒ±≈üƒ±k' : category;
                
                // ƒ∞LK KARTI GETƒ∞R
                window.nextCard();
                
                // Butonu resetle (geri d√∂n√ºl√ºrse hazƒ±r olsun)
                btn.innerHTML = 'Ba≈üla';
                btn.disabled = false;

            } catch (e) {
                console.error("Kart y√ºkleme hatasƒ±:", e);
                alert("Kartlar y√ºklenirken hata olu≈ütu: " + e.message);
                btn.innerHTML = 'Ba≈üla';
                btn.disabled = false;
            }
        };

        window.nextCard = () => {
            // 1. Havuz kontrol√º
            if(!flashcardsPool || flashcardsPool.length === 0) {
                alert("G√∂sterilecek kart kalmadƒ±! Kategori se√ßimine d√∂n√ºl√ºyor.");
                window.switchCardTab('browse'); 
                return;
            }

            // 2. Rastgele bir kart se√ß
            const randomIndex = Math.floor(Math.random() * flashcardsPool.length);
            currentCard = flashcardsPool[randomIndex];
            
            // 3. Kart elementini bul
            const cardEl = document.querySelector('.flip-card');
            
            if(cardEl) {
                // Eƒüer kartƒ±n arkasƒ± d√∂n√ºkse (cevap a√ßƒ±ksa), √∂nce √∂n y√ºz√ºn√º √ßevir
                if(cardEl.classList.contains('flipped')) {
                    cardEl.classList.remove('flipped');
                    
                    // Animasyonun bitmesini bekle (300ms), sonra yazƒ±larƒ± deƒüi≈ütir
                    // Bu sayede kullanƒ±cƒ± yazƒ±nƒ±n deƒüi≈ütiƒüini √ßevrilirken g√∂rmez
                    setTimeout(() => {
                        updateCardText();
                    }, 300);
                } else {
                    // Zaten √∂n y√ºzdeyse direkt deƒüi≈ütir
                    updateCardText();
                }
            } else {
                // Element bulunamazsa (nadiren olur) direkt g√ºncelle
                updateCardText();
            }
            
            // ƒ∞√ß yardƒ±mcƒ± fonksiyon: Metinleri g√ºncelle
            function updateCardText() {
                const frontEl = document.getElementById('fcFront');
                const backEl = document.getElementById('fcBack');
                
                if(frontEl) frontEl.innerText = currentCard.front;
                if(backEl) backEl.innerText = currentCard.back;
            }
        };

        window.adminSendNotification = async () => {
            const targetUid = document.getElementById('adminNotifUid').value.trim();
            const title = document.getElementById('adminNotifTitle').value.trim() || "Sistem Mesajƒ±";
            const message = document.getElementById('adminNotifMsg').value.trim();
            if(!message) return alert("Mesaj yazmalƒ±sƒ±n.");

            const notifData = { message, title, type: 'info', read: false, createdAt: serverTimestamp() };

            if(targetUid) {
                await addDoc(collection(db, "notifications"), { ...notifData, uid: targetUid });
                alert("Bildirim g√∂nderildi (Tekil).");
            } else {
                if(!confirm("T√úM kullanƒ±cƒ±lara bildirim gidecek. Emin misin?")) return;
                const usersSnap = await getDocs(collection(db, "users"));
                const batch = writeBatch(db);
                let count = 0;
                usersSnap.forEach(doc => {
                    if(doc.id !== currentUser.uid) {
                        const newRef = doc(collection(db, "notifications"));
                        batch.set(newRef, { ...notifData, uid: doc.id });
                        count++;
                    }
                });
                await batch.commit();
                alert(`Toplam ${count} kullanƒ±cƒ±ya bildirim g√∂nderildi.`);
            }
            document.getElementById('adminNotifMsg').value = "";
        };

        window.notifyAdmin = async (msg) => {
            const q = query(collection(db, "users"), where("email", "==", ADMIN_EMAIL));
            const snap = await getDocs(q);
            snap.forEach(async d => {
                 await addDoc(collection(db, "notifications"), { uid: d.id, title: "Y√∂netici Uyarƒ±sƒ±", message: msg, type: 'warning', read: false, createdAt: serverTimestamp() });
            });
        };

        // --- 19. MOCKS MODULE ---
        function renderMocks() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-32">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Yeni Deneme Ekle</h2>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500">T√ºrk√ße Net</label><input type="number" id="netTr" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Matematik Net</label><input type="number" id="netMat" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Tarih Net</label><input type="number" id="netHist" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Coƒürafya Net</label><input type="number" id="netGeo" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Vatanda≈ülƒ±k Net</label><input type="number" id="netCit" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                            </div>
                            <button onclick="window.saveMockResult()" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primaryDark mt-4">Hesapla ve Kaydet</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Sonu√ß Ge√ßmi≈üi</h2>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden max-h-96 overflow-y-auto">
                            ${mockExamsHistory.length === 0 ? '<p class="p-4 text-slate-500">Kayƒ±t yok.</p>' : ''}
                            ${mockExamsHistory.map(m => `
                                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700">
                                    <div>
                                        <div class="font-bold text-slate-800 dark:text-white">${m.date}</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">TR: ${m.trNet} | MAT: ${m.mathNet} | TAR: ${m.histNet}</div>
                                    </div>
                                    <div class="text-xl font-bold text-primary">${m.totalScore} Puan</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-2xl h-80 border border-slate-100 dark:border-slate-700 shadow-sm pb-32">
                    <h3 class="font-bold mb-4 dark:text-white">ƒ∞lerleme Analizi</h3>
                    <canvas id="historyChart"></canvas>
                </div>
            `;
        }

        window.saveMockResult = async () => {
            const tr = Number(document.getElementById('netTr').value) || 0;
            const mat = Number(document.getElementById('netMat').value) || 0;
            const hist = Number(document.getElementById('netHist').value) || 0;
            const geo = Number(document.getElementById('netGeo').value) || 0;
            const cit = Number(document.getElementById('netCit').value) || 0;

            const gy = tr + mat;
            const gk = hist + geo + cit;
            let score = Math.round(55 + (gy * 0.4) + (gk * 0.4)); 
            if(score > 100) score = 100;

            const data = {
                trNet: tr, mathNet: mat, histNet: hist, geoNet: geo, citNet: cit,
                totalScore: score,
                date: new Date().toLocaleDateString('tr-TR'),
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, `users/${currentUser.uid}/mockExams`), data);
            await updateDoc(doc(db, "users", currentUser.uid), { totalScore: score });
            
            alert(`Puanƒ±n: ${score}. Kaydedildi!`);
            window.loadPage('mocks');
        };

        async function loadMocks() {
            const q = query(collection(db, `users/${currentUser.uid}/mockExams`), orderBy("createdAt", "desc"), limit(10));
            onSnapshot(q, (s) => { 
                mockExamsHistory=[]; 
                s.forEach(d=>mockExamsHistory.push(d.data())); 
                const content = document.getElementById('contentArea');
                if(content.innerHTML.includes('Yeni Deneme Ekle') || content.innerHTML.includes('Puan Grafiƒüi')) {
                    const active = document.querySelector('.active-nav');
                    if(active) window.loadPage(active.id.replace('nav-', ''));
                }
            });
        }

        function renderChart(canvasId) {
            const ctx = document.getElementById(canvasId);
            if(!ctx || mockExamsHistory.length === 0) return;
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) existingChart.destroy();

            const labels = mockExamsHistory.slice().reverse().map(m => m.date);
            const data = mockExamsHistory.slice().reverse().map(m => m.totalScore);
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e2e8f0' : '#64748b';

            new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'Puan', 
                        data: data, 
                        borderColor: '#f97316', 
                        backgroundColor: 'rgba(249, 115, 22, 0.1)', 
                        fill: true, 
                        tension: 0.4 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: false, min: 50, max: 100, ticks: { color: textColor } },
                        x: { ticks: { color: textColor } }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                } 
            });
        }

        // --- GLOBAL HELPERS & CLOSING ---
        
        // ≈ûƒ∞KAYET MEKANƒ∞ZMASI
        window.reportContent = async (type, id, contentSummary) => {
            if(!confirm("Bu i√ßeriƒüi hatalƒ±/uygunsuz olarak bildirmek istiyor musun?")) return;
            
            const message = `KULLANICI ≈ûƒ∞KAYETƒ∞: Bir ${type} ≈üikayet edildi.\nID: ${id}\nƒ∞√ßerik √ñzeti: ${contentSummary || 'Belirtilmedi'}`;
            
            // Admin'e bildirim g√∂nder
            const q = query(collection(db, "users"), where("email", "==", ADMIN_EMAIL));
            const snap = await getDocs(q);
            snap.forEach(async d => {
                 await addDoc(collection(db, "notifications"), { 
                     uid: d.id, 
                     title: "‚ö†Ô∏è ƒ∞√ßerik ≈ûikayeti", 
                     message: message, 
                     type: 'error', 
                     read: false, 
                     createdAt: serverTimestamp() 
                 });
            });
            alert("Bildiriminiz y√∂neticilere iletildi. Te≈üekk√ºrler.");
        };

        window.deleteLiveItem = async (col, id) => {
            if(confirm("Y√ñNETƒ∞Cƒ∞ YETKƒ∞Sƒ∞: Bu canlƒ± veriyi silmek √ºzeresin!")) {
                await deleteDoc(doc(db, col, id));
                alert("Silindi.");
                // Sayfayƒ± yenile veya yeniden y√ºkle
                if(col === 'questions') { window.startQuizGame(); }
                if(col === 'flashcards') { window.nextCard(); }
            }
        };

        window.addToMistakes = async (qId) => {
            const docRef = doc(db, "questions", qId);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()) {
                const data = docSnap.data();
                await setDoc(doc(db, `users/${currentUser.uid}/mistakes/${qId}`), {
                    lesson: data.lesson,
                    text: data.text,
                    options: data.options,
                    correct: data.correct,
                    addedAt: serverTimestamp()
                });
            }
        };

        window.checkMistakeAnswer = async (docId, selectedIdx, correctIdx) => {
            const feedback = document.getElementById(`feedback-${docId}`);
            const buttons = document.querySelectorAll(`.mistake-opt-${docId}`);
            
            buttons.forEach(btn => btn.disabled = true);

            if (selectedIdx === correctIdx) {
                feedback.innerHTML = '<span class="text-green-500"><i class="fa-solid fa-check"></i> Doƒüru! Kutu temizleniyor...</span>';
                feedback.classList.remove('hidden');
                buttons[selectedIdx].classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                
                setTimeout(async () => {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/mistakes/${docId}`));
                    const el = document.getElementById(`mistake-${docId}`);
                    if(el) {
                        el.style.transition = 'all 0.5s';
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            el.remove();
                            if(document.getElementById('mistakesList').children.length === 0) loadMistakes();
                        }, 500);
                    }
                }, 1500);
            } else {
                feedback.innerHTML = '<span class="text-red-500"><i class="fa-solid fa-xmark"></i> Yanlƒ±≈ü. Tekrar dene!</span>';
                feedback.classList.remove('hidden');
                buttons[selectedIdx].classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                setTimeout(() => {
                      buttons.forEach(btn => {
                          btn.disabled = false;
                          btn.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');
                      });
                      feedback.classList.add('hidden');
                }, 1500);
            }
        };

        window.deleteMistake = async (id) => {
            if(confirm("Bu soruyu kutudan silmek istiyor musun?")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/mistakes/${id}`));
                loadMistakes();
            }
        };

        window.saveNote = async () => { const txt = document.getElementById('newNoteText').value; if(!txt) return; await addDoc(collection(db, `users/${currentUser.uid}/notes`), { text: txt, createdAt: serverTimestamp() }); document.getElementById('newNoteText').value = ""; loadMyNotes(); };
        window.deleteNote = async (id) => { if(confirm("Sileyim mi?")) { await deleteDoc(doc(db, `users/${currentUser.uid}/notes/${id}`)); loadMyNotes(); } };
        window.toggleTimer = () => { if(isTimerRunning) { clearInterval(pomodoroInterval); isTimerRunning = false; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; } else { isTimerRunning = true; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-pause text-[10px]"></i>'; pomodoroInterval = setInterval(() => { pomodoroTimeLeft--; const m = Math.floor(pomodoroTimeLeft / 60).toString().padStart(2, '0'); const s = (pomodoroTimeLeft % 60).toString().padStart(2, '0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; if(pomodoroTimeLeft <= 0) { clearInterval(pomodoroInterval); isTimerRunning = false; alert("Pomodoro Bitti! +1 Puan"); savePomodoroSession(); pomodoroTimeLeft = 25 * 60; document.getElementById('timerDisplay').innerText = "25:00"; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; } }, 1000); } };
        window.resetTimer = () => { clearInterval(pomodoroInterval); isTimerRunning = false; pomodoroTimeLeft = 25 * 60; document.getElementById('timerDisplay').innerText = "25:00"; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; };
        async function savePomodoroSession() { const newCount = (userData.pomodoroSessions || 0) + 1; userData.pomodoroSessions = newCount; document.getElementById('pomodoroCount').innerText = newCount + " Seans"; await updateDoc(doc(db, "users", currentUser.uid), { pomodoroSessions: newCount }); }
        window.cycleStatus = async (key) => { if(!userData.progress) userData.progress = {}; const current = userData.progress[key] || 'not_started'; const currentIdx = ['not_started', 'started', 'completed', 'needs_review'].indexOf(current); const next = ['not_started', 'started', 'completed', 'needs_review'][(currentIdx + 1) % 4]; userData.progress[key] = next; window.loadPage('subjects'); await updateDoc(doc(db, "users", currentUser.uid), { progress: userData.progress }); };
        window.deleteAccountRequest = async () => { if(confirm("Hesabƒ±nƒ± silmek istediƒüine emin misin?")) { try { await deleteDoc(doc(db, "users", currentUser.uid)); await deleteUser(currentUser); alert("Hesabƒ±nƒ±z silindi."); window.location.reload(); } catch(e) { alert("Hata: " + e.message); } } };
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } catch(e){alert(e.message)} };
        window.handleRegister = async () => { try { if(!document.getElementById('privacyCheck').checked) throw new Error("Onay gerekli"); const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPassword').value); await setDoc(doc(db, "users", cred.user.uid), {name: document.getElementById('regName').value, email: cred.user.email, progress: {}, targetScore: 85, createdAt: serverTimestamp(), avatar: AVATAR_OPTIONS[0], pomodoroSessions: 0, totalScore: 0 }); } catch(e){alert(e.message)} };
        
        window.logout = async () => { await signOut(auth); window.location.reload(); };
        window.toggleAuth = (type) => { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('registerForm').classList.add('hidden'); document.getElementById(type === 'login' ? 'loginForm' : 'registerForm').classList.remove('hidden'); };
        window.showPrivacyModal = () => document.getElementById('privacyModal').classList.remove('hidden');
        window.closePrivacyModal = () => document.getElementById('privacyModal').classList.add('hidden');
        async function loadMyNotes() { const q = query(collection(db, `users/${currentUser.uid}/notes`), orderBy("createdAt", "desc")); const snap = await getDocs(q); myNotes = []; snap.forEach(d => myNotes.push({ id: d.id, text: d.data().text, date: new Date(d.data().createdAt?.seconds * 1000).toLocaleDateString() })); if(document.getElementById('nav-notes').classList.contains('active-nav')) window.loadPage('notes'); }
        function calculateStats() { let totalTopics = 0, completed = 0, started = 0; for(let les in CURRICULUM) { totalTopics += CURRICULUM[les].length; CURRICULUM[les].forEach(t => { const s = (userData.progress || {})[les+"_"+t]; if(s === 'completed') completed++; if(s === 'started') started++; }); } const totalProgress = Math.round((completed/totalTopics)*100) || 0; const avgScore = mockExamsHistory.length > 0 ? Math.round(mockExamsHistory.reduce((a,b)=>a+b.totalScore,0)/mockExamsHistory.length) : 0; let situation = "Veri giri≈üi bekleniyor.", strategy = "√ñnce konulara ba≈üla.", shortAdvice = "Ba≈ülamak bitirmenin yarƒ±sƒ±dƒ±r.", weakness = "Veri yok.", motivation = "Yolun ba≈üƒ±ndasƒ±n."; if(totalProgress < 10) { situation = "Hen√ºz yolun ba≈üƒ±ndasƒ±n."; strategy = "Konulara y√ºklen."; shortAdvice = "Konu eksiƒüin √ßok."; } else if(totalProgress < 50) { situation = "Orta seviye."; strategy = "Tekrarlara ba≈üla."; shortAdvice = "Yarƒ±lamak √ºzeresin."; } else { situation = "Konular bitiyor."; strategy = "Deneme √ß√∂z."; shortAdvice = "Deneme vakti!"; } if(mockExamsHistory.length > 0 && avgScore < 70) weakness = "Netlerin d√º≈ü√ºk."; else if(avgScore > 85) motivation = "Derece yapabilirsin!"; return { totalProgress, avgScore, completedCount: completed, startedCount: started, situationAnalysis: situation, strategyAdvice: strategy, weaknessAnalysis: weakness, motivationMsg: motivation, shortAdvice }; }
        function updateSidebar() { 
    if(!userData) return; 
    document.getElementById('sidebarName').innerText = userData.name; 
    document.getElementById('sidebarAvatar').src = userData.avatar; 
    
    // Admin kontrol√ºyle unvan belirleme
    const sidebarTitle = document.getElementById('sidebarTitle');
    if (currentUser.email.toLowerCase() === "alnigamestudios@gmail.com") {
        sidebarTitle.innerText = "Y√∂netici";
        sidebarTitle.classList.add('text-red-500'); // Y√∂neticiyi kƒ±rmƒ±zƒ± yapalƒ±m
    } else {
        sidebarTitle.innerText = userData.title || '√ñƒürenci';
        sidebarTitle.classList.remove('text-red-500');
    }

    document.getElementById('pomodoroCount').innerText = (userData.pomodoroSessions || 0) + " Seans"; 
    document.getElementById('mobileAvatar').src = userData.avatar;
    if(document.getElementById('sidebarXP')) document.getElementById('sidebarXP').innerText = userData.xp || 0;
}
    </script>
</body>

</html>

