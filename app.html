<!DOCTYPE html>
<html lang="tr" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al&Ni KPSS Studio | Al&Ni Studios</title>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1105930817107200"
        crossorigin="anonymous"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#f97316',
                        primaryDark: '#ea580c',
                        secondary: '#fff7ed',
                        success: '#22c55e',
                        warning: '#eab308',
                        danger: '#ef4444',
                        studio: '#1e293b',
                        darkBg: '#0f172a',
                        darkCard: '#1e293b',
                        darkText: '#f1f5f9'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #f97316;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .status-btn {
            transition: all 0.2s;
        }

        .status-btn:active {
            transform: scale(0.95);
        }

        .nav-item.active-nav {
            background-color: #fff7ed;
            color: #f97316;
            border-right: 3px solid #f97316;
            font-weight: 600;
        }

        .dark .nav-item.active-nav {
            background-color: #334155;
            color: #fb923c;
            border-right: 3px solid #fb923c;
        }

        .avatar-option:hover {
            transform: scale(1.1);
            border-color: #f97316;
        }

        .avatar-option.selected {
            border-color: #f97316;
            ring: 2px solid #f97316;
            transform: scale(1.1);
        }

        .perspective {
            perspective: 1000px;
        }

        .flip-card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .flip-card-back {
            background-color: #f97316;
            color: white;
            transform: rotateY(180deg);
        }

        .sticky-note {
            background: #fef3c7;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
            border-bottom-right-radius: 20px;
        }

        .dark .sticky-note {
            background: #f59e0b;
            color: #000;
        }

        /* BahÃ§e ve Program Stilleri */
        .garden-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 1rem;
        }

        .plant-slot {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transition: all 0.3s;
            position: relative;
        }

        .dark .plant-slot {
            background: rgba(30, 41, 59, 0.5);
        }

        .plant-slot:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .plant-icon {
            font-size: 2rem;
            animation: growPlant 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes growPlant {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* AkÄ±llÄ± Program Mobil Uyumu */
        .scheduler-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 1rem;
            min-height: 500px;
        }

        @media (min-width: 1024px) {
            .scheduler-container {
                flex-direction: row;
                overflow-x: auto;
            }
        }

        .scheduler-col {
            min-width: 200px;
            flex: 1;
            background: #f8fafc;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .dark .scheduler-col {
            background: #1e293b;
            border-color: #334155;
        }

        .col-header {
            padding: 0.75rem;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            background: #f1f5f9;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .dark .col-header {
            background: #0f172a;
            border-color: #334155;
            color: #cbd5e1;
        }

        .col-body {
            padding: 0.5rem;
            flex: 1;
            min-height: 100px;
        }

        .col-body.drag-over {
            background-color: rgba(249, 115, 22, 0.1);
            border: 2px dashed #f97316;
        }

        #subjectSourceList.drag-over {
            background-color: rgba(239, 68, 68, 0.1);
            border: 2px dashed #ef4444;
        }

        .drag-item {
            background: white;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 0.8rem;
            cursor: grab;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .dark .drag-item {
            background: #334155;
            color: #f1f5f9;
        }

        .drag-item:hover {
            border-color: #f97316;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .drag-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .countdown-item span {
            display: block;
        }

        /* Tab Active State */
        .tab-btn-active {
            color: #f97316;
            border-bottom: 2px solid #f97316;
            background-color: rgba(249, 115, 22, 0.05);
        }

        /* ÅžÄ±klar ve Kart Efektleri */
        .quiz-option {
            transition: all 0.2s;
        }

        .quiz-option:hover:not(:disabled) {
            transform: translateX(5px);
            border-color: #f97316;
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }

            100% {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body
    class="text-slate-800 bg-slate-50 dark:bg-darkBg dark:text-darkText h-screen overflow-hidden flex flex-col transition-colors duration-300">


    <div id="appContainer" class="hidden flex h-full relative">

        <div id="mobileOverlay" onclick="window.toggleSidebar()"
            class="fixed inset-0 bg-black/50 z-40 hidden md:hidden glass-effect transition-opacity"></div>

        <aside id="mainSidebar"
            class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-darkCard border-r border-slate-200 dark:border-slate-700 flex flex-col justify-between transform -translate-x-full md:translate-x-0 transition-transform duration-300 md:static md:flex shrink-0 h-full shadow-2xl md:shadow-none transition-colors duration-300">

            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div
                            class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center text-white font-bold text-xl">
                            A</div>
                        <div>
                            <h2 class="font-bold text-slate-800 dark:text-white leading-tight">Al&Ni KPSS</h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Ultimate Pro Max</p>
                        </div>
                    </div>
                    <button onclick="window.toggleSidebar()"
                        class="md:hidden text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div
                    class="p-4 bg-secondary dark:bg-slate-800 m-4 rounded-xl border border-orange-100 dark:border-slate-600 text-center shrink-0">
                    <img id="sidebarAvatar" src=""
                        class="w-12 h-12 rounded-full mx-auto border-2 border-white dark:border-slate-700 shadow-sm mb-2 bg-white dark:bg-slate-600">
                    <div id="sidebarName" class="text-sm font-bold text-slate-800 dark:text-white">...</div>
                    <div class="flex justify-center items-center gap-2 mt-1">
                        <div id="sidebarTitle" class="text-xs text-primary font-semibold">...</div>
                        <div class="text-xs bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 px-1.5 py-0.5 rounded font-bold"
                            title="XP PuanÄ±">
                            <i class="fa-solid fa-star text-[10px] mr-1"></i><span id="sidebarXP">0</span>
                        </div>
                    </div>
                </div>

                <nav class="px-4 space-y-1 text-sm mt-2 flex-1 overflow-y-auto pb-4">
                    <button id="nav-dashboard" onclick="window.loadPage('dashboard')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-chart-pie w-5"></i><span>Genel BakÄ±ÅŸ</span></button>
                    <button id="nav-smartcoach" onclick="window.loadPage('smartcoach')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-brain w-5 text-purple-600"></i><span
                            class="font-bold text-purple-700 dark:text-purple-400">SmartCoach AI</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">VERÄ°MLÄ°LÄ°K</div>
                    <button id="nav-garden" onclick="window.loadPage('garden')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-seedling w-5 text-green-500"></i><span class="font-bold">Odak
                            BahÃ§esi</span></button>
                    <button id="nav-scheduler" onclick="window.loadPage('scheduler')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-calendar-week w-5 text-indigo-500"></i><span>AkÄ±llÄ±
                            Program</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">TOPLULUK</div>
                    <button id="nav-league" onclick="window.loadPage('league')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-trophy w-5 text-yellow-500"></i><span>HaftalÄ±k Lig</span></button>
                    <button id="nav-market" onclick="window.loadPage('market')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-shop w-5 text-pink-500"></i><span>Not PazarÄ±</span></button>
                    <button id="nav-etut" onclick="window.loadPage('etut')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-users-viewfinder w-5 text-blue-500"></i><span class="font-bold">Sanal
                            EtÃ¼t</span></button>
                    <button id="nav-forum" onclick="window.loadPage('forum')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-comments w-5"></i><span>Forum</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">Ã‡ALIÅžMA</div>
                    <button id="nav-mistakes" onclick="window.loadPage('mistakes')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-triangle-exclamation w-5 text-red-500"></i><span>Hata
                            Kutusu</span></button>
                    <button id="nav-subjects" onclick="window.loadPage('subjects')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-list-check w-5"></i><span>Konu Takip</span></button>
                    <button id="nav-quiz" onclick="window.loadPage('quiz')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-pen-nib w-5"></i><span>Soru Merkezi</span></button>
                    <button id="nav-cards" onclick="window.loadPage('cards')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-layer-group w-5"></i><span>Flashcards</span></button>
                    <button id="nav-mocks" onclick="window.loadPage('mocks')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-chart-line w-5"></i><span>Deneme & Analiz</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">EKSTRA</div>
                    <button id="nav-leaderboard" onclick="window.loadPage('leaderboard')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-trophy w-5 text-yellow-600"></i><span>Genel SÄ±ralama</span></button>
                    <button id="nav-notes" onclick="window.loadPage('notes')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-sticky-note w-5"></i><span>Not Defterim</span></button>
                    <button id="nav-feedback" onclick="window.loadPage('feedback')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-paper-plane w-5"></i><span>Ã–neri / Åžikayet</span></button>

                    <div class="pt-2 pb-1 text-xs font-bold text-slate-400 px-4">KÄ°ÅžÄ°SEL</div>
                    <button id="nav-notifications" onclick="window.loadPage('notifications')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition relative">
                        <i class="fa-solid fa-bell w-5"></i><span>Bildirimler</span>
                        <span id="notifBadge"
                            class="hidden absolute top-2 right-4 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full border border-white dark:border-slate-800">0</span>
                    </button>
                    <button id="nav-profile" onclick="window.loadPage('profile')"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition"><i
                            class="fa-solid fa-user-gear w-5"></i><span>Ayarlar</span></button>

                    <button id="adminLink" onclick="window.loadPage('admin')"
                        class="hidden nav-item w-full flex items-center space-x-3 px-4 py-3 text-red-600 bg-red-50 dark:bg-red-900/20 dark:text-red-400 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/40 transition mt-4"><i
                            class="fa-solid fa-shield-halved w-5"></i><span>YÃ¶netim Paneli</span></button>
                    <!-- YKS MODÃœLÃœNE GEÃ‡Ä°Åž BUTONU -->
                    <a href="yks.html"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition font-bold group mt-2 border border-slate-100 dark:border-slate-700">
                        <div
                            class="w-5 h-5 bg-gradient-to-r from-orange-500 to-pink-500 rounded flex items-center justify-center text-white text-[10px]">
                            <i class="fa-solid fa-graduation-cap"></i>
                        </div>
                        <span
                            class="bg-gradient-to-r from-orange-600 to-pink-600 bg-clip-text text-transparent group-hover:text-primary transition-colors">YKS
                            ModÃ¼lÃ¼ne GeÃ§</span>
                    </a>
                    <a href="dgs.html"
                        class="nav-item w-full flex items-center space-x-3 px-4 py-3 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-orange-50 dark:hover:bg-slate-700 hover:text-primary transition font-bold group mt-2 border border-slate-100 dark:border-slate-700">
                        <div
                            class="w-5 h-5 bg-gradient-to-r from-orange-500 to-pink-500 rounded flex items-center justify-center text-white text-[10px]">
                            <i class="fa-solid fa-graduation-cap"></i>
                        </div>
                        <span
                            class="bg-gradient-to-r from-orange-600 to-pink-600 bg-clip-text text-transparent group-hover:text-primary transition-colors">DGS
                            ModÃ¼lÃ¼ne GeÃ§</span>
                    </a>
                </nav>
            </div>
            <div class="bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-4">
                <div class="bg-slate-800 dark:bg-slate-700 rounded-xl p-3 text-white text-center mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-slate-400">POMODORO</span>
                        <span class="text-[10px] text-green-400" id="pomodoroCount">0 Seans</span>
                    </div>
                    <div id="timerDisplay" class="text-xl font-mono font-bold mb-2">25:00</div>
                    <div class="flex justify-center space-x-2">
                        <button onclick="window.toggleTimer()" id="timerBtn"
                            class="w-6 h-6 rounded-full bg-primary hover:bg-primaryDark flex items-center justify-center"><i
                                class="fa-solid fa-play text-[10px]"></i></button>
                        <button onclick="window.resetTimer()"
                            class="w-6 h-6 rounded-full bg-slate-600 hover:bg-slate-500 flex items-center justify-center"><i
                                class="fa-solid fa-rotate-right text-[10px]"></i></button>
                    </div>
                </div>

                <button onclick="window.toggleTheme()"
                    class="w-full flex items-center justify-center space-x-2 text-slate-500 dark:text-slate-400 hover:text-primary hover:bg-orange-50 dark:hover:bg-slate-700 p-2 rounded-lg transition text-sm font-medium mb-2">
                    <i class="fa-solid fa-moon dark:hidden"></i>
                    <i class="fa-solid fa-sun hidden dark:inline"></i>
                    <span class="dark:hidden">KaranlÄ±k Mod</span>
                    <span class="hidden dark:inline">AydÄ±nlÄ±k Mod</span>
                </button>

                <button onclick="window.logout()"
                    class="w-full flex items-center justify-center space-x-2 text-slate-500 dark:text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-lg transition text-sm font-medium">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Ã‡Ä±kÄ±ÅŸ Yap</span>
                </button>
            </div>
        </aside>

        <main
            class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50 dark:bg-darkBg transition-colors duration-300">
            <header
                class="md:hidden h-16 bg-white dark:bg-darkCard border-b dark:border-slate-700 flex items-center justify-between px-4 z-30 shrink-0 shadow-sm transition-colors duration-300">
                <div class="flex items-center space-x-3">
                    <button onclick="window.toggleSidebar()"
                        class="text-slate-600 dark:text-slate-300 hover:text-primary transition p-2">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="font-bold text-primary text-lg">Al&Ni KPSS</div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="window.toggleTheme()" class="text-slate-500 dark:text-slate-300 p-2">
                        <i class="fa-solid fa-moon dark:hidden"></i>
                        <i class="fa-solid fa-sun hidden dark:inline"></i>
                    </button>
                    <button onclick="window.loadPage('notifications')"
                        class="text-slate-500 dark:text-slate-300 relative">
                        <i class="fa-solid fa-bell"></i>
                        <span id="mobileNotifBadge"
                            class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] w-3 h-3 flex items-center justify-center rounded-full">0</span>
                    </button>
                    <img id="mobileAvatar" src=""
                        class="w-8 h-8 rounded-full border border-slate-200 dark:border-slate-600">
                </div>
            </header>

            <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 pb-32 relative"></div>
        </main>
    </div>

    <div id="privacyModal"
        class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div
            class="bg-white dark:bg-darkCard rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col mx-4 transition-colors duration-300">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Gizlilik PolitikasÄ± ve KullanÄ±m ÅžartlarÄ±
                </h3>
                <button onclick="window.closePrivacyModal()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-600 dark:text-slate-300 space-y-4">
                <p><strong>1. Veri Toplama:</strong> Al&Ni KPSS Studio, ilerleme durumunuzu takip etmek iÃ§in e-posta,
                    Ã§alÄ±ÅŸma istatistikleri ve hedef puan verilerini saklar.</p>
                <p><strong>2. GÃ¼venlik:</strong> Verileriniz Firebase altyapÄ±sÄ±nda ÅŸifrelenmiÅŸ olarak saklanÄ±r. 3.
                    ÅŸahÄ±slarla paylaÅŸÄ±lmaz.</p>
                <p><strong>3. Hesap Silme:</strong> KullanÄ±cÄ± dilediÄŸi zaman profil ayarlarÄ±ndan "HesabÄ±mÄ± Sil"
                    talebinde bulunabilir.</p>
                <p><strong>4. Sorumluluk Reddi:</strong> Bu uygulama bir hazÄ±rlÄ±k aracÄ±dÄ±r.</p>
            </div>
            <div
                class="p-6 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 rounded-b-xl flex justify-end">
                <button onclick="window.closePrivacyModal()"
                    class="bg-primary text-white px-6 py-2 rounded-lg font-medium hover:bg-primaryDark">AnladÄ±m</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, addDoc, collection, query, orderBy, limit, onSnapshot, serverTimestamp, where, getDocs, deleteDoc, arrayUnion, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        const firebaseConfig = {
            apiKey: "AIzaSyDVVuIdQzbPZqWaMLtkV0mRjr5qHOng460",
            authDomain: "alnikpss.firebaseapp.com",
            projectId: "alnikpss",
            storageBucket: "alnikpss.firebasestorage.app",
            messagingSenderId: "546288972320",
            appId: "1:546288972320:web:997647b8542e41f28f8245",
            measurementId: "G-XGCG35CPFJ"
        };

        // --- AL&NI AI ENGINE: GÃœNCEL VE ZIRHLI YAPI ---
        const API_KEY = "AIzaSyB5HCyCxzZbtPhD6FRUhqrb0gKwvQY67mo";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DARK MODE LOGIC ---
        window.initializeTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };

        window.toggleTheme = () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        };

        window.initializeTheme();

        // --- SLIDER LOGIC ---
        let currentSlide = 0;
        const totalSlides = 3;

        window.moveSlide = (n) => {
            currentSlide = (currentSlide + n + totalSlides) % totalSlides;
            const track = document.getElementById('sliderTrack');
            if (track) track.style.transform = `translateX(-${currentSlide * 100}%)`;
        };

        setInterval(() => { if (!currentUser) window.moveSlide(1); }, 5000);

        // --- CONSTANTS ---
        const CURRICULUM = {
            "TÃ¼rkÃ§e": ["SÃ¶zcÃ¼kte Anlam", "CÃ¼mlede Anlam", "Paragrafta Anlam", "Noktalama Ä°ÅŸaretleri", "YapÄ± Bilgisi", "Ses Bilgisi", "SÃ¶zcÃ¼k Bilgisi", "CÃ¼mle Bilgisi", "YazÄ±m KurallarÄ±", "AnlatÄ±m BozukluklarÄ±", "SÃ¶zel MantÄ±k"],
            "Matematik": ["Temel Kavramlar", "SayÄ±lar", "BÃ¶lme-BÃ¶lÃ¼nebilme", "Asal Ã‡arpanlar", "EBOB-EKOK", "1. Derece Denklemler", "Rasyonel SayÄ±lar", "EÅŸitsizlik", "Mutlak DeÄŸer", "ÃœslÃ¼ SayÄ±lar", "KÃ¶klÃ¼ SayÄ±lar", "Ã‡arpanlara AyÄ±rma", "Oran-OrantÄ±", "Problemler", "KÃ¼meler", "Fonksiyonlar", "PermÃ¼tasyon-Kombinasyon", "OlasÄ±lÄ±k"],
            "Tarih": ["Ä°slamiyet Ã–ncesi TÃ¼rk Tarihi", "TÃ¼rk-Ä°slam Tarihi", "Ä°lk TÃ¼rk Devletleri", "Anadolu SelÃ§uklu", "OsmanlÄ± KÃ¼ltÃ¼r Medeniyet", "OsmanlÄ± KuruluÅŸ-YÃ¼kselme", "OsmanlÄ± Duraklama-Gerileme", "Trablusgarp & Balkan SavaÅŸlarÄ±", "I. DÃ¼nya SavaÅŸÄ±", "KurtuluÅŸ SavaÅŸÄ± HazÄ±rlÄ±k", "KurtuluÅŸ SavaÅŸÄ± Muharebeler", "AtatÃ¼rk Ä°lkeleri", "DÄ±ÅŸ Politika", "Ã‡aÄŸdaÅŸ TÃ¼rk DÃ¼nyasÄ±"],
            "CoÄŸrafya": ["CoÄŸrafi Konum", "Yer Åžekilleri", "Ä°klim ve Bitki Ã–rtÃ¼sÃ¼", "NÃ¼fus ve YerleÅŸme", "TarÄ±m ve HayvancÄ±lÄ±k", "Madenler ve Enerji", "Sanayi ve Ticaret", "UlaÅŸÄ±m ve Turizm", "BÃ¶lgesel KalkÄ±nma"],
            "VatandaÅŸlÄ±k": ["Hukukun Temel KavramlarÄ±", "Anayasa Tarihi", "Temel Hak ve HÃ¼rriyetler", "Yasama", "YÃ¼rÃ¼tme", "YargÄ±", "Ä°dare Hukuku", "UluslararasÄ± KuruluÅŸlar", "GÃ¼ncel Bilgiler"]
        };

        const STATUS_TYPES = {
            'not_started': { label: 'BaÅŸlamadÄ±', color: 'bg-slate-100 text-slate-500 dark:bg-slate-700 dark:text-slate-300', icon: 'fa-circle' },
            'started': { label: 'Ã‡alÄ±ÅŸÄ±yorum', color: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-200', icon: 'fa-person-digging' },
            'completed': { label: 'Bitti', color: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200', icon: 'fa-check-circle' },
            'needs_review': { label: 'Tekrar LazÄ±m', color: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-200', icon: 'fa-rotate-right' }
        };

        const AVATAR_OPTIONS = [
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix", "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Bob", "https://api.dicebear.com/7.x/avataaars/svg?seed=Mia",
            "https://api.dicebear.com/7.x/notionists/svg?seed=Leo", "https://api.dicebear.com/7.x/notionists/svg?seed=Zoe",
            "https://api.dicebear.com/7.x/bottts/svg?seed=Robot1", "https://api.dicebear.com/7.x/bottts/svg?seed=Robot2"
        ];

        const ADMIN_EMAIL = "alnigamestudios@gmail.com";
        const IS_TEST_UNLOCKED = true; // Kilitler kaldÄ±rÄ±ldÄ±

        // --- STATE ---
        let currentUser = null;
        let userData = null;
        let marketItemsCache = [];
        let mockExamsHistory = [];
        let myQuestions = [];
        let myNotes = [];
        let myNotifications = [];
        let pomodoroInterval;
        let pomodoroTimeLeft = 25 * 60;
        let isTimerRunning = false;
        let unsubscribeNotifications = null;
        let countdownInterval;
        let activeLeaderboardTab = 'kpss';
        let etutQuestionsCache = []; // EtÃ¼t sorularÄ±nÄ± hafÄ±zada tutmak iÃ§in
        let forumPostsCache = [];    // Forum gÃ¶nderilerini hafÄ±zada tutmak iÃ§in

        // Yeni Oyun Modu DeÄŸiÅŸkenleri
        let quizQuestionsPool = []; // Ã‡ekilen sorular havuzu
        let currentQuestion = null; // Ekranda gÃ¶sterilen soru objesi
        let flashcardsPool = []; // Ã‡ekilen kart havuzu
        let currentCard = null; // Ekranda gÃ¶sterilen kart objesi

        // --- AUTH & INIT ---
        // app.html iÃ§indeki onAuthStateChanged kÄ±smÄ±nÄ± bununla gÃ¼ncelle
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const ADMIN_EMAIL = "alnigamestudios@gmail.com";

                // --- 1. BAKIM MODU KONTROLÃœ (KÄ°LÄ°T MEKANÄ°ZMASI) ---
                const maintenanceSnap = await getDoc(doc(db, "settings", "maintenance"));
                const isMaintenance = maintenanceSnap.exists() ? maintenanceSnap.data().active : false;

                // EÄŸer bakÄ±m varsa ve giren admin DEÄžÄ°LSE:
                if (isMaintenance && user.email.toLowerCase() !== ADMIN_EMAIL) {
                    // Body'yi temizle ve uyarÄ±sÄ±nÄ± Ã§ak
                    document.body.innerHTML = `
                <div style="height:100vh; background:#020617; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-family:sans-serif; text-align:center; padding:20px; selection:none;">
                    <div style="font-size:6rem; margin-bottom:20px; filter: drop-shadow(0 0 20px rgba(249,115,22,0.3));">ðŸš§</div>
                    <h1 style="color:#f97316; font-size:2.5rem; font-weight:900; margin:0; text-transform:uppercase; letter-spacing:-1px;">Sistem GÃ¼ncelleniyor</h1>
                    <p style="color:#64748b; max-width:500px; margin-top:15px; font-weight:600; line-height:1.6;">Patron ÅŸu an sisteme yeni mÃ¼himmatlar ekliyor. <br> KPSS Studio'yu senin iÃ§in daha gÃ¼Ã§lÃ¼ hale getirmek iÃ§in kÄ±sa bir mola verdik. <br><br> LÃ¼tfen birkaÃ§ dakika sonra tekrar dene!</p>
                    <button onclick="location.reload()" style="margin-top:30px; background:#f97316; color:white; border:none; padding:15px 40px; border-radius:15px; font-weight:900; cursor:pointer; font-size:14px; text-transform:uppercase; box-shadow:0 10px 20px rgba(249,115,22,0.2);">Yeniden BaÄŸlanmayÄ± Dene</button>
                </div>`;

                    // BURADA SIGN-OUT YAPMIYORUZ! 
                    // Sadece return diyoruz ki diÄŸer kodlar (dashboard yÃ¼kleme vs) Ã§alÄ±ÅŸmasÄ±n.
                    // Sayfa yenilense de bu blokta takÄ±lÄ± kalacak.
                    return;
                }

                // --- 2. KULLANICI VERÄ°SÄ° & BAN KONTROLÃœ ---
                const docRef = doc(db, "users", user.uid);
                const snap = await getDoc(docRef);

                if (snap.exists()) {
                    userData = snap.data();

                    if (userData.isBanned) {
                        alert("HESAP ENGELÄ°: Kural ihlali nedeniyle eriÅŸiminiz sistem kurucusu tarafÄ±ndan kesilmiÅŸtir.");
                        await signOut(auth);
                        window.location.href = './';
                        return;
                    }

                    // Aktiflik gÃ¼ncelle (Admin panelinde 'Son GiriÅŸ' olarak gÃ¶rÃ¼nÃ¼r)
                    await updateDoc(docRef, { lastLoginDate: serverTimestamp() });

                    // Dashboard'u GÃ¶ster
                    document.getElementById('appContainer').classList.remove('hidden');

                    // Admin butonu sadece sana gÃ¶zÃ¼ksÃ¼n
                    const adminBtn = document.getElementById('adminLink');
                    if (user.email.toLowerCase() === ADMIN_EMAIL && adminBtn) adminBtn.classList.remove('hidden');

                    updateSidebar();
                    loadMocks();
                    loadMyQuestions();
                    loadMyNotes();
                    listenForNotificationBadge();
                    window.loadPage('dashboard');
                    await checkStreak(docRef, userData);
                }
            } else {
                // EÄŸer birisi linkle app.html'e girmeye Ã§alÄ±ÅŸÄ±rsa index'e at
                window.location.href = './';
            }
        });
        // --- STREAK LOGIC (HATA KORUMALI) ---
        // --- STREAK LOGIC (DÃœZELTÄ°LDÄ°: Takvim GÃ¼nÃ¼ BazlÄ± Hesaplama) ---
        async function checkStreak(docRef, data) {
            const now = new Date();
            let lastLoginDate;

            // VeritabanÄ±ndan gelen tarihi al, yoksa ÅŸu anÄ± kabul et
            if (data.lastLoginDate && typeof data.lastLoginDate.toDate === 'function') {
                lastLoginDate = data.lastLoginDate.toDate();
            } else if (data.lastLoginDate instanceof Date) {
                lastLoginDate = data.lastLoginDate;
            } else {
                lastLoginDate = new Date();
            }

            // Tarihleri "Saat/Dakika/Saniye"den arÄ±ndÄ±rÄ±p saf gÃ¼n haline getiriyoruz (Gece yarÄ±sÄ± 00:00:00)
            const todayReset = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const lastLoginReset = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate());

            // Milisaniye farkÄ±nÄ± al
            const diffTime = todayReset - lastLoginReset;
            // GÃ¼n farkÄ±na Ã§evir (1 gÃ¼n = 86400000 ms)
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // Durum 1: EÄŸer fark 0 ise (BugÃ¼n zaten girmiÅŸ), hiÃ§bir ÅŸey yapma ve Ã§Ä±k.
            if (diffDays === 0) return;

            let newStreak = data.streak || 0;

            // Durum 2: EÄŸer fark 1 ise (DÃ¼n girmiÅŸ, bugÃ¼n de giriyor) -> Zinciri ArtÄ±r
            if (diffDays === 1) {
                newStreak += 1;
            }
            // Durum 3: EÄŸer fark 1'den bÃ¼yÃ¼kse (DÃ¼n girmemiÅŸ, zincir kopmuÅŸ) -> Zinciri 1'e SÄ±fÄ±rla
            else if (diffDays > 1) {
                newStreak = 1;
            }
            // (diffDays < 0 durumu teknik olarak imkansÄ±z ama olursa dokunma)

            // State gÃ¼ncelle
            userData.streak = newStreak;

            // VeritabanÄ± gÃ¼ncelle
            await updateDoc(docRef, {
                lastLoginDate: serverTimestamp(),
                streak: newStreak
            });

            // ArayÃ¼zÃ¼ anlÄ±k gÃ¼ncelle (Sayfa yenilemeye gerek kalmasÄ±n)
            updateSidebar();

            // Dashboard aÃ§Ä±ksa oradaki sayÄ±yÄ± da gÃ¼ncelle
            const dashboardStreak = document.querySelector('.fa-fire')?.nextElementSibling?.querySelector('.font-bold');
            if (dashboardStreak) dashboardStreak.innerText = newStreak + " GÃ¼n";
        }

        // --- MOBILE MENU LOGIC ---
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('mainSidebar');
            const overlay = document.getElementById('mobileOverlay');

            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
            }
        };

        // --- NAVIGATION LOGIC ---
        window.loadPage = (page) => {
            const content = document.getElementById('contentArea');
            const ADMIN_EMAIL = "alnigamestudios@gmail.com"; // Admin mailin

            // Admin sayfasÄ± korumasÄ±
            if (page === 'admin') {
                if (!currentUser || currentUser.email.toLowerCase() !== ADMIN_EMAIL) {
                    content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center p-8">
                    <i class="fa-solid fa-shield-slash text-6xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Yetkisiz EriÅŸim!</h2>
                    <p class="text-slate-500 mt-2">Bu alana sadece Al&Ni yÃ¶neticileri girebilir.</p>
                </div>`;
                    return;
                }
            }

            if (countdownInterval) clearInterval(countdownInterval);

            // ModÃ¼l geÃ§iÅŸlerinde temizlik
            currentQuestion = null;
            currentCard = null;

            switch (page) {
                case 'dashboard': content.innerHTML = renderDashboard(); renderChart('dashboardChart'); startCountdown(); break;
                case 'smartcoach': content.innerHTML = renderSmartCoachPage(); break;
                case 'subjects': content.innerHTML = renderSubjects(); break;
                case 'quiz': content.innerHTML = renderQuizCenter(); window.switchQuizTab('solve'); break;
                case 'mocks': content.innerHTML = renderMocks(); renderChart('historyChart'); break;
                case 'profile': content.innerHTML = renderProfile(); break;
                case 'admin': content.innerHTML = renderAdminPanel(); loadAdminData('questions'); break;
                case 'leaderboard': content.innerHTML = renderLeaderboard(); loadLeaderboardData(); break;
                case 'notes': content.innerHTML = renderNotes(); break;
                case 'cards': content.innerHTML = renderCards(); window.switchCardTab('browse'); break;
                case 'forum': content.innerHTML = renderForum(); loadForumPosts(); break;
                case 'feedback': content.innerHTML = renderFeedback(); break;
                case 'etut': content.innerHTML = renderEtut(); loadEtutQuestions(); break;
                case 'mistakes': content.innerHTML = renderMistakes(); loadMistakes(); break;
                case 'garden': content.innerHTML = renderGarden(); loadGarden(); break;
                case 'scheduler': content.innerHTML = renderScheduler(); loadScheduler(); break;
                case 'league': content.innerHTML = renderLeague(); loadLeagueData(); break;
                case 'market': content.innerHTML = renderMarket(); window.switchMarketTab('browse'); break;
                case 'notifications':
                    content.innerHTML = renderNotifications();
                    fetchNotifications();
                    break;
            }
        };

        // --- 1. DASHBOARD ---
        function renderDashboard() {
            const stats = calculateStats();
            const xp = userData.xp || 0;
            const streak = userData.streak || 1;
            const level = Math.floor(xp / 100) + 1;

            return `
                <div class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800 dark:text-white">Merhaba, ${userData.name} ðŸ‘‹</h1>
                        <p class="text-slate-500 dark:text-slate-400">BugÃ¼n kazanmak iÃ§in harika bir gÃ¼n!</p>
                    </div>
                    <div class="flex items-center gap-3">
                         <div class="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-fire text-orange-500 animate-pulse"></i>
                            <div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Zincir</div>
                                <div class="font-bold text-slate-800 dark:text-white leading-none">${streak} GÃ¼n</div>
                            </div>
                         </div>
                         <div class="bg-white dark:bg-slate-800 px-4 py-2 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-star text-yellow-500"></i>
                            <div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase">Seviye ${level}</div>
                                <div class="font-bold text-slate-800 dark:text-white leading-none">${xp} XP</div>
                            </div>
                         </div>
                    </div>
                </div>
                
                <div class="bg-slate-900 text-white rounded-2xl p-6 mb-8 relative shadow-xl overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-purple-600 opacity-20 group-hover:opacity-30 transition"></div>
                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
                        <div class="text-center md:text-left">
                            <h3 class="text-lg font-bold text-blue-200 uppercase tracking-widest mb-1">BÃ¼yÃ¼k SÄ±nav</h3>
                            <div class="text-3xl md:text-4xl font-bold">04 Ekim 2026</div>
                            <p class="text-blue-200/60 text-sm">Hayallerine giden yol.</p>
                        </div>
                        <div class="flex gap-3 md:gap-6 text-center" id="countdownTimer">
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdDays">00</span><span class="text-[10px] uppercase opacity-70">GÃ¼n</span></div>
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdHours">00</span><span class="text-[10px] uppercase opacity-70">Saat</span></div>
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdMins">00</span><span class="text-[10px] uppercase opacity-70">Dk</span></div>
                            <div class="countdown-item bg-white/10 p-3 rounded-lg min-w-[70px] backdrop-blur-sm"><span class="text-2xl font-bold" id="cdSecs">00</span><span class="text-[10px] uppercase opacity-70">Sn</span></div>
                        </div>
                    </div>
                </div>

                <div onclick="window.loadPage('smartcoach')" class="cursor-pointer bg-gradient-to-r from-purple-800 to-indigo-900 rounded-2xl p-6 text-white mb-8 relative shadow-xl transform transition hover:scale-[1.01]">
                    <div class="absolute right-4 top-4 bg-white/20 px-3 py-1 rounded-full text-xs font-bold">AI Raporu</div>
                    <div class="flex items-start gap-4">
                        <div class="bg-white/10 p-3 rounded-full animate-pulse"><i class="fa-solid fa-brain text-2xl"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-purple-200 mb-1">SmartCoach Ã–ngÃ¶rÃ¼sÃ¼</h3>
                            <p class="text-slate-100 text-sm italic">"${stats.shortAdvice}"</p>
                            <div class="mt-3 text-xs text-purple-300 font-semibold">DetaylÄ± analiz iÃ§in tÄ±kla &rarr;</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-sm text-slate-500 dark:text-slate-400">Genel Tamamlanma</div>
                        <div class="text-3xl font-bold text-slate-800 dark:text-white">%${stats.totalProgress}</div>
                        <div class="w-full bg-slate-100 dark:bg-slate-700 h-2 mt-2 rounded-full overflow-hidden"><div class="bg-primary h-2" style="width:${stats.totalProgress}%"></div></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-sm text-slate-500 dark:text-slate-400">Ã‡Ã¶zÃ¼len Deneme</div>
                        <div class="text-3xl font-bold text-primary">${mockExamsHistory.length}</div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div class="text-sm text-slate-500 dark:text-slate-400">Pomodoro SeansÄ±</div>
                        <div class="text-3xl font-bold text-green-600 dark:text-green-400">${userData.pomodoroSessions || 0}</div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm h-80">
                    <h3 class="font-bold mb-4 dark:text-white">Puan GrafiÄŸi</h3>
                    <canvas id="dashboardChart"></canvas>
                </div>
            `;
        }

        function startCountdown() {
            const targetDate = new Date("2026-10-04T00:00:00").getTime();
            const update = () => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                if (distance < 0) {
                    if (document.getElementById("countdownTimer")) document.getElementById("countdownTimer").innerHTML = "SINAV GÃœNÃœ!";
                    clearInterval(countdownInterval);
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                if (document.getElementById("cdDays")) {
                    document.getElementById("cdDays").innerText = days;
                    document.getElementById("cdHours").innerText = hours.toString().padStart(2, '0');
                    document.getElementById("cdMins").innerText = minutes.toString().padStart(2, '0');
                    document.getElementById("cdSecs").innerText = seconds.toString().padStart(2, '0');
                }
            };
            update();
            countdownInterval = setInterval(update, 1000);
        }

        // --- 2. SMARTCOACH (MEVCUT) ---
        function renderSmartCoachPage() {
            return `
        <div class="h-full flex flex-col bg-white dark:bg-darkBg -m-4 md:-m-8">
            <!-- Ãœst Bar -->
            <div class="h-16 bg-gradient-to-r from-primary to-primaryDark text-white px-6 flex items-center justify-between shadow-lg shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-graduation-cap text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black">KPSS SmartCoach</h1>
                        <p class="text-xs opacity-80">Yapay Zeka DanÄ±ÅŸmanÄ±n</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="hidden md:flex items-center gap-2 bg-white/10 px-3 py-1 rounded-full">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-xs font-bold">Aktif</span>
                    </div>
                </div>
            </div>

            <!-- Chat AlanÄ± -->
            <div id="chatWindow" class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 dark:bg-darkBg custom-scrollbar">
                <div id="emptyState" class="h-full flex items-center justify-center">
                    <div class="max-w-2xl w-full text-center space-y-6">
                        <!-- Hero Icon -->
                        <div class="inline-flex p-6 bg-gradient-to-br from-primary/10 to-primaryDark/10 rounded-3xl">
                            <i class="fa-solid fa-brain text-6xl text-primary"></i>
                        </div>

                        <!-- BaÅŸlÄ±k -->
                        <div>
                            <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-3">
                                Merhaba, ${userData.name}!
                            </h2>
                            <p class="text-slate-600 dark:text-slate-400 text-lg">
                                KPSS hedefine ulaÅŸman iÃ§in buradayÄ±m. <br class="hidden md:block">
                                Soru sor, motivasyon al, strateji belirle.
                            </p>
                        </div>

                        <!-- HÄ±zlÄ± BaÅŸlangÄ±Ã§ Ã–nerileri -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-8">
                            <button onclick="document.getElementById('aiInput').value='Hangi derslere Ã¶ncelik vermeliyim?'; window.askSmartCoach();" 
                                class="group p-4 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all text-left">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fa-solid fa-list-check text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-sm">Hangi derslere Ã¶ncelik vermeliyim?</span>
                                </div>
                            </button>

                            <button onclick="document.getElementById('aiInput').value='Ã‡alÄ±ÅŸma programÄ± Ã¶ner'; window.askSmartCoach();" 
                                class="group p-4 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all text-left">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fa-solid fa-calendar-days text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-sm">Ã‡alÄ±ÅŸma programÄ± Ã¶ner</span>
                                </div>
                            </button>

                            <button onclick="document.getElementById('aiInput').value='Motivasyon konuÅŸmasÄ± yap'; window.askSmartCoach();" 
                                class="group p-4 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all text-left">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fa-solid fa-fire text-purple-600 dark:text-purple-400"></i>
                                    </div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-sm">Motivasyon konuÅŸmasÄ± yap</span>
                                </div>
                            </button>

                            <button onclick="document.getElementById('aiInput').value='Ä°lerleme analizi yap'; window.askSmartCoach();" 
                                class="group p-4 bg-white dark:bg-slate-800 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all text-left">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center group-hover:scale-110 transition-transform">
                                        <i class="fa-solid fa-chart-line text-orange-600 dark:text-orange-400"></i>
                                    </div>
                                    <span class="font-bold text-slate-700 dark:text-slate-200 text-sm">Ä°lerleme analizi yap</span>
                                </div>
                            </button>
                        </div>

                        <!-- Bilgilendirme -->
                        <div class="mt-8 p-4 bg-amber-50 dark:bg-amber-900/10 border border-amber-200 dark:border-amber-800/30 rounded-xl">
                            <div class="flex items-start gap-3 text-left">
                                <i class="fa-solid fa-circle-info text-amber-600 dark:text-amber-400 text-lg mt-0.5"></i>
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-amber-900 dark:text-amber-300 mb-1">
                                        Yapay Zeka Asistan UyarÄ±sÄ±
                                    </p>
                                    <p class="text-xs text-amber-800/90 dark:text-amber-400/90 leading-relaxed">
                                        SmartCoach, Google Gemini altyapÄ±sÄ± kullanan yapay zeka destekli bir danÄ±ÅŸmandÄ±r ve yanÄ±labilir. 
                                        VerdiÄŸi bilgiler referans amaÃ§lÄ±dÄ±r. Kritik kararlar iÃ§in uzman desteÄŸi almanÄ±z Ã¶nerilir.
                                        <span class="block mt-2 text-[10px] opacity-70">Al&Ni Studios Â© 2024 â€¢ KPSS HazÄ±rlÄ±k Platformu</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mesaj Input AlanÄ± -->
            <div class="bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 p-4 shrink-0">
                <div class="max-w-4xl mx-auto">
                    <div class="flex gap-3">
                        <div class="flex-1 relative">
                            <textarea 
                                id="aiInput" 
                                rows="1" 
                                placeholder="MesajÄ±nÄ± yaz... (Enter ile gÃ¶nder)" 
                                class="w-full p-4 pr-12 border-2 border-slate-300 dark:border-slate-600 rounded-2xl focus:border-primary dark:focus:border-primary outline-none bg-white dark:bg-slate-800 text-slate-800 dark:text-white placeholder-slate-400 resize-none transition-all"
                                oninput="this.style.height = ''; this.style.height = Math.min(this.scrollHeight, 120) + 'px'"
                                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); window.askSmartCoach(); }"
                            ></textarea>
                        </div>
                        <button 
                            onclick="window.askSmartCoach()" 
                            class="w-14 h-14 bg-gradient-to-br from-primary to-primaryDark hover:shadow-xl hover:shadow-primary/30 text-white rounded-2xl flex items-center justify-center transition-all active:scale-95 shrink-0 font-bold"
                        >
                            <i class="fa-solid fa-paper-plane text-lg"></i>
                        </button>
                    </div>
                    <p class="text-center text-xs text-slate-500 dark:text-slate-400 mt-3">
                        SmartCoach yanÄ±labilir. Ã–nemli bilgileri doÄŸrulayÄ±n.
                    </p>
                </div>
            </div>
        </div>

        <style>
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(148, 163, 184, 0.4);
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(148, 163, 184, 0.6);
            }
            
            #aiInput:focus {
                box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
            }
        </style>
    `;
        }



        // --- 3. SUBJECTS (MEVCUT) ---
        function renderSubjects() {
            let html = `<div class="grid grid-cols-1 gap-8 max-w-5xl mx-auto">`;
            for (let les in CURRICULUM) {
                let total = CURRICULUM[les].length;
                let done = 0;
                CURRICULUM[les].forEach(t => { if ((userData.progress || {})[les + "_" + t] === 'completed') done++; });
                let pct = Math.round((done / total) * 100);
                html += `<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"><div class="bg-slate-50 dark:bg-slate-700 p-4 border-b border-slate-200 dark:border-slate-600 flex flex-col md:flex-row md:justify-between md:items-center gap-2"><h3 class="font-bold text-lg text-slate-800 dark:text-white border-l-4 border-primary pl-3">${les}</h3><div class="flex items-center gap-3 w-full md:w-1/3"><div class="flex-1 bg-white dark:bg-slate-600 h-3 rounded-full border border-slate-200 dark:border-slate-500 overflow-hidden"><div class="bg-primary h-full transition-all duration-500" style="width: ${pct}%"></div></div><span class="text-xs font-bold text-slate-600 dark:text-slate-300 min-w-[3rem] text-right">%${pct}</span></div></div><div class="p-2 md:p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">`;
                CURRICULUM[les].forEach(topic => {
                    const key = les + "_" + topic;
                    const status = (userData.progress || {})[key] || 'not_started';
                    const sInfo = STATUS_TYPES[status];
                    html += `<div class="flex items-center justify-between p-3 rounded-lg border border-slate-100 dark:border-slate-700 bg-white dark:bg-slate-800 hover:shadow-md transition group"><span class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate mr-2">${topic}</span><button onclick="window.cycleStatus('${key}')" class="text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1 ${sInfo.color} status-btn min-w-[90px] justify-center"><i class="fa-solid ${sInfo.icon}"></i> ${sInfo.label}</button></div>`;
                });
                html += `</div></div>`;
            }
            return html + `</div>`;
        }

        // --- 4. LEADERBOARD (MEVCUT) ---
        // --- 4. LEADERBOARD (GÃœNCELLENDÄ°: 3 SEKME) ---
        function renderLeaderboard() {
            return `
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-trophy text-yellow-500 mr-2"></i>Genel SÄ±ralama</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm">SÄ±nav tÃ¼rÃ¼ne gÃ¶re en yÃ¼ksek puanlar.</p>
            </div>

            <!-- SEKMELER -->
            <div class="flex p-1 bg-slate-200 dark:bg-slate-700 rounded-xl mb-6">
                <button onclick="window.switchLeaderboard('kpss')" id="tab-rank-kpss" class="flex-1 py-2 rounded-lg text-sm font-bold transition ${activeLeaderboardTab === 'kpss' ? 'bg-white dark:bg-slate-800 shadow text-primary' : 'text-slate-500 dark:text-slate-400'}">KPSS</button>
                <button onclick="window.switchLeaderboard('yks')" id="tab-rank-yks" class="flex-1 py-2 rounded-lg text-sm font-bold transition ${activeLeaderboardTab === 'yks' ? 'bg-white dark:bg-slate-800 shadow text-primary' : 'text-slate-500 dark:text-slate-400'}">YKS</button>
                <button onclick="window.switchLeaderboard('dgs')" id="tab-rank-dgs" class="flex-1 py-2 rounded-lg text-sm font-bold transition ${activeLeaderboardTab === 'dgs' ? 'bg-white dark:bg-slate-800 shadow text-primary' : 'text-slate-500 dark:text-slate-400'}">DGS</button>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700 overflow-hidden">
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 grid grid-cols-5 text-white font-bold text-sm">
                    <div class="col-span-2">KullanÄ±cÄ±</div>
                    <div class="text-center">Ãœnvan</div>
                    <div class="text-center">XP</div>
                    <div class="text-right">Puan</div>
                </div>
                <div id="leaderboardList" class="divide-y divide-slate-100 dark:divide-slate-700">
                    <div class="p-8 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                </div>
            </div>
        </div>
    `;
        }

        // Sekme DeÄŸiÅŸtirme Fonksiyonu
        window.switchLeaderboard = (tab) => {
            activeLeaderboardTab = tab;
            // UI GÃ¼ncelle
            ['kpss', 'yks', 'dgs'].forEach(t => {
                const btn = document.getElementById(`tab-rank-${t}`);
                if (t === tab) {
                    btn.className = "flex-1 py-2 rounded-lg text-sm font-bold transition bg-white dark:bg-slate-800 shadow text-primary";
                } else {
                    btn.className = "flex-1 py-2 rounded-lg text-sm font-bold transition text-slate-500 dark:text-slate-400";
                }
            });
            // Veriyi YÃ¼kle
            loadLeaderboardData();
        };

        async function loadLeaderboardData() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<div class="p-8 text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> SÄ±ralama Ã§ekiliyor...</div>';

            try {
                // TÃ¼m kullanÄ±cÄ±larÄ± Ã§ek (Firestore'da sÄ±ralama index hatasÄ± almamak iÃ§in client-side sÄ±ralama yapÄ±yoruz)
                // EÄŸer kullanÄ±cÄ± sayÄ±sÄ± Ã§ok artarsa buraya limit ve orderBy eklenmeli.
                const q = query(collection(db, "users"), limit(100));
                const snap = await getDocs(q);
                let users = [];

                snap.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                // Hangi puan tÃ¼rÃ¼ne bakacaÄŸÄ±z?
                let scoreField = 'kpssScore'; // VarsayÄ±lan (Eski totalScore'u buna sayabiliriz)
                if (activeLeaderboardTab === 'yks') scoreField = 'yksScore';
                if (activeLeaderboardTab === 'dgs') scoreField = 'dgsScore';

                // SÄ±ralama MantÄ±ÄŸÄ±
                users.sort((a, b) => {
                    // EÄŸer yeni alan yoksa 0 kabul et. 
                    // NOT: KPSS iÃ§in eski 'totalScore' verisini fallback olarak kullanabiliriz.
                    let scoreA = a[scoreField] || (activeLeaderboardTab === 'kpss' ? (a.totalScore || 0) : 0);
                    let scoreB = b[scoreField] || (activeLeaderboardTab === 'kpss' ? (b.totalScore || 0) : 0);

                    const scoreDiff = scoreB - scoreA;
                    if (scoreDiff !== 0) return scoreDiff;
                    return (b.xp || 0) - (a.xp || 0); // Puan eÅŸitse XP'ye bak
                });

                // Listeyi Render Et
                let html = '';
                let rank = 1;

                users.forEach(u => {
                    // PuanÄ± 0 olanlarÄ± listede gÃ¶sterme (Opsiyonel)
                    let currentScore = u[scoreField] || (activeLeaderboardTab === 'kpss' ? (u.totalScore || 0) : 0);
                    if (currentScore === 0) return;

                    const isMe = u.id === currentUser.uid;
                    const isAdmin = u.email === "alnigamestudios@gmail.com"; // Admin mailin

                    html += `
                <div class="p-4 grid grid-cols-5 items-center ${isMe ? 'bg-orange-50 dark:bg-orange-900/20' : ''} hover:bg-slate-50 dark:hover:bg-slate-700/50 transition">
                    <div class="col-span-2 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${rank <= 3 ? 'bg-yellow-100 text-yellow-600' : 'bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300'} flex items-center justify-center font-bold text-sm">
                            ${rank <= 3 ? '<i class="fa-solid fa-trophy"></i>' : rank}
                        </div>
                        <div class="flex items-center gap-2 min-w-0">
                            <img src="${u.avatar || 'https://i.pravatar.cc/150'}" class="w-8 h-8 rounded-full border border-slate-200 dark:border-slate-600 bg-white">
                            <div class="truncate">
                                <span class="font-bold text-sm ${isMe ? 'text-primary' : 'text-slate-700 dark:text-slate-200'}">
                                    ${u.name} ${isMe ? '(Sen)' : ''}
                                </span>
                                ${isAdmin ? '<i class="fa-solid fa-shield-halved text-red-500 text-xs ml-1" title="YÃ¶netici"></i>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="text-center flex justify-center">
                        <span class="text-[10px] uppercase font-bold text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 rounded py-1 px-2">
                            ${u.title || 'Ã–ÄŸrenci'}
                        </span>
                    </div>
                    <div class="text-center font-bold text-purple-600 dark:text-purple-400 text-xs">${u.xp || 0} XP</div>
                    <div class="text-right font-bold text-slate-800 dark:text-white text-lg">${currentScore}</div>
                </div>
            `;
                    rank++;
                });

                if (html === '') html = '<div class="p-8 text-center text-slate-500">Bu kategoride henÃ¼z puan kaydÄ± yok.</div>';
                list.innerHTML = html;

            } catch (error) {
                console.error("Leaderboard Error:", error);
                list.innerHTML = '<div class="p-4 text-center text-red-500">SÄ±ralama yÃ¼klenirken hata oluÅŸtu.</div>';
            }
        }

        // --- 5. ODAK BAHÃ‡ESÄ° ---
        function renderGarden() {
            return `
                <div class="max-w-4xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-seedling text-green-500 mr-2"></i>Odak BahÃ§esi</h2>
                        <p class="text-slate-500 dark:text-slate-400">TamamladÄ±ÄŸÄ±n her Pomodoro iÃ§in bir bitki kazanÄ±rsÄ±n.</p>
                    </div>
                    
                    <div class="bg-gradient-to-b from-blue-200 to-green-100 dark:from-slate-800 dark:to-slate-900 p-8 rounded-3xl shadow-xl min-h-[400px] border border-white/50 dark:border-slate-700 relative overflow-hidden">
                        <div class="absolute top-[-50px] right-[-50px] w-32 h-32 bg-yellow-300 rounded-full blur-2xl opacity-50"></div>
                        <div id="gardenGrid" class="garden-grid">
                            <div class="text-center w-full col-span-full py-20 text-slate-500 dark:text-slate-400">
                                <i class="fa-solid fa-spinner fa-spin text-2xl"></i><br>BahÃ§en sulanÄ±yor...
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-center gap-4 text-sm font-bold text-slate-600 dark:text-slate-300">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-tree text-green-700"></i> Toplam: <span id="totalPlants">0</span></div>
                        <div class="flex items-center gap-2"><i class="fa-solid fa-droplet text-blue-500"></i> Seviye: <span id="gardenLevel">1</span></div>
                    </div>
                </div>
            `;
        }

        async function loadGarden() {
            const count = userData.pomodoroSessions || 0;
            const grid = document.getElementById('gardenGrid');
            if (!grid) return;

            if (count === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-500 italic mt-20">HenÃ¼z hiÃ§ bitkin yok. Pomodoro sayacÄ±nÄ± baÅŸlat ve odaklan!</div>';
                document.getElementById('totalPlants').innerText = 0;
                return;
            }

            let html = '';
            const plants = ['ðŸŒ»', 'ðŸŒ²', 'ðŸŒµ', 'ðŸŒ´', 'ðŸŒ·', 'ðŸ„', 'ðŸŒ¸', 'ðŸŒ¹', 'ðŸŒ¾', 'ðŸª´'];
            for (let i = 0; i < count; i++) {
                const plantIcon = plants[i % plants.length];
                html += `<div class="plant-slot" title="Seans #${i + 1}"><div class="plant-icon">${plantIcon}</div></div>`;
            }

            grid.innerHTML = html;
            document.getElementById('totalPlants').innerText = count;
            document.getElementById('gardenLevel').innerText = Math.floor(count / 10) + 1;
        }

        // --- 6. AKILLI DERS PROGRAMI (MOBÄ°L UYUMLU & GERÄ° ALMA) ---
        function renderScheduler() {
            const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
            return `
                <div class="h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-calendar-week text-indigo-500 mr-2"></i>AkÄ±llÄ± Program</h2>
                            <p class="text-slate-500 dark:text-slate-400 text-sm">KonularÄ± gÃ¼nlerin Ã¼zerine sÃ¼rÃ¼kle. Ä°ptal etmek iÃ§in listeye geri sÃ¼rÃ¼kle.</p>
                        </div>
                        <button onclick="window.saveSchedule()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow-md transition"><i class="fa-solid fa-save mr-2"></i>Kaydet</button>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-6 h-full overflow-hidden">
                        <div class="w-full lg:w-64 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col shrink-0 max-h-[300px] lg:max-h-full">
                            <div class="p-4 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-200 bg-slate-50 dark:bg-slate-900 rounded-t-xl">
                                Ders KonularÄ±
                            </div>
                            <div class="p-2 overflow-y-auto flex-1 subject-source col-body" id="subjectSourceList" ondrop="window.drop(event)" ondragover="window.allowDrop(event)">
                                </div>
                        </div>

                        <div class="flex-1 overflow-x-auto pb-4">
                            <div class="scheduler-container" id="schedulerContainer">
                                ${days.map(day => `
                                    <div class="scheduler-col">
                                        <div class="col-header">${day}</div>
                                        <div class="col-body" id="col-${day}" ondrop="window.drop(event)" ondragover="window.allowDrop(event)">
                                            </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadScheduler() {
            const sourceList = document.getElementById('subjectSourceList');
            if (!sourceList) return;

            let sourceHtml = '';
            for (let lesson in CURRICULUM) {
                sourceHtml += `<div class="text-xs font-bold text-slate-400 uppercase mt-3 mb-1 px-2 no-drag pointer-events-none select-none" data-lesson="${lesson}">${lesson}</div>`;

                CURRICULUM[lesson].forEach((topic, idx) => {
                    const id = `drag-${lesson}-${idx}`.replace(/\s+/g, '');
                    sourceHtml += `
                        <div class="drag-item" id="${id}" draggable="true" ondragstart="window.drag(event)" data-lesson="${lesson}">
                            ${topic}
                        </div>
                    `;
                });
            }
            sourceList.innerHTML = sourceHtml;

            try {
                const docRef = doc(db, `users/${currentUser.uid}/scheduler/weekly`);
                const snap = await getDoc(docRef);

                if (snap.exists()) {
                    const data = snap.data();
                    for (const [day, items] of Object.entries(data)) {
                        const col = document.getElementById(`col-${day}`);
                        if (col && Array.isArray(items)) {
                            items.forEach(itemId => {
                                const original = document.getElementById(itemId);
                                if (original) {
                                    col.appendChild(original);
                                }
                            });
                        }
                    }
                }
            } catch (e) {
                console.error("Scheduler Load Error:", e);
            }
        }

        window.allowDrop = (ev) => {
            ev.preventDefault();
            if (!ev.target.classList.contains('no-drag')) {
                ev.currentTarget.classList.add('drag-over');
            }
        };

        window.drag = (ev) => {
            ev.dataTransfer.setData("text", ev.target.id);
            ev.target.classList.add('dragging');
        };

        window.drop = (ev) => {
            ev.preventDefault();
            let targetCol = ev.target;
            while (targetCol && !targetCol.classList.contains('col-body')) {
                targetCol = targetCol.parentElement;
            }
            if (!targetCol) return;
            targetCol.classList.remove('drag-over');

            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);

            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                if (targetCol.id === 'subjectSourceList') {
                    const lessonName = draggedElement.getAttribute('data-lesson');
                    const header = targetCol.querySelector(`.no-drag[data-lesson='${lessonName}']`);
                    if (header) {
                        if (header.nextSibling) targetCol.insertBefore(draggedElement, header.nextSibling);
                        else targetCol.appendChild(draggedElement);
                        return;
                    }
                }
                targetCol.appendChild(draggedElement);
            }
        };

        window.saveSchedule = async () => {
            const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let scheduleData = {};
            days.forEach(day => {
                const col = document.getElementById(`col-${day}`);
                if (col) {
                    const items = col.querySelectorAll('.drag-item');
                    let itemIds = [];
                    items.forEach(item => itemIds.push(item.id));
                    scheduleData[day] = itemIds;
                }
            });
            try {
                await setDoc(doc(db, `users/${currentUser.uid}/scheduler/weekly`), scheduleData);
                alert("Program kaydedildi!");
            } catch (e) {
                console.error(e);
                alert("Kaydederken hata oluÅŸtu.");
            }
        };
        // --- 7. HAFTALIK LÄ°G SÄ°STEMÄ° ---
        function renderLeague() {
            const league = userData.currentLeague || "Bronz";
            return `
                <div class="max-w-2xl mx-auto">
                    <div class="bg-gradient-to-r from-blue-900 to-slate-900 rounded-2xl p-8 text-white mb-8 text-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <h2 class="text-3xl font-bold mb-2 uppercase tracking-wide">${league} Ligi</h2>
                        <p class="text-blue-200 text-sm mb-6">HaftalÄ±k sÄ±ralama her Pazar 00:00'da sÄ±fÄ±rlanÄ±r.</p>
                        <div class="flex justify-center gap-8">
                            <div class="text-center"><div class="text-2xl font-bold text-green-400"><i class="fa-solid fa-arrow-up"></i> Ä°lk 10</div><div class="text-[10px] uppercase tracking-wider opacity-70">Lig Atlar</div></div>
                            <div class="text-center"><div class="text-2xl font-bold text-red-400"><i class="fa-solid fa-arrow-down"></i> Son 5</div><div class="text-[10px] uppercase tracking-wider opacity-70">Lig DÃ¼ÅŸer</div></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                        <div class="p-4 bg-slate-50 dark:bg-slate-900 border-b border-slate-100 dark:border-slate-700 font-bold text-slate-700 dark:text-slate-300">Bu HaftanÄ±n SÄ±ralamasÄ±</div>
                        <div id="leagueList" class="divide-y divide-slate-100 dark:divide-slate-700"><div class="p-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div></div>
                    </div>
                </div>
            `;
        }

        async function loadLeagueData() {
            const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(50));
            const snap = await getDocs(q);
            let users = [];
            snap.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

            users.sort((a, b) => {
                const xpDiff = (b.xp || 0) - (a.xp || 0);
                if (xpDiff !== 0) return xpDiff;
                return (a.name || "").localeCompare(b.name || "");
            });

            let html = '';
            let rank = 1;
            users.forEach(u => {
                const isMe = u.id === currentUser.uid;
                let statusIcon = rank <= 3 ? '<i class="fa-solid fa-trophy text-yellow-500"></i>' : (rank <= 10 ? '<i class="fa-solid fa-arrow-up text-green-500 text-xs"></i>' : (rank > 15 ? '<i class="fa-solid fa-arrow-down text-red-500 text-xs"></i>' : '<i class="fa-solid fa-minus text-slate-300 text-xs"></i>'));
                html += `<div class="p-4 flex items-center justify-between ${isMe ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''}"><div class="flex items-center gap-4"><div class="w-8 font-bold text-slate-500 text-center">${rank++}</div><img src="${u.avatar}" class="w-10 h-10 rounded-full border-2 border-white dark:border-slate-600 shadow-sm"><div><div class="font-bold text-slate-800 dark:text-white ${isMe ? 'text-indigo-600 dark:text-indigo-400' : ''}">${u.name} ${isMe ? '(Sen)' : ''}</div><div class="text-xs text-slate-500">${u.title || 'Ã–ÄŸrenci'}</div></div></div><div class="flex items-center gap-4"><div class="text-right"><div class="font-bold text-slate-800 dark:text-white">${u.xp || 0} XP</div><div class="text-[10px] text-slate-400">Bu Hafta</div></div><div class="w-6 text-center">${statusIcon}</div></div></div>`;
            });
            document.getElementById('leagueList').innerHTML = html;
        }

        // --- 8. NOT PAZARI ---
        // --- 8. NOT PAZARI (GÃœNCELLENMÄ°Åž VERSÄ°YON) ---
        function renderMarket() {
            return `
        <div class="max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-shop text-pink-500 mr-2"></i>Not PazarÄ±</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">XP'lerinle not satÄ±n al veya kendi notlarÄ±nÄ± sat.</p>
                </div>
                <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-xl font-bold border border-yellow-200 shadow-sm">
                    CÃ¼zdan: <span id="marketWallet">${userData.xp || 0}</span> XP
                </div>
            </div>
            
            <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6">
                <button onclick="window.switchMarketTab('browse')" id="tabMarketBrowse" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-bold hover:text-pink-600 transition border-b-2 border-transparent">MaÄŸaza</button>
                <button onclick="window.switchMarketTab('sell')" id="tabMarketSell" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-bold hover:text-pink-600 transition border-b-2 border-transparent">Not Sat</button>
                <button onclick="window.switchMarketTab('inventory')" id="tabMarketInv" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-bold hover:text-pink-600 transition border-b-2 border-transparent">AldÄ±klarÄ±m</button>
            </div>
            
            <div id="marketContent" class="min-h-[300px]"></div>
        </div>
    `;
        }

        window.switchMarketTab = async (tab) => {
            const content = document.getElementById('marketContent');
            ['tabMarketBrowse', 'tabMarketSell', 'tabMarketInv'].forEach(id => {
                document.getElementById(id).classList.remove('tab-btn-active');
            });

            const activeBtn = tab === 'browse' ? 'tabMarketBrowse' : (tab === 'sell' ? 'tabMarketSell' : 'tabMarketInv');
            document.getElementById(activeBtn).classList.add('tab-btn-active');

            if (tab === 'sell') {
                // ... (SatÄ±ÅŸ ekranÄ± aynÄ± kalacak) ...
                content.innerHTML = `
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 max-w-xl mx-auto">
                <h3 class="font-bold text-lg mb-4 dark:text-white">Not SatÄ±ÅŸa Ã‡Ä±kar</h3>
                <div class="space-y-4">
                    <input id="noteTitle" type="text" placeholder="Not BaÅŸlÄ±ÄŸÄ± (Ã–rn: Tarih Ã–zet)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-pink-500">
                    <textarea id="noteDesc" placeholder="AÃ§Ä±klama" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-pink-500" rows="3"></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <input id="notePrice" type="number" placeholder="Fiyat (XP)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-pink-500">
                        <input id="noteLink" type="text" placeholder="Google Drive / PDF Linki" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-pink-500">
                    </div>
                    <button onclick="window.sellNote()" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-pink-500/30">SatÄ±ÅŸa Koy</button>
                </div>
            </div>`;

            } else if (tab === 'browse') {
                // ARAMA Ã‡UBUÄžU EKLENDÄ°
                content.innerHTML = `
            <div class="mb-6 relative">
                <input type="text" id="marketSearchInput" onkeyup="window.filterMarket()" placeholder="Notlarda ara..." class="w-full p-3 pl-10 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-pink-500 outline-none">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
            <div id="marketItemsGrid" class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-pink-500 text-2xl"></i><br><span class="text-slate-500">MaÄŸaza yÃ¼kleniyor...</span></div>
        `;

                const q = query(collection(db, "marketItems"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);

                marketItemsCache = []; // Cache'i sÄ±fÄ±rla
                snap.forEach(doc => {
                    marketItemsCache.push({ id: doc.id, ...doc.data() });
                });

                // ÃœrÃ¼nleri listele
                window.renderMarketItems(marketItemsCache);

            } else if (tab === 'inventory') {
                // ... (Envanter aynÄ± kalacak) ...
                const inventory = userData.inventory || [];
                if (inventory.length === 0) { content.innerHTML = '<div class="text-center py-10 text-slate-500">HenÃ¼z bir ÅŸey satÄ±n almadÄ±n.</div>'; return; }
                content.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>';
                let html = '<div class="space-y-4">';
                for (const itemId of inventory) {
                    const itemDoc = await getDoc(doc(db, "marketItems", itemId));
                    if (itemDoc.exists()) {
                        const item = itemDoc.data();
                        html += `<div class="bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-100 dark:border-slate-700 flex justify-between items-center"><div><div class="font-bold text-slate-800 dark:text-white">${item.title}</div><div class="text-xs text-slate-500">${item.description}</div></div><a href="${item.link}" target="_blank" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg font-bold hover:bg-green-200 text-sm"><i class="fa-solid fa-download"></i> Ä°ndir</a></div>`;
                    }
                }
                html += '</div>';
                content.innerHTML = html;
            }
        };

        // YENÄ°: Market listesini render eden yardÄ±mcÄ± fonksiyon
        window.renderMarketItems = (items) => {
            const grid = document.getElementById('marketItemsGrid');
            if (!grid) return;

            if (items.length === 0) {
                grid.innerHTML = '<div class="text-center py-10 text-slate-500">AradÄ±ÄŸÄ±nÄ±z kriterde Ã¼rÃ¼n bulunamadÄ±.</div>';
                return;
            }

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';

            items.forEach(item => {
                const isOwn = item.sellerId === currentUser.uid;
                const isAdmin = currentUser.email === "alnigamestudios@gmail.com";
                const hasBought = (userData.inventory || []).includes(item.id);

                // BaÅŸlÄ±k iÃ§indeki tek tÄ±rnaklarÄ± kaÃ§Ä±ÅŸ karakteriyle dÃ¼zeltiyoruz (Hata almamak iÃ§in)
                const safeTitle = item.title.replace(/'/g, "\\'");

                html += `
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col relative group transition hover:shadow-md">
            
            <!-- ÅžÄ°KAYET VE SÄ°LME BUTONLARI -->
            <div class="absolute top-2 right-2 flex gap-1 z-10 opacity-0 group-hover:opacity-100 transition">
                ${!isOwn ? `<button onclick="window.reportContent('Market ÃœrÃ¼nÃ¼', '${item.id}', '${safeTitle}')" class="bg-slate-100 dark:bg-slate-700 text-slate-400 hover:text-yellow-600 dark:hover:text-yellow-500 p-1.5 rounded-lg text-xs shadow-sm" title="Åžikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>` : ''}
                ${(isOwn || isAdmin) ? `<button onclick="window.deleteMarketItem('${item.id}')" class="bg-red-500 text-white p-1.5 rounded-lg text-xs hover:bg-red-600 shadow-sm" title="Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>

            <div class="p-4 flex-1">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="font-bold text-slate-800 dark:text-white line-clamp-1" title="${item.title}">${item.title}</h4>
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded border border-yellow-200 shrink-0 ml-2">${item.price} XP</span>
                </div>
                <div class="flex items-center gap-2 mb-2">
                     <div class="text-[10px] bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-500 dark:text-slate-400"><i class="fa-solid fa-user"></i> ${item.sellerName}</div>
                     <div class="text-[10px] bg-green-50 dark:bg-green-900/20 px-2 py-0.5 rounded text-green-600 dark:text-green-400"><i class="fa-solid fa-download"></i> ${item.sales || 0} SatÄ±ÅŸ</div>
                </div>
                <p class="text-sm text-slate-600 dark:text-slate-300 line-clamp-2 min-h-[40px]">${item.description}</p>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-100 dark:border-slate-700">
                ${isOwn
                        ? '<button class="w-full py-2 bg-slate-200 dark:bg-slate-700 text-slate-500 rounded-lg cursor-not-allowed text-sm font-bold">Senin ÃœrÃ¼nÃ¼n</button>'
                        : (hasBought
                            ? `<a href="${item.link}" target="_blank" class="block w-full py-2 bg-green-500 text-white rounded-lg text-center text-sm font-bold hover:bg-green-600 shadow-green-500/20 shadow-lg">Ä°ndir / GÃ¶rÃ¼ntÃ¼le</a>`
                            : `<button onclick="window.buyItem('${item.id}', ${item.price}, '${item.sellerId}', '${safeTitle}')" class="w-full py-2 bg-pink-600 text-white rounded-lg text-sm font-bold hover:bg-pink-700 transition shadow-lg shadow-pink-500/30">SatÄ±n Al</button>`
                        )
                    }
            </div>
        </div>`;
            });

            html += '</div>';
            grid.innerHTML = html;
        };

        // YENÄ°: Arama Filtreleme Fonksiyonu
        window.filterMarket = () => {
            const query = document.getElementById('marketSearchInput').value.toLowerCase();
            const filtered = marketItemsCache.filter(item =>
                item.title.toLowerCase().includes(query) ||
                item.description.toLowerCase().includes(query) ||
                item.sellerName.toLowerCase().includes(query)
            );
            window.renderMarketItems(filtered);
        };

        window.sellNote = async () => {
            const title = document.getElementById('noteTitle').value;
            const desc = document.getElementById('noteDesc').value;
            const price = parseInt(document.getElementById('notePrice').value);
            const link = document.getElementById('noteLink').value;

            if (!title || isNaN(price) || !link) return alert("LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun. Fiyat sayÄ± olmalÄ±.");

            try {
                await addDoc(collection(db, "marketItems"), {
                    sellerId: currentUser.uid, sellerName: userData.name, title: title, description: desc, price: Number(price), link: link, createdAt: serverTimestamp(), sales: 0
                });
                alert("Notun satÄ±ÅŸa Ã§Ä±ktÄ±!");
                window.switchMarketTab('browse');
            } catch (e) { console.error("SatÄ±ÅŸ HatasÄ±:", e); alert("Hata oluÅŸtu: " + e.message); }
        };

        window.deleteMarketItem = async (id) => {
            if (confirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸine emin misin?")) {
                await deleteDoc(doc(db, "marketItems", id));
                alert("Silindi.");
                window.switchMarketTab('browse');
            }
        };

        // --- SATIN ALMA Ä°ÅžLEMÄ° (DÃœZELTÄ°LDÄ°: SATICIYA Ã–DEME VE BÄ°LDÄ°RÄ°M) ---
        window.buyItem = async (itemId, price, sellerId, itemTitle) => {
            // 1. Kontroller
            if (userData.xp < price) return alert("Yetersiz XP! Biraz daha soru Ã§Ã¶zmelisin.");
            if (!confirm(`${price} XP karÅŸÄ±lÄ±ÄŸÄ±nda bu notu satÄ±n almak istiyor musun?`)) return;

            try {
                const batch = writeBatch(db);

                // 2. AlÄ±cÄ±dan XP DÃ¼ÅŸ ve Envantere Ekle
                const buyerRef = doc(db, "users", currentUser.uid);
                batch.update(buyerRef, {
                    xp: increment(-price),
                    inventory: arrayUnion(itemId)
                });

                // 3. SatÄ±cÄ±ya XP Ekle ve Bildirim GÃ¶nder (Kendinden almÄ±yorsan)
                if (sellerId && sellerId !== currentUser.uid) {
                    const sellerRef = doc(db, "users", sellerId);
                    batch.update(sellerRef, { xp: increment(price) });

                    // SatÄ±cÄ±ya Bildirim OluÅŸtur
                    const notifRef = doc(collection(db, "notifications"));
                    batch.set(notifRef, {
                        uid: sellerId,
                        title: "Tebrikler! ÃœrÃ¼nÃ¼nÃ¼z SatÄ±ldÄ± ðŸ¤‘",
                        message: `"${itemTitle}" baÅŸlÄ±klÄ± notunuz bir kullanÄ±cÄ± tarafÄ±ndan satÄ±n alÄ±ndÄ±. HesabÄ±nÄ±za +${price} XP eklendi.`,
                        type: "success",
                        read: false,
                        createdAt: serverTimestamp()
                    });
                }

                // 4. ÃœrÃ¼nÃ¼n SatÄ±ÅŸ SayacÄ±nÄ± ArtÄ±r (Ä°statistik iÃ§in)
                const itemRef = doc(db, "marketItems", itemId);
                batch.update(itemRef, { sales: increment(1) });

                // 5. Ä°ÅŸlemi Onayla
                await batch.commit();

                // 6. Yerel Veriyi GÃ¼ncelle ve UI Yenile
                userData.xp -= price;
                if (!userData.inventory) userData.inventory = [];
                userData.inventory.push(itemId);

                alert("SatÄ±n alma baÅŸarÄ±lÄ±! NotlarÄ±m sekmesinden eriÅŸebilirsin.");
                updateSidebar();
                document.getElementById('marketWallet').innerText = userData.xp;
                window.switchMarketTab('inventory');

            } catch (e) {
                console.error("SatÄ±n alma hatasÄ±:", e);
                alert("SatÄ±n alma sÄ±rasÄ±nda bir hata oluÅŸtu: " + e.message);
            }
        };

        // --- 9. SANAL ETÃœT ODASI ---
        let tempUploadedImageUrl = "";
        function renderEtut() {
            return `
        <div class="max-w-4xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-users-viewfinder text-blue-500 mr-2"></i>Sanal EtÃ¼t OdasÄ±</h2>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">YapamadÄ±ÄŸÄ±n sorularÄ± sor, bilenlere yardÄ±m et, XP kazan!</p>
                </div>
                <div class="flex gap-2 text-[10px] font-bold">
                    <div class="bg-blue-100 text-blue-700 px-2 py-1 rounded border border-blue-200">Soru Sor: +5 XP</div>
                    <div class="bg-purple-100 text-purple-700 px-2 py-1 rounded border border-purple-200">Cevap: +10 XP</div>
                    <div class="bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">En Ä°yi: +50 XP</div>
                </div>
            </div>

            <!-- Soru Sorma Formu -->
            <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                <div onclick="document.getElementById('askForm').classList.toggle('hidden')" class="flex justify-between items-center cursor-pointer">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200">Yeni Soru OluÅŸtur</h3>
                    <i class="fa-solid fa-chevron-down text-slate-400"></i>
                </div>
                <div id="askForm" class="hidden mt-4 space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <select id="etutLesson" class="p-3 border dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-700 dark:text-white outline-none"><option value="Genel">Ders SeÃ§iniz...</option><option value="Matematik">Matematik</option><option value="TÃ¼rkÃ§e">TÃ¼rkÃ§e</option><option value="Tarih">Tarih</option><option value="CoÄŸrafya">CoÄŸrafya</option><option value="VatandaÅŸlÄ±k">VatandaÅŸlÄ±k</option></select>
                        <button onclick="window.openCloudinaryWidget()" id="uploadBtn" class="p-3 border border-dashed border-slate-300 dark:border-slate-600 rounded-lg text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center gap-2"><i class="fa-solid fa-camera"></i> FotoÄŸraf Ekle</button>
                    </div>
                    <div id="imagePreview" class="hidden relative w-full h-32 bg-slate-100 dark:bg-slate-900 rounded-lg overflow-hidden"><img id="previewImg" src="" class="h-full w-auto mx-auto object-contain"><button onclick="window.clearImage()" class="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button></div>
                    <textarea id="etutText" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none" placeholder="Sorunu buraya yaz..."></textarea>
                    <button onclick="window.submitEtutQuestion()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">PaylaÅŸ (+5 XP)</button>
                </div>
            </div>

            <!-- ARAMA Ã‡UBUÄžU (YENÄ°) -->
            <div class="mb-6 relative">
                <input type="text" id="etutSearchInput" onkeyup="window.filterEtut()" placeholder="Sorularda veya derslerde ara..." class="w-full p-3 pl-10 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>

            <div id="etutFeed" class="space-y-6">
                <div class="text-center text-slate-400 mt-8"><i class="fa-solid fa-spinner fa-spin"></i> Sorular yÃ¼kleniyor...</div>
            </div>
        </div>`;
        }

        window.openCloudinaryWidget = () => {
            const myWidget = cloudinary.createUploadWidget({ cloudName: 'dbwqidxpy', uploadPreset: 'alnikpss', sources: ['local', 'camera'], multiple: false, folder: 'etut_questions' }, (error, result) => {
                if (!error && result && result.event === "success") {
                    tempUploadedImageUrl = result.info.secure_url;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('previewImg').src = tempUploadedImageUrl;
                    document.getElementById('uploadBtn').classList.add('bg-green-50', 'text-green-600', 'border-green-200');
                    document.getElementById('uploadBtn').innerHTML = '<i class="fa-solid fa-check"></i> YÃ¼klendi';
                }
            });
            myWidget.open();
        }

        window.clearImage = () => {
            tempUploadedImageUrl = "";
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('previewImg').src = "";
            document.getElementById('uploadBtn').classList.remove('bg-green-50', 'text-green-600', 'border-green-200');
            document.getElementById('uploadBtn').innerHTML = '<i class="fa-solid fa-camera"></i> FotoÄŸraf Ekle';
        }

        window.submitEtutQuestion = async () => {
            const lesson = document.getElementById('etutLesson').value;
            const text = document.getElementById('etutText').value;
            if (lesson === 'Genel' || !text) return alert("LÃ¼tfen ders seÃ§in ve soru metni girin.");

            try {
                await addDoc(collection(db, "etutQuestions"), { uid: currentUser.uid, authorName: userData.name, authorAvatar: userData.avatar, lesson, text, image: tempUploadedImageUrl, createdAt: serverTimestamp(), isSolved: false, commentCount: 0 });
                const newXp = (userData.xp || 0) + 5;
                userData.xp = newXp;
                await updateDoc(doc(db, "users", currentUser.uid), { xp: newXp });
                window.notifyAdmin("Yeni bir EtÃ¼t Sorusu paylaÅŸÄ±ldÄ±.");
                alert("Soru paylaÅŸÄ±ldÄ±! +5 XP");
                document.getElementById('etutText').value = "";
                window.clearImage();
                document.getElementById('askForm').classList.add('hidden');
                loadEtutQuestions();
                updateSidebar();
            } catch (err) { console.error(err); alert("Hata oluÅŸtu."); }
        };

        window.deleteEtutQuestion = async (qId) => {
            if (!confirm("Bu soruyu silmek istediÄŸine emin misin?")) return;
            await deleteDoc(doc(db, "etutQuestions", qId));
            loadEtutQuestions();
        };

        window.deleteEtutComment = async (qId, cId) => {
            if (!confirm("Yorumu silmek istiyor musun?")) return;
            await deleteDoc(doc(db, `etutQuestions/${qId}/comments/${cId}`));
            loadEtutQuestions();
        };

        async function loadEtutQuestions() {
            const q = query(collection(db, "etutQuestions"), orderBy("createdAt", "desc"), limit(50));
            const snap = await getDocs(q);

            etutQuestionsCache = []; // Cache'i sÄ±fÄ±rla
            snap.forEach(doc => {
                etutQuestionsCache.push({ id: doc.id, ...doc.data() });
            });

            renderEtutList(etutQuestionsCache); // Listeyi Ã§izdir
        }

        // Listeyi Filtreleyen Fonksiyon
        window.filterEtut = () => {
            const query = document.getElementById('etutSearchInput').value.toLowerCase();
            const filtered = etutQuestionsCache.filter(item =>
                (item.text && item.text.toLowerCase().includes(query)) ||
                (item.lesson && item.lesson.toLowerCase().includes(query)) ||
                (item.authorName && item.authorName.toLowerCase().includes(query))
            );
            renderEtutList(filtered);
        };

        // Listeyi Ekrana Basan YardÄ±mcÄ± Fonksiyon
        async function renderEtutList(items) {
            const container = document.getElementById('etutFeed');
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10">AradÄ±ÄŸÄ±nÄ±z kriterde soru bulunamadÄ±.</div>';
                return;
            }

            let html = '';

            // YorumlarÄ± Ã§ekebilmek iÃ§in dÃ¶ngÃ¼ async yapÄ±sÄ±na uygun olmalÄ±
            for (const qData of items) {
                const qId = qData.id;
                const isMyQuestion = qData.uid === currentUser.uid;
                const isAdmin = currentUser.email === "alnigamestudios@gmail.com";

                // Metni gÃ¼venli hale getir (tÄ±rnaklar ve yeni satÄ±rlar iÃ§in)
                const safeText = qData.text.replace(/'/g, "\\'").replace(/\n/g, " ");

                // YorumlarÄ± Ã§ek
                let commentsHtml = '';
                try {
                    const commentsQ = query(collection(db, `etutQuestions/${qId}/comments`), orderBy("createdAt", "asc"));
                    const commentsSnap = await getDocs(commentsQ);

                    commentsSnap.forEach(cDoc => {
                        const c = cDoc.data();
                        const isBest = c.isBestAnswer;
                        commentsHtml += `
                <div class="flex gap-3 text-sm ${isBest ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3' : 'border-l-2 border-slate-200 dark:border-slate-700 pl-3'}">
                    <img src="${c.authorAvatar}" class="w-8 h-8 rounded-full">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div class="font-bold text-slate-700 dark:text-slate-300">${c.authorName} ${isBest ? '<span class="text-xs text-green-600 ml-2"><i class="fa-solid fa-check-circle"></i> En Ä°yi Cevap</span>' : ''}</div>
                            <div class="flex items-center gap-2">
                                <div class="text-xs text-slate-400">${c.createdAt ? new Date(c.createdAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</div>
                                ${(c.uid === currentUser.uid || isAdmin) ? `<button onclick="window.deleteEtutComment('${qId}', '${cDoc.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>` : ''}
                            </div>
                        </div>
                        <p class="text-slate-600 dark:text-slate-300 mt-1">${c.text}</p>
                        ${isMyQuestion && !qData.isSolved && !isBest && c.uid !== currentUser.uid ? `<button onclick="window.markBestAnswer('${qId}', '${cDoc.id}', '${c.uid}')" class="mt-2 text-xs text-slate-400 hover:text-green-500 transition flex items-center gap-1"><i class="fa-regular fa-star"></i> En iyi cevap seÃ§ (+50 XP)</button>` : ''}
                    </div>
                </div>`;
                    });
                } catch (e) { console.log("Yorum hatasÄ±", e); }

                html += `
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border ${qData.isSolved ? 'border-green-200 dark:border-green-900' : 'border-slate-100 dark:border-slate-700'} overflow-hidden relative group">
            
            <!-- ÅžÄ°KAYET VE SÄ°LME BUTONLARI -->
            <div class="absolute top-4 right-4 flex gap-2 z-10 opacity-0 group-hover:opacity-100 transition">
                <button onclick="window.reportContent('EtÃ¼t Sorusu', '${qId}', '${safeText.substring(0, 30)}...')" class="bg-slate-50 dark:bg-slate-700 text-slate-400 hover:text-yellow-600 dark:hover:text-yellow-500 p-1.5 rounded text-xs border border-slate-200 dark:border-slate-600 shadow-sm" title="Åžikayet Et">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </button>

                ${(isMyQuestion || isAdmin) ? `<button onclick="window.deleteEtutQuestion('${qId}')" class="bg-red-500 text-white p-1.5 rounded text-xs hover:bg-red-600 shadow-sm"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>

            <div class="p-4 md:p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <img src="${qData.authorAvatar}" class="w-10 h-10 rounded-full border border-slate-200">
                        <div>
                            <div class="font-bold text-slate-800 dark:text-white">${qData.authorName}</div>
                            <div class="text-xs text-slate-500">${qData.lesson} â€¢ ${qData.createdAt ? new Date(qData.createdAt.seconds * 1000).toLocaleString() : ''}</div>
                        </div>
                    </div>
                    ${qData.isSolved ? '<div class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold mr-16"><i class="fa-solid fa-check"></i> Ã‡Ã¶zÃ¼ldÃ¼</div>' : ''}
                </div>
                <p class="text-slate-800 dark:text-slate-200 mb-4 whitespace-pre-wrap">${qData.text}</p>
                ${qData.image ? `<div class="mb-4 rounded-lg overflow-hidden border border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900"><img src="${qData.image}" class="max-h-96 w-auto mx-auto" onclick="window.open(this.src)" style="cursor:zoom-in"></div>` : ''}
                <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <div class="space-y-4 mb-4" id="comments-${qId}">${commentsHtml}</div>
                    <div class="flex gap-2 items-center">
                        <img src="${userData.avatar}" class="w-8 h-8 rounded-full hidden md:block">
                        <div class="relative flex-1">
                            <input type="text" id="commentInput-${qId}" placeholder="CevabÄ±nÄ± yaz (+10 XP)..." class="w-full pl-4 pr-12 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-full text-sm outline-none focus:border-blue-500 transition dark:text-white" onkeydown="if(event.key === 'Enter') window.submitComment('${qId}')">
                            <button onclick="window.submitComment('${qId}')" class="absolute right-1 top-1/2 -translate-y-1/2 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center hover:bg-blue-600 transition"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
            }
            container.innerHTML = html;
        }

        window.submitComment = async (qId) => {
            const input = document.getElementById(`commentInput-${qId}`);
            const text = input.value.trim();
            if (!text) return;
            try {
                await addDoc(collection(db, `etutQuestions/${qId}/comments`), { uid: currentUser.uid, authorName: userData.name, authorAvatar: userData.avatar, text, createdAt: serverTimestamp(), isBestAnswer: false });
                const newXp = (userData.xp || 0) + 10;
                userData.xp = newXp;
                await updateDoc(doc(db, "users", currentUser.uid), { xp: newXp });
                input.value = "";
                loadEtutQuestions(); updateSidebar();
            } catch (err) { console.error(err); alert("Yorum gÃ¶nderilemedi."); }
        };

        window.markBestAnswer = async (qId, cId, authorId) => {
            if (!confirm("Bu cevabÄ± en iyi cevap seÃ§mek istiyor musun?")) return;
            try {
                await updateDoc(doc(db, `etutQuestions/${qId}/comments/${cId}`), { isBestAnswer: true });
                await updateDoc(doc(db, "etutQuestions", qId), { isSolved: true });
                const authorRef = doc(db, "users", authorId);
                const authorSnap = await getDoc(authorRef);
                if (authorSnap.exists()) { await updateDoc(authorRef, { xp: (authorSnap.data().xp || 0) + 50 }); }
                await addDoc(collection(db, "notifications"), { uid: authorId, message: "Tebrikler! CevabÄ±n 'En Ä°yi Cevap' seÃ§ildi. +50 XP kazandÄ±n!", type: "success", read: false, createdAt: serverTimestamp() });
                loadEtutQuestions();
            } catch (err) { console.error(err); alert("Hata oluÅŸtu."); }
        };

        // --- 10. HATA KUTUSU ---
        function renderMistakes() {
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-recycle text-red-500 mr-2"></i>Hata Kutusu</h2>
                        <p class="text-slate-500 dark:text-slate-400">YanlÄ±ÅŸ yaptÄ±ÄŸÄ±n sorular burada birikir. Tekrar Ã§Ã¶zÃ¼p doÄŸrusunu Ã¶ÄŸrenince silinir.</p>
                    </div>
                    <div id="mistakesList" class="space-y-6 pb-32">
                        <div class="text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                    </div>
                </div>
            `;
        }

        async function loadMistakes() {
            const container = document.getElementById('mistakesList');
            const q = query(collection(db, `users/${currentUser.uid}/mistakes`));
            const snap = await getDocs(q);

            if (snap.empty) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-10 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                        <i class="fa-solid fa-check-circle text-6xl text-green-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-800 dark:text-white">Harika Gidiyorsun!</h3>
                        <p class="text-slate-500 dark:text-slate-400">Hata kutun boÅŸ. TÃ¼m yanlÄ±ÅŸlarÄ±nÄ± temizledin.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            snap.forEach((doc) => {
                const data = doc.data();
                html += `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border-l-4 border-red-500 shadow-sm" id="mistake-${doc.id}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold px-2 py-1 rounded uppercase">${data.lesson || 'Genel'}</span>
                            <button onclick="window.deleteMistake('${doc.id}')" class="text-slate-400 hover:text-red-500" title="Kutudan Sil"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <p class="text-lg font-bold text-slate-800 dark:text-white mb-6">${data.text}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${data.options.map((opt, idx) => `
                                <button onclick="window.checkMistakeAnswer('${doc.id}', ${idx}, ${data.correct})" 
                                    class="text-left p-3 rounded-lg border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 transition mistake-opt-${doc.id}" data-idx="${idx}">
                                    <span class="font-bold mr-2">${String.fromCharCode(65 + idx)})</span> ${opt}
                                </button>
                            `).join('')}
                        </div>
                        <div id="feedback-${doc.id}" class="mt-4 hidden font-bold text-center"></div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- 11. FLASHCARDS (YENÄ°LENMÄ°Åž OYUN MODU) ---
        function renderCards() {
            return `
        <div class="max-w-4xl mx-auto h-full flex flex-col">
            <div class="flex border-b border-slate-200 dark:border-slate-700 mb-6 shrink-0">
                <button onclick="window.switchCardTab('browse')" id="tabCardBrowse" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Kartlara GÃ¶z At</button>
                <button onclick="window.switchCardTab('submit')" id="tabCardSubmit" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Kart GÃ¶nder</button>
            </div>

            <div id="contentCardBrowse" class="hidden flex-1 flex flex-col items-center">
                <div id="flashcardStartScreen" class="w-full max-w-md text-center p-8 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700">
                    <i class="fa-solid fa-layer-group text-5xl text-primary mb-4"></i>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Flashcard Ã‡alÄ±ÅŸmasÄ±</h3>
                    <p class="text-slate-500 dark:text-slate-400 mb-6">Kategorini seÃ§ ve kartlarÄ± Ã§evirmeye baÅŸla!</p>
                    <select id="flashcardCategorySelect" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 dark:text-white outline-none mb-4">
                        <option value="All">TÃ¼m Dersler</option>
                        <option value="Tarih">Tarih</option>
                        <option value="CoÄŸrafya">CoÄŸrafya</option>
                        <option value="VatandaÅŸlÄ±k">VatandaÅŸlÄ±k</option>
                        <option value="TÃ¼rkÃ§e">TÃ¼rkÃ§e</option>
                        <option value="Matematik">Matematik</option>
                        <option value="General">Genel</option>
                    </select>
                    <button onclick="window.startFlashcardGame()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-3 rounded-xl transition shadow-lg shadow-orange-500/30">BaÅŸla</button>
                </div>

                <div id="flashcardGameArea" class="hidden w-full max-w-lg flex flex-col items-center flex-1 justify-center min-h-[400px]">
                    <div class="w-full flex justify-between items-center mb-4 px-4">
                        <button onclick="window.switchCardTab('browse')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white"><i class="fa-solid fa-arrow-left"></i> Ã‡Ä±k</button>
                        <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200 px-3 py-1 rounded-full text-xs font-bold" id="fcCategoryBadge">Genel</span>
                    </div>
                    
                    <div class="flip-card w-full h-80 perspective cursor-pointer group mb-8" onclick="this.classList.toggle('flipped')">
                        <div class="flip-card-inner relative w-full h-full shadow-xl rounded-2xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 transition-transform duration-500">
                            <!-- KARTIN Ã–N YÃœZÃœ -->
                            <div class="flip-card-front flex flex-col items-center justify-center p-8 text-center bg-white dark:bg-slate-800 rounded-2xl">
                                <div class="absolute top-4 right-4 flex gap-2 z-20" onclick="event.stopPropagation()">
                                    <!-- BURASI DEÄžÄ°ÅžTÄ° -->
                                    <button onclick="window.handleActiveItemReport('flashcard')" class="text-slate-300 hover:text-yellow-500 transition" title="Åžikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>
                                    
                                    ${currentUser.email === ADMIN_EMAIL ? `<button onclick="window.deleteLiveItem('flashcards', currentCard.id)" class="text-red-300 hover:text-red-500 transition" title="YÃ¶netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
                                </div>
                                <h3 class="font-bold text-slate-800 dark:text-white text-2xl" id="fcFront">...</h3>
                                <p class="text-xs text-slate-400 mt-4 uppercase tracking-widest">Ã‡evirmek iÃ§in dokun</p>
                            </div>
                            <!-- KARTIN ARKA YÃœZÃœ -->
                            <div class="flip-card-back flex flex-col items-center justify-center p-8 text-center bg-primary text-white rounded-2xl">
                                <div class="absolute top-4 right-4 flex gap-2 z-20" onclick="event.stopPropagation()">
                                    <!-- BURASI DEÄžÄ°ÅžTÄ° -->
                                    <button onclick="window.handleActiveItemReport('flashcard')" class="text-white/50 hover:text-white transition" title="Åžikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>
                                    
                                    ${currentUser.email === ADMIN_EMAIL ? `<button onclick="window.deleteLiveItem('flashcards', currentCard.id)" class="text-white/50 hover:text-white transition" title="YÃ¶netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
                                </div>
                                <p class="font-bold text-2xl" id="fcBack">...</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.nextCard()" class="bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:-translate-y-1">
                        SÄ±radaki Kart <i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <div id="contentCardSubmit" class="hidden pb-32">
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">Kart Ã–nerisi GÃ¶nder</h3>
                    <div class="space-y-4">
                        <input id="cardFront" type="text" placeholder="Ã–n YÃ¼z (Soru/Kavram)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                        <input id="cardBack" type="text" placeholder="Arka YÃ¼z (Cevap/AÃ§Ä±klama)" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                        <button onclick="window.submitCard()" class="w-full bg-slate-800 dark:bg-slate-700 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">YÃ¶netici OnayÄ±na GÃ¶nder</button>
                    </div>
                </div>
                <div class="mt-8"><h3 class="font-bold text-md mb-4 text-slate-800 dark:text-white">GÃ¶nderimlerin</h3><div id="myCardsList" class="space-y-3"></div></div>
            </div>
        </div>
    `;
        }

        window.switchCardTab = (tab) => {
            document.getElementById('contentCardBrowse').classList.add('hidden');
            document.getElementById('contentCardSubmit').classList.add('hidden');
            document.getElementById('tabCardBrowse').classList.remove('tab-btn-active');
            document.getElementById('tabCardSubmit').classList.remove('tab-btn-active');

            if (tab === 'browse') {
                document.getElementById('contentCardBrowse').classList.remove('hidden');
                document.getElementById('tabCardBrowse').classList.add('tab-btn-active');
                // Reset Game View
                document.getElementById('flashcardStartScreen').classList.remove('hidden');
                document.getElementById('flashcardGameArea').classList.add('hidden');
            } else {
                document.getElementById('contentCardSubmit').classList.remove('hidden');
                document.getElementById('tabCardSubmit').classList.add('tab-btn-active');
                loadMyCardSubmissions();
            }
        };

        window.submitCard = async () => {
            const front = document.getElementById('cardFront').value;
            const back = document.getElementById('cardBack').value;
            if (!front || !back) return alert("Ä°ki yÃ¼zÃ¼ de doldurun.");
            await addDoc(collection(db, "flashcardSubmissions"), {
                uid: currentUser.uid, authorName: userData.name, front, back, status: 'pending', createdAt: serverTimestamp()
            });
            window.notifyAdmin("Yeni bir Flashcard onayÄ± bekliyor.");
            alert("Kart gÃ¶nderildi!");
            document.getElementById('cardFront').value = ""; document.getElementById('cardBack').value = "";
            loadMyCardSubmissions();
        };

        async function loadMyCardSubmissions() {
            const q = query(collection(db, "flashcardSubmissions"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            const list = document.getElementById('myCardsList');
            if (list) {
                list.innerHTML = snap.docs.map(d => {
                    const data = d.data(); return `
                    <div class="p-3 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded flex justify-between items-center text-slate-800 dark:text-slate-200">
                        <div><span class="font-bold">${data.front}</span> - ${data.back}</div>
                        <span class="text-xs px-2 py-1 rounded ${data.status === 'approved' ? 'bg-green-100 text-green-700' : (data.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700')}">${data.status}</span>
                    </div>`;
                }).join('');
            }
        }

        // --- FLASHCARD OYUN MANTIÄžI ---
        window.startFlashcardGame = async () => {
            const category = document.getElementById('flashcardCategorySelect').value;
            const btn = document.querySelector('#flashcardStartScreen button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...';

            try {
                let q;
                if (category === 'All') {
                    q = query(collection(db, "flashcards"));
                } else {
                    // Not: Bu sorgu iÃ§in Firestore Index gerekebilir. Hata verirse linke tÄ±kla.
                    // Åžimdilik client-side filtering yapalÄ±m gÃ¼venli olsun.
                    q = query(collection(db, "flashcards"));
                }

                const snap = await getDocs(q);
                flashcardsPool = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    // Manuel filtreleme (Category field varsa) veya hepsi
                    // JSON import'ta category yoksa 'General' varsayÄ±yoruz
                    if (category === 'All' || d.lesson === category || (!d.lesson && category === 'General')) {
                        flashcardsPool.push({ id: doc.id, ...d });
                    }
                });

                if (flashcardsPool.length === 0) {
                    alert("Bu kategoride henÃ¼z kart yok.");
                    btn.innerHTML = 'BaÅŸla';
                    return;
                }

                // Shuffle (KarÄ±ÅŸtÄ±r)
                flashcardsPool.sort(() => Math.random() - 0.5);

                // UI GeÃ§iÅŸi
                document.getElementById('flashcardStartScreen').classList.add('hidden');
                document.getElementById('flashcardGameArea').classList.remove('hidden');
                document.getElementById('fcCategoryBadge').innerText = category === 'All' ? 'KarÄ±ÅŸÄ±k' : category;

                window.nextCard();
                btn.innerHTML = 'BaÅŸla';

            } catch (e) {
                console.error(e);
                alert("Kartlar yÃ¼klenirken hata oluÅŸtu.");
                btn.innerHTML = 'BaÅŸla';
            }
        };

        window.nextCard = () => {
            if (flashcardsPool.length === 0) {
                alert("TÃ¼m kartlar bitti! BaÅŸa dÃ¶nÃ¼lÃ¼yor.");
                window.switchCardTab('browse');
                return;
            }
            // Havuzdan rastgele bir tane alÄ±p Ã§Ä±karalÄ±m (tekrarsÄ±z olsun diye) veya rastgele seÃ§ip bÄ±rakalÄ±m (sonsuz dÃ¶ngÃ¼)
            // Sonsuz dÃ¶ngÃ¼ iÃ§in:
            const randomIndex = Math.floor(Math.random() * flashcardsPool.length);
            currentCard = flashcardsPool[randomIndex];

            // KartÄ± Ã§evrilmemiÅŸ hale getir
            const cardEl = document.querySelector('.flip-card');
            cardEl.classList.remove('flipped');

            // Ä°Ã§eriÄŸi gÃ¼ncelle (biraz gecikmeli ki animasyon bozulmasÄ±n)
            setTimeout(() => {
                document.getElementById('fcFront').innerText = currentCard.front;
                document.getElementById('fcBack').innerText = currentCard.back;
            }, 200);
        };

        // --- 12. NOTLAR ---
        function renderNotes() {
            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Not Defterim</h2>
                    <div class="mb-6 bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <textarea id="newNoteText" class="w-full p-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-primary h-24" placeholder="Yeni bir not al..."></textarea>
                        <button onclick="window.saveNote()" class="mt-2 bg-primary text-white px-6 py-2 rounded-lg font-bold hover:bg-primaryDark">Notu Kaydet</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-32" id="notesList">
                        ${myNotes.length === 0 ? '<p class="text-slate-500">HenÃ¼z notun yok.</p>' : ''}
                        ${myNotes.map(note => `
                            <div class="sticky-note p-6 relative group">
                                <p class="text-slate-800 font-handwriting">${note.text}</p>
                                <div class="absolute bottom-2 right-2 text-xs text-slate-500">${note.date}</div>
                                <button onclick="window.deleteNote('${note.id}')" class="absolute top-2 right-2 text-red-400 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- 13. FORUM ---
        function renderForum() {
            return `
        <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Ã–ÄŸrenci Forumu</h2>
            
            <!-- Yeni Konu Ekleme -->
            <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-8">
                <h3 class="font-bold mb-4 dark:text-white">Yeni Konu BaÅŸlat</h3>
                <div class="space-y-3">
                    <input id="forumTitle" type="text" placeholder="BaÅŸlÄ±k" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-slate-400">
                    <textarea id="forumContent" placeholder="MesajÄ±n..." class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg outline-none focus:border-slate-400" rows="3"></textarea>
                    <select id="forumCategory" class="p-3 border dark:border-slate-600 rounded-lg w-full bg-white dark:bg-slate-700 dark:text-white outline-none">
                        <option>Genel Sohbet</option><option>Ders: TÃ¼rkÃ§e</option><option>Ders: Matematik</option><option>Ders: Tarih</option><option>Motivasyon</option>
                    </select>
                    <button onclick="window.submitForumPost()" class="bg-slate-800 dark:bg-slate-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-900 transition">GÃ¶nder (Onay Gerekli)</button>
                </div>
            </div>

            <!-- ARAMA Ã‡UBUÄžU (YENÄ°) -->
            <div class="mb-6 relative">
                <input type="text" id="forumSearchInput" onkeyup="window.filterForum()" placeholder="Konu baÅŸlÄ±klarÄ±nda veya iÃ§erikte ara..." class="w-full p-3 pl-10 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800 text-slate-800 dark:text-white focus:ring-2 focus:ring-slate-500 outline-none transition">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>

            <div id="forumFeed" class="space-y-4 pb-32">
                <div class="text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
            </div>
        </div>
    `;
        }

        window.submitForumPost = async () => {
            const title = document.getElementById('forumTitle').value;
            const content = document.getElementById('forumContent').value;
            const category = document.getElementById('forumCategory').value;
            if (!title || !content) return alert("Eksik alan var.");

            await addDoc(collection(db, "forumPosts"), {
                uid: currentUser.uid,
                authorName: userData.name,
                authorTitle: userData.title,
                avatar: userData.avatar,
                title, content, category, status: 'pending', createdAt: serverTimestamp()
            });
            window.notifyAdmin("Yeni bir Forum Konusu onayÄ± bekliyor.");
            alert("Konu onaya gÃ¶nderildi.");
            document.getElementById('forumTitle').value = ""; document.getElementById('forumContent').value = "";
        }

        // Verileri Ã‡eken Fonksiyon
        async function loadForumPosts() {
            try {
                const q = query(collection(db, "forumPosts"), where("status", "==", "approved"));
                const snap = await getDocs(q);

                forumPostsCache = []; // Cache'i sÄ±fÄ±rla
                snap.forEach(d => {
                    forumPostsCache.push({ id: d.id, ...d.data() });
                });

                // Tarihe gÃ¶re sÄ±rala (Yeniden eskiye)
                forumPostsCache.sort((a, b) => {
                    const timeA = a.createdAt?.seconds || 0;
                    const timeB = b.createdAt?.seconds || 0;
                    return timeB - timeA;
                });

                renderForumList(forumPostsCache); // Listeyi Ã§izdir

            } catch (err) {
                console.error("Forum loading error:", err);
                document.getElementById('forumFeed').innerHTML = '<div class="text-center text-red-500">Hata oluÅŸtu.</div>';
            }
        }

        // Listeyi Filtreleyen Fonksiyon
        window.filterForum = () => {
            const query = document.getElementById('forumSearchInput').value.toLowerCase();
            const filtered = forumPostsCache.filter(item =>
                (item.title && item.title.toLowerCase().includes(query)) ||
                (item.content && item.content.toLowerCase().includes(query)) ||
                (item.category && item.category.toLowerCase().includes(query)) ||
                (item.authorName && item.authorName.toLowerCase().includes(query))
            );
            renderForumList(filtered);
        };

        // Listeyi Ekrana Basan YardÄ±mcÄ± Fonksiyon
        function renderForumList(items) {
            const container = document.getElementById('forumFeed');
            if (!container) return;

            if (items.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-slate-500 dark:text-slate-400">AradÄ±ÄŸÄ±nÄ±z kriterde konu bulunamadÄ±.</div>';
                return;
            }

            const isAdminUser = currentUser.email.toLowerCase() === "alnigamestudios@gmail.com";

            container.innerHTML = items.map(p => {
                const isAuthorAdmin = p.authorTitle === 'YÃ¶netici';
                const safeTitle = p.title.replace(/'/g, "\\'");

                return `
        <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm relative group transition hover:shadow-md">
            
            <!-- ÅžÄ°KAYET VE SÄ°LME BUTONLARI -->
            <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition z-10">
                <button onclick="window.reportContent('Forum Konusu', '${p.id}', '${safeTitle}')" class="text-slate-300 hover:text-yellow-500 p-2 transition" title="Åžikayet Et">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </button>
                
                ${isAdminUser ? `<button onclick="window.deleteForumPost('${p.id}')" class="text-red-300 hover:text-red-500 p-2 transition" title="YÃ¶netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>

            <div class="flex items-center gap-3 mb-3">
                <img src="${p.avatar}" class="w-10 h-10 rounded-full">
                <div>
                    <div class="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                        ${p.authorName}
                        ${isAuthorAdmin ? '<span class="bg-red-100 text-red-600 px-1.5 py-0.5 rounded text-[9px] font-bold border border-red-200">YÃ–NETÄ°CÄ°</span>' : ''}
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">${p.category} â€¢ ${p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleDateString() : 'Az Ã¶nce'}</div>
                </div>
            </div>
            <h4 class="font-bold text-lg text-slate-900 dark:text-white mb-2">${p.title}</h4>
            <p class="text-slate-600 dark:text-slate-300 whitespace-pre-wrap">${p.content}</p>
        </div>
    `;
            }).join('');
        }

        window.deleteForumPost = async (id) => {
            if (confirm("Bu konuyu silmek istiyor musunuz?")) {
                await deleteDoc(doc(db, "forumPosts", id));
                loadForumPosts();
            }
        };
        // --- 14. FEEDBACK MODULE ---
        function renderFeedback() {
            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Ã–neri & Åžikayet Kutusu</h2>
                    <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-lg border border-orange-100 dark:border-slate-700">
                        <div class="text-center mb-6"><i class="fa-solid fa-envelope-open-text text-6xl text-orange-200 dark:text-orange-900"></i></div>
                        <p class="text-center text-slate-600 dark:text-slate-300 mb-6">UygulamayÄ± geliÅŸtirmemiz iÃ§in fikirlerin bizim iÃ§in Ã§ok deÄŸerli. LÃ¼tfen aklÄ±na gelen her ÅŸeyi yaz.</p>
                        <textarea id="feedbackText" class="w-full p-4 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-xl h-40 focus:border-primary outline-none" placeholder="MesajÄ±nÄ±z..."></textarea>
                        <button onclick="window.sendFeedback()" class="w-full mt-4 bg-primary text-white py-3 rounded-xl font-bold hover:bg-primaryDark transition">GÃ¶nder</button>
                    </div>
                </div>
            `;
        }

        window.sendFeedback = async () => {
            const txt = document.getElementById('feedbackText').value;
            if (!txt) return;
            await addDoc(collection(db, "feedback"), {
                uid: currentUser.uid, name: userData.name, message: txt, createdAt: serverTimestamp(), read: false
            });
            window.notifyAdmin("Yeni bir Geri Bildirim var.");
            alert("MesajÄ±nÄ±z iletildi, teÅŸekkÃ¼rler!");
            document.getElementById('feedbackText').value = "";
        };

        // --- 15. NOTIFICATIONS MODULE ---
        function listenForNotificationBadge() {
            if (unsubscribeNotifications) unsubscribeNotifications();
            const q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), where("read", "==", false));
            unsubscribeNotifications = onSnapshot(q, (snap) => {
                const badge = document.getElementById('notifBadge');
                const mobileBadge = document.getElementById('mobileNotifBadge');
                if (snap.size > 0) {
                    if (badge) { badge.innerText = snap.size; badge.classList.remove('hidden'); }
                    if (mobileBadge) { mobileBadge.innerText = snap.size; mobileBadge.classList.remove('hidden'); }
                } else {
                    if (badge) badge.classList.add('hidden');
                    if (mobileBadge) mobileBadge.classList.add('hidden');
                }
            });
        }

        function renderNotifications() {
            return `
                <div class="max-w-3xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Bildirimler</h2>
                        <div class="flex gap-2">
                            <button onclick="window.toggleSelectAllNotifications()" class="text-xs bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded hover:bg-slate-200 dark:text-white transition">Hepsini SeÃ§</button>
                            <button onclick="window.deleteSelectedNotifications()" class="text-xs bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 border border-red-200 transition">SeÃ§ilenleri Sil</button>
                            <button onclick="window.deleteAllNotifications()" class="text-xs bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 transition">TÃ¼mÃ¼nÃ¼ Sil</button>
                        </div>
                    </div>
                    <div id="notifList" class="space-y-3 pb-32">
                         <div class="text-center text-slate-400 mt-10"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
                    </div>
                </div>
            `;
        }

        async function fetchNotifications() {
            let q;
            q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            let notifs = [];
            snap.forEach(d => notifs.push({ id: d.id, ...d.data() }));

            notifs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            displayNotifications(notifs);

            const unreadQ = query(collection(db, "notifications"), where("uid", "==", currentUser.uid), where("read", "==", false));
            const unreadSnap = await getDocs(unreadQ);
            const batch = writeBatch(db);
            unreadSnap.forEach(d => batch.update(doc(db, "notifications", d.id), { read: true }));
            await batch.commit();
        }

        function displayNotifications(data) {
            const list = document.getElementById('notifList');
            if (!list) return;

            if (data.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 dark:text-slate-400 p-8">Bildirim yok.</div>';
                return;
            }

            let html = '';
            data.forEach(n => {
                // Mesaj uzunluk kontrolÃ¼
                const isLong = n.message.length > 150;
                const shortMsg = isLong ? n.message.substring(0, 150) + "..." : n.message;

                // EÅŸsiz ID oluÅŸtur (Collapse iÅŸlemi iÃ§in)
                const contentId = `notif-content-${n.id}`;
                const btnId = `notif-btn-${n.id}`;

                html += `
            <div class="p-4 bg-white dark:bg-slate-800 border-l-4 ${n.type === 'success' ? 'border-green-500' : (n.type === 'error' ? 'border-red-500' : (n.type === 'warning' ? 'border-yellow-500' : 'border-blue-500'))} rounded shadow-sm flex gap-3 items-start transition hover:shadow-md mb-3">
                <input type="checkbox" class="notif-checkbox mt-1.5 w-4 h-4 accent-primary cursor-pointer" value="${n.id}">
                <div class="flex-1 overflow-hidden">
                    ${n.title ? `<div class="font-bold text-sm text-slate-800 dark:text-white mb-1">${n.title}</div>` : ''}
                    
                    <!-- KÄ±sa Metin -->
                    <div id="${contentId}-short" class="text-sm font-medium text-slate-700 dark:text-slate-200 leading-relaxed whitespace-pre-wrap">${shortMsg}</div>
                    
                    <!-- Uzun Metin (Gizli) -->
                    ${isLong ? `<div id="${contentId}-full" class="hidden text-sm font-medium text-slate-700 dark:text-slate-200 leading-relaxed whitespace-pre-wrap">${n.message}</div>` : ''}
                    
                    <div class="flex justify-between items-center mt-2">
                        <div class="text-xs text-slate-400 flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${n.createdAt ? new Date(n.createdAt.seconds * 1000).toLocaleString() : ''}</div>
                        
                        <!-- GeniÅŸletme Butonu -->
                        ${isLong ? `<button id="${btnId}" onclick="window.toggleNotificationText('${n.id}')" class="text-xs font-bold text-primary hover:underline">DevamÄ±nÄ± Oku</button>` : ''}
                    </div>
                </div>
            </div>`;
            });
            list.innerHTML = html;
        }

        window.toggleNotificationText = (id) => {
            const shortDiv = document.getElementById(`notif-content-${id}-short`);
            const fullDiv = document.getElementById(`notif-content-${id}-full`);
            const btn = document.getElementById(`notif-btn-${id}`);

            if (fullDiv.classList.contains('hidden')) {
                fullDiv.classList.remove('hidden');
                shortDiv.classList.add('hidden');
                btn.innerText = "Daha Az GÃ¶ster";
            } else {
                fullDiv.classList.add('hidden');
                shortDiv.classList.remove('hidden');
                btn.innerText = "DevamÄ±nÄ± Oku";
            }
        };

        window.toggleSelectAllNotifications = () => {
            const checkboxes = document.querySelectorAll('.notif-checkbox');
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        };

        window.deleteSelectedNotifications = async () => {
            const checkboxes = document.querySelectorAll('.notif-checkbox:checked');
            if (checkboxes.length === 0) return alert("SeÃ§im yapmadÄ±nÄ±z.");
            if (!confirm(`${checkboxes.length} bildirimi silmek istiyor musun?`)) return;

            const batch = writeBatch(db);
            checkboxes.forEach(c => { batch.delete(doc(db, "notifications", c.value)); });
            await batch.commit();
            fetchNotifications();
        };

        window.deleteAllNotifications = async () => {
            if (!confirm("TÃœM bildirimlerin silinecek! Emin misin?")) return;
            const q = query(collection(db, "notifications"), where("uid", "==", currentUser.uid));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(doc(db, "notifications", d.id)));
            await batch.commit();
            fetchNotifications();
        };

        // --- 16. QUIZ CENTER (YENÄ°LENMÄ°Åž OYUN MODU) ---
        // --- 16. QUIZ CENTER (GÃœNCELLENDÄ°: MOBÄ°L KAYDIRMA & KÃœÃ‡ÃœLTME) ---
        function renderQuizCenter() {
            return `
                <div class="max-w-3xl mx-auto h-full flex flex-col">
                    <div class="flex border-b border-slate-200 dark:border-slate-700 mb-4 shrink-0">
                        <button onclick="window.switchQuizTab('solve')" id="tabSolve" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Test Ã‡Ã¶z</button>
                        <button onclick="window.switchQuizTab('submit')" id="tabSubmit" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-medium hover:text-slate-700 dark:hover:text-slate-200 transition">Soru GÃ¶nder</button>
                    </div>
                    
                    <div id="contentSolve" class="hidden flex-1 overflow-y-auto w-full px-2"> 
                        
                        <div id="quizStartScreen" class="w-full max-w-md mx-auto text-center p-6 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 mt-4">
                            <i class="fa-solid fa-pen-nib text-4xl md:text-5xl text-primary mb-4"></i>
                            <h3 class="text-lg md:text-xl font-bold text-slate-800 dark:text-white mb-2">Test Ã‡Ã¶z</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Kendini sÄ±namaya hazÄ±r mÄ±sÄ±n? Dersini seÃ§ ve baÅŸla.</p>
                            <select id="quizCategorySelect" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-slate-50 dark:bg-slate-900 dark:text-white outline-none mb-4 text-sm">
                                <option value="All">TÃ¼m Dersler (KarÄ±ÅŸÄ±k)</option>
                                <option value="Tarih">Tarih</option>
                                <option value="CoÄŸrafya">CoÄŸrafya</option>
                                <option value="VatandaÅŸlÄ±k">VatandaÅŸlÄ±k</option>
                                <option value="TÃ¼rkÃ§e">TÃ¼rkÃ§e</option>
                                <option value="Matematik">Matematik</option>
                            </select>
                            <button onclick="window.startQuizGame()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-3 rounded-xl transition shadow-lg shadow-orange-500/30">Teste BaÅŸla</button>
                        </div>

                        <div id="quizGameArea" class="hidden w-full max-w-2xl mx-auto flex flex-col py-4 pb-24"> <div class="w-full flex justify-between items-center mb-3">
                                <button onclick="window.switchQuizTab('solve')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white text-sm"><i class="fa-solid fa-arrow-left"></i> Ã‡Ä±k</button>
                                <span class="bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-200 px-3 py-1 rounded-full text-[10px] md:text-xs font-bold uppercase" id="quizCategoryBadge">Genel</span>
                            </div>

                            <div class="bg-white dark:bg-slate-800 p-5 md:p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 relative">
                                <div class="absolute top-3 right-3 flex gap-1">
                                    <button onclick="window.handleActiveItemReport('question')" class="text-slate-300 hover:text-yellow-500 transition p-2" title="Åžikayet Et"><i class="fa-solid fa-triangle-exclamation"></i></button>
                                    ${currentUser.email === ADMIN_EMAIL ? `<button onclick="window.deleteLiveItem('questions', currentQuestion.id)" class="text-red-300 hover:text-red-500 transition p-2" title="YÃ¶netici Sil"><i class="fa-solid fa-trash"></i></button>` : ''}
                                </div>

                                <div class="text-xs text-slate-400 mb-2 font-bold uppercase tracking-wider">Soru</div>
                                
                                <p class="font-bold text-slate-800 dark:text-white text-base md:text-xl mb-6 leading-relaxed" id="qGameText">...</p>
                                
                                <div class="space-y-2 md:space-y-3" id="qGameOptions">
                                    </div>

                                <div id="qGameFeedback" class="mt-4 hidden p-3 rounded-xl font-bold text-center text-sm md:text-base"></div>
                            </div>

                            <div class="mt-6 text-center">
                                <button onclick="window.nextQuestion()" id="nextQBtn" class="hidden bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-3 px-8 md:px-12 rounded-full shadow-lg transition transform hover:-translate-y-1 w-full md:w-auto">
                                    Sonraki Soru <i class="fa-solid fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="contentSubmit" class="hidden flex-1 overflow-y-auto pb-32 px-2">
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mt-4">
                            <h3 class="font-bold text-lg mb-4 text-slate-800 dark:text-white">TopluluÄŸa KatkÄ±da Bulun</h3>
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Ders</label><select id="qLesson" class="w-full p-3 border dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 dark:text-white"><option>TÃ¼rkÃ§e</option><option>Matematik</option><option>Tarih</option><option>CoÄŸrafya</option><option>VatandaÅŸlÄ±k</option></select></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Soru Metni</label><textarea id="qText" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg" placeholder="Soruyu buraya yazÄ±n..."></textarea></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input id="optA" type="text" placeholder="A ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optB" type="text" placeholder="B ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optC" type="text" placeholder="C ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optD" type="text" placeholder="D ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <input id="optE" type="text" placeholder="E ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg">
                                    <select id="qCorrect" class="p-3 border rounded-lg bg-green-50 border-green-200 dark:bg-green-900 dark:border-green-700 dark:text-white"><option value="0">DoÄŸru Cevap: A</option><option value="1">DoÄŸru Cevap: B</option><option value="2">DoÄŸru Cevap: C</option><option value="3">DoÄŸru Cevap: D</option><option value="4">DoÄŸru Cevap: E</option></select>
                                </div>
                                <button onclick="window.submitQuestion()" class="w-full bg-slate-800 dark:bg-slate-600 text-white font-bold py-3 rounded-lg hover:bg-slate-900 transition">YÃ¶netici OnayÄ±na GÃ¶nder</button>
                            </div>
                        </div>
                        <div class="mt-8"><h3 class="font-bold text-md mb-4 text-slate-800 dark:text-white">GÃ¶nderdiÄŸin Sorular</h3><div id="myQuestionsList" class="space-y-3"></div></div>
                    </div>
                </div>
            `;
        }

        window.switchQuizTab = (tab) => {
            document.getElementById('contentSolve').classList.add('hidden');
            document.getElementById('contentSubmit').classList.add('hidden');
            document.getElementById('tabSolve').classList.remove('tab-btn-active');
            document.getElementById('tabSubmit').classList.remove('tab-btn-active');

            if (tab === 'solve') {
                document.getElementById('contentSolve').classList.remove('hidden');
                document.getElementById('tabSolve').classList.add('tab-btn-active');
                // Reset Game View
                document.getElementById('quizStartScreen').classList.remove('hidden');
                document.getElementById('quizGameArea').classList.add('hidden');
            } else {
                document.getElementById('contentSubmit').classList.remove('hidden');
                document.getElementById('tabSubmit').classList.add('tab-btn-active');
                loadMyQuestions();
            }
        };

        // --- QUIZ OYUN MANTIÄžI ---
        window.startQuizGame = async () => {
            const category = document.getElementById('quizCategorySelect').value;
            const btn = document.querySelector('#quizStartScreen button');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> HazÄ±rlanÄ±yor...';

            try {
                let q;
                if (category === 'All') {
                    q = query(collection(db, "questions"));
                } else {
                    // Not: Index hatasÄ± alÄ±rsan linke tÄ±kla veya client-side filtre kullan.
                    // Client-side filtre (Daha gÃ¼venli):
                    q = query(collection(db, "questions"));
                }

                const snap = await getDocs(q);
                quizQuestionsPool = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if (category === 'All' || d.lesson === category) {
                        quizQuestionsPool.push({ id: doc.id, ...d });
                    }
                });

                if (quizQuestionsPool.length === 0) {
                    alert("Bu kategoride henÃ¼z soru yok.");
                    btn.innerHTML = 'Teste BaÅŸla';
                    return;
                }

                // Shuffle
                quizQuestionsPool.sort(() => Math.random() - 0.5);

                // UI Transition
                document.getElementById('quizStartScreen').classList.add('hidden');
                document.getElementById('quizGameArea').classList.remove('hidden');
                document.getElementById('quizCategoryBadge').innerText = category === 'All' ? 'Karma Test' : category;

                window.nextQuestion();
                btn.innerHTML = 'Teste BaÅŸla';

            } catch (e) {
                console.error(e);
                alert("Hata oluÅŸtu.");
                btn.innerHTML = 'Teste BaÅŸla';
            }
        };

        window.nextQuestion = () => {
            if (quizQuestionsPool.length === 0) {
                alert("Test bitti! BaÅŸa dÃ¶nÃ¼lÃ¼yor.");
                window.switchQuizTab('solve');
                return;
            }

            // Sonsuz dÃ¶ngÃ¼ iÃ§in random seÃ§ip bÄ±rakÄ±yoruz (veya Ã§Ä±karabiliriz)
            // TekrarsÄ±z iÃ§in:
            // currentQuestion = quizQuestionsPool.pop();
            // Sonsuz iÃ§in:
            const randomIndex = Math.floor(Math.random() * quizQuestionsPool.length);
            currentQuestion = quizQuestionsPool[randomIndex];

            // Render
            document.getElementById('qGameText').innerText = currentQuestion.text;
            const optsDiv = document.getElementById('qGameOptions');
            optsDiv.innerHTML = '';

            currentQuestion.options.forEach((opt, idx) => {
                optsDiv.innerHTML += `
                    <button onclick="window.checkGameAnswer(${idx})" 
                        class="quiz-option w-full text-left p-4 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-700 bg-white dark:bg-slate-800 transition flex items-center gap-3" id="gameOpt-${idx}">
                        <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-600 flex items-center justify-center font-bold text-slate-500 dark:text-slate-300 text-sm shrink-0">${String.fromCharCode(65 + idx)}</div>
                        <span class="text-slate-700 dark:text-slate-200">${opt}</span>
                    </button>
                `;
            });

            document.getElementById('qGameFeedback').classList.add('hidden');
            document.getElementById('nextQBtn').classList.add('hidden');
        };

        window.checkGameAnswer = (selectedIdx) => {
            const correctIdx = currentQuestion.correct;
            const feedback = document.getElementById('qGameFeedback');
            const buttons = document.querySelectorAll('.quiz-option');

            // Disable all
            buttons.forEach(btn => btn.disabled = true);

            if (selectedIdx === correctIdx) {
                feedback.innerHTML = '<span class="text-green-600"><i class="fa-solid fa-check-circle"></i> DoÄŸru Cevap! HarikasÄ±n.</span>';
                feedback.className = "mt-6 p-4 rounded-xl font-bold text-center bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800";
                document.getElementById(`gameOpt-${selectedIdx}`).classList.add('ring-2', 'ring-green-500', 'bg-green-50', 'dark:bg-green-900/20');
            } else {
                feedback.innerHTML = `<span class="text-red-600"><i class="fa-solid fa-times-circle"></i> YanlÄ±ÅŸ Cevap. DoÄŸru ÅŸÄ±k: ${String.fromCharCode(65 + correctIdx)}</span>`;
                feedback.className = "mt-6 p-4 rounded-xl font-bold text-center bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800";
                document.getElementById(`gameOpt-${selectedIdx}`).classList.add('ring-2', 'ring-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                document.getElementById(`gameOpt-${correctIdx}`).classList.add('ring-2', 'ring-green-500', 'bg-green-50', 'dark:bg-green-900/20'); // DoÄŸruyu gÃ¶ster

                // Hata Kutusuna Ekle
                window.addToMistakes(currentQuestion.id);
            }

            feedback.classList.remove('hidden');
            document.getElementById('nextQBtn').classList.remove('hidden');
        };

        // ... addToMistakes fonksiyonu Part 4 iÃ§inde tanÄ±mlÄ± ...

        window.submitQuestion = async () => {
            const text = document.getElementById('qText').value;
            const optA = document.getElementById('optA').value;
            if (!text || !optA) return alert("Soru ve en az bir ÅŸÄ±k girin.");

            const qData = {
                uid: currentUser.uid,
                authorName: userData.name,
                lesson: document.getElementById('qLesson').value,
                text: text,
                options: [
                    document.getElementById('optA').value,
                    document.getElementById('optB').value,
                    document.getElementById('optC').value,
                    document.getElementById('optD').value,
                    document.getElementById('optE').value
                ],
                correct: parseInt(document.getElementById('qCorrect').value),
                status: 'pending',
                adminNote: '',
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, "questionSubmissions"), qData);
            window.notifyAdmin("Yeni bir soru onayÄ± bekliyor.");
            alert("Sorun gÃ¶nderildi!");
            document.getElementById('qText').value = "";
            loadMyQuestions();
        };

        async function loadMyQuestions() {
            if (!currentUser) return;
            const q = query(collection(db, "questionSubmissions"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            myQuestions = [];
            snapshot.forEach(doc => myQuestions.push({ id: doc.id, ...doc.data() }));

            const list = document.getElementById('myQuestionsList');
            if (list) {
                list.innerHTML = myQuestions.map(mq => `
                    <div class="p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 flex justify-between items-start">
                        <div>
                            <div class="text-xs font-bold text-slate-500 mb-1">${mq.lesson}</div>
                            <div class="text-sm font-medium text-slate-800 dark:text-white line-clamp-1">${mq.text}</div>
                            ${mq.status === 'rejected' ? `<div class="text-xs text-red-600 mt-2 bg-red-50 p-2 rounded"><strong>Red Sebebi:</strong> ${mq.adminNote}</div>` : ''}
                        </div>
                        <div class="ml-4">
                            ${mq.status === 'pending' ? '<span class="text-xs font-bold bg-yellow-100 text-yellow-700 px-2 py-1 rounded">Bekliyor</span>' : ''}
                            ${mq.status === 'approved' ? '<span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded">YayÄ±nda</span>' : ''}
                            ${mq.status === 'rejected' ? '<span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded">Red</span>' : ''}
                        </div>
                    </div>`).join('') || '<p class="text-sm text-slate-400">HenÃ¼z soru gÃ¶ndermediniz.</p>';
            }
        }

        // --- 17. PROFILE MODULE ---
        function renderProfile() {
            const uName = userData?.name || '';
            const uTarget = userData?.targetScore || 85;
            const uAvatar = userData?.avatar || AVATAR_OPTIONS[0];

            return `
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6">Profil AyarlarÄ±</h2>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6">
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">Avatar SeÃ§</label>
                            <div class="grid grid-cols-4 md:grid-cols-8 gap-2">
                                ${AVATAR_OPTIONS.map(url => `
                                    <img src="${url}" 
                                         onclick="window.updateProfileField('avatar', '${url}')"
                                         class="avatar-option w-12 h-12 rounded-full border-2 border-transparent cursor-pointer transition ${uAvatar === url ? 'selected' : ''}">
                                `).join('')}
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ad Soyad</label><input type="text" onchange="window.updateProfileField('name', this.value)" value="${uName}" class="w-full p-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:border-primary outline-none"></div>
                            <div><label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Hedef PuanÄ±n</label><input type="number" onchange="window.updateProfileField('targetScore', this.value)" value="${uTarget}" class="w-full p-3 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded-lg focus:border-primary outline-none"></div>
                            <div class="text-sm text-slate-500 mt-4 flex items-center gap-2"><i class="fa-solid fa-file-contract"></i><span onclick="window.showPrivacyModal()" class="cursor-pointer hover:underline text-primary">Gizlilik PolitikasÄ±</span></div>
                            <hr class="border-slate-100 dark:border-slate-700 my-4">
                            <button onclick="alert('Åžifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± gÃ¶nderildi.')" class="w-full border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-medium py-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition">Åžifre DeÄŸiÅŸtir</button>
                            <button onclick="window.deleteAccountRequest()" class="w-full border border-red-200 text-red-500 font-medium py-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition">HesabÄ±mÄ± Sil</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.updateProfileField = async (key, value) => {
            userData[key] = value;
            updateSidebar();
            if (key === 'avatar') window.loadPage('profile');
            await updateDoc(doc(db, "users", currentUser.uid), { [key]: value });
        };

        // --- 18. ADMIN PANEL (DÃœZELTÄ°LDÄ°: Layout & Flashcard JSON) ---
        function renderAdminPanel() {
            return `
        <div class="max-w-6xl mx-auto">
            <h1 class="text-2xl font-bold mb-6 text-slate-800 dark:text-white">YÃ¶netim Paneli</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- SOL SÃœTUN (Ä°Ã§erik YÃ¶netimi ve Denetleme) -->
                <div class="lg:col-span-2">
                    
                    <!-- 1. Ãœst MenÃ¼ ButonlarÄ± -->
                    <div class="flex gap-4 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                        <button onclick="window.loadAdminData('questions')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap font-medium transition">Bekleyen Soru</button>
                        <button onclick="window.loadAdminData('cards')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap font-medium transition">Bekleyen Kart</button>
                        <button onclick="window.loadAdminData('forum')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap font-medium transition">Bekleyen Konu</button>
                        <button onclick="window.loadAdminData('inbox')" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-600 rounded shadow-sm hover:bg-slate-50 text-slate-800 dark:text-white whitespace-nowrap font-medium transition">Gelen Kutusu</button>
                    </div>

                    <!-- 2. YENÄ°: Ä°Ã§erik Denetleyicisi (Åžikayetleri Ä°nceleme AlanÄ±) -->
                    <div class="bg-indigo-50 dark:bg-slate-700 p-5 rounded-xl border border-indigo-100 dark:border-slate-600 mb-6 shadow-inner">
                        <h3 class="font-bold text-slate-800 dark:text-white mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass-location text-indigo-500"></i> Ä°Ã§erik Denetleyicisi
                        </h3>
                        <p class="text-xs text-slate-500 dark:text-slate-300 mb-3">Bildirimlerden kopyaladÄ±ÄŸÄ±nÄ±z Ä°Ã§erik ID'sini buraya yapÄ±ÅŸtÄ±rarak iÃ§eriÄŸi inceleyebilir ve silebilirsiniz.</p>
                        
                        <div class="flex flex-col md:flex-row gap-2">
                            <select id="inspectCollection" class="p-2.5 rounded-lg border border-slate-300 dark:border-slate-500 bg-white dark:bg-slate-800 dark:text-white text-sm outline-none cursor-pointer">
    <optgroup label="KPSS (Ana ModÃ¼l)">
        <option value="questions">KPSS Soru Havuzu</option>
        <option value="flashcards">KPSS Flashcard</option>
        <option value="etutQuestions">KPSS EtÃ¼t Sorusu</option>
        <option value="forumPosts">Forum Konusu</option>
        <option value="marketItems">Market ÃœrÃ¼nÃ¼</option>
    </optgroup>
    
    <optgroup label="DGS ModÃ¼lÃ¼">
        <option value="exams/dgs/questions">DGS Sorusu</option>
        <option value="exams/dgs/flashcards">DGS Flashcard</option>
    </optgroup>

    <optgroup label="YKS ModÃ¼lÃ¼">
        <option value="exams/yks/questions">YKS Sorusu</option>
        <option value="exams/yks/flashcards">YKS Flashcard</option>
    </optgroup>
</select>
                            <input type="text" id="inspectContentId" placeholder="Ä°Ã§erik ID YapÄ±ÅŸtÄ±r..." class="flex-1 p-2.5 rounded-lg border border-slate-300 dark:border-slate-500 bg-white dark:bg-slate-800 dark:text-white text-sm outline-none focus:border-indigo-500 transition">
                            <button onclick="window.inspectContent()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 transition">
                                <i class="fa-solid fa-search mr-1"></i> Ä°ncele
                            </button>
                        </div>
                        <!-- SonuÃ§larÄ±n gÃ¶sterileceÄŸi gizli alan -->
                        <div id="inspectorResult" class="mt-4 hidden bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-600 animate-in fade-in slide-in-from-top-2"></div>
                    </div>

                    <!-- 3. Dinamik Ä°Ã§erik Listesi (Bekleyenler vb.) -->
                    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden min-h-[400px]">
                        <div id="adminContentArea" class="divide-y divide-slate-100 dark:divide-slate-700 text-slate-800 dark:text-slate-200">
                            <div class="p-8 text-center text-slate-400">
                                <i class="fa-solid fa-arrow-up"></i><br>Ä°ÅŸlem yapmak iÃ§in yukarÄ±dan bir kategori seÃ§iniz.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SAÄž SÃœTUN (AraÃ§lar) -->
                <div class="space-y-6">
                    
                    <!-- Bildirim GÃ¶nder -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i class="fa-solid fa-bell text-yellow-500"></i> Bildirim GÃ¶nder</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">KullanÄ±cÄ± ID (Opsiyonel)</label>
                                <input type="text" id="adminNotifUid" placeholder="BoÅŸ bÄ±rakÄ±lÄ±rsa herkese gider" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-sm focus:border-primary outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">BaÅŸlÄ±k</label>
                                <input type="text" id="adminNotifTitle" placeholder="Admin MesajÄ±" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-sm focus:border-primary outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mesaj</label>
                                <textarea id="adminNotifMsg" rows="3" placeholder="Bildirim metni..." class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-sm focus:border-primary outline-none"></textarea>
                            </div>
                            <button onclick="window.adminSendNotification()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">GÃ¶nder</button>
                        </div>
                    </div>

                    <!-- Toplu Soru YÃ¼kle -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i class="fa-solid fa-file-import text-indigo-500"></i> Toplu Soru YÃ¼kle</h3>
                        <div class="space-y-3">
                            <p class="text-xs text-slate-500 dark:text-slate-400">JSON Format: <code>[{"lesson":"..", "text":"..", "options":[], "correct":0}]</code></p>
                            <textarea id="bulkJsonData" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-xs font-mono outline-none focus:border-indigo-500" placeholder="JSON buraya..."></textarea>
                            <button onclick="window.bulkUploadQuestions()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2.5 rounded-lg font-bold transition shadow-lg shadow-indigo-500/30">
                                SorularÄ± YÃ¼kle
                            </button>
                        </div>
                    </div>

                    <!-- Toplu Flashcard YÃ¼kle -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i class="fa-solid fa-layer-group text-pink-500"></i> Toplu Flashcard YÃ¼kle</h3>
                        <div class="space-y-3">
                            <p class="text-xs text-slate-500 dark:text-slate-400">JSON Format: <code>[{"front":"Soru", "back":"Cevap"}]</code></p>
                            <textarea id="bulkJsonFlashcards" rows="3" class="w-full p-3 border dark:border-slate-600 dark:bg-slate-900 dark:text-white rounded-lg text-xs font-mono outline-none focus:border-pink-500" placeholder="JSON buraya..."></textarea>
                            <button onclick="window.bulkUploadFlashcards()" class="w-full bg-pink-600 hover:bg-pink-700 text-white py-2.5 rounded-lg font-bold transition shadow-lg shadow-pink-500/30">
                                KartlarÄ± YÃ¼kle
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    `;
        }

        // --- ADMIN HELPER FUNCTIONS ---
        window.loadAdminData = async (type) => {
            const container = document.getElementById('adminContentArea');
            container.innerHTML = '<div class="p-8 text-center text-slate-400">YÃ¼kleniyor...</div>';
            let html = '';

            if (type === 'questions') {
                const q = query(collection(db, "questionSubmissions"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if (snap.empty) html = '<div class="p-8 text-center">Bekleyen soru yok.</div>';
                else {
                    snap.forEach(doc => {
                        const d = doc.data(); html += `
                        <div class="p-6">
                             <div class="flex justify-between mb-2"><span class="badge bg-blue-100 text-blue-800 px-2 rounded">${d.lesson}</span> <span class="text-xs text-slate-500">${d.authorName}</span></div>
                             <p class="font-bold mb-2">${d.text}</p>
                             <div class="grid grid-cols-2 text-sm gap-2 mb-4">${d.options.map((o, i) => `<div class="${i === d.correct ? 'text-green-600 font-bold' : ''}">${String.fromCharCode(65 + i)}) ${o}</div>`).join('')}</div>
                             <div class="flex gap-2"><button onclick="window.adminAction('question', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('question', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'cards') {
                const q = query(collection(db, "flashcardSubmissions"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if (snap.empty) html = '<div class="p-8 text-center">Bekleyen kart yok.</div>';
                else {
                    snap.forEach(doc => {
                        const d = doc.data(); html += `
                        <div class="p-6 flex justify-between items-center">
                            <div><div class="font-bold text-lg">${d.front}</div><div class="text-slate-600 dark:text-slate-400">${d.back}</div><div class="text-xs text-slate-400 mt-1">${d.authorName}</div></div>
                            <div class="flex gap-2"><button onclick="window.adminAction('card', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('card', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'forum') {
                const q = query(collection(db, "forumPosts"), where("status", "==", "pending"));
                const snap = await getDocs(q);
                if (snap.empty) html = '<div class="p-8 text-center">Bekleyen konu yok.</div>';
                else {
                    snap.forEach(doc => {
                        const d = doc.data(); html += `
                        <div class="p-6">
                            <h4 class="font-bold text-lg">${d.title}</h4><p class="text-slate-600 dark:text-slate-400 mb-2">${d.content}</p><div class="text-xs text-slate-400 mb-2">${d.category} - ${d.authorName}</div>
                            <div class="flex gap-2"><button onclick="window.adminAction('forum', '${doc.id}', 'approve')" class="bg-green-500 text-white px-3 py-1 rounded">Onayla</button><button onclick="window.adminAction('forum', '${doc.id}', 'reject')" class="bg-red-500 text-white px-3 py-1 rounded">Reddet</button></div>
                        </div>`;
                    });
                }
            } else if (type === 'inbox') {
                const q = query(collection(db, "feedback"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                snap.forEach(doc => { const d = doc.data(); html += `<div class="p-6"><div class="font-bold text-slate-800 dark:text-white">${d.name}</div><p class="text-slate-600 dark:text-slate-400 mt-1">${d.message}</p><div class="text-xs text-slate-400 mt-2">${d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleString() : ''}</div></div>`; });
            }

            container.innerHTML = html || '<div class="p-8 text-center">Veri yok.</div>';
        };

        window.adminAction = async (type, id, action) => {
            const collectionName = type === 'question' ? 'questionSubmissions' : (type === 'card' ? 'flashcardSubmissions' : 'forumPosts');
            const docRef = doc(db, collectionName, id);
            const docSnap = await getDoc(docRef);
            const data = docSnap.data();

            const notifMsg = `GÃ¶nderin (${type}) yÃ¶netici tarafÄ±ndan ${action === 'approve' ? 'onaylandÄ±' : 'reddedildi'}.`;
            await addDoc(collection(db, "notifications"), { uid: data.uid, title: "Onay Durumu", message: notifMsg, type: action === 'approve' ? 'success' : 'error', read: false, createdAt: serverTimestamp() });

            if (action === 'reject') {
                await updateDoc(docRef, { status: 'rejected' });
            } else {
                await updateDoc(docRef, { status: 'approved' });
                // OnaylananlarÄ± ana koleksiyona taÅŸÄ± (CANLI VERÄ°TABANI)
                if (type === 'question') {
                    await addDoc(collection(db, "questions"), {
                        lesson: data.lesson, text: data.text, options: data.options, correct: data.correct,
                        authorName: data.authorName, uid: data.uid, createdAt: serverTimestamp(), status: 'approved'
                    });
                }
                if (type === 'card') {
                    await addDoc(collection(db, "flashcards"), {
                        front: data.front, back: data.back, authorName: data.authorName, uid: data.uid, createdAt: serverTimestamp()
                    });
                }
            }
            alert("Ä°ÅŸlem tamam.");
            loadAdminData(type === 'question' ? 'questions' : (type === 'card' ? 'cards' : 'forum'));
        };

        window.bulkUploadQuestions = async () => {
            const input = document.getElementById('bulkJsonData').value.trim();
            if (!input) return alert("LÃ¼tfen JSON verisi yapÄ±ÅŸtÄ±rÄ±n.");
            try {
                const questions = JSON.parse(input);
                if (!Array.isArray(questions)) throw new Error("Veri kÃ¶ÅŸeli parantez [] ile baÅŸlamalÄ±.");
                if (questions.length === 0) throw new Error("Liste boÅŸ.");
                if (!confirm(`${questions.length} adet soru YAYINA alÄ±nacak. Emin misin?`)) return;

                const batch = writeBatch(db);
                let count = 0;
                questions.forEach(q => {
                    if (q.lesson && q.text && Array.isArray(q.options) && q.correct !== undefined) {
                        const newRef = doc(collection(db, "questions"));
                        batch.set(newRef, {
                            lesson: q.lesson, text: q.text, options: q.options, correct: Number(q.correct),
                            authorName: "Sistem", uid: currentUser.uid, createdAt: serverTimestamp(), status: 'approved'
                        });
                        count++;
                    }
                });
                await batch.commit();
                alert(`âœ… Ä°ÅŸlem BaÅŸarÄ±lÄ±! ${count} soru canlÄ±ya alÄ±ndÄ±.`);
                document.getElementById('bulkJsonData').value = "";
            } catch (e) { console.error(e); alert("âŒ HATA: " + e.message); }
        };

        // --- EKSÄ°K OLAN FLASHCARD YÃœKLEME FONKSÄ°YONU ---
        window.bulkUploadFlashcards = async () => {
            // 1. Elementi Bul
            const inputEl = document.getElementById('bulkJsonFlashcards');
            if (!inputEl) return alert("Hata: JSON kutusu bulunamadÄ±.");

            const input = inputEl.value.trim();
            if (!input) return alert("LÃ¼tfen kutuya JSON verisi yapÄ±ÅŸtÄ±rÄ±n.");

            try {
                // 2. JSON AyrÄ±ÅŸtÄ±rma
                const cards = JSON.parse(input);

                // 3. YapÄ± KontrolÃ¼
                if (!Array.isArray(cards)) throw new Error("Veri [...] kÃ¶ÅŸeli parantez ile baÅŸlamalÄ±dÄ±r.");
                if (cards.length === 0) throw new Error("Liste boÅŸ.");

                if (!confirm(`${cards.length} adet Flashcard YAYINA alÄ±nacak. Emin misin?`)) return;

                // Butonu geÃ§ici olarak kilitle
                const btn = document.querySelector('button[onclick="window.bulkUploadFlashcards()"]');
                if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ä°ÅŸleniyor...'; }

                // 4. VeritabanÄ±na Yazma (Batch iÅŸlemi)
                const batch = writeBatch(db);
                let count = 0;

                cards.forEach((c, index) => {
                    // AnahtarlarÄ±n (Keys) doÄŸru olduÄŸundan emin oluyoruz
                    if (c.front && c.back) {
                        const newRef = doc(collection(db, "flashcards"));
                        batch.set(newRef, {
                            front: c.front,
                            back: c.back,
                            lesson: c.lesson || "General", // Ders belirtilmemiÅŸse 'General' yap
                            authorName: "Sistem",
                            uid: currentUser.uid,
                            createdAt: serverTimestamp()
                        });
                        count++;
                    } else {
                        console.warn(`SatÄ±r ${index + 1} atlandÄ±: 'front' veya 'back' verisi eksik.`);
                    }
                });

                if (count === 0) throw new Error("YÃ¼klenecek geÃ§erli kart bulunamadÄ±. JSON formatÄ±nda 'front' ve 'back' alanlarÄ±nÄ±n olduÄŸundan emin ol.");

                await batch.commit();

                alert(`âœ… BAÅžARILI! ${count} adet kart sisteme yÃ¼klendi.`);
                inputEl.value = ""; // Kutuyu temizle

            } catch (e) {
                console.error("YÃ¼kleme HatasÄ±:", e);
                alert("âŒ HATA: " + e.message + "\n\nLÃ¼tfen JSON formatÄ±nÄ± kontrol et.");
            } finally {
                // Butonu eski haline getir
                const btn = document.querySelector('button[onclick="window.bulkUploadFlashcards()"]');
                if (btn) { btn.disabled = false; btn.innerHTML = 'KartlarÄ± YÃ¼kle'; }
            }
        };

        window.startFlashcardGame = async () => {
            const category = document.getElementById('flashcardCategorySelect').value;
            const btn = document.querySelector('#flashcardStartScreen button');

            // Butonu kilitle ve yÃ¼kleniyor yap
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...';
            btn.disabled = true;

            try {
                // VeritabanÄ±ndan tÃ¼m kartlarÄ± Ã§ek
                const q = query(collection(db, "flashcards"));
                const snap = await getDocs(q);

                flashcardsPool = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    // Kategori filtreleme: "All" ise hepsi, deÄŸilse sadece o ders
                    // EÄŸer veritabanÄ±nda 'lesson' alanÄ± yoksa ve kategori 'General' ise onu da al
                    if (category === 'All' || d.lesson === category || (!d.lesson && category === 'General')) {
                        flashcardsPool.push({ id: doc.id, ...d });
                    }
                });

                // EÄŸer hiÃ§ kart yoksa uyar
                if (flashcardsPool.length === 0) {
                    alert("Bu kategoride henÃ¼z kart bulunamadÄ±.");
                    btn.innerHTML = 'BaÅŸla';
                    btn.disabled = false;
                    return;
                }

                // KartlarÄ± karÄ±ÅŸtÄ±r (Shuffle)
                flashcardsPool.sort(() => Math.random() - 0.5);

                // EkranlarÄ± deÄŸiÅŸtir (GiriÅŸ ekranÄ±nÄ± gizle, Oyunu aÃ§)
                document.getElementById('flashcardStartScreen').classList.add('hidden');
                document.getElementById('flashcardGameArea').classList.remove('hidden');

                // Rozeti gÃ¼ncelle
                const badge = document.getElementById('fcCategoryBadge');
                if (badge) badge.innerText = category === 'All' ? 'KarÄ±ÅŸÄ±k' : category;

                // Ä°LK KARTI GETÄ°R
                window.nextCard();

                // Butonu resetle (geri dÃ¶nÃ¼lÃ¼rse hazÄ±r olsun)
                btn.innerHTML = 'BaÅŸla';
                btn.disabled = false;

            } catch (e) {
                console.error("Kart yÃ¼kleme hatasÄ±:", e);
                alert("Kartlar yÃ¼klenirken hata oluÅŸtu: " + e.message);
                btn.innerHTML = 'BaÅŸla';
                btn.disabled = false;
            }
        };

        window.nextCard = () => {
            // 1. Havuz kontrolÃ¼
            if (!flashcardsPool || flashcardsPool.length === 0) {
                alert("GÃ¶sterilecek kart kalmadÄ±! Kategori seÃ§imine dÃ¶nÃ¼lÃ¼yor.");
                window.switchCardTab('browse');
                return;
            }

            // 2. Rastgele bir kart seÃ§
            const randomIndex = Math.floor(Math.random() * flashcardsPool.length);
            currentCard = flashcardsPool[randomIndex];

            // 3. Kart elementini bul
            const cardEl = document.querySelector('.flip-card');

            if (cardEl) {
                // EÄŸer kartÄ±n arkasÄ± dÃ¶nÃ¼kse (cevap aÃ§Ä±ksa), Ã¶nce Ã¶n yÃ¼zÃ¼nÃ¼ Ã§evir
                if (cardEl.classList.contains('flipped')) {
                    cardEl.classList.remove('flipped');

                    // Animasyonun bitmesini bekle (300ms), sonra yazÄ±larÄ± deÄŸiÅŸtir
                    // Bu sayede kullanÄ±cÄ± yazÄ±nÄ±n deÄŸiÅŸtiÄŸini Ã§evrilirken gÃ¶rmez
                    setTimeout(() => {
                        updateCardText();
                    }, 300);
                } else {
                    // Zaten Ã¶n yÃ¼zdeyse direkt deÄŸiÅŸtir
                    updateCardText();
                }
            } else {
                // Element bulunamazsa (nadiren olur) direkt gÃ¼ncelle
                updateCardText();
            }

            // Ä°Ã§ yardÄ±mcÄ± fonksiyon: Metinleri gÃ¼ncelle
            function updateCardText() {
                const frontEl = document.getElementById('fcFront');
                const backEl = document.getElementById('fcBack');

                if (frontEl) frontEl.innerText = currentCard.front;
                if (backEl) backEl.innerText = currentCard.back;
            }
        };

        window.adminSendNotification = async () => {
            const targetUid = document.getElementById('adminNotifUid').value.trim();
            const title = document.getElementById('adminNotifTitle').value.trim() || "Sistem MesajÄ±";
            const message = document.getElementById('adminNotifMsg').value.trim();
            if (!message) return alert("Mesaj yazmalÄ±sÄ±n.");

            const notifData = { message, title, type: 'info', read: false, createdAt: serverTimestamp() };

            if (targetUid) {
                await addDoc(collection(db, "notifications"), { ...notifData, uid: targetUid });
                alert("Bildirim gÃ¶nderildi (Tekil).");
            } else {
                if (!confirm("TÃœM kullanÄ±cÄ±lara bildirim gidecek. Emin misin?")) return;
                const usersSnap = await getDocs(collection(db, "users"));
                const batch = writeBatch(db);
                let count = 0;
                usersSnap.forEach(doc => {
                    if (doc.id !== currentUser.uid) {
                        const newRef = doc(collection(db, "notifications"));
                        batch.set(newRef, { ...notifData, uid: doc.id });
                        count++;
                    }
                });
                await batch.commit();
                alert(`Toplam ${count} kullanÄ±cÄ±ya bildirim gÃ¶nderildi.`);
            }
            document.getElementById('adminNotifMsg').value = "";
        };

        window.notifyAdmin = async (msg) => {
            const q = query(collection(db, "users"), where("email", "==", ADMIN_EMAIL));
            const snap = await getDocs(q);
            snap.forEach(async d => {
                await addDoc(collection(db, "notifications"), { uid: d.id, title: "YÃ¶netici UyarÄ±sÄ±", message: msg, type: 'warning', read: false, createdAt: serverTimestamp() });
            });
        };

        // --- 19. MOCKS MODULE ---
        function renderMocks() {
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-32">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Yeni Deneme Ekle</h2>
                        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500">TÃ¼rkÃ§e Net</label><input type="number" id="netTr" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Matematik Net</label><input type="number" id="netMat" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">Tarih Net</label><input type="number" id="netHist" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">CoÄŸrafya Net</label><input type="number" id="netGeo" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                                <div><label class="text-xs font-bold text-slate-500">VatandaÅŸlÄ±k Net</label><input type="number" id="netCit" class="w-full p-2 border dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded outline-none focus:border-primary" placeholder="0"></div>
                            </div>
                            <button onclick="window.saveMockResult()" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primaryDark mt-4">Hesapla ve Kaydet</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">SonuÃ§ GeÃ§miÅŸi</h2>
                        <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm overflow-hidden max-h-96 overflow-y-auto">
                            ${mockExamsHistory.length === 0 ? '<p class="p-4 text-slate-500">KayÄ±t yok.</p>' : ''}
                            ${mockExamsHistory.map(m => `
                                <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700">
                                    <div>
                                        <div class="font-bold text-slate-800 dark:text-white">${m.date}</div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">TR: ${m.trNet} | MAT: ${m.mathNet} | TAR: ${m.histNet}</div>
                                    </div>
                                    <div class="text-xl font-bold text-primary">${m.totalScore} Puan</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                <div class="mt-8 bg-white dark:bg-slate-800 p-6 rounded-2xl h-80 border border-slate-100 dark:border-slate-700 shadow-sm pb-32">
                    <h3 class="font-bold mb-4 dark:text-white">Ä°lerleme Analizi</h3>
                    <canvas id="historyChart"></canvas>
                </div>
            `;
        }

        window.saveMockResult = async () => {
            // 1. DeÄŸerleri Al
            const tr = Number(document.getElementById('netTr').value) || 0;
            const mat = Number(document.getElementById('netMat').value) || 0;
            const hist = Number(document.getElementById('netHist').value) || 0;
            const geo = Number(document.getElementById('netGeo').value) || 0;
            const cit = Number(document.getElementById('netCit').value) || 0;

            // 2. Puan Hesapla (KPSS P3 SimÃ¼lasyonu)
            const gy = tr + mat;
            const gk = hist + geo + cit;
            let score = Math.round(55 + (gy * 0.4) + (gk * 0.4));
            if (score > 100) score = 100;

            // 3. GeÃ§miÅŸe Ekleme Verisi HazÄ±rla
            const data = {
                trNet: tr, mathNet: mat, histNet: hist, geoNet: geo, citNet: cit,
                totalScore: score,
                date: new Date().toLocaleDateString('tr-TR'),
                createdAt: serverTimestamp()
            };

            try {
                // Deneme GeÃ§miÅŸine Ekle
                await addDoc(collection(db, `users/${currentUser.uid}/mockExams`), data);

                // KullanÄ±cÄ± Profilini GÃ¼ncelle (KPSS PuanÄ± ve Genel Puan)
                await updateDoc(doc(db, "users", currentUser.uid), {
                    totalScore: score,  // Profilde gÃ¶rÃ¼nen genel puan
                    kpssScore: score    // SÄ±ralama tablosu iÃ§in Ã¶zel puan
                });

                alert(`PuanÄ±n: ${score}. Kaydedildi!`);
                window.loadPage('mocks'); // SayfayÄ± yenile
            } catch (e) {
                console.error(e);
                alert("Kaydederken bir hata oluÅŸtu.");
            }
        };

        async function loadMocks() {
            const q = query(collection(db, `users/${currentUser.uid}/mockExams`), orderBy("createdAt", "desc"), limit(10));
            onSnapshot(q, (s) => {
                mockExamsHistory = [];
                s.forEach(d => mockExamsHistory.push(d.data()));
                const content = document.getElementById('contentArea');
                if (content.innerHTML.includes('Yeni Deneme Ekle') || content.innerHTML.includes('Puan GrafiÄŸi')) {
                    const active = document.querySelector('.active-nav');
                    if (active) window.loadPage(active.id.replace('nav-', ''));
                }
            });
        }

        function renderChart(canvasId) {
            const ctx = document.getElementById(canvasId);
            if (!ctx || mockExamsHistory.length === 0) return;

            const existingChart = Chart.getChart(ctx);
            if (existingChart) existingChart.destroy();

            const labels = mockExamsHistory.slice().reverse().map(m => m.date);
            const data = mockExamsHistory.slice().reverse().map(m => m.totalScore);
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e2e8f0' : '#64748b';

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Puan',
                        data: data,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 50, max: 100, ticks: { color: textColor } },
                        x: { ticks: { color: textColor } }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                }
            });
        }

        // --- GLOBAL HELPERS & CLOSING ---

        // ÅžÄ°KAYET MEKANÄ°ZMASI
        window.reportContent = async (type, id, contentSummary) => {
            if (!confirm("Bu iÃ§eriÄŸi hatalÄ±/uygunsuz olarak bildirmek istiyor musun?")) return;

            const message = `KULLANICI ÅžÄ°KAYETÄ°: Bir ${type} ÅŸikayet edildi.\nID: ${id}\nÄ°Ã§erik Ã–zeti: ${contentSummary || 'Belirtilmedi'}`;

            // Admin'e bildirim gÃ¶nder
            const q = query(collection(db, "users"), where("email", "==", ADMIN_EMAIL));
            const snap = await getDocs(q);
            snap.forEach(async d => {
                await addDoc(collection(db, "notifications"), {
                    uid: d.id,
                    title: "âš ï¸ Ä°Ã§erik Åžikayeti",
                    message: message,
                    type: 'error',
                    read: false,
                    createdAt: serverTimestamp()
                });
            });
            alert("Bildiriminiz yÃ¶neticilere iletildi. TeÅŸekkÃ¼rler.");
        };

        window.deleteLiveItem = async (col, id) => {
            if (confirm("YÃ–NETÄ°CÄ° YETKÄ°SÄ°: Bu canlÄ± veriyi silmek Ã¼zeresin!")) {
                await deleteDoc(doc(db, col, id));
                alert("Silindi.");
                // SayfayÄ± yenile veya yeniden yÃ¼kle
                if (col === 'questions') { window.startQuizGame(); }
                if (col === 'flashcards') { window.nextCard(); }
            }
        };

        // --- ÅžÄ°KAYET FONKSÄ°YONU (YENÄ°) ---
        // Script'in en altÄ±na, diÄŸer global window fonksiyonlarÄ±nÄ±n yanÄ±na ekle.

        window.reportContent = async (contentType, contentId, contentTitle) => {
            // 1. ADIM: KullanÄ±cÄ±dan GerekÃ§e Ä°ste (Prompt Penceresi)
            const reason = prompt("Bu iÃ§eriÄŸi neden ÅŸikayet ediyorsunuz?\nLÃ¼tfen gerekÃ§enizi kÄ±saca yazÄ±n:", "Uygunsuz iÃ§erik / HatalÄ± bilgi");

            // EÄŸer 'Ä°ptal'e basarsa veya boÅŸ bÄ±rakÄ±rsa iÅŸlemi durdur
            if (reason === null) { // KullanÄ±cÄ± iptal etti
                return;
            }
            if (reason.trim().length < 3) {
                return alert("LÃ¼tfen geÃ§erli bir ÅŸikayet gerekÃ§esi belirtin (en az 3 karakter).");
            }

            // YÃ¼kleniyor durumu (Opsiyonel UX iÃ§in)
            const originalCursor = document.body.style.cursor;
            document.body.style.cursor = 'wait'; // Ä°mleci bekleme moduna al

            try {
                // 2. ADIM: Ä°Ã§erik BaÅŸlÄ±ÄŸÄ±nÄ± GÃ¼venli Hale Getir
                // OlasÄ± hatalarÄ± Ã¶nlemek iÃ§in tÄ±rnaklarÄ± ve Ã¶zel karakterleri temizle
                const safeTitle = contentTitle ? contentTitle.replace(/[\\"']/g, "\\$&").replace(/\n/g, " ") : "BaÅŸlÄ±k Yok";
                const summary = safeTitle.length > 50 ? safeTitle.substring(0, 50) + "..." : safeTitle;

                // 3. ADIM: Admin MesajÄ±nÄ± HazÄ±rla (GerekÃ§eyi de ekledik)
                const reportMessage = `ðŸš¨ ÅžÄ°KAYET VAR!\n\nðŸ‘¤ Bildiren: ${userData.name} (ID: ${currentUser.uid})\nðŸ“‚ TÃ¼r: ${contentType}\nðŸ“ GerekÃ§e: "${reason}"\nðŸ”— Ä°Ã§erik ID: ${contentId}\nðŸ“Œ BaÅŸlÄ±k Ã–zeti: ${summary}`;

                // 4. ADIM: Admin KullanÄ±cÄ±sÄ±nÄ± Bul
                const adminEmail = "alnigamestudios@gmail.com";
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", adminEmail));
                const adminSnap = await getDocs(q); // Snapshot'Ä± adminSnap olarak yeniden adlandÄ±rdÄ±k

                if (!adminSnap.empty) {
                    // Admin bulundu, bildirimi gÃ¶nder
                    const batch = writeBatch(db);

                    adminSnap.forEach(adminUserDoc => { // DÃ¶ngÃ¼ deÄŸiÅŸkenini 'adminUserDoc' olarak yeniden adlandÄ±rdÄ±k
                        // Yeni bir bildirim dokÃ¼man referansÄ± oluÅŸtur (otomatik ID ile)
                        const notifRef = doc(collection(db, "notifications"));

                        batch.set(notifRef, {
                            uid: adminUserDoc.id, // Admin'in UID'sini doÄŸru ÅŸekilde kullanÄ±yoruz
                            title: "âš ï¸ Ä°Ã§erik Åžikayeti",
                            message: reportMessage,
                            type: "error", // KÄ±rmÄ±zÄ± renkli (Ã¶nemli) bildirim
                            read: false,
                            createdAt: serverTimestamp()
                        });
                    });

                    await batch.commit();
                    alert("Åžikayetiniz ve gerekÃ§eniz yÃ¶neticilere iletildi. Hassasiyetiniz iÃ§in teÅŸekkÃ¼rler.");
                } else {
                    console.warn(`Sistem YÃ¶neticisi (${adminEmail}) bulunamadÄ±. LÃ¼tfen users koleksiyonunda kayÄ±tlÄ± olduÄŸunu teyit edin.`);
                    alert("Åžikayet alÄ±nÄ±rken teknik bir sorun oluÅŸtu (YÃ¶netici hesabÄ± bulunamadÄ±). LÃ¼tfen yÃ¶neticilere doÄŸrudan ulaÅŸÄ±n.");
                }

            } catch (error) {
                console.error("Åžikayet HatasÄ± DetayÄ±:", error);
                alert("Bir hata oluÅŸtu: " + error.message + "\n\nLÃ¼tfen konsolu kontrol edin.");
            } finally {
                document.body.style.cursor = originalCursor; // Ä°mleci eski haline dÃ¶ndÃ¼r
            }
        };

        window.addToMistakes = async (qId) => {
            const docRef = doc(db, "questions", qId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                await setDoc(doc(db, `users/${currentUser.uid}/mistakes/${qId}`), {
                    lesson: data.lesson,
                    text: data.text,
                    options: data.options,
                    correct: data.correct,
                    addedAt: serverTimestamp()
                });
            }
        };

        window.checkMistakeAnswer = async (docId, selectedIdx, correctIdx) => {
            const feedback = document.getElementById(`feedback-${docId}`);
            const buttons = document.querySelectorAll(`.mistake-opt-${docId}`);

            buttons.forEach(btn => btn.disabled = true);

            if (selectedIdx === correctIdx) {
                feedback.innerHTML = '<span class="text-green-500"><i class="fa-solid fa-check"></i> DoÄŸru! Kutu temizleniyor...</span>';
                feedback.classList.remove('hidden');
                buttons[selectedIdx].classList.add('bg-green-100', 'border-green-500', 'text-green-700');

                setTimeout(async () => {
                    await deleteDoc(doc(db, `users/${currentUser.uid}/mistakes/${docId}`));
                    const el = document.getElementById(`mistake-${docId}`);
                    if (el) {
                        el.style.transition = 'all 0.5s';
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            el.remove();
                            if (document.getElementById('mistakesList').children.length === 0) loadMistakes();
                        }, 500);
                    }
                }, 1500);
            } else {
                feedback.innerHTML = '<span class="text-red-500"><i class="fa-solid fa-xmark"></i> YanlÄ±ÅŸ. Tekrar dene!</span>';
                feedback.classList.remove('hidden');
                buttons[selectedIdx].classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                setTimeout(() => {
                    buttons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('bg-red-100', 'border-red-500', 'text-red-700');
                    });
                    feedback.classList.add('hidden');
                }, 1500);
            }
        };

        window.deleteMistake = async (id) => {
            if (confirm("Bu soruyu kutudan silmek istiyor musun?")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/mistakes/${id}`));
                loadMistakes();
            }
        };

        window.saveNote = async () => { const txt = document.getElementById('newNoteText').value; if (!txt) return; await addDoc(collection(db, `users/${currentUser.uid}/notes`), { text: txt, createdAt: serverTimestamp() }); document.getElementById('newNoteText').value = ""; loadMyNotes(); };
        window.deleteNote = async (id) => { if (confirm("Sileyim mi?")) { await deleteDoc(doc(db, `users/${currentUser.uid}/notes/${id}`)); loadMyNotes(); } };
        window.toggleTimer = () => { if (isTimerRunning) { clearInterval(pomodoroInterval); isTimerRunning = false; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; } else { isTimerRunning = true; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-pause text-[10px]"></i>'; pomodoroInterval = setInterval(() => { pomodoroTimeLeft--; const m = Math.floor(pomodoroTimeLeft / 60).toString().padStart(2, '0'); const s = (pomodoroTimeLeft % 60).toString().padStart(2, '0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; if (pomodoroTimeLeft <= 0) { clearInterval(pomodoroInterval); isTimerRunning = false; alert("Pomodoro Bitti! +1 Puan"); savePomodoroSession(); pomodoroTimeLeft = 25 * 60; document.getElementById('timerDisplay').innerText = "25:00"; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; } }, 1000); } };
        window.resetTimer = () => { clearInterval(pomodoroInterval); isTimerRunning = false; pomodoroTimeLeft = 25 * 60; document.getElementById('timerDisplay').innerText = "25:00"; document.getElementById('timerBtn').innerHTML = '<i class="fa-solid fa-play text-[10px]"></i>'; };
        async function savePomodoroSession() { const newCount = (userData.pomodoroSessions || 0) + 1; userData.pomodoroSessions = newCount; document.getElementById('pomodoroCount').innerText = newCount + " Seans"; await updateDoc(doc(db, "users", currentUser.uid), { pomodoroSessions: newCount }); }
        window.cycleStatus = async (key) => { if (!userData.progress) userData.progress = {}; const current = userData.progress[key] || 'not_started'; const currentIdx = ['not_started', 'started', 'completed', 'needs_review'].indexOf(current); const next = ['not_started', 'started', 'completed', 'needs_review'][(currentIdx + 1) % 4]; userData.progress[key] = next; window.loadPage('subjects'); await updateDoc(doc(db, "users", currentUser.uid), { progress: userData.progress }); };
        window.deleteAccountRequest = async () => { if (confirm("HesabÄ±nÄ± silmek istediÄŸine emin misin?")) { try { await deleteDoc(doc(db, "users", currentUser.uid)); await deleteUser(currentUser); alert("HesabÄ±nÄ±z silindi."); window.location.reload(); } catch (e) { alert("Hata: " + e.message); } } };
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } catch (e) { alert(e.message) } };
        window.handleRegister = async () => { try { if (!document.getElementById('privacyCheck').checked) throw new Error("Onay gerekli"); const cred = await createUserWithEmailAndPassword(auth, document.getElementById('regEmail').value, document.getElementById('regPassword').value); await setDoc(doc(db, "users", cred.user.uid), { name: document.getElementById('regName').value, email: cred.user.email, progress: {}, targetScore: 85, createdAt: serverTimestamp(), avatar: AVATAR_OPTIONS[0], pomodoroSessions: 0, totalScore: 0 }); } catch (e) { alert(e.message) } };

        window.logout = async () => { await signOut(auth); window.location.reload(); };
        window.toggleAuth = (type) => { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('registerForm').classList.add('hidden'); document.getElementById(type === 'login' ? 'loginForm' : 'registerForm').classList.remove('hidden'); };
        window.showPrivacyModal = () => document.getElementById('privacyModal').classList.remove('hidden');
        window.closePrivacyModal = () => document.getElementById('privacyModal').classList.add('hidden');
        async function loadMyNotes() { const q = query(collection(db, `users/${currentUser.uid}/notes`), orderBy("createdAt", "desc")); const snap = await getDocs(q); myNotes = []; snap.forEach(d => myNotes.push({ id: d.id, text: d.data().text, date: new Date(d.data().createdAt?.seconds * 1000).toLocaleDateString() })); if (document.getElementById('nav-notes').classList.contains('active-nav')) window.loadPage('notes'); }
        function calculateStats() { let totalTopics = 0, completed = 0, started = 0; for (let les in CURRICULUM) { totalTopics += CURRICULUM[les].length; CURRICULUM[les].forEach(t => { const s = (userData.progress || {})[les + "_" + t]; if (s === 'completed') completed++; if (s === 'started') started++; }); } const totalProgress = Math.round((completed / totalTopics) * 100) || 0; const avgScore = mockExamsHistory.length > 0 ? Math.round(mockExamsHistory.reduce((a, b) => a + b.totalScore, 0) / mockExamsHistory.length) : 0; let situation = "Veri giriÅŸi bekleniyor.", strategy = "Ã–nce konulara baÅŸla.", shortAdvice = "BaÅŸlamak bitirmenin yarÄ±sÄ±dÄ±r.", weakness = "Veri yok.", motivation = "Yolun baÅŸÄ±ndasÄ±n."; if (totalProgress < 10) { situation = "HenÃ¼z yolun baÅŸÄ±ndasÄ±n."; strategy = "Konulara yÃ¼klen."; shortAdvice = "Konu eksiÄŸin Ã§ok."; } else if (totalProgress < 50) { situation = "Orta seviye."; strategy = "Tekrarlara baÅŸla."; shortAdvice = "YarÄ±lamak Ã¼zeresin."; } else { situation = "Konular bitiyor."; strategy = "Deneme Ã§Ã¶z."; shortAdvice = "Deneme vakti!"; } if (mockExamsHistory.length > 0 && avgScore < 70) weakness = "Netlerin dÃ¼ÅŸÃ¼k."; else if (avgScore > 85) motivation = "Derece yapabilirsin!"; return { totalProgress, avgScore, completedCount: completed, startedCount: started, situationAnalysis: situation, strategyAdvice: strategy, weaknessAnalysis: weakness, motivationMsg: motivation, shortAdvice }; }
        function updateSidebar() {
            if (!userData) return;
            document.getElementById('sidebarName').innerText = userData.name;
            document.getElementById('sidebarAvatar').src = userData.avatar;

            // Admin kontrolÃ¼yle unvan belirleme
            const sidebarTitle = document.getElementById('sidebarTitle');
            if (currentUser.email.toLowerCase() === "alnigamestudios@gmail.com") {
                sidebarTitle.innerText = "YÃ¶netici";
                sidebarTitle.classList.add('text-red-500'); // YÃ¶neticiyi kÄ±rmÄ±zÄ± yapalÄ±m
            } else {
                sidebarTitle.innerText = userData.title || 'Ã–ÄŸrenci';
                sidebarTitle.classList.remove('text-red-500');
            }

            document.getElementById('pomodoroCount').innerText = (userData.pomodoroSessions || 0) + " Seans";
            document.getElementById('mobileAvatar').src = userData.avatar;
            if (document.getElementById('sidebarXP')) document.getElementById('sidebarXP').innerText = userData.xp || 0;
        }

        window.askSmartCoach = async () => {
            const input = document.getElementById('aiInput');
            const chatWindow = document.getElementById('chatWindow');
            const prompt = input.value.trim();

            if (!prompt) return;
            document.getElementById('emptyState')?.remove();

            // KullanÄ±cÄ± mesajÄ±nÄ± ekle
            chatWindow.insertAdjacentHTML('beforeend', `
        <div class="flex justify-end mb-4 animate-in slide-in-from-right-2">
            <div class="bg-[#dcf8c6] dark:bg-[#005c4b] text-slate-800 dark:text-[#e9edef] px-4 py-2 rounded-xl rounded-tr-none text-[15px] shadow-sm max-w-[85%]">
                ${prompt}
                <div class="text-[10px] text-right mt-1 opacity-50">Okundu âœ“âœ“</div>
            </div>
        </div>`);

            input.value = ""; input.style.height = 'auto';
            window.scrollToBottom();

            const loadingId = "loading-" + Date.now();
            chatWindow.insertAdjacentHTML('beforeend', `<div class="flex justify-start mb-4 animate-pulse" id="${loadingId}"><div class="bg-white dark:bg-[#202c33] px-3 py-1 rounded-lg text-[10px] dark:text-slate-400">Hoca dÃ¼ÅŸÃ¼nÃ¼yor...</div></div>`);
            window.scrollToBottom();

            try {
                // askSmartCoach fonksiyonunun iÃ§indeki systemInstruction kÄ±smÄ±nÄ± ÅŸu ÅŸekilde modernize edelim:

                const stats = calculateStats();
                let aiMode = "";

                // Karakter Belirleme MantÄ±ÄŸÄ±
                if (stats.totalProgress < 20) {
                    aiMode = "Sen ÅŸu an 'Yol GÃ¶steren Dost' modundasÄ±n. KullanÄ±cÄ± henÃ¼z yolun Ã§ok baÅŸÄ±nda, onu korkutmadan, kÃ¼Ã§Ã¼k adÄ±mlarla motive etmelisin.";
                } else if (stats.avgScore < 70 && stats.totalProgress > 50) {
                    aiMode = "Sen ÅŸu an 'GerÃ§ekÃ§i Mentor' modundasÄ±n. KullanÄ±cÄ± konularÄ± bitirmiÅŸ ama netleri dÃ¼ÅŸÃ¼k. Samimi ama hatalarÄ±nÄ± dÃ¼rÃ¼stÃ§e yÃ¼zÃ¼ne vuran, taktik veren bir tavÄ±r takÄ±n.";
                } else if (stats.avgScore >= 85) {
                    aiMode = "Sen ÅŸu an 'Åžampiyon AntrenÃ¶rÃ¼' modundasÄ±n. KarÅŸÄ±nda derece adayÄ± bir Ã¶ÄŸrenci var. Onu rehavetten koru, en zor detaylara odaklanmasÄ±nÄ± saÄŸla.";
                } else {
                    aiMode = "Sen 'Samimi ve Dengeli bir KPSS HocasÄ±' modundasÄ±n. NeÅŸeli, arkadaÅŸÃ§a ama sÄ±nav ciddiyetini koruyan bir tavÄ±r sergile.";
                }

                const systemInstruction = `
    ${aiMode}
    
    Ã–ÄžRENCÄ° KÄ°MLÄ°ÄžÄ°:
    - Ä°sim: ${userData.name}
    - Hedef Puan: ${userData.targetScore}
    - Mevcut Durum: %${stats.totalProgress} tamamlandÄ±.
    
    KURALLAR:
    1. KullanÄ±cÄ±yÄ± ismiyle selamla (Hocam, ${userData.name} dostum, Åžampiyon vb.).
    2. Cevap verirken sadece bilgi verme; o anki moduna gÃ¶re (yukarÄ±da belirtilen) duygusal bir baÄŸ kur.
    3. EÄŸer hedef puanÄ± ${userData.targetScore} ise ve durumu buna uzaksa, ona gerÃ§ekÃ§i bir yol haritasÄ± Ã§iz.
    4. ArkadaÅŸÃ§a bir dil kullan (Kanka gibi deÄŸil, sevilen bir hoca gibi). "YaparsÄ±n", "Hallederiz", "Bak burasÄ± Ã¶nemli" gibi ifadeler kullan.
`;

                const requestData = {
                    contents: [{
                        parts: [{
                            text: `${systemInstruction} \n\n KullanÄ±cÄ± Sorusu: ${prompt}`
                        }]
                    }]
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;

                document.getElementById(loadingId)?.remove();


                // --- Ã–ZEL EASTER EGG (SEVGÄ°LÄ° KONTROLÃœ) ---
                if (prompt.toLowerCase().includes("sevgilimi Ã§ok seviyorum")) {
                    setTimeout(() => {
                        chatWindow.insertAdjacentHTML('beforeend', `
                <div class="flex justify-start mb-6 animate-in fade-in duration-700">
                    <div class="bg-white dark:bg-[#202c33] text-slate-800 dark:text-[#e9edef] px-5 py-3 rounded-2xl rounded-tl-none text-[15px] shadow-md border-l-4 border-pink-500 font-bold italic">
                        o da seni Ã§ok seviyor ðŸ¤
                    </div>
                </div>`);
                        window.scrollToBottom();
                    }, 600);
                    return;
                }

                // AI YANITI
                chatWindow.insertAdjacentHTML('beforeend', `
            <div class="flex justify-start mb-6 animate-in slide-in-from-left-2 duration-500">
                <div class="bg-white dark:bg-[#202c33] text-slate-800 dark:text-[#e9edef] px-5 py-3 rounded-2xl rounded-tl-none text-[15px] shadow-md max-w-[90%] border-l-4 border-primary leading-relaxed">
                    ${formatAiResponse(text)}
                </div>
            </div>`);

            } catch (e) {
                document.getElementById(loadingId)?.remove();
                chatWindow.insertAdjacentHTML('beforeend', `<div class="text-center my-4"><span class="bg-red-50 text-red-600 text-[10px] p-2 rounded-lg font-bold">Hoca baÄŸlantÄ±da bir kopukluk oldu.</span></div>`);
            }
            window.scrollToBottom();
        };

        window.scrollToBottom = () => {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
        };

        window.formatAiResponse = (text) => {
            // Markdown Bold ( **text** ) -> HTML Bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Yeni satÄ±rlarÄ± <br> yap
            text = text.replace(/\n/g, '<br>');
            // Madde iÅŸaretlerini gÃ¼zelleÅŸtir
            text = text.replace(/^- (.*?)<br>/gm, 'â€¢ $1<br>');
            return text;
        };


        // --- Ä°Ã‡ERÄ°K DENETLEME VE SÄ°LME SÄ°STEMÄ° ---

        // 1. Ä°Ã§eriÄŸi VeritabanÄ±ndan Ã‡ekip GÃ¶steren Fonksiyon
        window.inspectContent = async () => {
            const collectionName = document.getElementById('inspectCollection').value;
            const docId = document.getElementById('inspectContentId').value.trim();
            const resultDiv = document.getElementById('inspectorResult');

            if (!docId) return alert("LÃ¼tfen bir ID girin.");

            resultDiv.innerHTML = '<div class="text-center text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> Ä°Ã§erik aranÄ±yor...</div>';
            resultDiv.classList.remove('hidden');

            try {
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // Ä°Ã§erik tipine gÃ¶re gÃ¶sterilecek metin/baÅŸlÄ±k belirleme
                    let contentDisplay = "";
                    let title = "";

                    if (collectionName === 'questions') { title = "Soru"; contentDisplay = `<b>Ders:</b> ${data.lesson}<br><b>Soru:</b> ${data.text}`; }
                    else if (collectionName === 'forumPosts') { title = "Forum Konusu"; contentDisplay = `<b>BaÅŸlÄ±k:</b> ${data.title}<br><b>Ä°Ã§erik:</b> ${data.content}`; }
                    else if (collectionName === 'etutQuestions') { title = "EtÃ¼t Sorusu"; contentDisplay = `<b>Ders:</b> ${data.lesson}<br><b>Metin:</b> ${data.text}`; if (data.image) contentDisplay += `<br><img src="${data.image}" class="h-32 mt-2 rounded">`; }
                    else if (collectionName === 'marketItems') { title = "Market ÃœrÃ¼nÃ¼"; contentDisplay = `<b>ÃœrÃ¼n:</b> ${data.title}<br><b>AÃ§Ä±klama:</b> ${data.description}<br><b>Fiyat:</b> ${data.price} XP`; }
                    else { title = "Ä°Ã§erik"; contentDisplay = JSON.stringify(data); }

                    // Sahibinin adÄ±nÄ± gÃ¼venli Ã§ek
                    const ownerName = data.authorName || data.sellerName || "Bilinmiyor";
                    const ownerId = data.uid || data.sellerId || "yok";

                    resultDiv.innerHTML = `
                <div class="text-sm">
                    <div class="flex justify-between items-start mb-2 border-b pb-2 dark:border-slate-600">
                        <span class="font-bold text-indigo-600 dark:text-indigo-400">${title} Bulundu</span>
                        <span class="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">Yazar: ${ownerName}</span>
                    </div>
                    <div class="mb-4 text-slate-700 dark:text-slate-300 p-2 bg-slate-50 dark:bg-slate-900 rounded border border-slate-100 dark:border-slate-700">
                        ${contentDisplay}
                    </div>
                    <div class="flex justify-end">
                        <button onclick="window.adminDeleteContent('${collectionName}', '${docId}', '${ownerId}', '${title}')" 
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-xs font-bold transition flex items-center gap-2">
                            <i class="fa-solid fa-trash-can"></i> Ä°Ã§eriÄŸi KaldÄ±r ve Bildir
                        </button>
                    </div>
                </div>
            `;
                } else {
                    resultDiv.innerHTML = '<div class="text-center text-red-500 font-bold">âŒ Ä°Ã§erik bulunamadÄ±! Koleksiyonu veya ID\'yi kontrol edin.</div>';
                }
            } catch (e) {
                console.error(e);
                resultDiv.innerHTML = `<div class="text-center text-red-500">Hata: ${e.message}</div>`;
            }
        };

        // 2. Ä°Ã§eriÄŸi Silip KullanÄ±cÄ±ya Bildirim Atan Fonksiyon
        window.adminDeleteContent = async (colName, docId, ownerUid, contentTitle) => {
            // Silme sebebini sor (Zorunlu)
            const reason = prompt("DÄ°KKAT: Bu iÃ§erik kalÄ±cÄ± olarak silinecek!\n\nKullanÄ±cÄ±ya gÃ¶nderilecek silme sebebini yazÄ±n:", "Topluluk kurallarÄ±na aykÄ±rÄ± iÃ§erik / Telif hakkÄ± ihlali");

            if (reason === null) return; // Ä°ptal
            if (reason.trim().length < 5) return alert("LÃ¼tfen geÃ§erli bir sebep belirtin (KullanÄ±cÄ±ya bildirilecek).");

            if (!confirm("Ä°ÅŸlemi onaylÄ±yor musunuz?")) return;

            try {
                const batch = writeBatch(db);

                // 1. DokÃ¼manÄ± Sil
                const contentRef = doc(db, colName, docId);
                batch.delete(contentRef);

                // 2. KullanÄ±cÄ±ya Bildirim GÃ¶nder (EÄŸer kullanÄ±cÄ± ID'si varsa)
                if (ownerUid && ownerUid !== 'yok') {
                    const notifRef = doc(collection(db, "notifications"));
                    batch.set(notifRef, {
                        uid: ownerUid,
                        title: "âš ï¸ Ä°Ã§eriÄŸiniz KaldÄ±rÄ±ldÄ±",
                        message: `SayÄ±n kullanÄ±cÄ±mÄ±z, '${contentTitle}' baÅŸlÄ±klÄ±/iÃ§erikli paylaÅŸÄ±mÄ±nÄ±z yÃ¶neticiler tarafÄ±ndan ÅŸu gerekÃ§eyle kaldÄ±rÄ±lmÄ±ÅŸtÄ±r:\n\n"${reason}"\n\nLÃ¼tfen topluluk kurallarÄ±na dikkat ediniz.`,
                        type: "error",
                        read: false,
                        createdAt: serverTimestamp()
                    });
                }

                await batch.commit();

                // UI Temizle
                document.getElementById('inspectorResult').innerHTML = `
            <div class="p-4 bg-green-100 text-green-700 rounded text-center border border-green-200">
                <i class="fa-solid fa-check-circle"></i> Ä°Ã§erik baÅŸarÄ±yla silindi ve kullanÄ±cÄ± bilgilendirildi.
            </div>
        `;

                // EÄŸer admin "Soru Havuzu" veya "Forum" listesine bakÄ±yorsa orayÄ± da yenile
                if (colName === 'questions') window.loadAdminData('questions');
                if (colName === 'forumPosts') window.loadAdminData('forum');

            } catch (e) {
                console.error(e);
                alert("Silme iÅŸlemi sÄ±rasÄ±nda hata oluÅŸtu: " + e.message);
            }
        };

        // --- APP.HTML EN ALTA EKLENECEK FONKSÄ°YON ---
        window.handleActiveItemReport = (type) => {
            if (type === 'question') {
                if (!currentQuestion) return alert("Åžu an aktif bir soru yok.");
                // reportContent fonksiyonunu Ã§aÄŸÄ±rÄ±yoruz (Mevcut ÅŸikayet sistemin)
                window.reportContent('Soru Havuzu', currentQuestion.id, currentQuestion.text);
            }
            else if (type === 'flashcard') {
                if (!currentCard) return alert("Åžu an aktif bir kart yok.");
                window.reportContent('Flashcard', currentCard.id, currentCard.front);
            }
        };
    </script>
</body>

</html>


