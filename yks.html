<!doctype html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Al&Ni YKS Studio</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class', // <--- BU SATIR EKSÄ°KTÄ°, BUNU EKLEDÄ°K
      theme: {
        extend: {
          colors: {
            primary: "#f97316",
            primaryDark: "#ea580c",
          },
          boxShadow: {
            soft: "0 12px 30px rgba(0,0,0,.08)",
          }
        }
      }
    };
  </script>

  <style>
    .tab-btn-active {
      color: #0f172a !important;
      border-bottom: 3px solid #f97316;
      background: rgba(249, 115, 22, .06);
    }

    .dark .tab-btn-active {
      color: #fff !important;
    }

    .flip-card {
      perspective: 1000px;
    }

    .flip-card-inner {
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front,
    .flip-card-back {
      backface-visibility: hidden;
    }

    .flip-card-back {
      transform: rotateY(180deg);
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <!-- AUTH SCREEN -->
  <div id="authScreen" class="min-h-screen flex items-center justify-center p-4">
    <div
      class="w-full max-w-md bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 rounded-3xl p-8 shadow-soft">
      <div class="flex items-center justify-between mb-8">
        <div>
          <div class="text-xs font-black tracking-widest text-slate-400">AL&NI</div>
          <h1 class="text-2xl font-black">YKS Studio</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">Ã–ÄŸrenci GiriÅŸi</p>
        </div>
        <button id="toggleDark"
          class="w-10 h-10 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-center hover:bg-slate-50 dark:hover:bg-slate-800 transition">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>

      <!-- Sadece GiriÅŸ Formu KaldÄ± -->
      <div id="loginForm" class="space-y-4">
        <div>
          <label class="block text-xs font-black text-slate-500 mb-1 ml-1">E-POSTA</label>
          <input id="loginEmail" type="email"
            class="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 outline-none focus:border-primary transition font-bold"
            placeholder="ornek@email.com" />
        </div>

        <div>
          <label class="block text-xs font-black text-slate-500 mb-1 ml-1">ÅžÄ°FRE</label>
          <input id="loginPassword" type="password"
            class="w-full p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 outline-none focus:border-primary transition font-bold"
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>

        <button onclick="handleLogin()" id="loginBtnUI"
          class="w-full bg-slate-900 dark:bg-slate-100 hover:bg-black dark:hover:bg-white text-white dark:text-slate-900 font-black py-4 rounded-2xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2">
          <span>GiriÅŸ Yap</span>
          <i class="fa-solid fa-arrow-right"></i>
        </button>

        <div id="loginErrorMsg"
          class="hidden p-3 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-200 text-xs font-black text-center">
          Hata mesajÄ± burada gÃ¶rÃ¼necek.
        </div>

        <p class="text-xs text-slate-400 text-center mt-4">
          HesabÄ±n yoksa ana sitemizden kayÄ±t oluÅŸturmalÄ±sÄ±n.
        </p>
      </div>

      <div class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-800 text-center">
        <p class="text-[10px] text-slate-400 font-black">AL&NI Game Studios Â© 2025</p>
      </div>
    </div>
  </div>

  <!-- APP -->
  <!-- APP SCREEN -->
  <div id="app" class="hidden flex min-h-screen bg-slate-50 dark:bg-slate-950 transition-colors duration-300">


    <!-- MOBILE BACKDROP (MenÃ¼ aÃ§Ä±lÄ±nca arkaplanÄ± karartÄ±r) -->
    <div id="mobileBackdrop" onclick="toggleMobileNav()"
      class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity lg:hidden backdrop-blur-sm">
    </div>

    <!-- 1. PARÃ‡A: MOBÄ°L ARKA PLAN (KaranlÄ±k Perde) -->
    <!-- Bunu aside'Ä±n hemen Ã¼stÃ¼ne ekliyorsun -->
    <div id="mobileBackdrop" onclick="toggleMobileNav()"
      class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity lg:hidden backdrop-blur-sm">
    </div>

    <!-- 2. PARÃ‡A: GÃœNCELLENMÄ°Åž SIDEBAR (ASIDE) -->
    <aside id="mainSidebar"
      class="fixed lg:sticky top-0 left-0 h-screen w-72 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 p-4 flex flex-col shrink-0 overflow-y-auto custom-scrollbar z-50 transition-transform duration-300 -translate-x-full lg:translate-x-0">

      <!-- MOBÄ°L Ä°Ã‡Ä°N KAPATMA BUTONU (Sadece mobilde gÃ¶rÃ¼nÃ¼r) -->
      <button onclick="toggleMobileNav()"
        class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-800 rounded-full lg:hidden text-slate-500 hover:text-red-500 transition">
        <i class="fa-solid fa-xmark"></i>
      </button>

      <!-- LOGO & TOGGLE -->
      <div class="flex items-center justify-between mb-6 pr-8 lg:pr-0">
        <div>
          <div class="text-[10px] font-black tracking-[0.2em] text-slate-400">AL&NI</div>
          <div
            class="text-xl font-black bg-gradient-to-r from-slate-900 to-slate-600 dark:from-white dark:to-slate-400 bg-clip-text text-transparent">
            YKS Studio</div>
        </div>
        <button id="toggleDark2"
          class="w-10 h-10 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 transition text-slate-600 dark:text-slate-300">
          <i class="fa-solid fa-circle-half-stroke"></i>
        </button>
      </div>

      <!-- USER CARD -->
      <div
        class="flex items-center gap-3 p-3 rounded-2xl border border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-950 mb-6">
        <img id="sidebarAvatar" class="w-12 h-12 rounded-xl border border-slate-200 dark:border-slate-700 object-cover"
          src="">
        <div class="flex-1 min-w-0">
          <div id="sidebarName" class="font-black leading-tight truncate text-sm text-slate-800 dark:text-slate-200">...
          </div>
          <div id="sidebarTitle" class="text-[10px] uppercase font-bold text-slate-400 tracking-wide mt-0.5">Ã–ÄŸrenci
          </div>
        </div>
      </div>

      <!-- STATS GRID -->
      <div class="grid grid-cols-2 gap-2 mb-6">
        <div
          class="p-3 rounded-2xl bg-orange-50 dark:bg-orange-900/10 border border-orange-100 dark:border-orange-900/20">
          <div class="text-[9px] uppercase font-black text-orange-400 tracking-wider">XP</div>
          <div id="sidebarXP" class="text-lg font-black text-orange-600 dark:text-orange-400">0</div>
        </div>
        <div class="p-3 rounded-2xl bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/20">
          <div class="text-[9px] uppercase font-black text-blue-400 tracking-wider">Puan</div>
          <div id="sidebarScore" class="text-lg font-black text-blue-600 dark:text-blue-400">0</div>
        </div>
      </div>

      <!-- COUNTDOWN -->
      <div class="mb-6 relative group overflow-hidden rounded-2xl">
        <div class="absolute inset-0 bg-gradient-to-br from-slate-800 to-black dark:from-slate-800 dark:to-slate-950">
        </div>
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-400 via-pink-500 to-purple-500"></div>
        <div class="relative p-4 text-center">
          <div class="text-[9px] uppercase tracking-[0.2em] text-slate-400 font-black mb-1">YKS 2026</div>
          <div id="yksCountdown" class="text-lg font-black font-mono tracking-tighter text-white">HesaplanÄ±yor...</div>
        </div>
      </div>

      <!-- NAVIGATION -->
      <nav class="space-y-1 flex-1">
        <button id="nav-dashboard" onclick="loadPage('dashboard')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-chart-pie"></i>
          </div>
          Genel BakÄ±ÅŸ
        </button>

        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2"></div>

        <button id="nav-program" onclick="loadPage('program')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-calendar-days"></i>
          </div>
          AkÄ±llÄ± Program
        </button>
        <button id="nav-topics" onclick="loadPage('topics')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-list-check"></i>
          </div>
          Konu Takip
        </button>

        <div class="h-px bg-slate-100 dark:bg-slate-800 my-2"></div>

        <button id="nav-quiz" onclick="loadPage('quiz')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center text-orange-600 dark:text-orange-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-pen-nib"></i>
          </div>
          Quiz Center
        </button>
        <button id="nav-flashcards" onclick="loadPage('flashcards')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-pink-100 dark:bg-pink-900/30 flex items-center justify-center text-pink-600 dark:text-pink-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-layer-group"></i>
          </div>
          Flashcards
        </button>
        <button id="nav-mistakes" onclick="loadPage('mistakes')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-600 dark:text-red-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-recycle"></i>
          </div>
          Hata Kutusu
        </button>
        <button id="nav-mocks" onclick="loadPage('mocks')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-chart-line"></i>
          </div>
          Mock Exams
        </button>
        <button id="nav-coach" onclick="loadPage('coach')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group">
          <div
            class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400 group-hover:scale-110 transition">
            <i class="fa-solid fa-robot"></i>
          </div>
          SmartCoach
        </button>
        <button id="nav-admin" onclick="loadPage('admin')"
          class="w-full text-left p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 font-bold text-sm text-slate-600 dark:text-slate-400 flex items-center gap-3 transition-all group hidden">
          <div
            class="w-8 h-8 rounded-lg bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300 group-hover:scale-110 transition">
            <i class="fa-solid fa-shield-halved"></i>
          </div>
          Admin Panel
        </button>
      </nav>

      <!-- FOOTER ACTIONS (Ä°ÅŸte KPSS Linki de burada) -->
      <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800 space-y-2">
        <a href="app.html"
          class="block w-full text-left p-3 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 font-bold text-xs text-slate-500 transition">
          <i class="fa-solid fa-arrow-left mr-2"></i> KPSS ModÃ¼lÃ¼ne DÃ¶n
        </a>
        <button onclick="logout()"
          class="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 font-bold text-xs hover:bg-slate-50 dark:hover:bg-slate-800 text-left transition flex items-center gap-2">
          <i class="fa-solid fa-right-from-bracket"></i> Ã‡Ä±kÄ±ÅŸ Yap
        </button>
      </div>
    </aside>

    <!-- CONTENT AREA (SAÄž TARAF) -->
    <main class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden">
      <!-- MOBILE TOPBAR (Sadece Mobilde GÃ¶rÃ¼nÃ¼r) -->
      <div
        class="lg:hidden shrink-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur border-b border-slate-100 dark:border-slate-800 z-30">
        <div class="p-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <img id="mobileAvatar" class="w-9 h-9 rounded-xl border border-slate-200 dark:border-slate-700" src="">
            <div>
              <div id="mobileName" class="font-black leading-tight text-sm">...</div>
              <div class="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase">YKS Studio</div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="toggleMobileNav()"
              class="w-9 h-9 rounded-lg border border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300">
              <i class="fa-solid fa-bars"></i>
            </button>
            <button id="toggleDark3"
              class="w-9 h-9 rounded-lg border border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-600 dark:text-slate-300">
              <i class="fa-solid fa-moon"></i>
            </button>
          </div>
        </div>
      </div>


      <!-- DYNAMIC CONTENT (DeÄŸiÅŸen KÄ±sÄ±m) -->
      <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
        <!-- Buraya JS ile iÃ§erik dolacak -->
      </div>
    </main>
  </div>

  <!-- REPORT MODAL -->
  <div id="reportModal" class="hidden fixed inset-0 z-50 bg-black/50 p-4">
    <div
      class="max-w-md mx-auto bg-white dark:bg-slate-900 rounded-3xl p-5 border border-slate-100 dark:border-slate-800">
      <div class="flex items-center justify-between mb-3">
        <div class="font-black text-lg">Ä°Ã§erik Åžikayet</div>
        <button onclick="closeReportModal()"
          class="w-9 h-9 rounded-xl border border-slate-200 dark:border-slate-700 flex items-center justify-center">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="text-xs text-slate-500 dark:text-slate-400 font-black mb-2">Ã–zet</div>
      <div id="reportSummary"
        class="text-sm p-3 rounded-2xl bg-slate-50 dark:bg-slate-950 border border-slate-100 dark:border-slate-800 mb-3">
      </div>
      <textarea id="reportReason"
        class="w-full p-3 rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 outline-none"
        rows="3" placeholder="KÄ±sa sebep (opsiyonel)"></textarea>
      <button onclick="submitReport()"
        class="w-full mt-3 bg-yellow-500 hover:bg-yellow-600 text-white font-black py-3 rounded-2xl">
        GÃ¶nder
      </button>
    </div>
  </div>

  <script type="module">
    // ==========================
    // FIREBASE IMPORTS (CDN)
    // ==========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
      collection, query, where, orderBy, limit, getDocs, onSnapshot, serverTimestamp, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, deleteUser
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ==========================
    // CONFIG
    // ==========================

    const YKS_TOPICS = {
      "TYT TÃ¼rkÃ§e": ["SÃ¶zcÃ¼kte Anlam", "SÃ¶z Yorumu", "Deyim ve AtasÃ¶zÃ¼", "CÃ¼mlede Anlam", "Paragraf", "Paragrafta AnlatÄ±m Teknikleri", "Paragrafta DÃ¼ÅŸÃ¼nceyi GeliÅŸtirme", "Paragrafta YapÄ±", "Paragrafta Konu-Ana DÃ¼ÅŸÃ¼nce", "Paragrafta YardÄ±mcÄ± DÃ¼ÅŸÃ¼nce", "Ses Bilgisi", "YazÄ±m KurallarÄ±", "Noktalama Ä°ÅŸaretleri", "SÃ¶zcÃ¼kte YapÄ±/Ekler", "SÃ¶zcÃ¼k TÃ¼rleri", "Ä°simler", "Zamirler", "SÄ±fatlar", "Zarflar", "Edat â€“ BaÄŸlaÃ§ â€“ Ãœnlem", "Fiiller", "Fiilde Anlam", "Ek Fiil", "Fiilimsi", "Fiilde Ã‡atÄ±", "SÃ¶zcÃ¼k GruplarÄ±", "CÃ¼mlenin Ã–geleri", "CÃ¼mle TÃ¼rleri", "AnlatÄ±m BozukluÄŸu"],
      "TYT Matematik": ["Temel Kavramlar", "SayÄ± BasamaklarÄ±", "BÃ¶lme ve BÃ¶lÃ¼nebilme", "EBOB â€“ EKOK", "Rasyonel SayÄ±lar", "Basit EÅŸitsizlikler", "Mutlak DeÄŸer", "ÃœslÃ¼ SayÄ±lar", "KÃ¶klÃ¼ SayÄ±lar", "Ã‡arpanlara AyÄ±rma", "Oran OrantÄ±", "Denklem Ã‡Ã¶zme", "SayÄ± Problemleri", "Kesir Problemleri", "YaÅŸ Problemleri", "Hareket HÄ±z Problemleri", "Ä°ÅŸÃ§i Emek Problemleri", "YÃ¼zde Problemleri", "Kar Zarar Problemleri", "KarÄ±ÅŸÄ±m Problemleri", "Grafik Problemleri", "Rutin Olmayan Problemler", "KÃ¼meler â€“ Kartezyen Ã‡arpÄ±m", "MantÄ±k", "Fonksiyonlar", "Polinomlar", "2.Dereceden Denklemler", "PermÃ¼tasyon ve Kombinasyon", "OlasÄ±lÄ±k", "Veri â€“ Ä°statistik"],
      "TYT Geometri": ["DoÄŸruda AÃ§Ä±lar", "ÃœÃ§gende AÃ§Ä±lar", "Ã–zel ÃœÃ§genler (Dik, Ä°kizkenar, EÅŸkenar)", "AÃ§Ä±ortay - Kenarortay", "EÅŸlik ve Benzerlik", "ÃœÃ§gende Alan", "AÃ§Ä± Kenar BaÄŸÄ±ntÄ±larÄ±", "Ã‡okgenler", "DÃ¶rtgenler (Deltoid, Paralelkenar, EÅŸkenar DÃ¶rtgen, DikdÃ¶rtgen, Kare, Yamuk)", "Ã‡ember ve Daire", "Analitik Geometri", "KatÄ± Cisimler (Prizma, KÃ¼p, Silindir, Piramit, Koni, KÃ¼re)"],
      "TYT Fen": ["Fizik Bilimine GiriÅŸ", "Madde ve Ã–zellikleri", "Hareket ve Kuvvet", "Ä°ÅŸ, GÃ¼Ã§ ve Enerji", "IsÄ± ve SÄ±caklÄ±k", "Elektrostatik", "Optik", "Kimya Bilimi", "Atom ve Periyodik Sistem", "Kimyasal TÃ¼rler ArasÄ± EtkileÅŸimler", "Maddenin Halleri", "Asit, Baz ve Tuz", "CanlÄ±larÄ±n Ortak Ã–zellikleri", "HÃ¼cre", "CanlÄ±larÄ±n SÄ±nÄ±flandÄ±rÄ±lmasÄ±", "KalÄ±tÄ±m", "Ekosistem Ekolojisi"],
      "TYT Sosyal": ["Tarih ve Zaman", "Ä°lk UygarlÄ±klar", "Ä°lk TÃ¼rk Devletleri", "Ä°slam Tarihi", "TÃ¼rk-Ä°slam Devletleri", "OsmanlÄ± KuruluÅŸ-YÃ¼kselme", "Milli MÃ¼cadele", "AtatÃ¼rkÃ§Ã¼lÃ¼k", "CoÄŸrafi Konum", "Ä°klim Bilgisi", "Yerin Åžekillenmesi", "NÃ¼fus ve YerleÅŸme", "Felsefenin Konusu", "Bilgi-VarlÄ±k-Ahlak Felsefesi", "Din KÃ¼ltÃ¼rÃ¼ Genel"],
      "AYT Matematik": ["Fonksiyonlar (Ä°leri)", "Polinomlar", "2. Dereceden Denklemler", "Parabol", "EÅŸitsizlikler", "Trigonometri", "Logaritma", "Diziler", "Limit ve SÃ¼reklilik", "TÃ¼rev", "Ä°ntegral", "Sayma ve OlasÄ±lÄ±k"],
      "AYT Edebiyat": ["Åžiir Bilgisi", "SÃ¶z SanatlarÄ±", "Ä°slamiyet Ã–ncesi TÃ¼rk Ed.", "Halk EdebiyatÄ±", "Divan EdebiyatÄ±", "Tanzimat EdebiyatÄ±", "Servet-i FÃ¼nun", "Milli Edebiyat", "Cumhuriyet DÃ¶nemi"],
      "AYT Fizik": ["VektÃ¶rler", "BaÄŸÄ±l Hareket", "Newton'un Hareket YasalarÄ±", "AtÄ±ÅŸlar", "Ä°tme ve Momentum", "Tork ve Denge", "Elektrik ve Manyetizma", "Ã‡embersel Hareket", "Basit Harmonik Hareket", "Dalga MekaniÄŸi", "Modern Fizik"],
      "AYT Kimya": ["Modern Atom Teorisi", "Gazlar", "SÄ±vÄ± Ã‡Ã¶zeltiler", "Kimyasal Tepkimelerde Enerji", "Tepkime HÄ±zÄ± ve Denge", "Asit-Baz Dengesi", "KÃ‡Ã‡", "Kimya ve Elektrik", "Organik Kimya"],
      "AYT Biyoloji": ["Sinir Sistemi", "Endokrin Sistem", "Duyu OrganlarÄ±", "Destek ve Hareket", "Sindirim Sistemi", "DolaÅŸÄ±m ve BaÄŸÄ±ÅŸÄ±klÄ±k", "Solunum Sistemi", "Ãœriner Sistem", "Ãœreme Sistemi", "KomÃ¼nite ve PopÃ¼lasyon Ekolojisi", "Genden Proteine", "CanlÄ±larda Enerji DÃ¶nÃ¼ÅŸÃ¼mleri (Fotosentez/Solunum)", "Bitki Biyolojisi"],
      "AYT YDT (Ä°ngilizce)": ["Kelime Bilgisi", "Grammar (Tenses, Modals, Passive)", "Cloze Test", "CÃ¼mle Tamamlama", "Ã‡eviri", "Paragraf", "Anlamca YakÄ±n CÃ¼mle", "Diyalog Tamamlama", "Anlam BÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ Bozan CÃ¼mle"]
    };


    const EXAM = "yks";
    const ADMIN_EMAIL = "alnigamestudios@gmail.com"; // deÄŸiÅŸtirilebilir
    // ==========================
    // AL&NI AI ENGINE (YKS SÃœRÃœMÃœ)
    // ==========================
    const API_KEY = "AIzaSyByWAFDvkkqMKyPz43MmnYzu8qAM7pkQ1A"; // Buraya kendi keyini koyabilirsin
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`;

    // Ä°statistik HesaplayÄ±cÄ± (AI'ya veri beslemek iÃ§in)
    function calculateStats() {
      let totalTopics = 0, completed = 0;
      // YKS_TOPICS listesinden toplam konu ve biten konu sayÄ±sÄ±nÄ± bul
      for (let les in YKS_TOPICS) {
        totalTopics += YKS_TOPICS[les].length;
        YKS_TOPICS[les].forEach(t => {
          // userTopicProgress objesinde durum "done" ise bitmiÅŸ sayÄ±yoruz
          if (userTopicProgress[`${les}-${t}`] === 'done') completed++;
        });
      }
      const progress = totalTopics > 0 ? Math.round((completed / totalTopics) * 100) : 0;

      // Deneme ortalamasÄ±nÄ± al (Yoksa 0)
      const avgScore = mockHistory.length > 0
        ? Math.round(mockHistory.reduce((a, b) => a + (b.totalScore || 0), 0) / mockHistory.length)
        : (userData.totalScore || 0);

      return { progress, avgScore };
    }

    // AI CevabÄ±nÄ± GÃ¼zelleÅŸtirme (Bold, Alt satÄ±r vb.)
    function formatAiResponse(text) {
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-600 dark:text-indigo-400">$1</strong>');
      text = text.replace(/\n/g, '<br>');
      text = text.replace(/^- (.*?)<br>/gm, 'â€¢ $1<br>');
      return text;
    }



    // >>> KENDÄ° FIREBASE CONFIG'Ä°NÄ° GÄ°R <<<
    const firebaseConfig = {
      apiKey: "AIzaSyDVVuIdQzbPZqWaMLtkV0mRjr5qHOng460",
      authDomain: "alnikpss.firebaseapp.com",
      projectId: "alnikpss",
      storageBucket: "alnikpss.firebasestorage.app",
      messagingSenderId: "546288972320",
      appId: "1:546288972320:web:997647b8542e41f28f8245",
      measurementId: "G-XGCG35CPFJ"
    };

    // ==========================
    // INIT
    // ==========================
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ==========================
    // HELPERS / PATHS
    // ==========================
    const colPath = (base) => `exams/${EXAM}/${base}`;
    const userExamPath = (uid, base) => `users/${uid}/exams/${EXAM}/${base}`;

    const AVATAR_OPTIONS = [
      "https://i.pravatar.cc/120?img=1",
      "https://i.pravatar.cc/120?img=2",
      "https://i.pravatar.cc/120?img=3",
      "https://i.pravatar.cc/120?img=4",
      "https://i.pravatar.cc/120?img=5",
      "https://i.pravatar.cc/120?img=6",
      "https://i.pravatar.cc/120?img=7",
      "https://i.pravatar.cc/120?img=8"
    ];

    // ==========================
    // GLOBAL STATE
    // ==========================
    let currentUser = null;
    let userData = null;

    // quiz
    let quizQuestionsPool = [];
    let currentQuestion = null;

    // flashcards
    let flashcardsPool = [];
    let currentCard = null;

    // mocks
    let mockHistory = [];
    let mockChart = null;

    // report
    let reportPayload = { col: "", id: "", summary: "" };

    // ==========================
    // DARK MODE (TAMÄ°R EDÄ°LDÄ°)
    // ==========================

    // 1. Sayfa yÃ¼klenirken kontrol et (Local Storage veya Sistem Tercihi)
    const initTheme = () => {
      const savedTheme = localStorage.getItem("theme");
      const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

      // EÄŸer kayÄ±tlÄ± tema 'dark' ise VEYA kayÄ±t yoksa ama sistem dark ise:
      if (savedTheme === "dark" || (!savedTheme && systemPrefersDark)) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    };
    initTheme(); // BaÅŸlat

    // 2. Butona basÄ±lÄ±nca Ã§alÄ±ÅŸacak fonksiyon
    window.toggleTheme = () => {
      const isDark = document.documentElement.classList.contains("dark");

      if (isDark) {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("theme", "light");
      } else {
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme", "dark");
      }
    };

    // 3. Event Listener'larÄ± BaÄŸla (EÄŸer HTML'de onclick yoksa diye)
    document.getElementById("toggleDark")?.addEventListener("click", window.toggleTheme);
    document.getElementById("toggleDark2")?.addEventListener("click", window.toggleTheme);
    document.getElementById("toggleDark3")?.addEventListener("click", window.toggleTheme);

    // ==========================
    // AUTH UI
    // ==========================
    // ==========================
    // AUTH LOGIC (UPDATED)
    // ==========================


    window.handleLogin = async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const pass = document.getElementById("loginPassword").value;
      const btn = document.getElementById("loginBtnUI");
      const errBox = document.getElementById("loginErrorMsg");

      // UI Reset
      if (errBox) errBox.classList.add("hidden");

      if (!email || !pass) {
        if (errBox) {
          errBox.innerText = "LÃ¼tfen e-posta ve ÅŸifre gir.";
          errBox.classList.remove("hidden");
        }
        return;
      }

      // Loading State
      const originalText = btn ? btn.innerHTML : "GiriÅŸ";
      if (btn) {
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        btn.disabled = true;
      }

      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // BaÅŸarÄ±lÄ± olursa onAuthStateChanged otomatik Ã§alÄ±ÅŸÄ±r.
      } catch (e) {
        console.error("Login HatasÄ±:", e);

        let msg = "GiriÅŸ yapÄ±lamadÄ±.";
        if (e.code === "auth/invalid-email") msg = "GeÃ§ersiz e-posta adresi.";
        if (e.code === "auth/user-not-found") msg = "Bu e-posta kayÄ±tlÄ± deÄŸil.";
        if (e.code === "auth/wrong-password") msg = "Åžifre hatalÄ±.";
        if (e.code === "auth/invalid-credential") msg = "Bilgiler hatalÄ±.";
        if (e.code === "auth/too-many-requests") msg = "Ã‡ok deneme yaptÄ±n, bekle.";

        if (errBox) {
          errBox.innerText = msg;
          errBox.classList.remove("hidden");
        } else {
          alert(msg);
        }

        // Butonu dÃ¼zelt
        if (btn) {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }
      }
    };




    window.handleRegister = async () => {
      try {
        if (!document.getElementById("privacyCheck").checked) throw new Error("Gizlilik onayÄ± gerekli.");
        const name = document.getElementById("regName").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const pass = document.getElementById("regPassword").value;
        if (!name || !email || !pass) throw new Error("Eksik alan var.");
        const cred = await createUserWithEmailAndPassword(auth, email, pass);

        const baseUser = {
          name,
          email,
          avatar: AVATAR_OPTIONS[0],
          xp: 0,
          totalScore: 0,
          createdAt: serverTimestamp()
        };
        await setDoc(doc(db, "users", cred.user.uid), baseUser);

        // Exam scoped defaults
        await setDoc(doc(db, userExamPath(cred.user.uid, "meta"), "stats"), {
          mockCount: 0,
          lastScore: 0,
          createdAt: serverTimestamp()
        });

      } catch (e) {
        alert("KayÄ±t HatasÄ±: " + e.message);
      }
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        // location.reload() KULLANMIYORUZ.
        // Firebase listener (onAuthStateChanged) zaten Ã§Ä±kÄ±ÅŸ olduÄŸunu anlayÄ±p ekranÄ± deÄŸiÅŸtirecek.
        console.log("BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±.");
      } catch (e) {
        console.error("Ã‡Ä±kÄ±ÅŸ hatasÄ±:", e);
        alert("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken hata oluÅŸtu.");
      }
    };

    // ==========================
    // APP BOOTSTRAP
    // ==========================
    // ==========================
    // APP BOOTSTRAP (GÃœNCELLENMÄ°Åž)
    // ==========================
    onAuthStateChanged(auth, async (u) => {
      if (!u) {
        // KullanÄ±cÄ± yoksa veya Ã§Ä±kÄ±ÅŸ yaptÄ±ysa:
        currentUser = null;
        userData = null;

        // EkranlarÄ± deÄŸiÅŸtir
        document.getElementById("app").classList.add("hidden");
        document.getElementById("app").classList.remove("flex"); // Flex class'Ä±nÄ± kaldÄ±r
        document.getElementById("authScreen").classList.remove("hidden");

        // Formu temizle
        document.getElementById("loginEmail").value = "";
        document.getElementById("loginPassword").value = "";
        return;
      }

      // KullanÄ±cÄ± giriÅŸ yaptÄ±ysa:
      currentUser = u;
      document.getElementById("authScreen").classList.add("hidden");

      // App ekranÄ±nÄ± aÃ§ (Flex yapÄ±sÄ±nÄ± koruyarak)
      const appDiv = document.getElementById("app");
      appDiv.classList.remove("hidden");
      appDiv.classList.add("flex");

      // Verileri Ã§ek
      try {
        const snap = await getDoc(doc(db, "users", u.uid));
        // EÄŸer kullanÄ±cÄ± verisi yoksa varsayÄ±lan oluÅŸtur (Hata almamak iÃ§in)
        userData = snap.exists() ? snap.data() : { name: "Ã–ÄŸrenci", avatar: AVATAR_OPTIONS[0], xp: 0, totalScore: 0 };

        // Kenar Ã§ubuÄŸunu gÃ¼ncelle
        updateSidebar();

        // Admin kontrolÃ¼
        const isAdmin = currentUser.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();
        const adminNav = document.getElementById("nav-admin");
        const adminMob = document.getElementById("mobileAdminBtn");

        if (adminNav) adminNav.classList.toggle("hidden", !isAdmin);
        if (adminMob) adminMob.classList.toggle("hidden", !isAdmin);

        // SayfayÄ± yÃ¼kle
        loadPage("dashboard");

      } catch (e) {
        console.error("KullanÄ±cÄ± verisi Ã§ekilemedi:", e);
        alert("Veriler yÃ¼klenirken baÄŸlantÄ± sorunu oldu.");
      }
    });

    async function loadUserData() {
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      userData = snap.exists() ? snap.data() : { name: "KullanÄ±cÄ±", avatar: AVATAR_OPTIONS[0], xp: 0, totalScore: 0 };

      // ensure exam stats doc
      const statsRef = doc(db, userExamPath(currentUser.uid, "meta"), "stats");
      const statsSnap = await getDoc(statsRef);
      if (!statsSnap.exists()) {
        await setDoc(statsRef, { mockCount: 0, lastScore: 0, createdAt: serverTimestamp() });
      }
    }

    function updateSidebar() {
      if (!userData || !currentUser) return;

      const isAdmin = currentUser.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();

      document.getElementById("sidebarName").innerText = userData.name || "KullanÄ±cÄ±";
      document.getElementById("sidebarAvatar").src = userData.avatar || AVATAR_OPTIONS[0];
      document.getElementById("sidebarXP").innerText = userData.xp || 0;
      document.getElementById("sidebarScore").innerText = userData.totalScore || 0;

      document.getElementById("mobileName").innerText = userData.name || "KullanÄ±cÄ±";
      document.getElementById("mobileAvatar").src = userData.avatar || AVATAR_OPTIONS[0];

      const titleEl = document.getElementById("sidebarTitle");
      if (isAdmin) {
        titleEl.innerText = "YÃ¶netici";
        titleEl.classList.add("text-red-500");
      } else {
        titleEl.innerText = "Ã–ÄŸrenci";
        titleEl.classList.remove("text-red-500");
      }
    }

    // ==========================
    // MOBILE NAV
    // ==========================
    // ==========================
    // MOBILE NAV (YENÄ° - SIDEBAR)
    // ==========================
    window.toggleMobileNav = (forceClose = false) => {
      const sidebar = document.getElementById("mainSidebar");
      const backdrop = document.getElementById("mobileBackdrop");

      if (!sidebar || !backdrop) return;

      const isOpen = !sidebar.classList.contains("-translate-x-full");

      if (forceClose || isOpen) {
        // Kapat
        sidebar.classList.add("-translate-x-full");
        backdrop.classList.add("hidden");
      } else {
        // AÃ§
        sidebar.classList.remove("-translate-x-full");
        backdrop.classList.remove("hidden");
      }
    };

    // ==========================
    // ROUTER
    // ==========================
    const contentArea = document.getElementById("contentArea");
    const setActiveNav = (id) => {
      // Ã–nce tÃ¼m butonlarÄ±n aktiflik sÄ±nÄ±flarÄ±nÄ± temizle
      document.querySelectorAll("aside nav button").forEach(b => {
        b.classList.remove("active-nav", "bg-slate-100", "dark:bg-slate-800");
      });

      // Sonra tÄ±klanan butona aktiflik sÄ±nÄ±fÄ±nÄ± ekle
      const btn = document.getElementById("nav-" + id);
      if (btn) {
        btn.classList.add("active-nav", "bg-slate-100", "dark:bg-slate-800");
      }
    };

    window.loadPage = async (page) => {
      setActiveNav(page);
      toggleMobileNav(true);


      // YENÄ°: Dashboard kontrolÃ¼ eklendi
      if (page === "dashboard") {
        contentArea.innerHTML = renderDashboard();
        loadDashboardStats();
      }

      if (page === "quiz") contentArea.innerHTML = renderQuiz();
      if (page === "flashcards") contentArea.innerHTML = renderFlashcards();
      if (page === "mistakes") { contentArea.innerHTML = renderMistakes(); loadMistakes(); }
      if (page === "mocks") { contentArea.innerHTML = renderMocks(); loadMocks(); }
      if (page === "coach") contentArea.innerHTML = renderCoach();
      if (page === "admin") { contentArea.innerHTML = renderAdmin(); loadAdminData("questions"); }
      if (page === "program") { contentArea.innerHTML = renderProgram(); loadProgram(); }
      if (page === "topics") { contentArea.innerHTML = renderTopicTracker(); loadTopicsProgress(); }
    };

    // --- DASHBOARD (YENÄ°) ---
    function renderDashboard() {
      return `
        <div class="space-y-6 pb-24">
          <!-- WELCOME HEADER -->
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
             <div>
               <h1 class="text-3xl font-black text-slate-800 dark:text-white">Merhaba, ${userData.name || "Ã–ÄŸrenci"} ðŸ‘‹</h1>
               <p class="text-slate-500 dark:text-slate-400 font-bold">BugÃ¼n kazanmak iÃ§in harika bir gÃ¼n!</p>
             </div>
             <div class="flex gap-2">
                <div class="bg-slate-800 text-white px-4 py-2 rounded-xl font-black flex items-center gap-2">
                   <i class="fa-solid fa-fire text-orange-500"></i> <span>XP: ${userData.xp || 0}</span>
                </div>
             </div>
          </div>

          <!-- BIG COUNTDOWN CARD -->
          <div class="relative overflow-hidden rounded-3xl bg-gradient-to-r from-blue-900 to-slate-900 p-8 text-white shadow-xl group">
             <div class="absolute top-0 right-0 p-32 bg-white/5 rounded-full blur-3xl -mr-16 -mt-16"></div>
             <div class="relative z-10">
                <div class="text-xs font-black tracking-[0.2em] opacity-70 mb-1">BÃœYÃœK SINAV</div>
                <h2 class="text-4xl font-black mb-1">20 Haziran 2026</h2>
                <p class="text-blue-200 text-sm font-bold mb-6">Hayallerine giden yol.</p>
                
                <div class="flex gap-4 text-center">
                   <div class="bg-white/10 backdrop-blur rounded-2xl p-3 min-w-[70px]">
                      <div class="text-2xl font-black" id="dDay">0</div><div class="text-[10px] opacity-70 font-bold">GÃœN</div>
                   </div>
                   <div class="bg-white/10 backdrop-blur rounded-2xl p-3 min-w-[70px]">
                      <div class="text-2xl font-black" id="dHour">0</div><div class="text-[10px] opacity-70 font-bold">SAAT</div>
                   </div>
                   <div class="bg-white/10 backdrop-blur rounded-2xl p-3 min-w-[70px]">
                      <div class="text-2xl font-black" id="dMin">0</div><div class="text-[10px] opacity-70 font-bold">DK</div>
                   </div>
                </div>
             </div>
          </div>

          <!-- SMART COACH BANNER -->
          <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-3xl p-6 text-white shadow-lg flex justify-between items-center relative overflow-hidden cursor-pointer hover:scale-[1.01] transition" onclick="loadPage('coach')">
             <div class="absolute -left-10 -bottom-10 text-9xl text-white/10"><i class="fa-solid fa-brain"></i></div>
             <div class="relative z-10 pl-2">
                <div class="font-black text-lg mb-1"><i class="fa-solid fa-robot mr-2"></i> SmartCoach Ã–ngÃ¶rÃ¼sÃ¼</div>
                <p class="text-purple-100 font-bold italic">"Son Ã§Ã¶zdÃ¼ÄŸÃ¼n denemede matematikte artÄ±ÅŸ var, harikasÄ±n!"</p>
                <div class="text-xs mt-2 text-purple-200 font-bold">DetaylÄ± analiz iÃ§in tÄ±kla â†’</div>
             </div>
             <button class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl font-black text-sm backdrop-blur transition">AI Raporu</button>
          </div>

          <!-- STATS GRID -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
             <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800">
                <div class="text-xs font-black text-slate-400 mb-2">Genel PuanÄ±n</div>
                <div class="text-3xl font-black text-slate-800 dark:text-white">${userData.totalScore || 0}</div>
                <div class="w-full bg-slate-100 dark:bg-slate-800 h-2 rounded-full mt-3 overflow-hidden">
                   <div class="bg-orange-500 h-full rounded-full" style="width: ${Math.min((userData.totalScore || 0) / 5, 100)}%"></div>
                </div>
             </div>
             <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800">
                <div class="text-xs font-black text-slate-400 mb-2">Ã‡Ã¶zÃ¼len Deneme</div>
                <div class="text-3xl font-black text-slate-800 dark:text-white" id="dashMockCount">-</div>
             </div>
             <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800">
                <div class="text-xs font-black text-slate-400 mb-2">Hata Kutusu</div>
                <div class="text-3xl font-black text-red-500" id="dashMistakeCount">-</div>
             </div>
          </div>

          <!-- CHART SECTION -->
          <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft">
             <h3 class="font-black mb-4">Puan GrafiÄŸi</h3>
             <div class="h-64"><canvas id="dashChart"></canvas></div>
          </div>
        </div>
      `;
    }

    async function loadDashboardStats() {
      // Countdown Logic
      const target = new Date("June 20, 2026 10:15:00").getTime();
      const updateTime = () => {
        const now = new Date().getTime();
        const diff = target - now;
        if (document.getElementById("dDay")) {
          document.getElementById("dDay").innerText = Math.floor(diff / (1000 * 60 * 60 * 24));
          document.getElementById("dHour").innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          document.getElementById("dMin").innerText = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        }
      };
      updateTime();

      // Stats
      const mocks = await getDocs(query(collection(db, userExamPath(currentUser.uid, "mockExams")), orderBy("createdAt", "desc"), limit(10)));
      const mistakes = await getDocs(collection(db, userExamPath(currentUser.uid, "mistakes")));

      document.getElementById("dashMockCount").innerText = mocks.size;
      document.getElementById("dashMistakeCount").innerText = mistakes.size;

      // Chart
      const data = mocks.docs.map(d => d.data()).reverse();
      new Chart(document.getElementById("dashChart"), {
        type: "line",
        data: {
          labels: data.map(x => x.date),
          datasets: [{ label: "Puan", data: data.map(x => x.totalScore), borderColor: "#f97316", tension: 0.4, fill: true, backgroundColor: "rgba(249,115,22,0.1)" }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true } } }
      });
    }

    // ==========================
    // QUIZ PAGE
    // ==========================
    function renderQuiz() {
      const isAdmin = currentUser?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();
      return `
        <div class="max-w-3xl mx-auto h-full flex flex-col">
          <div class="flex border-b border-slate-200 dark:border-slate-800 mb-4 shrink-0">
            <button onclick="switchQuizTab('solve')" id="tabSolve" class="flex-1 py-4 text-center text-slate-600 dark:text-slate-300 font-black tab-btn-active">Test Ã‡Ã¶z</button>
            <button onclick="switchQuizTab('submit')" id="tabSubmit" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-black hover:text-slate-700 dark:hover:text-slate-200">Soru GÃ¶nder</button>
          </div>

          <div id="contentSolve" class="flex-1 overflow-y-auto w-full px-2">
            <div id="quizStartScreen" class="w-full max-w-md mx-auto text-center p-6 bg-white dark:bg-slate-900 rounded-3xl shadow-soft border border-slate-100 dark:border-slate-800 mt-4">
              <i class="fa-solid fa-pen-nib text-5xl text-primary mb-4"></i>
              <h3 class="text-xl font-black mb-2">YKS Test</h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Dersini seÃ§ ve baÅŸla.</p>

              <select id="quizCategorySelect" class="w-full p-3 border dark:border-slate-800 rounded-2xl bg-slate-50 dark:bg-slate-950 dark:text-white outline-none mb-4 text-sm">
                <option value="All">TÃ¼m Dersler (KarÄ±ÅŸÄ±k)</option>
                <option value="TYT TÃ¼rkÃ§e">TYT TÃ¼rkÃ§e</option>
                <option value="TYT Matematik">TYT Matematik</option>
                <option value="TYT Sosyal">TYT Sosyal</option>
                <option value="TYT Fen">TYT Fen</option>
                <option value="AYT Matematik">AYT Matematik</option>
                <option value="AYT Fizik">AYT Fizik</option>
                <option value="AYT Kimya">AYT Kimya</option>
                <option value="AYT Biyoloji">AYT Biyoloji</option>
                <option value="AYT Edebiyat">AYT Edebiyat</option>
                <option value="AYT Tarih">AYT Tarih</option>
                <option value="AYT CoÄŸrafya">AYT CoÄŸrafya</option>
              </select>

              <button onclick="startQuizGame()" class="w-full bg-primary hover:bg-primaryDark text-white font-black py-3 rounded-2xl transition">
                Teste BaÅŸla
              </button>
            </div>

            <div id="quizGameArea" class="hidden w-full max-w-2xl mx-auto flex flex-col py-4 pb-24">
              <div class="w-full flex justify-between items-center mb-3">
                <button onclick="switchQuizTab('solve')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white text-sm font-black">
                  <i class="fa-solid fa-arrow-left"></i> Ã‡Ä±k
                </button>
                <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200 px-3 py-1 rounded-full text-xs font-black uppercase" id="quizCategoryBadge">Genel</span>
              </div>

              <div class="bg-white dark:bg-slate-900 p-5 md:p-8 rounded-3xl shadow-soft border border-slate-100 dark:border-slate-800 relative">
                <div class="absolute top-3 right-3 flex gap-1">
                  <button onclick="openReportModal('questions', currentQuestion?.id, currentQuestion?.text)" class="text-slate-300 hover:text-yellow-500 transition p-2" title="Åžikayet Et">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                  </button>
                  ${isAdmin ? `
                    <button onclick="deleteLiveItem('questions', currentQuestion?.id)" class="text-red-300 hover:text-red-500 transition p-2" title="YÃ¶netici Sil">
                      <i class="fa-solid fa-trash"></i>
                    </button>` : ``}
                </div>

                <div class="text-xs text-slate-400 mb-2 font-black uppercase tracking-widest">Soru</div>
                <p class="font-black text-slate-900 dark:text-white text-base md:text-xl mb-6 leading-relaxed" id="qGameText">...</p>

                <div class="space-y-2 md:space-y-3" id="qGameOptions"></div>
                <div id="qGameFeedback" class="mt-4 hidden p-3 rounded-2xl font-black text-center text-sm md:text-base"></div>
              </div>

              <div class="mt-6 text-center">
                <button onclick="nextQuestion()" id="nextQBtn" class="hidden bg-slate-900 dark:bg-slate-800 hover:bg-black dark:hover:bg-slate-700 text-white font-black py-3 px-10 rounded-full shadow-lg transition w-full md:w-auto">
                  Sonraki Soru <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
              </div>
            </div>
          </div>

          <div id="contentSubmit" class="hidden flex-1 overflow-y-auto pb-32 px-2">
            <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-soft border border-slate-100 dark:border-slate-800 mt-4">
              <h3 class="font-black text-lg mb-4">TopluluÄŸa KatkÄ±</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-xs font-black text-slate-500 uppercase mb-1">Ders</label>
                  <select id="qLesson" class="w-full p-3 border dark:border-slate-800 rounded-2xl bg-white dark:bg-slate-950 dark:text-white">
                    <option>TYT TÃ¼rkÃ§e</option><option>TYT Matematik</option><option>TYT Sosyal</option><option>TYT Fen</option>
                    <option>AYT Matematik</option><option>AYT Fizik</option><option>AYT Kimya</option><option>AYT Biyoloji</option>
                    <option>AYT Edebiyat</option><option>AYT Tarih</option><option>AYT CoÄŸrafya</option>
                  </select>
                </div>

                <div>
                  <label class="block text-xs font-black text-slate-500 uppercase mb-1">Soru Metni</label>
                  <textarea id="qText" rows="3" class="w-full p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl" placeholder="Soruyu buraya yaz..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <input id="optA" type="text" placeholder="A ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                  <input id="optB" type="text" placeholder="B ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                  <input id="optC" type="text" placeholder="C ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                  <input id="optD" type="text" placeholder="D ÅžÄ±kkÄ±" class="p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                  <input id="optE" type="text" placeholder="E ÅžÄ±kkÄ± (opsiyonel)" class="p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                  <select id="qCorrect" class="p-3 border rounded-2xl bg-green-50 border-green-200 dark:bg-green-900/30 dark:border-green-700 dark:text-white font-black">
                    <option value="0">DoÄŸru: A</option><option value="1">DoÄŸru: B</option><option value="2">DoÄŸru: C</option><option value="3">DoÄŸru: D</option><option value="4">DoÄŸru: E</option>
                  </select>
                </div>

                <button onclick="submitQuestion()" class="w-full bg-slate-900 dark:bg-slate-800 text-white font-black py-3 rounded-2xl hover:bg-black transition">
                  YÃ¶netici OnayÄ±na GÃ¶nder
                </button>
              </div>
            </div>

            <div class="mt-8">
              <h3 class="font-black text-md mb-4">GÃ¶nderdiÄŸin Sorular</h3>
              <div id="myQuestionsList" class="space-y-3"></div>
            </div>
          </div>
        </div>
      `;
    }

    window.switchQuizTab = (tab) => {
      const solve = document.getElementById("contentSolve");
      const submit = document.getElementById("contentSubmit");
      const tSolve = document.getElementById("tabSolve");
      const tSubmit = document.getElementById("tabSubmit");

      solve.classList.add("hidden");
      submit.classList.add("hidden");
      tSolve.classList.remove("tab-btn-active");
      tSubmit.classList.remove("tab-btn-active");

      if (tab === "solve") {
        solve.classList.remove("hidden");
        tSolve.classList.add("tab-btn-active");
        document.getElementById("quizStartScreen").classList.remove("hidden");
        document.getElementById("quizGameArea").classList.add("hidden");
      } else {
        submit.classList.remove("hidden");
        tSubmit.classList.add("tab-btn-active");
        loadMyQuestions();
      }
    };

    window.startQuizGame = async () => {
      const category = document.getElementById("quizCategorySelect").value;
      const btn = document.querySelector("#quizStartScreen button");
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> HazÄ±rlanÄ±yor...';
      btn.disabled = true;

      try {
        const snap = await getDocs(query(collection(db, colPath("questions"))));
        quizQuestionsPool = [];
        snap.forEach(d => {
          const q = d.data();
          if (category === "All" || q.lesson === category) quizQuestionsPool.push({ id: d.id, ...q });
        });

        if (quizQuestionsPool.length === 0) {
          alert("Bu kategoride soru yok.");
          btn.innerHTML = "Teste BaÅŸla";
          btn.disabled = false;
          return;
        }

        quizQuestionsPool.sort(() => Math.random() - 0.5);

        document.getElementById("quizStartScreen").classList.add("hidden");
        document.getElementById("quizGameArea").classList.remove("hidden");
        document.getElementById("quizCategoryBadge").innerText = category === "All" ? "Karma Test" : category;

        nextQuestion();
      } catch (e) {
        console.error(e);
        alert("Hata: " + e.message);
      } finally {
        btn.innerHTML = "Teste BaÅŸla";
        btn.disabled = false;
      }
    };

    window.nextQuestion = () => {
      if (!quizQuestionsPool.length) {
        alert("Test bitti!");
        switchQuizTab("solve");
        return;
      }

      const randomIndex = Math.floor(Math.random() * quizQuestionsPool.length);
      currentQuestion = quizQuestionsPool[randomIndex];

      document.getElementById("qGameText").innerText = currentQuestion.text;

      const optsDiv = document.getElementById("qGameOptions");
      optsDiv.innerHTML = "";

      currentQuestion.options.forEach((opt, idx) => {
        if (!opt) return;
        optsDiv.innerHTML += `
          <button onclick="checkGameAnswer(${idx})" class="quiz-option w-full text-left p-4 rounded-2xl border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-950 bg-white dark:bg-slate-900 transition flex items-center gap-3" id="gameOpt-${idx}">
            <div class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center font-black text-slate-500 dark:text-slate-300 text-sm shrink-0">
              ${String.fromCharCode(65 + idx)}
            </div>
            <span class="text-slate-800 dark:text-slate-200 font-black">${opt}</span>
          </button>
        `;
      });

      document.getElementById("qGameFeedback").classList.add("hidden");
      document.getElementById("nextQBtn").classList.add("hidden");

      document.querySelectorAll(".quiz-option").forEach(b => b.disabled = false);
    };

    window.checkGameAnswer = async (selectedIdx) => {
      const correctIdx = Number(currentQuestion.correct);
      const feedback = document.getElementById("qGameFeedback");
      const buttons = document.querySelectorAll(".quiz-option");
      buttons.forEach(b => b.disabled = true);

      const selBtn = document.getElementById(`gameOpt-${selectedIdx}`);
      const corBtn = document.getElementById(`gameOpt-${correctIdx}`);

      if (selectedIdx === correctIdx) {
        feedback.innerHTML = `<span class="text-green-700 dark:text-green-300"><i class="fa-solid fa-check-circle"></i> DoÄŸru!</span>`;
        feedback.className = "mt-4 p-4 rounded-2xl font-black text-center bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800";
        selBtn?.classList.add("ring-2", "ring-green-500");
        await gainXP(2);
      } else {
        feedback.innerHTML = `<span class="text-red-700 dark:text-red-300"><i class="fa-solid fa-times-circle"></i> YanlÄ±ÅŸ. DoÄŸru: ${String.fromCharCode(65 + correctIdx)}</span>`;
        feedback.className = "mt-4 p-4 rounded-2xl font-black text-center bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800";
        selBtn?.classList.add("ring-2", "ring-red-500");
        corBtn?.classList.add("ring-2", "ring-green-500");

        await addToMistakes(currentQuestion.id);
      }

      feedback.classList.remove("hidden");
      document.getElementById("nextQBtn").classList.remove("hidden");
    };

    async function gainXP(amount) {
      const newXp = (userData.xp || 0) + amount;
      userData.xp = newXp;
      await updateDoc(doc(db, "users", currentUser.uid), { xp: newXp });
      updateSidebar();
    }

    window.submitQuestion = async () => {
      const text = document.getElementById("qText").value.trim();
      const optA = document.getElementById("optA").value.trim();
      const optB = document.getElementById("optB").value.trim();
      const optC = document.getElementById("optC").value.trim();
      const optD = document.getElementById("optD").value.trim();
      const optE = document.getElementById("optE").value.trim();
      const lesson = document.getElementById("qLesson").value;
      const correct = Number(document.getElementById("qCorrect").value);

      if (!text || !optA || !optB || !optC || !optD) return alert("Soru + en az A/B/C/D ÅŸart.");

      const payload = {
        uid: currentUser.uid,
        authorName: userData.name,
        lesson,
        text,
        options: [optA, optB, optC, optD, optE].filter(x => x !== ""),
        correct,
        status: "pending",
        adminNote: "",
        createdAt: serverTimestamp()
      };

      await addDoc(collection(db, colPath("questionSubmissions")), payload);
      alert("Soru onaya gÃ¶nderildi.");
      document.getElementById("qText").value = "";
      await gainXP(5);
      loadMyQuestions();
      notifyAdmin(`[YKS] Yeni soru onaya dÃ¼ÅŸtÃ¼: ${lesson}`);
    };

    async function loadMyQuestions() {
      const list = document.getElementById("myQuestionsList");
      if (!list) return;

      const qy = query(
        collection(db, colPath("questionSubmissions")),
        where("uid", "==", currentUser.uid),
        orderBy("createdAt", "desc"),
        limit(30)
      );

      const snap = await getDocs(qy);
      if (snap.empty) {
        list.innerHTML = `<div class="text-sm text-slate-400 font-black">HenÃ¼z soru gÃ¶ndermedin.</div>`;
        return;
      }

      list.innerHTML = snap.docs.map(d => {
        const s = d.data();
        const badge =
          s.status === "approved" ? "bg-green-100 text-green-700" :
            s.status === "rejected" ? "bg-red-100 text-red-700" :
              "bg-yellow-100 text-yellow-700";

        return `
          <div class="p-4 bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 flex justify-between gap-3">
            <div class="min-w-0">
              <div class="text-xs font-black text-slate-500 mb-1">${s.lesson}</div>
              <div class="text-sm font-black text-slate-900 dark:text-white truncate">${s.text}</div>
              ${s.status === "rejected" && s.adminNote ? `<div class="text-xs mt-2 p-2 rounded-xl bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-200"><b>Red:</b> ${s.adminNote}</div>` : ""}
            </div>
            <div class="shrink-0">
              <span class="text-xs font-black px-2 py-1 rounded-xl ${badge}">${s.status}</span>
            </div>
          </div>
        `;
      }).join("");
    }

    // ==========================
    // FLASHCARDS
    // ==========================
    function renderFlashcards() {
      const isAdmin = currentUser?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase();
      return `
        <div class="max-w-4xl mx-auto h-full flex flex-col">
          <div class="flex border-b border-slate-200 dark:border-slate-800 mb-6 shrink-0">
            <button onclick="switchCardTab('browse')" id="tabCardBrowse" class="flex-1 py-4 text-center text-slate-600 dark:text-slate-300 font-black tab-btn-active">Kartlara GÃ¶z At</button>
            <button onclick="switchCardTab('submit')" id="tabCardSubmit" class="flex-1 py-4 text-center text-slate-500 dark:text-slate-400 font-black hover:text-slate-700 dark:hover:text-slate-200">Kart GÃ¶nder</button>
          </div>

          <div id="contentCardBrowse" class="flex-1 flex flex-col items-center">
            <div id="flashcardStartScreen" class="w-full max-w-md text-center p-8 bg-white dark:bg-slate-900 rounded-3xl shadow-soft border border-slate-100 dark:border-slate-800">
              <i class="fa-solid fa-layer-group text-5xl text-primary mb-4"></i>
              <h3 class="text-xl font-black mb-2">Flashcard</h3>
              <p class="text-sm text-slate-500 dark:text-slate-400 mb-6">Kategorini seÃ§ ve baÅŸla.</p>

              <select id="flashcardCategorySelect" class="w-full p-3 border dark:border-slate-800 rounded-2xl bg-slate-50 dark:bg-slate-950 dark:text-white outline-none mb-4">
                <option value="All">TÃ¼m Dersler</option>
                <option value="TYT TÃ¼rkÃ§e">TYT TÃ¼rkÃ§e</option>
                <option value="TYT Matematik">TYT Matematik</option>
                <option value="TYT Sosyal">TYT Sosyal</option>
                <option value="TYT Fen">TYT Fen</option>
                <option value="AYT Matematik">AYT Matematik</option>
                <option value="AYT Fizik">AYT Fizik</option>
                <option value="AYT Kimya">AYT Kimya</option>
                <option value="AYT Biyoloji">AYT Biyoloji</option>
                <option value="AYT Edebiyat">AYT Edebiyat</option>
                <option value="AYT Tarih">AYT Tarih</option>
                <option value="AYT CoÄŸrafya">AYT CoÄŸrafya</option>
                <option value="General">Genel</option>
              </select>

              <button onclick="startFlashcardGame()" class="w-full bg-primary hover:bg-primaryDark text-white font-black py-3 rounded-2xl transition">
                BaÅŸla
              </button>
            </div>

            <div id="flashcardGameArea" class="hidden w-full max-w-lg flex flex-col items-center flex-1 justify-center min-h-[420px]">
              <div class="w-full flex justify-between items-center mb-4 px-4">
                <button onclick="switchCardTab('browse')" class="text-slate-400 hover:text-slate-600 dark:hover:text-white font-black">
                  <i class="fa-solid fa-arrow-left"></i> Ã‡Ä±k
                </button>
                <span class="bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200 px-3 py-1 rounded-full text-xs font-black" id="fcCategoryBadge">Genel</span>
              </div>

              <div class="flip-card w-full h-80 cursor-pointer group mb-6" onclick="this.classList.toggle('flipped')">
                <div class="flip-card-inner relative w-full h-full shadow-xl rounded-3xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 transition-transform duration-500">
                  <div class="flip-card-front flex flex-col items-center justify-center p-8 text-center bg-white dark:bg-slate-900 rounded-3xl">
                    <div class="absolute top-4 right-4 flex gap-2 z-20" onclick="event.stopPropagation()">
                      <button onclick="openReportModal('flashcards', currentCard?.id, currentCard?.front)" class="text-slate-300 hover:text-yellow-500 transition" title="Åžikayet Et">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                      </button>
                      ${isAdmin ? `
                        <button onclick="deleteLiveItem('flashcards', currentCard?.id)" class="text-red-300 hover:text-red-500 transition" title="YÃ¶netici Sil">
                          <i class="fa-solid fa-trash"></i>
                        </button>` : ``}
                    </div>
                    <h3 class="font-black text-slate-900 dark:text-white text-2xl" id="fcFront">...</h3>
                    <p class="text-xs text-slate-400 mt-4 uppercase tracking-widest font-black">Ã‡evirmek iÃ§in dokun</p>
                  </div>

                  <div class="flip-card-back flex flex-col items-center justify-center p-8 text-center bg-primary text-white rounded-3xl">
                    <div class="absolute top-4 right-4 flex gap-2 z-20" onclick="event.stopPropagation()">
                      <button onclick="openReportModal('flashcards', currentCard?.id, currentCard?.front)" class="text-white/60 hover:text-white transition" title="Åžikayet Et">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                      </button>
                      ${isAdmin ? `
                        <button onclick="deleteLiveItem('flashcards', currentCard?.id)" class="text-white/60 hover:text-white transition" title="YÃ¶netici Sil">
                          <i class="fa-solid fa-trash"></i>
                        </button>` : ``}
                    </div>
                    <p class="font-black text-2xl" id="fcBack">...</p>
                  </div>
                </div>
              </div>

              <button onclick="nextCard()" class="bg-slate-900 dark:bg-slate-800 hover:bg-black dark:hover:bg-slate-700 text-white font-black py-3 px-12 rounded-full shadow-lg transition">
                SÄ±radaki Kart <i class="fa-solid fa-arrow-right ml-2"></i>
              </button>
            </div>
          </div>

          <div id="contentCardSubmit" class="hidden pb-32 w-full">
            <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl shadow-soft border border-slate-100 dark:border-slate-800 mb-6">
              <h3 class="font-black text-lg mb-4">Kart GÃ¶nder (Onay)</h3>
              <div class="space-y-4">
                <select id="cardLesson" class="w-full p-3 border dark:border-slate-800 rounded-2xl bg-white dark:bg-slate-950 dark:text-white">
                  <option value="General">Genel</option>
                  <option>TYT TÃ¼rkÃ§e</option><option>TYT Matematik</option><option>TYT Sosyal</option><option>TYT Fen</option>
                  <option>AYT Matematik</option><option>AYT Fizik</option><option>AYT Kimya</option><option>AYT Biyoloji</option>
                  <option>AYT Edebiyat</option><option>AYT Tarih</option><option>AYT CoÄŸrafya</option>
                </select>
                <input id="cardFront" type="text" placeholder="Ã–n yÃ¼z" class="w-full p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                <input id="cardBack" type="text" placeholder="Arka yÃ¼z" class="w-full p-3 border dark:border-slate-800 dark:bg-slate-950 dark:text-white rounded-2xl">
                <button onclick="submitCard()" class="w-full bg-slate-900 dark:bg-slate-800 text-white font-black py-3 rounded-2xl hover:bg-black transition">
                  YÃ¶netici OnayÄ±na GÃ¶nder
                </button>
              </div>
            </div>

            <div class="mt-6">
              <h3 class="font-black text-md mb-3">GÃ¶nderimlerin</h3>
              <div id="myCardsList" class="space-y-3"></div>
            </div>
          </div>
        </div>
      `;
    }

    window.switchCardTab = (tab) => {
      document.getElementById("contentCardBrowse").classList.add("hidden");
      document.getElementById("contentCardSubmit").classList.add("hidden");
      document.getElementById("tabCardBrowse").classList.remove("tab-btn-active");
      document.getElementById("tabCardSubmit").classList.remove("tab-btn-active");

      if (tab === "browse") {
        document.getElementById("contentCardBrowse").classList.remove("hidden");
        document.getElementById("tabCardBrowse").classList.add("tab-btn-active");
        document.getElementById("flashcardStartScreen").classList.remove("hidden");
        document.getElementById("flashcardGameArea").classList.add("hidden");
      } else {
        document.getElementById("contentCardSubmit").classList.remove("hidden");
        document.getElementById("tabCardSubmit").classList.add("tab-btn-active");
        loadMyCardSubmissions();
      }
    };

    window.startFlashcardGame = async () => {
      const category = document.getElementById("flashcardCategorySelect").value;
      const btn = document.querySelector("#flashcardStartScreen button");
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...';
      btn.disabled = true;

      try {
        const snap = await getDocs(query(collection(db, colPath("flashcards"))));
        flashcardsPool = [];
        snap.forEach(d => {
          const c = d.data();
          if (category === "All" || c.lesson === category || (!c.lesson && category === "General")) {
            flashcardsPool.push({ id: d.id, ...c });
          }
        });

        if (!flashcardsPool.length) {
          alert("Bu kategoride kart yok.");
          return;
        }

        flashcardsPool.sort(() => Math.random() - 0.5);

        document.getElementById("flashcardStartScreen").classList.add("hidden");
        document.getElementById("flashcardGameArea").classList.remove("hidden");
        document.getElementById("fcCategoryBadge").innerText = category === "All" ? "KarÄ±ÅŸÄ±k" : category;

        nextCard();
      } catch (e) {
        console.error(e);
        alert("Kartlar yÃ¼klenemedi: " + e.message);
      } finally {
        btn.innerHTML = "BaÅŸla";
        btn.disabled = false;
      }
    };

    window.nextCard = () => {
      if (!flashcardsPool.length) {
        alert("Kart bitti!");
        switchCardTab("browse");
        return;
      }

      const randomIndex = Math.floor(Math.random() * flashcardsPool.length);
      currentCard = flashcardsPool[randomIndex];

      const cardEl = document.querySelector(".flip-card");
      const updateText = () => {
        document.getElementById("fcFront").innerText = currentCard.front || "...";
        document.getElementById("fcBack").innerText = currentCard.back || "...";
      };

      if (cardEl && cardEl.classList.contains("flipped")) {
        cardEl.classList.remove("flipped");
        setTimeout(updateText, 300);
      } else {
        updateText();
      }
    };

    window.submitCard = async () => {
      const front = document.getElementById("cardFront").value.trim();
      const back = document.getElementById("cardBack").value.trim();
      const lesson = document.getElementById("cardLesson").value;

      if (!front || !back) return alert("Ã–n ve arka yÃ¼z dolu olmalÄ±.");

      await addDoc(collection(db, colPath("flashcardSubmissions")), {
        uid: currentUser.uid,
        authorName: userData.name,
        lesson,
        front,
        back,
        status: "pending",
        createdAt: serverTimestamp()
      });

      alert("Kart onaya gÃ¶nderildi.");
      document.getElementById("cardFront").value = "";
      document.getElementById("cardBack").value = "";
      await gainXP(5);
      loadMyCardSubmissions();
      notifyAdmin(`[YKS] Yeni flashcard onaya dÃ¼ÅŸtÃ¼: ${lesson}`);
    };

    async function loadMyCardSubmissions() {
      const list = document.getElementById("myCardsList");
      if (!list) return;

      const qy = query(
        collection(db, colPath("flashcardSubmissions")),
        where("uid", "==", currentUser.uid),
        orderBy("createdAt", "desc"),
        limit(30)
      );

      const snap = await getDocs(qy);
      if (snap.empty) {
        list.innerHTML = `<div class="text-sm text-slate-400 font-black">HenÃ¼z kart gÃ¶ndermedin.</div>`;
        return;
      }

      list.innerHTML = snap.docs.map(d => {
        const c = d.data();
        const badge =
          c.status === "approved" ? "bg-green-100 text-green-700" :
            c.status === "rejected" ? "bg-red-100 text-red-700" :
              "bg-yellow-100 text-yellow-700";

        return `
          <div class="p-4 bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 flex justify-between items-start gap-3">
            <div class="min-w-0">
              <div class="text-xs font-black text-slate-500 mb-1">${c.lesson || "General"}</div>
              <div class="font-black truncate">${c.front}</div>
              <div class="text-sm text-slate-600 dark:text-slate-400 font-black truncate">${c.back}</div>
            </div>
            <span class="text-xs font-black px-2 py-1 rounded-xl ${badge}">${c.status}</span>
          </div>
        `;
      }).join("");
    }

    // ==========================
    // MISTAKES (Hata Kutusu)
    // ==========================
    function renderMistakes() {
      return `
        <div class="max-w-3xl mx-auto">
          <div class="text-center mb-8">
            <h2 class="text-2xl font-black"><i class="fa-solid fa-recycle text-red-500 mr-2"></i>Hata Kutusu</h2>
            <p class="text-slate-500 dark:text-slate-400 font-black text-sm">YanlÄ±ÅŸ yaptÄ±ÄŸÄ±n sorular burada birikir.</p>
          </div>
          <div id="mistakesList" class="space-y-6 pb-32">
            <div class="text-center text-slate-400 font-black"><i class="fa-solid fa-spinner fa-spin"></i> YÃ¼kleniyor...</div>
          </div>
        </div>
      `;
    }

    async function addToMistakes(qId) {
      const qRef = doc(db, colPath("questions"), qId);
      const snap = await getDoc(qRef);
      if (!snap.exists()) return;

      const q = snap.data();
      await setDoc(doc(db, userExamPath(currentUser.uid, "mistakes"), qId), {
        ...q,
        qId,
        addedAt: serverTimestamp()
      });
    }

    async function loadMistakes() {
      const container = document.getElementById("mistakesList");
      if (!container) return;

      const snap = await getDocs(query(collection(db, userExamPath(currentUser.uid, "mistakes")), orderBy("addedAt", "desc")));
      if (snap.empty) {
        container.innerHTML = `
          <div class="flex flex-col items-center justify-center p-10 bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800">
            <i class="fa-solid fa-check-circle text-6xl text-green-500 mb-4"></i>
            <h3 class="text-xl font-black">Harika!</h3>
            <p class="text-slate-500 dark:text-slate-400 font-black text-sm">Hata kutun boÅŸ.</p>
          </div>
        `;
        return;
      }

      let html = "";
      snap.forEach(d => {
        const data = d.data();
        const id = d.id;
        html += `
          <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border-l-4 border-red-500 shadow-soft" id="mistake-${id}">
            <div class="flex justify-between items-start mb-4">
              <span class="bg-slate-100 dark:bg-slate-950 text-slate-600 dark:text-slate-300 text-xs font-black px-2 py-1 rounded-xl uppercase">${data.lesson || "Genel"}</span>
              <button onclick="deleteMistake('${id}')" class="text-slate-400 hover:text-red-500" title="Sil"><i class="fa-solid fa-trash"></i></button>
            </div>
            <p class="text-lg font-black mb-6">${data.text}</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${(data.options || []).map((opt, idx) => `
                <button onclick="checkMistakeAnswer('${id}', ${idx}, ${data.correct})"
                  class="text-left p-3 rounded-2xl border border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-950 transition font-black mistake-opt-${id}">
                  <span class="font-black mr-2">${String.fromCharCode(65 + idx)})</span> ${opt}
                </button>
              `).join("")}
            </div>
            <div id="feedback-${id}" class="mt-4 hidden font-black text-center"></div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    window.checkMistakeAnswer = async (docId, selectedIdx, correctIdx) => {
      const feedback = document.getElementById(`feedback-${docId}`);
      const buttons = document.querySelectorAll(`.mistake-opt-${docId}`);
      buttons.forEach(b => b.disabled = true);

      if (selectedIdx === correctIdx) {
        feedback.innerHTML = `<span class="text-green-600 dark:text-green-300"><i class="fa-solid fa-check"></i> DoÄŸru! Siliniyor...</span>`;
        feedback.classList.remove("hidden");
        setTimeout(async () => {
          await deleteDoc(doc(db, userExamPath(currentUser.uid, "mistakes"), docId));
          const el = document.getElementById(`mistake-${docId}`);
          if (el) {
            el.style.transition = "all .4s";
            el.style.opacity = "0";
            el.style.transform = "scale(.95)";
            setTimeout(() => { el.remove(); }, 420);
          }
          await gainXP(3);
          // refresh empty state if needed
          setTimeout(() => loadMistakes(), 450);
        }, 900);
      } else {
        feedback.innerHTML = `<span class="text-red-600 dark:text-red-300"><i class="fa-solid fa-xmark"></i> YanlÄ±ÅŸ. Tekrar dene!</span>`;
        feedback.classList.remove("hidden");
        setTimeout(() => {
          buttons.forEach(b => b.disabled = false);
          feedback.classList.add("hidden");
        }, 900);
      }
    };

    window.deleteMistake = async (id) => {
      if (!confirm("Bu soruyu kutudan silmek istiyor musun?")) return;
      await deleteDoc(doc(db, userExamPath(currentUser.uid, "mistakes"), id));
      loadMistakes();
    };

    // ==========================
    // MOCK EXAMS (UPDATED)
    // ==========================
    function renderMocks() {
      return `
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 pb-24">
          <!-- HESAPLAMA MODÃœLÃœ -->
          <div class="lg:col-span-5 space-y-6">
            <h2 class="text-2xl font-black">Deneme Ekle & Hesapla</h2>
            <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft">
              
              <!-- TYT BÃ–LÃœMÃœ -->
              <div class="mb-4">
                <h4 class="font-black text-primary mb-2 border-b border-slate-100 dark:border-slate-800 pb-1">TYT Netleri</h4>
                <div class="grid grid-cols-2 gap-3">
                   <div><label class="text-[10px] uppercase font-black text-slate-400">TÃ¼rkÃ§e (40)</label><input type="number" id="tytTr" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Sosyal (20)</label><input type="number" id="tytSos" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Matematik (40)</label><input type="number" id="tytMat" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Fen (20)</label><input type="number" id="tytFen" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                </div>
              </div>

              <!-- AYT BÃ–LÃœMÃœ -->
              <div class="mb-4">
                <h4 class="font-black text-indigo-500 mb-2 border-b border-slate-100 dark:border-slate-800 pb-1">AYT Netleri (Ä°lgili alanlarÄ± doldur)</h4>
                <div class="grid grid-cols-2 gap-3">
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Matematik (40)</label><input type="number" id="aytMat" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Fizik (14)</label><input type="number" id="aytFiz" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Kimya (13)</label><input type="number" id="aytKim" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Biyoloji (13)</label><input type="number" id="aytBiy" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Edebiyat (24)</label><input type="number" id="aytEdb" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">Tarih-1 (10)</label><input type="number" id="aytTar1" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">CoÄŸrafya-1 (6)</label><input type="number" id="aytCog1" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                   <div><label class="text-[10px] uppercase font-black text-slate-400">YDT (80)</label><input type="number" id="ydtNet" class="w-full p-2 rounded-xl border dark:border-slate-800 dark:bg-slate-950 font-bold" placeholder="Net"></div>
                </div>
              </div>

              <button onclick="saveMockResult()" class="w-full bg-slate-900 dark:bg-slate-800 hover:bg-black text-white font-black py-3 rounded-2xl shadow-lg transform hover:scale-[1.02] transition">
                <i class="fa-solid fa-calculator mr-2"></i> Hesapla ve Kaydet
              </button>
            </div>
          </div>

          <!-- GEÃ‡MÄ°Åž VE GRAFÄ°K -->
          <div class="lg:col-span-7 flex flex-col gap-6">
             <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft h-64">
               <canvas id="mockChart"></canvas>
             </div>
             
             <div class="flex-1 bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft overflow-hidden flex flex-col">
                <div class="p-4 border-b border-slate-100 dark:border-slate-800 font-black bg-slate-50 dark:bg-slate-950">Son Denemeler</div>
                <div id="mockList" class="flex-1 overflow-y-auto p-2 space-y-2 max-h-80">
                   <div class="text-center text-slate-400 p-4">YÃ¼kleniyor...</div>
                </div>
             </div>
          </div>
        </div>
      `;
    }

    window.saveMockResult = async () => {
      // KULLANICI KONTROLÃœ
      if (!currentUser) {
        alert("LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n.");
        return;
      }

      try {
        // 1. TYT DeÄŸerlerini Al
        const tTr = Number(document.getElementById("tytTr")?.value) || 0;
        const tSos = Number(document.getElementById("tytSos")?.value) || 0;
        const tMat = Number(document.getElementById("tytMat")?.value) || 0;
        const tFen = Number(document.getElementById("tytFen")?.value) || 0;

        // 2. AYT DeÄŸerlerini Al
        const aMat = Number(document.getElementById("aytMat")?.value) || 0;
        const aFiz = Number(document.getElementById("aytFiz")?.value) || 0;
        const aKim = Number(document.getElementById("aytKim")?.value) || 0;
        const aBiy = Number(document.getElementById("aytBiy")?.value) || 0;
        const aEdb = Number(document.getElementById("aytEdb")?.value) || 0;
        const aTar1 = Number(document.getElementById("aytTar1")?.value) || 0;
        const aCog1 = Number(document.getElementById("aytCog1")?.value) || 0;
        const ydt = Number(document.getElementById("ydtNet")?.value) || 0;

        // 3. Hesaplama (YaklaÅŸÄ±k KatsayÄ±lar)
        const tytScore = 100 + (tTr * 3.3) + (tSos * 3.4) + (tMat * 3.3) + (tFen * 3.4);

        // AYT PuanlarÄ±
        const sayScore = (tytScore * 0.4) + ((aMat * 3 + aFiz * 2.8 + aKim * 2.8 + aBiy * 2.8) * 2.5) + 100;
        const eaScore = (tytScore * 0.4) + ((aMat * 3 + aEdb * 3 + aTar1 * 2.8 + aCog1 * 2.8) * 2.5) + 100;
        const dilScore = (tytScore * 0.4) + (ydt * 3) + 100;

        // En YÃ¼ksek Puan (Max 500 SÄ±nÄ±rÄ±)
        const mainScore = Math.max(tytScore, sayScore, eaScore, dilScore);
        const finalScore = Math.min(500, Math.floor(mainScore));

        // 4. Veri HazÄ±rla
        const payload = {
          tyt: { tr: tTr, sos: tSos, mat: tMat, fen: tFen, score: Math.floor(tytScore) },
          ayt: { say: Math.floor(sayScore), ea: Math.floor(eaScore), dil: Math.floor(dilScore) },
          totalScore: finalScore,
          date: new Date().toLocaleDateString("tr-TR"),
          createdAt: serverTimestamp()
        };

        // 5. Firestore'a KayÄ±t (Yollar Elle YazÄ±ldÄ± - Garanti Olsun)
        // A) Deneme GeÃ§miÅŸine Ekle
        await addDoc(collection(db, `users/${currentUser.uid}/exams/yks/mockExams`), payload);

        // B) KullanÄ±cÄ± Profilini GÃ¼ncelle
        await updateDoc(doc(db, "users", currentUser.uid), {
          totalScore: finalScore,  // Profilde gÃ¶rÃ¼nen
          yksScore: finalScore     // SÄ±ralama iÃ§in
        });

        // 6. UI GÃ¼ncelle
        if (typeof updateSidebar === 'function') updateSidebar();
        alert(`âœ… SonuÃ§ Kaydedildi!\nTYT: ${Math.floor(tytScore)}\nSAY: ${Math.floor(sayScore)}\nEA: ${Math.floor(eaScore)}`);

        // SayfayÄ± Yenile
        if (typeof loadPage === 'function') loadPage("mocks");

      } catch (e) {
        console.error("YKS KayÄ±t HatasÄ±:", e);
        alert("âŒ Hata oluÅŸtu: " + e.message);
      }
    };

    // Chart render kÄ±smÄ±nÄ± da gÃ¼ncellememiz lazÄ±m, data yapÄ±sÄ± deÄŸiÅŸti.
    async function loadMocks() {
      const listEl = document.getElementById("mockList");
      if (!listEl) return;

      const qy = query(collection(db, userExamPath(currentUser.uid, "mockExams")), orderBy("createdAt", "desc"), limit(20));
      const snap = await getDocs(qy);
      mockHistory = snap.docs.map(d => d.data());

      if (mockHistory.length === 0) {
        listEl.innerHTML = `<div class="p-6 text-slate-400 font-black text-center">HenÃ¼z deneme kaydetmedin.</div>`;
      } else {
        listEl.innerHTML = mockHistory.map(m => `
            <div class="p-3 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-950 transition">
              <div>
                <div class="font-black text-sm">${m.date}</div>
                <div class="text-[10px] text-slate-500 font-black">TYT: ${m.tyt?.score || 0} | SAY: ${m.ayt?.say || 0} | EA: ${m.ayt?.ea || 0}</div>
              </div>
              <div class="text-lg font-black text-primary">${m.totalScore}</div>
            </div>
          `).join("");
      }

      renderMockChart();
    }



    function renderMockChart() {
      const canvas = document.getElementById("mockChart");
      if (!canvas) return;

      const labels = mockHistory.slice().reverse().map(x => x.date);
      const data = mockHistory.slice().reverse().map(x => x.score);

      if (mockChart) mockChart.destroy();

      mockChart = new Chart(canvas, {
        type: "line",
        data: { labels, datasets: [{ label: "Puan", data, tension: 0.35, fill: true }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // ==========================
    // SMART COACH (WhatsApp style)
    // ==========================
    function renderCoach() {
      return `
        <div class="max-w-3xl mx-auto">
          <h2 class="text-2xl font-black mb-4">SmartCoach</h2>
          <div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft overflow-hidden">
            <div id="chatWindow" class="p-4 h-[460px] overflow-y-auto bg-slate-50 dark:bg-slate-950">
              <div id="emptyState" class="text-center text-slate-400 font-black mt-10">
                <i class="fa-solid fa-comments text-4xl mb-2"></i><br/>
                Hoca burada. Sor bakalÄ±m.
              </div>
            </div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900">
              <div class="flex items-end gap-2">
                <textarea id="aiInput" class="flex-1 p-3 rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 outline-none resize-none" rows="1" placeholder="Mesaj yaz..."></textarea>
                <button onclick="askSmartCoach()" class="w-12 h-12 rounded-2xl bg-primary hover:bg-primaryDark text-white font-black flex items-center justify-center">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
              <div class="text-[10px] text-slate-400 font-black mt-2">API_URL boÅŸsa demo cevap verir.</div>
            </div>
          </div>
        </div>
      `;
    }

    function scrollToBottom() {
      const w = document.getElementById("chatWindow");
      if (w) w.scrollTop = w.scrollHeight;
    }

    window.askSmartCoach = async () => {
      const input = document.getElementById("aiInput");
      const chatWindow = document.getElementById("chatWindow");
      const prompt = input.value.trim();
      if (!prompt) return;

      // BoÅŸ durumu kaldÄ±r
      document.getElementById("emptyState")?.remove();

      // 1. KullanÄ±cÄ± MesajÄ±nÄ± Ekle
      chatWindow.insertAdjacentHTML("beforeend", `
         <div class="flex justify-end mb-4">
           <div class="bg-[#dcf8c6] dark:bg-[#005c4b] text-slate-800 dark:text-[#e9edef] px-4 py-2 rounded-2xl rounded-tr-none text-sm shadow font-bold max-w-[85%]">
             ${prompt.replace(/</g, "&lt;")}
             <div class="text-[9px] text-right mt-1 opacity-50">Okundu âœ“âœ“</div>
           </div>
         </div>
       `);
      input.value = "";
      scrollToBottom();

      // 2. YÃ¼kleniyor Animasyonu
      const loadingId = "loading-" + Date.now();
      chatWindow.insertAdjacentHTML("beforeend", `
         <div class="flex justify-start mb-4 animate-pulse" id="${loadingId}">
           <div class="bg-white dark:bg-[#202c33] px-4 py-2 rounded-2xl text-xs dark:text-slate-300 font-bold border border-slate-100 dark:border-slate-700">
             Hoca dÃ¼ÅŸÃ¼nÃ¼yor...
           </div>
         </div>
       `);
      scrollToBottom();

      try {
        // Ä°statistikleri Ã§ek
        const stats = calculateStats();
        let aiMode = "";

        // YKS Puan AralÄ±ÄŸÄ±na GÃ¶re Karakter Analizi (0-500 Puan)
        if (stats.progress < 15) {
          aiMode = "Sen ÅŸu an 'Yol GÃ¶steren Dost' modundasÄ±n. Ã–ÄŸrenci YKS maratonunun Ã§ok baÅŸÄ±nda. Onu korkutmadan, TYT temellerini atmasÄ± iÃ§in motive et.";
        } else if (stats.avgScore < 250 && stats.progress > 40) {
          aiMode = "Sen ÅŸu an 'UyarÄ±cÄ± Mentor' modundasÄ±n. Ã–ÄŸrenci konularÄ± ilerletmiÅŸ ama netleri (250 altÄ±) dÃ¼ÅŸÃ¼k. Samimi ama sert bir dille eksiklerini (deneme analizi vb.) yÃ¼zÃ¼ne vur.";
        } else if (stats.avgScore >= 420) {
          aiMode = "Sen ÅŸu an 'Derece KoÃ§u' modundasÄ±n. KarÅŸÄ±nda ilk 10.000 hedefleyen bir Ã¶ÄŸrenci var. Rehavete kapÄ±lmasÄ±nÄ± engelle, AYT detaylarÄ±na odaklanmasÄ±nÄ± sÃ¶yle.";
        } else {
          aiMode = "Sen 'Samimi YKS Rehber Ã–ÄŸretmeni' modundasÄ±n. NeÅŸeli, enerjik ama sÄ±nav ciddiyetini koruyan bir tavÄ±r sergile.";
        }

        const systemInstruction = `
              ${aiMode}
              
              Ã–ÄžRENCÄ° KÄ°MLÄ°ÄžÄ°:
              - Ä°sim: ${userData.name || "Ã–ÄŸrenci"}
              - Hedef: YKS (TYT/AYT)
              - Mevcut BaÅŸarÄ±: %${stats.progress} konu bitirme, Ortalama ${stats.avgScore} Puan.
              
              KURALLAR:
              1. KullanÄ±cÄ±yÄ± ismiyle selamla (Hocam, ${userData.name}, Åžampiyon vb.).
              2. Cevap verirken KPSS'den deÄŸil, TYT ve AYT'den bahset.
              3. Ã‡ok uzun paragraflar yazma, maddeler halinde ve okunabilir yaz.
              4. "Hallederiz", "Bas gaza", "Bu sene o sene" gibi motive edici ifadeler kullan.
          `;

        // API Ä°steÄŸi
        const response = await fetch(GEMINI_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{
              parts: [{ text: `${systemInstruction} \n\n KullanÄ±cÄ± Sorusu: ${prompt}` }]
            }]
          })
        });

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Hoca ÅŸu an meÅŸgul, sonra tekrar dene.";

        document.getElementById(loadingId)?.remove();

        // 3. AI CevabÄ±nÄ± Ekle
        chatWindow.insertAdjacentHTML("beforeend", `
            <div class="flex justify-start mb-6">
              <div class="bg-white dark:bg-[#202c33] text-slate-800 dark:text-[#e9edef] px-5 py-3 rounded-2xl rounded-tl-none text-sm shadow-md max-w-[90%] border-l-4 border-primary leading-relaxed font-medium">
                ${formatAiResponse(text)}
              </div>
            </div>
          `);
        scrollToBottom();

      } catch (e) {
        document.getElementById(loadingId)?.remove();
        chatWindow.insertAdjacentHTML("beforeend", `
            <div class="text-center mb-3">
              <span class="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-200 text-[10px] px-3 py-1 rounded-lg font-bold">
                Hoca ile baÄŸlantÄ± koptu. Ä°nternetini kontrol et.
              </span>
            </div>
          `);
        console.error(e);
      }
    };

    // ==========================
    // ADMIN PANEL + BULK UPLOAD
    // ==========================
    function renderAdmin() {
      return `
        <div class="max-w-6xl mx-auto">
          <h1 class="text-2xl font-black mb-6">Admin Panel (YKS)</h1>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
              <div class="flex gap-3 mb-4 overflow-x-auto pb-2">
                <button onclick="loadAdminData('questions')" class="px-4 py-2 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-soft font-black whitespace-nowrap">Bekleyen Soru</button>
                <button onclick="loadAdminData('cards')" class="px-4 py-2 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl shadow-soft font-black whitespace-nowrap">Bekleyen Kart</button>
                <!-- ÅžÄ°KAYET BUTONU KALDIRILDI -->
              </div>

              <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-soft border border-slate-100 dark:border-slate-800 overflow-hidden min-h-[420px]">
                <div id="adminContentArea" class="divide-y divide-slate-100 dark:divide-slate-800">
                  <div class="p-8 text-center text-slate-400 font-black">YÃ¼kleniyor...</div>
                </div>
              </div>
            </div>

            <div class="space-y-6">
              <!-- Toplu YÃ¼kleme AlanlarÄ± AynÄ± Kalacak -->
              <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft">
                <h3 class="font-black text-lg mb-3"><i class="fa-solid fa-file-import text-indigo-500 mr-2"></i>Toplu Soru YÃ¼kle</h3>
                <textarea id="bulkJsonQuestions" rows="6" class="w-full p-3 rounded-2xl border dark:border-slate-800 dark:bg-slate-950 text-xs font-mono outline-none" placeholder="JSON buraya..."></textarea>
                <button onclick="bulkUploadQuestions()" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3 rounded-2xl">SorularÄ± CanlÄ±ya Al</button>
              </div>
              
              <div class="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft">
                <h3 class="font-black text-lg mb-3"><i class="fa-solid fa-layer-group text-pink-500 mr-2"></i>Toplu Kart YÃ¼kle</h3>
                <textarea id="bulkJsonCards" rows="6" class="w-full p-3 rounded-2xl border dark:border-slate-800 dark:bg-slate-950 text-xs font-mono outline-none" placeholder="JSON buraya..."></textarea>
                <button onclick="bulkUploadFlashcards()" class="w-full mt-3 bg-pink-600 hover:bg-pink-700 text-white font-black py-3 rounded-2xl">KartlarÄ± CanlÄ±ya Al</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.loadAdminData = async (type) => {
      const container = document.getElementById("adminContentArea");
      if (!container) return;
      container.innerHTML = `<div class="p-8 text-center text-slate-400 font-black">YÃ¼kleniyor...</div>`;

      if (currentUser.email?.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
        container.innerHTML = `<div class="p-8 text-center text-red-500 font-black">Yetkisiz.</div>`;
        return;
      }

      let html = "";

      if (type === "questions") {
        const snap = await getDocs(query(collection(db, colPath("questionSubmissions")), where("status", "==", "pending"), orderBy("createdAt", "desc"), limit(50)));
        if (snap.empty) html = `<div class="p-8 text-center font-black">Bekleyen soru yok.</div>`;
        else {
          snap.forEach(d => {
            const q = d.data();
            html += `
              <div class="p-6">
                <div class="flex justify-between mb-2">
                  <span class="text-xs font-black bg-blue-100 text-blue-700 px-2 py-1 rounded-xl">${q.lesson}</span>
                  <span class="text-xs text-slate-500 font-black">${q.authorName}</span>
                </div>
                <p class="font-black mb-3">${q.text}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm font-black mb-4">
                  ${(q.options || []).map((o, i) => `<div class="${i === q.correct ? 'text-green-600' : ''}">${String.fromCharCode(65 + i)}) ${o}</div>`).join("")}
                </div>
                <div class="flex gap-2">
                  <button onclick="adminAction('question','${d.id}','approve')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-2xl font-black">Onayla</button>
                  <button onclick="adminRejectPrompt('question','${d.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-2xl font-black">Reddet</button>
                </div>
              </div>
            `;
          });
        }
      }

      if (type === "cards") {
        const snap = await getDocs(query(collection(db, colPath("flashcardSubmissions")), where("status", "==", "pending"), orderBy("createdAt", "desc"), limit(50)));
        if (snap.empty) html = `<div class="p-8 text-center font-black">Bekleyen kart yok.</div>`;
        else {
          snap.forEach(d => {
            const c = d.data();
            html += `
              <div class="p-6 flex justify-between items-start gap-3">
                <div class="min-w-0">
                  <div class="text-xs font-black text-slate-500 mb-1">${c.lesson || "General"} â€¢ ${c.authorName}</div>
                  <div class="font-black text-lg truncate">${c.front}</div>
                  <div class="text-sm text-slate-600 dark:text-slate-400 font-black truncate">${c.back}</div>
                </div>
                <div class="flex gap-2 shrink-0">
                  <button onclick="adminAction('card','${d.id}','approve')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-2xl font-black">Onayla</button>
                  <button onclick="adminRejectPrompt('card','${d.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-2xl font-black">Reddet</button>
                </div>
              </div>
            `;
          });
        }
      }

      if (type === "reports") {
        const snap = await getDocs(query(collection(db, colPath("reports")), orderBy("createdAt", "desc"), limit(80)));
        if (snap.empty) html = `<div class="p-8 text-center font-black">Åžikayet yok.</div>`;
        else {
          snap.forEach(d => {
            const r = d.data();
            html += `
              <div class="p-6">
                <div class="flex justify-between items-start mb-2">
                  <div class="text-xs font-black text-slate-500">${r.col} â€¢ ${r.itemId}</div>
                  <button onclick="deleteDocByPath('${colPath("reports")}', '${d.id}')" class="text-red-500 font-black"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="font-black mb-1">${escapeHtml(r.summary || "")}</div>
                <div class="text-sm text-slate-600 dark:text-slate-400 font-black">${escapeHtml(r.reason || "")}</div>
                <div class="text-[10px] text-slate-400 font-black mt-2">${r.createdAt?.seconds ? new Date(r.createdAt.seconds * 1000).toLocaleString() : ""}</div>
              </div>
            `;
          });
        }
      }

      container.innerHTML = html || `<div class="p-8 text-center font-black">Veri yok.</div>`;
    };

    window.deleteDocByPath = async (baseCol, id) => {
      if (!confirm("Silinsin mi?")) return;
      await deleteDoc(doc(db, baseCol, id));
      loadAdminData("reports");
    };

    window.adminRejectPrompt = async (type, id) => {
      const note = prompt("Red sebebi (opsiyonel):") || "";
      await adminAction(type, id, "reject", note);
    };

    window.adminAction = async (type, id, action, note = "") => {
      if (currentUser.email?.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) return alert("Yetkisiz.");

      const subCol = type === "question" ? colPath("questionSubmissions") : colPath("flashcardSubmissions");
      const ref = doc(db, subCol, id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return alert("BulunamadÄ±.");
      const data = snap.data();

      if (action === "reject") {
        await updateDoc(ref, { status: "rejected", adminNote: note || "" });
        await addUserNotification(data.uid, "Onay Durumu", `GÃ¶nderin reddedildi. ${note ? "Sebep: " + note : ""}`, "error");
      } else {
        await updateDoc(ref, { status: "approved", adminNote: "" });

        if (type === "question") {
          await addDoc(collection(db, colPath("questions")), {
            lesson: data.lesson,
            text: data.text,
            options: data.options,
            correct: data.correct,
            authorName: data.authorName,
            uid: data.uid,
            createdAt: serverTimestamp()
          });
          await addUserNotification(data.uid, "Onay Durumu", "Sorun onaylandÄ± ve yayÄ±na alÄ±ndÄ±.", "success");
        } else {
          await addDoc(collection(db, colPath("flashcards")), {
            lesson: data.lesson || "General",
            front: data.front,
            back: data.back,
            authorName: data.authorName,
            uid: data.uid,
            createdAt: serverTimestamp()
          });
          await addUserNotification(data.uid, "Onay Durumu", "KartÄ±n onaylandÄ± ve yayÄ±na alÄ±ndÄ±.", "success");
        }
      }

      alert("Ä°ÅŸlem tamam.");
      loadAdminData(type === "question" ? "questions" : "cards");
    };

    async function addUserNotification(uid, title, message, type) {
      await addDoc(collection(db, colPath("notifications")), {
        uid,
        title,
        message,
        type,
        read: false,
        createdAt: serverTimestamp()
      });
    }

    window.bulkUploadQuestions = async () => {
      if (currentUser.email?.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) return alert("Yetkisiz.");

      const el = document.getElementById("bulkJsonQuestions");
      const input = el.value.trim();
      if (!input) return alert("JSON boÅŸ.");

      try {
        const arr = JSON.parse(input);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("Liste boÅŸ / format hatalÄ±.");
        if (!confirm(`${arr.length} soru canlÄ±ya eklenecek. Emin misin?`)) return;

        const batch = writeBatch(db);
        let count = 0;

        arr.forEach(q => {
          if (q.lesson && q.text && Array.isArray(q.options) && q.correct !== undefined) {
            const r = doc(collection(db, colPath("questions")));
            batch.set(r, {
              lesson: q.lesson,
              text: q.text,
              options: q.options,
              correct: Number(q.correct),
              authorName: "Sistem",
              uid: currentUser.uid,
              createdAt: serverTimestamp()
            });
            count++;
          }
        });

        if (!count) throw new Error("GeÃ§erli soru bulunamadÄ±.");
        await batch.commit();
        el.value = "";
        alert(`âœ… ${count} soru yÃ¼klendi.`);
      } catch (e) {
        alert("âŒ " + e.message);
      }
    };

    window.bulkUploadFlashcards = async () => {
      if (currentUser.email?.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) return alert("Yetkisiz.");

      const el = document.getElementById("bulkJsonCards");
      const input = el.value.trim();
      if (!input) return alert("JSON boÅŸ.");

      try {
        const arr = JSON.parse(input);
        if (!Array.isArray(arr) || arr.length === 0) throw new Error("Liste boÅŸ / format hatalÄ±.");
        if (!confirm(`${arr.length} kart canlÄ±ya eklenecek. Emin misin?`)) return;

        const batch = writeBatch(db);
        let count = 0;

        arr.forEach(c => {
          if (c.front && c.back) {
            const r = doc(collection(db, colPath("flashcards")));
            batch.set(r, {
              lesson: c.lesson || "General",
              front: c.front,
              back: c.back,
              authorName: "Sistem",
              uid: currentUser.uid,
              createdAt: serverTimestamp()
            });
            count++;
          }
        });

        if (!count) throw new Error("GeÃ§erli kart bulunamadÄ±.");
        await batch.commit();
        el.value = "";
        alert(`âœ… ${count} kart yÃ¼klendi.`);
      } catch (e) {
        alert("âŒ " + e.message);
      }
    };

    // ==========================
    // REPORT + DELETE LIVE ITEM
    // ==========================
    window.openReportModal = (col, id, summary) => {
      reportPayload = { col, id, summary: summary || "" };
      document.getElementById("reportSummary").innerText = reportPayload.summary || "(Ã–zet yok)";
      document.getElementById("reportReason").value = "";
      document.getElementById("reportModal").classList.remove("hidden");
    };

    window.closeReportModal = () => {
      document.getElementById("reportModal").classList.add("hidden");
    };

    window.submitReport = async () => {
      const reason = document.getElementById("reportReason").value.trim();
      await addDoc(collection(db, colPath("reports")), {
        uid: currentUser.uid,
        col: reportPayload.col,
        itemId: reportPayload.id,
        summary: reportPayload.summary || "",
        reason,
        createdAt: serverTimestamp()
      });
      closeReportModal();
      alert("Åžikayet gÃ¶nderildi.");
      notifyAdmin(`[YKS] Åžikayet geldi: ${reportPayload.col} / ${reportPayload.id}`);
    };

    window.deleteLiveItem = async (col, id) => {
      if (currentUser.email?.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) return alert("Yetkisiz.");
      if (!id) return;
      if (!confirm("Bu canlÄ± veriyi sileceksin. Emin misin?")) return;

      const liveCol = col === "questions" ? colPath("questions") : colPath("flashcards");
      await deleteDoc(doc(db, liveCol, id));
      alert("Silindi.");

      // refresh current page
      const active = document.querySelector("aside nav button.active-nav")?.id?.replace("nav-", "") || "quiz";
      loadPage(active);
    };

    // ==========================
    // ADMIN NOTIFY HELPERS
    // ==========================
    async function notifyAdmin(msg) {
      // admin kullanÄ±cÄ± doc'larÄ±nÄ± bul
      const snap = await getDocs(query(collection(db, "users"), where("email", "==", ADMIN_EMAIL)));
      snap.forEach(async (d) => {
        await addDoc(collection(db, colPath("notifications")), {
          uid: d.id,
          title: "YÃ¶netici UyarÄ±sÄ±",
          message: msg,
          type: "warning",
          read: false,
          createdAt: serverTimestamp()
        });
      });
    }

    // ==========================
    // START DEFAULT
    // ==========================
    // (auth state change loads quiz)

    // ==========================
    // SMART PROGRAM (Drag & Drop)
    // ==========================
    let programData = { Mon: [], Tue: [], Wed: [], Thu: [], Fri: [], Sat: [], Sun: [] };

    function renderProgram() {
      return `
        <div class="h-[calc(100vh-100px)] flex flex-col">
          <div class="flex justify-between items-center mb-4">
             <div>
               <h2 class="text-2xl font-black">HaftalÄ±k AkÄ±llÄ± Program</h2>
               <p class="text-xs text-slate-500 dark:text-slate-400 font-black">KonularÄ± gÃ¼nlere sÃ¼rÃ¼kle veya tÄ±kla.</p>
             </div>
             <div class="flex gap-2">
               <button onclick="saveProgram()" class="bg-primary hover:bg-primaryDark text-white px-4 py-2 rounded-xl font-black text-sm"><i class="fa-solid fa-save mr-2"></i>Kaydet</button>
               <button onclick="clearProgram()" class="bg-red-100 text-red-600 px-4 py-2 rounded-xl font-black text-sm"><i class="fa-solid fa-trash mr-2"></i>SÄ±fÄ±rla</button>
             </div>
          </div>

          <div class="flex-1 flex gap-4 overflow-hidden">
            <!-- TOPIC POOL -->
            <div class="w-1/3 bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 flex flex-col shadow-soft">
              <div class="p-4 border-b border-slate-100 dark:border-slate-800 font-black">Konu Havuzu</div>
              <div class="p-2 overflow-x-auto whitespace-nowrap border-b border-slate-50 dark:border-slate-800">
                <select id="poolFilter" onchange="filterTopicPool()" class="text-sm bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-xl p-2 outline-none font-bold w-full">
                  <option value="All">TÃ¼m Dersler</option>
                  ${Object.keys(YKS_TOPICS).map(k => `<option value="${k}">${k}</option>`).join("")}
                </select>
              </div>
              <div id="topicPoolList" class="flex-1 overflow-y-auto p-2 space-y-1 custom-scrollbar"></div>
            </div>

            <!-- WEEKLY CALENDAR -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
              <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                ${["Pazartesi", "SalÄ±", "Ã‡arÅŸamba", "PerÅŸembe", "Cuma", "Cumartesi", "Pazar"].map((day, idx) => {
        const enDay = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"][idx];
        return `
                     <div class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 min-h-[200px] flex flex-col" 
                          ondragover="allowDrop(event)" ondrop="drop(event, '${enDay}')">
                        <div class="p-3 border-b border-slate-100 dark:border-slate-800 font-black text-center ${idx > 4 ? 'text-red-500' : 'text-slate-700 dark:text-slate-300'}">${day}</div>
                        <div id="day-${enDay}" class="flex-1 p-2 space-y-1"></div>
                     </div>
                   `;
      }).join("")}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Program Helpers
    window.filterTopicPool = () => {
      const cat = document.getElementById("poolFilter").value;
      const list = document.getElementById("topicPoolList");
      list.innerHTML = "";

      Object.keys(YKS_TOPICS).forEach(key => {
        if (cat === "All" || cat === key) {
          YKS_TOPICS[key].forEach(topic => {
            const div = document.createElement("div");
            div.className = "p-2 bg-slate-50 dark:bg-slate-950 hover:bg-slate-100 dark:hover:bg-slate-800 border border-slate-200 dark:border-slate-800 rounded-xl text-xs font-black cursor-grab active:cursor-grabbing select-none";
            div.draggable = true;
            div.innerText = topic;
            div.setAttribute("data-topic", topic);
            div.setAttribute("data-cat", key);

            // Drag Start
            div.addEventListener("dragstart", (e) => {
              e.dataTransfer.setData("text/plain", JSON.stringify({ topic, cat: key }));
            });

            // Click to add (Mobile friendly alternative)
            div.addEventListener("click", () => {
              const day = prompt("Hangi gÃ¼ne eklensin? (1-7 arasÄ± sayÄ± girin)\n1: Pzt ... 7: Pazar");
              if (day && day >= 1 && day <= 7) {
                const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                addToDay(days[day - 1], topic, key);
              }
            });

            list.appendChild(div);
          });
        }
      });
    };

    window.allowDrop = (ev) => ev.preventDefault();

    window.drop = (ev, dayKey) => {
      ev.preventDefault();
      try {
        const data = JSON.parse(ev.dataTransfer.getData("text/plain"));
        addToDay(dayKey, data.topic, data.cat);
      } catch (e) { }
    };

    function addToDay(dayKey, topic, cat) {
      // Add to local state
      if (!programData[dayKey]) programData[dayKey] = [];
      // Avoid duplicates in same day
      if (programData[dayKey].find(x => x.topic === topic && x.cat === cat)) return;

      programData[dayKey].push({ topic, cat });
      renderDay(dayKey);
    }

    function renderDay(dayKey) {
      const container = document.getElementById(`day-${dayKey}`);
      if (!container) return;
      container.innerHTML = "";
      programData[dayKey].forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "group relative p-2 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800/30 rounded-xl text-[11px] font-black text-indigo-900 dark:text-indigo-200";
        div.innerHTML = `
            <span>${item.topic}</span>
            <button onclick="removeFromDay('${dayKey}', ${index})" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 text-red-500"><i class="fa-solid fa-times"></i></button>
          `;
        container.appendChild(div);
      });
    }

    window.removeFromDay = (dayKey, index) => {
      programData[dayKey].splice(index, 1);
      renderDay(dayKey);
    };

    window.saveProgram = async () => {
      await setDoc(doc(db, userExamPath(currentUser.uid, "program"), "weekly"), { ...programData });
      alert("Program kaydedildi!");
    };

    window.clearProgram = async () => {
      if (!confirm("Program sÄ±fÄ±rlansÄ±n mÄ±?")) return;
      programData = { Mon: [], Tue: [], Wed: [], Thu: [], Fri: [], Sat: [], Sun: [] };
      ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(d => renderDay(d));
      await saveProgram();
    };

    window.loadProgram = async () => {
      // Init UI
      filterTopicPool();

      const snap = await getDoc(doc(db, userExamPath(currentUser.uid, "program"), "weekly"));
      if (snap.exists()) {
        programData = snap.data();
        ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"].forEach(d => {
          if (!programData[d]) programData[d] = [];
          renderDay(d);
        });
      }
    };

    // ==========================
    // TOPIC TRACKER (GÃœNCELLENMÄ°Åž - KAPANMA SORUNU YOK)
    // ==========================
    let userTopicProgress = {};

    function renderTopicTracker() {
      return `
         <div class="max-w-5xl mx-auto pb-24">
           <h2 class="text-2xl font-black mb-6">Konu Takip Ã‡izelgesi</h2>
           <div class="space-y-6">
             ${Object.keys(YKS_TOPICS).map(lesson => `
               <div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-soft overflow-hidden">
                 <button onclick="toggleAccordion('acc-${lesson.replace(/\s/g, '_')}')" class="w-full p-5 flex justify-between items-center bg-slate-50 dark:bg-slate-950 hover:bg-slate-100 dark:hover:bg-slate-900 transition">
                    <span class="font-black text-lg">${lesson}</span>
                    <i class="fa-solid fa-chevron-down text-slate-400"></i>
                 </button>
                 <div id="acc-${lesson.replace(/\s/g, '_')}" class="hidden p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    ${YKS_TOPICS[lesson].map(topic => {
        const key = `${lesson}-${topic}`;
        const status = userTopicProgress[key] || "todo";
        // ID oluÅŸtururken boÅŸluklarÄ± alt Ã§izgi yapÄ±yoruz
        const safeID = `tracker-card-${lesson.replace(/\s/g, '_')}-${topic.replace(/\s/g, '_')}`;

        const colors = {
          todo: "bg-slate-100 text-slate-500 border-slate-200 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400",
          doing: "bg-yellow-100 text-yellow-700 border-yellow-200",
          done: "bg-green-100 text-green-700 border-green-200",
          repeat: "bg-red-100 text-red-700 border-red-200"
        };
        const icons = {
          todo: "fa-circle",
          doing: "fa-person-running",
          done: "fa-check-circle",
          repeat: "fa-rotate-right"
        };

        return `
                         <div class="flex items-center justify-between p-3 rounded-2xl border ${colors[status]} transition-all" id="${safeID}">
                            <span class="text-xs font-black truncate mr-2">${topic}</span>
                            <button onclick="cycleTopicStatus('${lesson}', '${topic}')" class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center hover:scale-110 transition">
                               <i class="fa-solid ${icons[status]}"></i>
                            </button>
                         </div>
                       `;
      }).join("")}
                 </div>
               </div>
             `).join("")}
           </div>
         </div>
       `;
    }

    window.toggleAccordion = (id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("hidden");
    };

    window.cycleTopicStatus = async (lesson, topic) => {
      const key = `${lesson}-${topic}`;
      const current = userTopicProgress[key] || "todo";
      const map = { todo: "doing", doing: "done", done: "repeat", repeat: "todo" };
      const next = map[current];

      userTopicProgress[key] = next;

      // 1. UI'Ä± anlÄ±k gÃ¼ncelle (Sayfa YENÄ°LENMEZ)
      updateTopicCardUI(lesson, topic, next);

      // 2. VeritabanÄ±na kaydet
      await setDoc(doc(db, userExamPath(currentUser.uid, "topics"), "status"), userTopicProgress, { merge: true });
    };

    function updateTopicCardUI(lesson, topic, status) {
      const safeID = `tracker-card-${lesson.replace(/\s/g, '_')}-${topic.replace(/\s/g, '_')}`;
      const el = document.getElementById(safeID);
      if (!el) return;

      const colors = {
        todo: "bg-slate-100 text-slate-500 border-slate-200 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400",
        doing: "bg-yellow-100 text-yellow-700 border-yellow-200",
        done: "bg-green-100 text-green-700 border-green-200",
        repeat: "bg-red-100 text-red-700 border-red-200"
      };
      const icons = {
        todo: "fa-circle",
        doing: "fa-person-running",
        done: "fa-check-circle",
        repeat: "fa-rotate-right"
      };

      el.className = `flex items-center justify-between p-3 rounded-2xl border transition-all ${colors[status]}`;
      const iconEl = el.querySelector("button i");
      if (iconEl) iconEl.className = `fa-solid ${icons[status]}`;
    }

    window.loadTopicsProgress = async () => {
      const snap = await getDoc(doc(db, userExamPath(currentUser.uid, "topics"), "status"));
      if (snap.exists()) {
        userTopicProgress = snap.data();
      }
      contentArea.innerHTML = renderTopicTracker();
    };



  </script>
</body>

</html>
